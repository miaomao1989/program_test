<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vmdq/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vmdq/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__prefetch_8h.html">rte_prefetch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__random_8h.html">rte_random.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_QUEUES 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * 1024 queues require to meet the needs of a large number of vmdq_pools.</span></div>
<div class="line"><span class="comment"> * (RX/TX_queue_nb * RX/TX_ring_descriptors_nb) per port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define NUM_MBUFS_PER_PORT (MAX_QUEUES * RTE_MAX(RTE_TEST_RX_DESC_DEFAULT, \</span></div>
<div class="line"><span class="preprocessor">                        RTE_TEST_TX_DESC_DEFAULT))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_CACHE_SIZE 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_PKT_BURST 32</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Configurable number of RX/TX ring descriptors</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define INVALID_PORT_ID 0xFF</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* number of pools (if user does not specify any, 8 by default */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_queues = 8;</div>
<div class="line"><span class="keyword">static</span> uint32_t num_pools = 8;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* empty vmdq configuration structure. Filled in programatically */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> vmdq_conf_default = {</div>
<div class="line">    .<a name="a1"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a2"></a><a class="code" href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">mq_mode</a>        = <a name="a3"></a><a class="code" href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c">ETH_MQ_RX_VMDQ_ONLY</a>,</div>
<div class="line">        .split_hdr_size = 0,</div>
<div class="line">        .header_split   = 0, </div>
<div class="line">        .hw_ip_checksum = 0, </div>
<div class="line">        .hw_vlan_filter = 0, </div>
<div class="line">        .jumbo_frame    = 0, </div>
<div class="line">    },</div>
<div class="line"></div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">    .rx_adv_conf = {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * should be overridden separately in code with</span></div>
<div class="line"><span class="comment">         * appropriate values</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .vmdq_rx_conf = {</div>
<div class="line">            .nb_queue_pools = <a name="a5"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae">ETH_8_POOLS</a>,</div>
<div class="line">            .enable_default_pool = 0,</div>
<div class="line">            .default_pool = 0,</div>
<div class="line">            .nb_pool_maps = 0,</div>
<div class="line">            .pool_map = {{0, 0},},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> lcore_ids[RTE_MAX_LCORE];</div>
<div class="line"><span class="keyword">static</span> uint8_t ports[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> num_ports; </div>
<div class="line"><span class="comment">/* array used for printing out statistics */</span></div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rxPackets[MAX_QUEUES] = {0};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> uint16_t vlan_tags[] = {</div>
<div class="line">    0,  1,  2,  3,  4,  5,  6,  7,</div>
<div class="line">    8,  9, 10, 11,  12, 13, 14, 15,</div>
<div class="line">    16, 17, 18, 19, 20, 21, 22, 23,</div>
<div class="line">    24, 25, 26, 27, 28, 29, 30, 31,</div>
<div class="line">    32, 33, 34, 35, 36, 37, 38, 39,</div>
<div class="line">    40, 41, 42, 43, 44, 45, 46, 47,</div>
<div class="line">    48, 49, 50, 51, 52, 53, 54, 55,</div>
<div class="line">    56, 57, 58, 59, 60, 61, 62, 63,</div>
<div class="line">};</div>
<div class="line"><span class="keyword">const</span> uint16_t num_vlans = <a name="a6"></a><a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(vlan_tags);</div>
<div class="line"><span class="keyword">static</span> uint16_t num_pf_queues,  num_vmdq_queues;</div>
<div class="line"><span class="keyword">static</span> uint16_t vmdq_pool_base, vmdq_queue_base;</div>
<div class="line"><span class="comment">/* pool mac addr template, pool mac addr is like: 52 54 00 12 port# pool# */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structether__addr.html">ether_addr</a> pool_addr_template = {</div>
<div class="line">    .<a name="a8"></a><a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a> = {0x52, 0x54, 0x00, 0x12, 0x00, 0x00}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structether__addr.html">ether_addr</a> vmdq_ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_QUEUE_NUM_10G 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_QUEUE_NUM_1G 8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_POOL_MAP_NUM_10G 64</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_POOL_MAP_NUM_1G 32</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_POOL_NUM_10G 64</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_POOL_NUM_1G 8</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Builds up the correct configuration for vmdq based on the vlan tags array</span></div>
<div class="line"><span class="comment"> * given above, and determine the queue number and pool map number according to</span></div>
<div class="line"><span class="comment"> * valid pool number</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">get_eth_conf(<span class="keyword">struct</span> <a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> *eth_conf, uint32_t num_pools)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_eth_vmdq_rx_conf conf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    conf.nb_queue_pools = (<span class="keyword">enum</span> <a name="a9"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0d">rte_eth_nb_pools</a>)num_pools;</div>
<div class="line">    conf.nb_pool_maps = num_pools;</div>
<div class="line">    conf.enable_default_pool = 0;</div>
<div class="line">    conf.default_pool = 0; <span class="comment">/* set explicit value, even if not used */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; conf.nb_pool_maps; i++) {</div>
<div class="line">        conf.pool_map[i].vlan_id = vlan_tags[i];</div>
<div class="line">        conf.pool_map[i].pools = (1UL &lt;&lt; (i % num_pools));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    (void)(<a name="a10"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(eth_conf, &amp;vmdq_conf_default, <span class="keyword">sizeof</span>(*eth_conf)));</div>
<div class="line">    (void)(<a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;eth_conf-&gt;<a name="a11"></a><a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a name="a12"></a><a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>, &amp;conf,</div>
<div class="line">           <span class="keyword">sizeof</span>(eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>)));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialises a given port using global settings and with the rx buffers</span></div>
<div class="line"><span class="comment"> * coming from the mbuf_pool passed as parameter</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">port_init(uint8_t <a name="_a13"></a><a class="code" href="structport.html">port</a>, <span class="keyword">struct</span> <a name="_a14"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a15"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a16"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> *rxconf;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf;</div>
<div class="line">    uint16_t rxRings, txRings;</div>
<div class="line">    <span class="keyword">const</span> uint16_t rxRingSize = RTE_TEST_RX_DESC_DEFAULT, txRingSize = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line">    uint16_t queues_per_pool;</div>
<div class="line">    uint32_t max_nb_pools;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * The max pool number from dev_info will be used to validate the pool</span></div>
<div class="line"><span class="comment">     * number specified in cmd line</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a name="a17"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line">    max_nb_pools = (uint32_t)dev_info.max_vmdq_pools;</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * We allow to process part of VMDQ pools specified by num_pools in</span></div>
<div class="line"><span class="comment">     * command line.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    if (num_pools &gt; max_nb_pools) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;num_pools %d &gt;max_nb_pools %d\n&quot;</span>,</div>
<div class="line">            num_pools, max_nb_pools);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    retval = get_eth_conf(&amp;port_conf, max_nb_pools);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * NIC queues are divided into pf queues and vmdq queues.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="comment">/* There is assumption here all ports have the same configuration! */</span></div>
<div class="line">    num_pf_queues = dev_info.max_rx_queues - dev_info.vmdq_queue_num;</div>
<div class="line">    queues_per_pool = dev_info.vmdq_queue_num / dev_info.max_vmdq_pools;</div>
<div class="line">    num_vmdq_queues = num_pools * queues_per_pool;</div>
<div class="line">    num_queues = num_pf_queues + num_vmdq_queues;</div>
<div class="line">    vmdq_queue_base = dev_info.vmdq_queue_base;</div>
<div class="line">    vmdq_pool_base  = dev_info.vmdq_pool_base;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;pf queue num: %u, configured vmdq pool num: %u,&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot; each vmdq pool has %u queues\n&quot;</span>,</div>
<div class="line">        num_pf_queues, num_pools, queues_per_pool);</div>
<div class="line">    printf(<span class="stringliteral">&quot;vmdq queue base: %d pool base %d\n&quot;</span>,</div>
<div class="line">        vmdq_queue_base, vmdq_pool_base);</div>
<div class="line">    <span class="keywordflow">if</span> (port &gt;= <a name="a18"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>())</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Though in this example, we only receive packets from the first queue</span></div>
<div class="line"><span class="comment">     * of each pool and send packets through first rte_lcore_count() tx</span></div>
<div class="line"><span class="comment">     * queues of vmdq queues, all queues including pf queues are setup.</span></div>
<div class="line"><span class="comment">     * This is because VMDQ queues doesn&#39;t always start from zero, and the</span></div>
<div class="line"><span class="comment">     * PMD layer doesn&#39;t support selectively initialising part of rx/tx</span></div>
<div class="line"><span class="comment">     * queues.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    rxRings = (uint16_t)dev_info.max_rx_queues;</div>
<div class="line">    txRings = (uint16_t)dev_info.max_tx_queues;</div>
<div class="line">    retval = <a name="a19"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, rxRings, txRings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line">    rxconf = &amp;dev_info.default_rxconf;</div>
<div class="line">    rxconf-&gt;<a name="a20"></a><a class="code" href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rx_drop_en</a> = 1;</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rxRings; q++) {</div>
<div class="line">        retval = <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, q, rxRingSize,</div>
<div class="line">                    rte_eth_dev_socket_id(port),</div>
<div class="line">                    rxconf,</div>
<div class="line">                    mbuf_pool);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;initialise rx queue %d failed\n&quot;</span>, q);</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; txRings; q++) {</div>
<div class="line">        retval = <a name="a22"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, q, txRingSize,</div>
<div class="line">                    rte_eth_dev_socket_id(port),</div>
<div class="line">                    NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;initialise tx queue %d failed\n&quot;</span>, q);</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    retval  = <a name="a23"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;port %d start failed\n&quot;</span>, port);</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a24"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(port, &amp;vmdq_ports_eth_addr[port]);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Port %u MAC: %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8</div>
<div class="line">            <span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)port,</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[0],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[1],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[2],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[3],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[4],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[5]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Set mac for each pool.</span></div>
<div class="line"><span class="comment">     * There is no default mac for the pools in i40.</span></div>
<div class="line"><span class="comment">     * Removes this after i40e fixes this issue.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; num_pools; q++) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structether__addr.html">ether_addr</a> mac;</div>
<div class="line">        mac = pool_addr_template;</div>
<div class="line">        mac.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[4] = port;</div>
<div class="line">        mac.addr_bytes[5] = q;</div>
<div class="line">        printf(<span class="stringliteral">&quot;Port %u vmdq pool %u set mac %02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</div>
<div class="line">            port, q,</div>
<div class="line">            mac.addr_bytes[0], mac.addr_bytes[1],</div>
<div class="line">            mac.addr_bytes[2], mac.addr_bytes[3],</div>
<div class="line">            mac.addr_bytes[4], mac.addr_bytes[5]);</div>
<div class="line">        retval = <a name="a25"></a><a class="code" href="rte__ethdev_8h.html#aa2b81750086f5f9e55cf65e5cf9f2c58">rte_eth_dev_mac_addr_add</a>(port, &amp;mac,</div>
<div class="line">                q + vmdq_pool_base);</div>
<div class="line">        <span class="keywordflow">if</span> (retval) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;mac addr add failed at pool %d\n&quot;</span>, q);</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check num_pools parameter and set it if OK*/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">vmdq_parse_num_pools(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> n;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse number string */</span></div>
<div class="line">    n = strtol(q_arg, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((q_arg[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_pools &gt; num_vlans) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;num_pools %d &gt; num_vlans %d\n&quot;</span>, num_pools, num_vlans);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    num_pools = n;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Display usage */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vmdq_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK]\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;  --nb-pools NP: number of pools\n&quot;</span>,</div>
<div class="line">           prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*  Parse the argument (num_pools) given in the command line of the application */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">vmdq_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;nb-pools&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, 0, 0}</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:&quot;</span>, long_option,</div>
<div class="line">        &amp;option_index)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;invalid portmask\n&quot;</span>);</div>
<div class="line">                vmdq_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="keywordflow">if</span> (vmdq_parse_num_pools(optarg) == -1) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;invalid number of pools\n&quot;</span>);</div>
<div class="line">                vmdq_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            vmdq_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enabled_port_mask &amp; (1 &lt;&lt; i))</div>
<div class="line">            ports[num_ports++] = (uint8_t)i;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_ports &lt; 2 || num_ports % 2) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but it should be even and at least 2\n&quot;</span>, num_ports);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">update_mac_address(<span class="keyword">struct</span> <a name="_a26"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, <span class="keywordtype">unsigned</span> dst_port)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a27"></a><a class="code" href="structether__hdr.html">ether_hdr</a> *eth;</div>
<div class="line">    <span class="keywordtype">void</span> *tmp;</div>
<div class="line"></div>
<div class="line">    eth = <a name="a28"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* 02:00:00:00:00:xx */</span></div>
<div class="line">    tmp = &amp;eth-&gt;<a name="a29"></a><a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[0];</div>
<div class="line">    *((uint64_t *)tmp) = 0x000000000002 + ((uint64_t)dst_port &lt;&lt; 40);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* src addr */</span></div>
<div class="line">    <a name="a30"></a><a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;vmdq_ports_eth_addr[dst_port], &amp;eth-&gt;<a name="a31"></a><a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* When we receive a HUP signal, print out our stats */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sighup_handler(<span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> q;</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; num_queues; q++) {</div>
<div class="line">        <span class="keywordflow">if</span> (q % (num_queues/num_pools) == 0)</div>
<div class="line">            printf(<span class="stringliteral">&quot;\nPool %u: &quot;</span>, q/(num_queues/num_pools));</div>
<div class="line">        printf(<span class="stringliteral">&quot;%lu &quot;</span>, rxPackets[q]);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;\nFinished handling signal %d\n&quot;</span>, signum);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main thread that does the work, reading from INPUT_PORT</span></div>
<div class="line"><span class="comment"> * and writing to OUTPUT_PORT</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">lcore_main(__attribute__((__unused__)) <span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = (uint16_t)<a name="a32"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t num_cores = (uint16_t)<a name="a33"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    uint16_t core_id = 0;</div>
<div class="line">    uint16_t startQueue, endQueue;</div>
<div class="line">    uint16_t q, i, p;</div>
<div class="line">    <span class="keyword">const</span> uint16_t remainder = (uint16_t)(num_vmdq_queues % num_cores);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_cores; i++)</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ids[i] == lcore_id) {</div>
<div class="line">            core_id = i;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (remainder != 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (core_id &lt; remainder) {</div>
<div class="line">            startQueue = (uint16_t)(core_id *</div>
<div class="line">                    (num_vmdq_queues / num_cores + 1));</div>
<div class="line">            endQueue = (uint16_t)(startQueue +</div>
<div class="line">                    (num_vmdq_queues / num_cores) + 1);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            startQueue = (uint16_t)(core_id *</div>
<div class="line">                    (num_vmdq_queues / num_cores) +</div>
<div class="line">                    remainder);</div>
<div class="line">            endQueue = (uint16_t)(startQueue +</div>
<div class="line">                    (num_vmdq_queues / num_cores));</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        startQueue = (uint16_t)(core_id *</div>
<div class="line">                (num_vmdq_queues / num_cores));</div>
<div class="line">        endQueue = (uint16_t)(startQueue +</div>
<div class="line">                (num_vmdq_queues / num_cores));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* vmdq queue idx doesn&#39;t always start from zero.*/</span></div>
<div class="line">    startQueue += vmdq_queue_base;</div>
<div class="line">    endQueue   += vmdq_queue_base;</div>
<div class="line">    printf(<span class="stringliteral">&quot;core %u(lcore %u) reading queues %i-%i\n&quot;</span>, (<span class="keywordtype">unsigned</span>)core_id,</div>
<div class="line">        (<span class="keywordtype">unsigned</span>)lcore_id, startQueue, endQueue - 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (startQueue == endQueue) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;lcore %u has nothing to do\n&quot;</span>, lcore_id);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf[MAX_PKT_BURST];</div>
<div class="line">        <span class="keyword">const</span> uint16_t buf_size = <span class="keyword">sizeof</span>(buf) / <span class="keyword">sizeof</span>(buf[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (p = 0; p &lt; num_ports; p++) {</div>
<div class="line">            <span class="keyword">const</span> uint8_t sport = ports[p];</div>
<div class="line">            <span class="comment">/* 0 &lt;-&gt; 1, 2 &lt;-&gt; 3 etc */</span></div>
<div class="line">            <span class="keyword">const</span> uint8_t dport = ports[p ^ 1];</div>
<div class="line">            <span class="keywordflow">if</span> ((sport == INVALID_PORT_ID) || (dport == INVALID_PORT_ID))</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (q = startQueue; q &lt; endQueue; q++) {</div>
<div class="line">                <span class="keyword">const</span> uint16_t rxCount = <a name="a34"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(sport,</div>
<div class="line">                    q, buf, buf_size);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (<a name="a35"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rxCount == 0))</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">                rxPackets[q] += rxCount;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; rxCount; i++)</div>
<div class="line">                    update_mac_address(buf[i], dport);</div>
<div class="line"></div>
<div class="line">                <span class="keyword">const</span> uint16_t txCount = <a name="a36"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(dport,</div>
<div class="line">                    vmdq_queue_base + core_id,</div>
<div class="line">                    buf,</div>
<div class="line">                    rxCount);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (txCount != rxCount) {</div>
<div class="line">                    <span class="keywordflow">for</span> (i = txCount; i &lt; rxCount; i++)</div>
<div class="line">                        <a name="a37"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(buf[i]);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update the global var NUM_PORTS and array PORTS according to system ports number</span></div>
<div class="line"><span class="comment"> * and return valid ports number</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> check_ports_num(<span class="keywordtype">unsigned</span> nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> valid_num_ports = num_ports;</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_ports &gt; nb_ports) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nSpecified port number(%u) exceeds total system port number(%u)\n&quot;</span>,</div>
<div class="line">            num_ports, nb_ports);</div>
<div class="line">        num_ports = nb_ports;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; num_ports; portid++) {</div>
<div class="line">        <span class="keywordflow">if</span> (ports[portid] &gt;= nb_ports) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;\nSpecified port ID(%u) exceeds max system port ID(%u)\n&quot;</span>,</div>
<div class="line">                ports[portid], (nb_ports - 1));</div>
<div class="line">            ports[portid] = INVALID_PORT_ID;</div>
<div class="line">            valid_num_ports--;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> valid_num_ports;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Main function, does initialisation and calls the per-lcore functions */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id, core_id = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports, valid_num_ports;</div>
<div class="line">    uint8_t portid;</div>
<div class="line"></div>
<div class="line">    signal(SIGHUP, sighup_handler);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a38"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a39"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse app arguments */</span></div>
<div class="line">    ret = vmdq_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid VMDQ argument\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++)</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a40"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            lcore_ids[core_id++] = lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>() &gt; RTE_MAX_LCORE)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Not enough cores\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    nb_ports = <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        nb_ports = RTE_MAX_ETHPORTS;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Update the global var NUM_PORTS and global array PORTS</span></div>
<div class="line"><span class="comment">     * and get value of var VALID_NUM_PORTS according to system ports number</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    valid_num_ports = check_ports_num(nb_ports);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (valid_num_ports &lt; 2 || valid_num_ports % 2) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Current valid ports number is %u\n&quot;</span>, valid_num_ports);</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with valid ports number is not even or less than 2\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mbuf_pool = <a name="a41"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;MBUF_POOL&quot;</span>,</div>
<div class="line">        NUM_MBUFS_PER_PORT * nb_ports, MBUF_CACHE_SIZE,</div>
<div class="line">        0, RTE_MBUF_DEFAULT_BUF_SIZE, <a name="a42"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;\nSkipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (port_init(portid, mbuf_pool) != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot initialize network ports\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* call lcore_main() on every lcore */</span></div>
<div class="line">    <a name="a43"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(lcore_main, NULL, <a name="a44"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2ada39ec34f33f669f99bd28ab7c58a952ac">CALL_MASTER</a>);</div>
<div class="line">    <a name="a45"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a46"></a><a class="code" href="rte__launch_8h.html#a1282dc7cd7e6793afab3ef29239ddf54">rte_eal_wait_lcore</a>(lcore_id) &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
