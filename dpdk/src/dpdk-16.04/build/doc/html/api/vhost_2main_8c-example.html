<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vhost/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vhost/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_ether.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_vlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/eventfd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__virtio__net_8h.html">rte_virtio_net.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef MAX_QUEUES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_QUEUES 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* the maximum number of external ports supported */</span></div>
<div class="line"><span class="preprocessor">#define MAX_SUP_PORTS 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Calculate the number of buffers needed per port</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define NUM_MBUFS_PER_PORT ((MAX_QUEUES*RTE_TEST_RX_DESC_DEFAULT) +     \</span></div>
<div class="line"><span class="preprocessor">                            (num_switching_cores*MAX_PKT_BURST) +           \</span></div>
<div class="line"><span class="preprocessor">                            (num_switching_cores*RTE_TEST_TX_DESC_DEFAULT) +\</span></div>
<div class="line"><span class="preprocessor">                            ((num_switching_cores+1)*MBUF_CACHE_SIZE))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBUF_CACHE_SIZE 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_DATA_SIZE  RTE_MBUF_DEFAULT_BUF_SIZE</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * No frame data buffer allocated from host are required for zero copy</span></div>
<div class="line"><span class="comment"> * implementation, guest will allocate the frame data buffer, and vhost</span></div>
<div class="line"><span class="comment"> * directly use it.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define VIRTIO_DESCRIPTOR_LEN_ZCP   RTE_MBUF_DEFAULT_DATAROOM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_DATA_SIZE_ZCP      RTE_MBUF_DEFAULT_BUF_SIZE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_CACHE_SIZE_ZCP 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_PKT_BURST 32        </span><span class="comment">/* Max burst size for RX/TX */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_TX_DRAIN_US 100   </span><span class="comment">/* TX drain every ~100us */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BURST_RX_WAIT_US 15 </span><span class="comment">/* Defines how long we wait between retries on RX */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_RX_RETRIES 4      </span><span class="comment">/* Number of retries on RX. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define JUMBO_FRAME_MAX_SIZE    0x2600</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* State of virtio device. */</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_MAC_LEARNING 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_RX           1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_SAFE_REMOVE  2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Config_core_flag status definitions. */</span></div>
<div class="line"><span class="preprocessor">#define REQUEST_DEV_REMOVAL 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ACK_DEV_REMOVAL 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Configurable number of RX/TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Need refine these 2 macros for legacy and DPDK based front end:</span></div>
<div class="line"><span class="comment"> * Max vring avail descriptor/entries from guest - MAX_PKT_BURST</span></div>
<div class="line"><span class="comment"> * And then adjust power 2.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * For legacy front end, 128 descriptors,</span></div>
<div class="line"><span class="comment"> * half for virtio header, another half for mbuf.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT_ZCP 32   </span><span class="comment">/* legacy: 32, DPDK virt FE: 128. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT_ZCP 64   </span><span class="comment">/* legacy: 64, DPDK virt FE: 64.  */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Get first 4 bytes in mbuf headroom. */</span></div>
<div class="line"><span class="preprocessor">#define MBUF_HEADROOM_UINT32(mbuf) (*(uint32_t *)((uint8_t *)(mbuf) \</span></div>
<div class="line"><span class="preprocessor">        + sizeof(struct rte_mbuf)))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* true if x is a power of 2 */</span></div>
<div class="line"><span class="preprocessor">#define POWEROF2(x) ((((x)-1) &amp; (x)) == 0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define INVALID_PORT_ID 0xFF</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Max number of devices. Limited by vmdq. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_DEVICES 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Size of buffers used for snprintfs. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PRINT_BUFF 6072</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Maximum character device basename size. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_BASENAME_SZ 10</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Maximum long option length for option parsing. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_LONG_OPT_SZ 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Used to compare MAC addresses. */</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_CMP 0xFFFFFFFFFFFFULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of descriptors per cacheline. */</span></div>
<div class="line"><span class="preprocessor">#define DESC_PER_CACHELINE (RTE_CACHE_LINE_SIZE / sizeof(struct vring_desc))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBUF_EXT_MEM(mb)   (rte_mbuf_from_indirect(mb) != (mb))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Promiscuous mode */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t promiscuous;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*Number of switching cores enabled*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_switching_cores = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* number of devices/queues to support*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_queues = 0;</div>
<div class="line"><span class="keyword">static</span> uint32_t num_devices;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Enable zero copy, pkts buffer will directly dma to hw descriptor,</span></div>
<div class="line"><span class="comment"> * disabled on default.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t zero_copy;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> mergeable;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Do vlan strip on host, enabled on default */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t vlan_strip = 1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* number of descriptors to apply*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_rx_descriptor = RTE_TEST_RX_DESC_DEFAULT_ZCP;</div>
<div class="line"><span class="keyword">static</span> uint32_t num_tx_descriptor = RTE_TEST_TX_DESC_DEFAULT_ZCP;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* max ring descriptor, ixgbe, i40e, e1000 all are 4096. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_RING_DESC 4096</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>vpool {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *pool;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__ring.html">rte_ring</a> *ring;</div>
<div class="line">    uint32_t buf_size;</div>
<div class="line">} vpool_array[MAX_QUEUES+MAX_QUEUES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable VM2VM communications. If this is disabled then the MAC address compare is skipped. */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    VM2VM_DISABLED = 0,</div>
<div class="line">    VM2VM_SOFTWARE = 1,</div>
<div class="line">    VM2VM_HARDWARE = 2,</div>
<div class="line">    VM2VM_LAST</div>
<div class="line">} vm2vm_type;</div>
<div class="line"><span class="keyword">static</span> vm2vm_type vm2vm_mode = VM2VM_SOFTWARE;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* The type of host physical address translated from guest physical address. */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    PHYS_ADDR_CONTINUOUS = 0,</div>
<div class="line">    PHYS_ADDR_CROSS_SUBREG = 1,</div>
<div class="line">    PHYS_ADDR_INVALID = 2,</div>
<div class="line">    PHYS_ADDR_LAST</div>
<div class="line">} hpa_type;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable stats. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_stats = 0;</div>
<div class="line"><span class="comment">/* Enable retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_retry = 1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Disable TX checksum offload */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_tx_csum;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Disable TSO offload */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_tso;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Specify timeout (in useconds) between retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_delay_time = BURST_RX_WAIT_US;</div>
<div class="line"><span class="comment">/* Specify the number of retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_retry_num = BURST_RX_RETRIES;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Character device basename. Can be set by user. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> dev_basename[MAX_BASENAME_SZ] = <span class="stringliteral">&quot;vhost-net&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* empty vmdq configuration structure. Filled in programatically */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> vmdq_conf_default = {</div>
<div class="line">    .<a name="a3"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a4"></a><a class="code" href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">mq_mode</a>        = <a name="a5"></a><a class="code" href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c">ETH_MQ_RX_VMDQ_ONLY</a>,</div>
<div class="line">        .split_hdr_size = 0,</div>
<div class="line">        .header_split   = 0, </div>
<div class="line">        .hw_ip_checksum = 0, </div>
<div class="line">        .hw_vlan_filter = 0, </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * It is necessary for 1G NIC such as I350,</span></div>
<div class="line"><span class="comment">         * this fixes bug of ipv4 forwarding in guest can&#39;t</span></div>
<div class="line"><span class="comment">         * forward pakets from one virtio dev to another virtio dev.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .hw_vlan_strip  = 1, </div>
<div class="line">        .jumbo_frame    = 0, </div>
<div class="line">        .hw_strip_crc   = 0, </div>
<div class="line">    },</div>
<div class="line"></div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a6"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">    .rx_adv_conf = {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * should be overridden separately in code with</span></div>
<div class="line"><span class="comment">         * appropriate values</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .vmdq_rx_conf = {</div>
<div class="line">            .nb_queue_pools = <a name="a7"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae">ETH_8_POOLS</a>,</div>
<div class="line">            .enable_default_pool = 0,</div>
<div class="line">            .default_pool = 0,</div>
<div class="line">            .nb_pool_maps = 0,</div>
<div class="line">            .pool_map = {{0, 0},},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> lcore_ids[RTE_MAX_LCORE];</div>
<div class="line"><span class="keyword">static</span> uint8_t ports[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> num_ports = 0; </div>
<div class="line"><span class="keyword">static</span> uint16_t num_pf_queues, num_vmdq_queues;</div>
<div class="line"><span class="keyword">static</span> uint16_t vmdq_pool_base, vmdq_queue_base;</div>
<div class="line"><span class="keyword">static</span> uint16_t queues_per_pool;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint16_t external_pkt_default_vlan_tag = 2000;</div>
<div class="line"><span class="keyword">const</span> uint16_t vlan_tags[] = {</div>
<div class="line">    1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007,</div>
<div class="line">    1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015,</div>
<div class="line">    1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023,</div>
<div class="line">    1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031,</div>
<div class="line">    1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039,</div>
<div class="line">    1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047,</div>
<div class="line">    1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055,</div>
<div class="line">    1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structether__addr.html">ether_addr</a> vmdq_ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* heads for the main used and free linked lists for the data path. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_used = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_free = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Array of data core structures containing information on individual core linked lists. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>lcore_info lcore_info[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Used for queueing bursts of TX packets. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table {</div>
<div class="line">    <span class="keywordtype">unsigned</span> len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> txq_id;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a9"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_table[MAX_PKT_BURST];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* TX queue for each data core. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table lcore_tx_queue[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* TX queue fori each virtio device for zero copy. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table tx_queue_zcp[MAX_QUEUES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Vlan header struct used to insert vlan tags on TX. */</span></div>
<div class="line"><span class="keyword">struct </span>vlan_ethhdr {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   h_dest[ETH_ALEN];</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   h_source[ETH_ALEN];</div>
<div class="line">    __be16          h_vlan_proto;</div>
<div class="line">    __be16          h_vlan_TCI;</div>
<div class="line">    __be16          h_vlan_encapsulated_proto;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Header lengths. */</span></div>
<div class="line"><span class="preprocessor">#define VLAN_HLEN       4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define VLAN_ETH_HLEN   18</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Per-device statistics struct */</span></div>
<div class="line"><span class="keyword">struct </span>device_statistics {</div>
<div class="line">    uint64_t tx_total;</div>
<div class="line">    <a name="_a10"></a><a class="code" href="structrte__atomic64__t.html">rte_atomic64_t</a> rx_total_atomic;</div>
<div class="line">    uint64_t rx_total;</div>
<div class="line">    uint64_t tx;</div>
<div class="line">    <a class="code" href="structrte__atomic64__t.html">rte_atomic64_t</a> rx_atomic;</div>
<div class="line">    uint64_t rx;</div>
<div class="line">} <a name="a11"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"><span class="keyword">struct </span>device_statistics dev_statistics[MAX_DEVICES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Builds up the correct configuration for VMDQ VLAN pool map</span></div>
<div class="line"><span class="comment"> * according to the pool &amp; queue limits.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">get_eth_conf(<span class="keyword">struct</span> <a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> *eth_conf, uint32_t num_devices)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_eth_vmdq_rx_conf conf;</div>
<div class="line">    <span class="keyword">struct </span>rte_eth_vmdq_rx_conf *def_conf =</div>
<div class="line">        &amp;vmdq_conf_default.<a name="a12"></a><a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a name="a13"></a><a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    memset(&amp;conf, 0, <span class="keyword">sizeof</span>(conf));</div>
<div class="line">    conf.nb_queue_pools = (<span class="keyword">enum</span> <a name="a14"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0d">rte_eth_nb_pools</a>)num_devices;</div>
<div class="line">    conf.nb_pool_maps = num_devices;</div>
<div class="line">    conf.enable_loop_back = def_conf-&gt;enable_loop_back;</div>
<div class="line">    conf.rx_mode = def_conf-&gt;rx_mode;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; conf.nb_pool_maps; i++) {</div>
<div class="line">        conf.pool_map[i].vlan_id = vlan_tags[ i ];</div>
<div class="line">        conf.pool_map[i].pools = (1UL &lt;&lt; i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    (void)(<a name="a15"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(eth_conf, &amp;vmdq_conf_default, <span class="keyword">sizeof</span>(*eth_conf)));</div>
<div class="line">    (void)(<a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>, &amp;conf,</div>
<div class="line">           <span class="keyword">sizeof</span>(eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>)));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Validate the device number according to the max pool number gotten form</span></div>
<div class="line"><span class="comment"> * dev_info. If the device number is invalid, give the error message and</span></div>
<div class="line"><span class="comment"> * return -1. Each device must have its own pool.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">validate_num_devices(uint32_t max_nb_devices)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (num_devices &gt; max_nb_devices) {</div>
<div class="line">        <a name="a16"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;invalid number of devices\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialises a given port using global settings and with the rx buffers</span></div>
<div class="line"><span class="comment"> * coming from the mbuf_pool passed as parameter</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">port_init(uint8_t <a name="_a17"></a><a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a18"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a19"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> *rxconf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a20"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> *txconf;</div>
<div class="line">    int16_t rx_rings, tx_rings;</div>
<div class="line">    uint16_t rx_ring_size, tx_ring_size;</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* The max pool number from dev_info will be used to validate the pool number specified in cmd line */</span></div>
<div class="line">    <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a> (port, &amp;dev_info);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (dev_info.max_rx_queues &gt; MAX_QUEUES) {</div>
<div class="line">        <a name="a22"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;please define MAX_QUEUES no less than %u in %s\n&quot;</span>,</div>
<div class="line">            dev_info.max_rx_queues, __FILE__);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    rxconf = &amp;dev_info.default_rxconf;</div>
<div class="line">    txconf = &amp;dev_info.default_txconf;</div>
<div class="line">    rxconf-&gt;<a name="a23"></a><a class="code" href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rx_drop_en</a> = 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable vlan offload */</span></div>
<div class="line">    txconf-&gt;<a name="a24"></a><a class="code" href="structrte__eth__txconf.html#a80d79f1953993347e9b0312a2096f86e">txq_flags</a> &amp;= ~<a name="a25"></a><a class="code" href="rte__ethdev_8h.html#ae8b377dce04cd001079a35f5b7746276">ETH_TXQ_FLAGS_NOVLANOFFL</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Zero copy defers queue RX/TX start to the time when guest</span></div>
<div class="line"><span class="comment">     * finishes its startup and packet buffers from that guest are</span></div>
<div class="line"><span class="comment">     * available.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy) {</div>
<div class="line">        rxconf-&gt;<a name="a26"></a><a class="code" href="structrte__eth__rxconf.html#a896d85e472c798525640a5f1f46d192d">rx_deferred_start</a> = 1;</div>
<div class="line">        rxconf-&gt;<a class="code" href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rx_drop_en</a> = 0;</div>
<div class="line">        txconf-&gt;<a name="a27"></a><a class="code" href="structrte__eth__txconf.html#a2c04854788bca64798ab9c8ff8540db6">tx_deferred_start</a> = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*configure the number of supported virtio devices based on VMDQ limits */</span></div>
<div class="line">    num_devices = dev_info.max_vmdq_pools;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy) {</div>
<div class="line">        rx_ring_size = num_rx_descriptor;</div>
<div class="line">        tx_ring_size = num_tx_descriptor;</div>
<div class="line">        tx_rings = dev_info.max_tx_queues;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        rx_ring_size = RTE_TEST_RX_DESC_DEFAULT;</div>
<div class="line">        tx_ring_size = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line">        tx_rings = (uint16_t)<a name="a28"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    retval = validate_num_devices(MAX_DEVICES);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get port configuration. */</span></div>
<div class="line">    retval = get_eth_conf(&amp;port_conf, num_devices);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    <span class="comment">/* NIC queues are divided into pf queues and vmdq queues.  */</span></div>
<div class="line">    num_pf_queues = dev_info.max_rx_queues - dev_info.vmdq_queue_num;</div>
<div class="line">    queues_per_pool = dev_info.vmdq_queue_num / dev_info.max_vmdq_pools;</div>
<div class="line">    num_vmdq_queues = num_devices * queues_per_pool;</div>
<div class="line">    num_queues = num_pf_queues + num_vmdq_queues;</div>
<div class="line">    vmdq_queue_base = dev_info.vmdq_queue_base;</div>
<div class="line">    vmdq_pool_base  = dev_info.vmdq_pool_base;</div>
<div class="line">    printf(<span class="stringliteral">&quot;pf queue num: %u, configured vmdq pool num: %u, each vmdq pool has %u queues\n&quot;</span>,</div>
<div class="line">        num_pf_queues, num_devices, queues_per_pool);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port &gt;= <a name="a29"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>()) <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (enable_tx_csum == 0)</div>
<div class="line">        <a name="a30"></a><a class="code" href="rte__virtio__net_8h.html#a3f23978b601f32fec3e70d36395f2856">rte_vhost_feature_disable</a>(1ULL &lt;&lt; VIRTIO_NET_F_CSUM);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (enable_tso == 0) {</div>
<div class="line">        <a class="code" href="rte__virtio__net_8h.html#a3f23978b601f32fec3e70d36395f2856">rte_vhost_feature_disable</a>(1ULL &lt;&lt; VIRTIO_NET_F_HOST_TSO4);</div>
<div class="line">        <a class="code" href="rte__virtio__net_8h.html#a3f23978b601f32fec3e70d36395f2856">rte_vhost_feature_disable</a>(1ULL &lt;&lt; VIRTIO_NET_F_HOST_TSO6);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    rx_rings = (uint16_t)dev_info.max_rx_queues;</div>
<div class="line">    <span class="comment">/* Configure ethernet device. */</span></div>
<div class="line">    retval = <a name="a31"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, rx_rings, tx_rings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup the queues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rx_rings; q ++) {</div>
<div class="line">        retval = <a name="a32"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, q, rx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port),</div>
<div class="line">                        rxconf,</div>
<div class="line">                        vpool_array[q].pool);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; tx_rings; q ++) {</div>
<div class="line">        retval = <a name="a33"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, q, tx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port),</div>
<div class="line">                        txconf);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the device. */</span></div>
<div class="line">    retval  = <a name="a34"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA, <span class="stringliteral">&quot;Failed to start the device.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (promiscuous)</div>
<div class="line">        <a name="a35"></a><a class="code" href="rte__ethdev_8h.html#aa8064b25aee324bdbbf779ea23d55f49">rte_eth_promiscuous_enable</a>(port);</div>
<div class="line"></div>
<div class="line">    <a name="a36"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(port, &amp;vmdq_ports_eth_addr[port]);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Max virtio devices supported: %u\n&quot;</span>, num_devices);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Port %u MAC: %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8</div>
<div class="line">            <span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)port,</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[0],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[1],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[2],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[3],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[4],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[5]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Set character device basename.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_basename(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* parse number string */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (strnlen(q_arg, MAX_BASENAME_SZ) &gt; MAX_BASENAME_SZ)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        snprintf((<span class="keywordtype">char</span>*)&amp;dev_basename, MAX_BASENAME_SZ, <span class="stringliteral">&quot;%s&quot;</span>, q_arg);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the portmask provided at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse num options at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_num_opt(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg, uint32_t max_valid_value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse unsigned int string */</span></div>
<div class="line">    num = strtoul(q_arg, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((q_arg[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num &gt; max_valid_value)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> num;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Display usage</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">us_vhost_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vm2vm [0|1|2]\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx_retry [0|1] --mergeable [0|1] --stats [0-N]\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --dev-basename &lt;name&gt;\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --nb-devices ND\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       -p PORTMASK: Set mask for ports to be used by application\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vm2vm [0|1|2]: disable/software(default)/hardware vm2vm comms\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry [0|1]: disable/enable(default) retries on rx. Enable retry if destintation queue is full\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-delay [0-N]: timeout(in usecond) between retries on RX. This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-num [0-N]: the number of retries on rx. This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --mergeable [0|1]: disable(default)/enable RX mergeable buffers\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vlan-strip [0|1]: disable/enable(default) RX VLAN strip on host\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --stats [0-N]: 0: Disable stats, N: Time in seconds to print stats\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --dev-basename: The basename to be used for the character device.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --zero-copy [0|1]: disable(default)/enable rx/tx &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;zero copy\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-desc-num [0-N]: the number of descriptors on rx, &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;used only when zero copy is enabled.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --tx-desc-num [0-N]: the number of descriptors on tx, &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;used only when zero copy is enabled.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --tx-csum [0|1] disable/enable TX checksum offload.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --tso [0|1] disable/enable TCP segment offload.\n&quot;</span>,</div>
<div class="line">           prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the arguments given in the command line of the application.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;vm2vm&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry-delay&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry-num&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;mergeable&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;vlan-strip&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;stats&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;dev-basename&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;zero-copy&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-desc-num&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;tx-desc-num&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;tx-csum&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;tso&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, 0, 0},</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:P&quot;</span>,</div>
<div class="line">            long_option, &amp;option_index)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* Portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid portmask\n&quot;</span>);</div>
<div class="line">                us_vhost_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:</div>
<div class="line">            promiscuous = 1;</div>
<div class="line">            vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>.rx_mode =</div>
<div class="line">                <a name="a37"></a><a class="code" href="rte__ethdev_8h.html#a5cb1059587ee40589f8d9da60107e740">ETH_VMDQ_ACCEPT_BROADCAST</a> |</div>
<div class="line">                <a name="a38"></a><a class="code" href="rte__ethdev_8h.html#ac0109eb1974972c4fc0f964bc4de3b1a">ETH_VMDQ_ACCEPT_MULTICAST</a>;</div>
<div class="line">            <a name="a39"></a><a class="code" href="rte__virtio__net_8h.html#a433ee3db28785abc8c02edcc04e6a76b">rte_vhost_feature_enable</a>(1ULL &lt;&lt; VIRTIO_NET_F_CTRL_RX);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="comment">/* Enable/disable vm2vm comms. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;vm2vm&quot;</span>,</div>
<div class="line">                MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, (VM2VM_LAST - 1));</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;vm2vm [0|1|2]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    vm2vm_mode = (vm2vm_type)ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable retries on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_retry = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable TX checksum offload. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;tx-csum&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for tx-csum [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_tx_csum = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable TSO offload. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;tso&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for tso [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_tso = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the retries delay time (in useconds) on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry-delay&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry-delay [0-N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    burst_rx_delay_time = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the retries number on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry-num&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry-num [0-N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    burst_rx_retry_num = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable RX mergeable buffers. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;mergeable&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for mergeable [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    mergeable = !!ret;</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a40"></a><a class="code" href="structrte__eth__rxmode.html#a11f6e2aa5e36df74b8c2e4f9e870ce71">jumbo_frame</a> = 1;</div>
<div class="line">                        vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a41"></a><a class="code" href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">max_rx_pkt_len</a></div>
<div class="line">                            = JUMBO_FRAME_MAX_SIZE;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable RX VLAN strip on host. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                <span class="stringliteral">&quot;vlan-strip&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for VLAN strip [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    vlan_strip = !!ret;</div>
<div class="line">                    vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a42"></a><a class="code" href="structrte__eth__rxmode.html#a8b23875815d9a88818c1cd043c817e6c">hw_vlan_strip</a> =</div>
<div class="line">                        vlan_strip;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable stats. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;stats&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for stats [0..N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_stats = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Set character device basename. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;dev-basename&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                <span class="keywordflow">if</span> (us_vhost_parse_basename(optarg) == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for character device basename (Max %d characters)\n&quot;</span>, MAX_BASENAME_SZ);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable rx/tx zero copy. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                <span class="stringliteral">&quot;zero-copy&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument&quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot; for zero-copy [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    zero_copy = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the descriptor number on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                <span class="stringliteral">&quot;rx-desc-num&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, MAX_RING_DESC);</div>
<div class="line">                <span class="keywordflow">if</span> ((ret == -1) || (!POWEROF2(ret))) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;Invalid argument for rx-desc-num[0-N],&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;power of 2 required.\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    num_rx_descriptor = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the descriptor number on TX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                <span class="stringliteral">&quot;tx-desc-num&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, MAX_RING_DESC);</div>
<div class="line">                <span class="keywordflow">if</span> ((ret == -1) || (!POWEROF2(ret))) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;Invalid argument for tx-desc-num [0-N],&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;power of 2 required.\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    num_tx_descriptor = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Invalid option - print options. */</span></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            us_vhost_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enabled_port_mask &amp; (1 &lt;&lt; i))</div>
<div class="line">            ports[num_ports++] = (uint8_t)i;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((num_ports ==  0) || (num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((zero_copy == 1) &amp;&amp; (vm2vm_mode == VM2VM_SOFTWARE)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">            <span class="stringliteral">&quot;Vhost zero copy doesn&#39;t support software vm2vm,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;please specify &#39;vm2vm 2&#39; to use hardware vm2vm.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((zero_copy == 1) &amp;&amp; (vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a class="code" href="structrte__eth__rxmode.html#a11f6e2aa5e36df74b8c2e4f9e870ce71">jumbo_frame</a> == 1)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">            <span class="stringliteral">&quot;Vhost zero copy doesn&#39;t support jumbo frame,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;please specify &#39;--mergeable 0&#39; to disable the &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;mergeable feature.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update the global var NUM_PORTS and array PORTS according to system ports number</span></div>
<div class="line"><span class="comment"> * and return valid ports number</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> check_ports_num(<span class="keywordtype">unsigned</span> nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> valid_num_ports = num_ports;</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_ports &gt; nb_ports) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port number(%u) exceeds total system port number(%u)\n&quot;</span>,</div>
<div class="line">            num_ports, nb_ports);</div>
<div class="line">        num_ports = nb_ports;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; num_ports; portid ++) {</div>
<div class="line">        <span class="keywordflow">if</span> (ports[portid] &gt;= nb_ports) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port ID(%u) exceeds max system port ID(%u)\n&quot;</span>,</div>
<div class="line">                ports[portid], (nb_ports - 1));</div>
<div class="line">            ports[portid] = INVALID_PORT_ID;</div>
<div class="line">            valid_num_ports--;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> valid_num_ports;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Macro to print out packet contents. Wrapped in debug define so that the</span></div>
<div class="line"><span class="comment"> * data path is not effected when debug is disabled.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PRINT_PACKET(device, addr, size, header) do {                                                               \</span></div>
<div class="line"><span class="preprocessor">    char *pkt_addr = (char*)(addr);                                                                                 \</span></div>
<div class="line"><span class="preprocessor">    unsigned int index;                                                                                             \</span></div>
<div class="line"><span class="preprocessor">    char packet[MAX_PRINT_BUFF];                                                                                    \</span></div>
<div class="line"><span class="preprocessor">                                                                                                                    \</span></div>
<div class="line"><span class="preprocessor">    if ((header))                                                                                                   \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet, MAX_PRINT_BUFF, &quot;(%&quot;PRIu64&quot;) Header size %d: &quot;, (device-&gt;device_fh), (size));              \</span></div>
<div class="line"><span class="preprocessor">    else                                                                                                            \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet, MAX_PRINT_BUFF, &quot;(%&quot;PRIu64&quot;) Packet size %d: &quot;, (device-&gt;device_fh), (size));              \</span></div>
<div class="line"><span class="preprocessor">    for (index = 0; index &lt; (size); index++) {                                                                      \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet + strnlen(packet, MAX_PRINT_BUFF), MAX_PRINT_BUFF - strnlen(packet, MAX_PRINT_BUFF),    \</span></div>
<div class="line"><span class="preprocessor">            &quot;%02hhx &quot;, pkt_addr[index]);                                                                            \</span></div>
<div class="line"><span class="preprocessor">    }                                                                                                               \</span></div>
<div class="line"><span class="preprocessor">    snprintf(packet + strnlen(packet, MAX_PRINT_BUFF), MAX_PRINT_BUFF - strnlen(packet, MAX_PRINT_BUFF), &quot;\n&quot;); \</span></div>
<div class="line"><span class="preprocessor">                                                                                                                    \</span></div>
<div class="line"><span class="preprocessor">    LOG_DEBUG(VHOST_DATA, &quot;%s&quot;, packet);                                                                                    \</span></div>
<div class="line"><span class="preprocessor">} while(0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PRINT_PACKET(device, addr, size, header) do{} while(0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function to convert guest physical addresses to vhost physical addresses.</span></div>
<div class="line"><span class="comment"> * This is used to convert virtio buffer addresses.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t __attribute__((always_inline))</div>
<div class="line">gpa_to_hpa(struct vhost_dev  *vdev, uint64_t guest_pa,</div>
<div class="line">    uint32_t buf_len, hpa_type *addr_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_memory_regions_hpa *region;</div>
<div class="line">    uint32_t regionidx;</div>
<div class="line">    uint64_t vhost_pa = 0;</div>
<div class="line"></div>
<div class="line">    *addr_type = PHYS_ADDR_INVALID;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (regionidx = 0; regionidx &lt; vdev-&gt;nregions_hpa; regionidx++) {</div>
<div class="line">        region = &amp;vdev-&gt;regions_hpa[regionidx];</div>
<div class="line">        <span class="keywordflow">if</span> ((guest_pa &gt;= region-&gt;guest_phys_address) &amp;&amp;</div>
<div class="line">            (guest_pa &lt;= region-&gt;guest_phys_address_end)) {</div>
<div class="line">            vhost_pa = region-&gt;host_phys_addr_offset + guest_pa;</div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a43"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>((guest_pa + buf_len - 1)</div>
<div class="line">                &lt;= region-&gt;guest_phys_address_end))</div>
<div class="line">                *addr_type = PHYS_ADDR_CONTINUOUS;</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                *addr_type = PHYS_ADDR_CROSS_SUBREG;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) GPA %p| HPA %p\n&quot;</span>,</div>
<div class="line">        vdev-&gt;dev-&gt;device_fh, (<span class="keywordtype">void</span> *)(uintptr_t)guest_pa,</div>
<div class="line">        (<span class="keywordtype">void</span> *)(uintptr_t)vhost_pa);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> vhost_pa;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Compares a packet destination MAC address to a device MAC address.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> __attribute__((always_inline))</div>
<div class="line">ether_addr_cmp(struct <a class="code" href="structether__addr.html">ether_addr</a> *ea, struct <a class="code" href="structether__addr.html">ether_addr</a> *eb)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> ((*(uint64_t *)ea ^ *(uint64_t *)eb) &amp; MAC_ADDR_CMP) == 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function learns the MAC address of the device and registers this along with a</span></div>
<div class="line"><span class="comment"> * vlan tag to a VMDQ.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">link_vmdq(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a44"></a><a class="code" href="structether__hdr.html">ether_hdr</a> *pkt_hdr;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a45"></a><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = vdev-&gt;dev;</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Learn MAC address of guest device from packet */</span></div>
<div class="line">    pkt_hdr = <a name="a46"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    dev_ll = ll_root_used;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ether_addr_cmp(&amp;(pkt_hdr-&gt;<a name="a47"></a><a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>), &amp;dev_ll-&gt;vdev-&gt;mac_address)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) WARNING: This device is using an existing MAC address and has not been registered.\n&quot;</span>, dev-&gt;<a name="a48"></a><a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        dev_ll = dev_ll-&gt;next;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a49"></a><a class="code" href="rte__ether_8h.html#abf4fcaacb1ad2010711b7c880ec2ed20">ETHER_ADDR_LEN</a>; i++)</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[i] = pkt_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a name="a50"></a><a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[i];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* vlan_tag currently uses the device_id. */</span></div>
<div class="line">    vdev-&gt;vlan_tag = vlan_tags[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Print out VMDQ registration info. */</span></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) MAC_ADDRESS %02x:%02x:%02x:%02x:%02x:%02x and VLAN_TAG %d registered\n&quot;</span>,</div>
<div class="line">        dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[0], vdev-&gt;mac_address.addr_bytes[1],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[2], vdev-&gt;mac_address.addr_bytes[3],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[4], vdev-&gt;mac_address.addr_bytes[5],</div>
<div class="line">        vdev-&gt;vlan_tag);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Register the MAC address. */</span></div>
<div class="line">    ret = <a name="a51"></a><a class="code" href="rte__ethdev_8h.html#aa2b81750086f5f9e55cf65e5cf9f2c58">rte_eth_dev_mac_addr_add</a>(ports[0], &amp;vdev-&gt;mac_address,</div>
<div class="line">                (uint32_t)dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a> + vmdq_pool_base);</div>
<div class="line">    <span class="keywordflow">if</span> (ret)</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to add device MAC address to VMDQ\n&quot;</span>,</div>
<div class="line">                    dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable stripping of the vlan tag as we handle routing. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (vlan_strip)</div>
<div class="line">        <a name="a52"></a><a class="code" href="rte__ethdev_8h.html#a15fd035ce805444a3df4738a5c53fa62">rte_eth_dev_set_vlan_strip_on_queue</a>(ports[0],</div>
<div class="line">            (uint16_t)vdev-&gt;vmdq_rx_q, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set device as ready for RX. */</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_RX;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Removes MAC address and vlan tag from VMDQ. Ensures that nothing is adding buffers to the RX</span></div>
<div class="line"><span class="comment"> * queue before disabling RX on the device.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">unlink_vmdq(<span class="keyword">struct</span> vhost_dev *vdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> rx_count;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vdev-&gt;ready == DEVICE_RX) {</div>
<div class="line">        <span class="comment">/*clear MAC and VLAN settings*/</span></div>
<div class="line">        <a name="a53"></a><a class="code" href="rte__ethdev_8h.html#ad6dce3e24e3443c64da7f5ace3ddf36b">rte_eth_dev_mac_addr_remove</a>(ports[0], &amp;vdev-&gt;mac_address);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)</div>
<div class="line">            vdev-&gt;mac_address.addr_bytes[i] = 0;</div>
<div class="line"></div>
<div class="line">        vdev-&gt;vlan_tag = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*Clear out the receive buffers*/</span></div>
<div class="line">        rx_count = <a name="a54"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)vdev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (rx_count) {</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++)</div>
<div class="line">                <a name="a55"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[i]);</div>
<div class="line"></div>
<div class="line">            rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)vdev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Check if the packet destination MAC address is for a local device. If so then put</span></div>
<div class="line"><span class="comment"> * the packet on that devices RX queue. If not then return.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_local(struct vhost_dev *vdev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *pkt_hdr;</div>
<div class="line">    uint64_t ret = 0;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = vdev-&gt;dev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *tdev; <span class="comment">/* destination virito device */</span></div>
<div class="line"></div>
<div class="line">    pkt_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*get the used devices list*/</span></div>
<div class="line">    dev_ll = ll_root_used;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> ((dev_ll-&gt;vdev-&gt;ready == DEVICE_RX) &amp;&amp; ether_addr_cmp(&amp;(pkt_hdr-&gt;<a name="a56"></a><a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a>),</div>
<div class="line">                          &amp;dev_ll-&gt;vdev-&gt;mac_address)) {</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Drop the packet if the TX packet is destined for the TX device. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (dev_ll-&gt;vdev-&gt;dev-&gt;device_fh == dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: Source and destination MAC addresses are the same. Dropping packet.\n&quot;</span>,</div>
<div class="line">                            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">            }</div>
<div class="line">            tdev = dev_ll-&gt;vdev-&gt;dev;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: MAC address is local\n&quot;</span>, tdev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a57"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(dev_ll-&gt;vdev-&gt;remove)) {</div>
<div class="line">                <span class="comment">/*drop the packet if the device is marked for removal*/</span></div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device is marked for removal\n&quot;</span>, tdev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">/*send the packet to the local virtio device*/</span></div>
<div class="line">                ret = <a name="a58"></a><a class="code" href="rte__virtio__net_8h.html#accee7f1bb7727ee9e39c452119d632b7">rte_vhost_enqueue_burst</a>(tdev, VIRTIO_RXQ, &amp;m, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                    <a name="a59"></a><a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                    &amp;dev_statistics[tdev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_total_atomic,</div>
<div class="line">                    1);</div>
<div class="line">                    <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                    &amp;dev_statistics[tdev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_atomic,</div>
<div class="line">                    ret);</div>
<div class="line">                    dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx_total++;</div>
<div class="line">                    dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx += ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">        dev_ll = dev_ll-&gt;next;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Check if the destination MAC of a packet is one local VM,</span></div>
<div class="line"><span class="comment"> * and get its vlan tag, and offset if it is.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> __attribute__((always_inline))</div>
<div class="line">find_local_dest(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m,</div>
<div class="line">    uint32_t *offset, uint16_t *vlan_tag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll = ll_root_used;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *pkt_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> ((dev_ll-&gt;vdev-&gt;ready == DEVICE_RX)</div>
<div class="line">            &amp;&amp; ether_addr_cmp(&amp;(pkt_hdr-&gt;<a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a>),</div>
<div class="line">        &amp;dev_ll-&gt;vdev-&gt;mac_address)) {</div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * Drop the packet if the TX packet is</span></div>
<div class="line"><span class="comment">             * destined for the TX device.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            <span class="keywordflow">if</span> (dev_ll-&gt;vdev-&gt;dev-&gt;device_fh == dev-&gt;device_fh) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: Source and destination&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; MAC addresses are the same. Dropping &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;packet.\n&quot;</span>,</div>
<div class="line">                dev_ll-&gt;vdev-&gt;dev-&gt;device_fh);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * HW vlan strip will reduce the packet length</span></div>
<div class="line"><span class="comment">             * by minus length of vlan tag, so need restore</span></div>
<div class="line"><span class="comment">             * the packet length by plus it.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            *offset = VLAN_HLEN;</div>
<div class="line">            *vlan_tag =</div>
<div class="line">            (uint16_t)</div>
<div class="line">            vlan_tags[(uint16_t)dev_ll-&gt;vdev-&gt;dev-&gt;device_fh];</div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: pkt to local VM device id:&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) vlan tag: %d.\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh, dev_ll-&gt;vdev-&gt;dev-&gt;device_fh,</div>
<div class="line">            (<span class="keywordtype">int</span>)*vlan_tag);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        dev_ll = dev_ll-&gt;next;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint16_t</div>
<div class="line">get_psd_sum(<span class="keywordtype">void</span> *l3_hdr, uint64_t ol_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ol_flags &amp; <a name="a60"></a><a class="code" href="rte__mbuf_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a>)</div>
<div class="line">        <span class="keywordflow">return</span> <a name="a61"></a><a class="code" href="rte__ip_8h.html#a75f64f54d6cddb4fa42af12dd1554db4">rte_ipv4_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">/* assume ethertype == ETHER_TYPE_IPv6 */</span></div>
<div class="line">        <span class="keywordflow">return</span> <a name="a62"></a><a class="code" href="rte__ip_8h.html#ace337b73683fd373943d46cf79caceb5">rte_ipv6_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> virtio_tx_offload(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *l3_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a63"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *<a class="code" href="structipv4__hdr.html">ipv4_hdr</a> = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a64"></a><a class="code" href="structtcp__hdr.html">tcp_hdr</a> *<a class="code" href="structtcp__hdr.html">tcp_hdr</a> = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    l3_hdr = (<span class="keywordtype">char</span> *)eth_hdr + m-&gt;<a name="a65"></a><a class="code" href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">l2_len</a>;</div>
<div class="line"></div>
<div class="line">    if (m-&gt;<a name="a66"></a><a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a class="code" href="rte__mbuf_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a>) {</div>
<div class="line">        ipv4_hdr = l3_hdr;</div>
<div class="line">        ipv4_hdr-&gt;<a name="a67"></a><a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a> = 0;</div>
<div class="line">        m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= <a name="a68"></a><a class="code" href="rte__mbuf_8h.html#a51280725dafdf282a80b2d964418798c">PKT_TX_IP_CKSUM</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tcp_hdr = (<span class="keyword">struct </span>tcp_hdr *)((<span class="keywordtype">char</span> *)l3_hdr + m-&gt;<a name="a69"></a><a class="code" href="structrte__mbuf.html#a82a34cb6d5935a8c0f043f2783d6b42d">l3_len</a>);</div>
<div class="line">    tcp_hdr-&gt;<a name="a70"></a><a class="code" href="structtcp__hdr.html#a749687f86afcc33e9d390500910ef60d">cksum</a> = get_psd_sum(l3_hdr, m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function routes the TX packet to the correct interface. This may be a local device</span></div>
<div class="line"><span class="comment"> * or the physical port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_route(struct vhost_dev *vdev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint16_t vlan_tag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **m_table;</div>
<div class="line">    <span class="keywordtype">unsigned</span> len, ret, offset = 0;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a name="a71"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = vdev-&gt;dev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *nh;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*check if destination is local VM*/</span></div>
<div class="line">    <span class="keywordflow">if</span> ((vm2vm_mode == VM2VM_SOFTWARE) &amp;&amp; (virtio_tx_local(vdev, m) == 0)) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vm2vm_mode == VM2VM_HARDWARE)) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(find_local_dest(dev, m, &amp;offset, &amp;vlan_tag) != 0)) {</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: MAC address is external\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Add packet to the port tx queue*/</span></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    len = tx_q-&gt;len;</div>
<div class="line"></div>
<div class="line">    nh = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(nh-&gt;<a name="a72"></a><a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a> == <a name="a73"></a><a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(<a name="a74"></a><a class="code" href="rte__ether_8h.html#aaaa516211cec2b61e3717c5fec36952f">ETHER_TYPE_VLAN</a>))) {</div>
<div class="line">        <span class="comment">/* Guest has inserted the vlan tag. */</span></div>
<div class="line">        <span class="keyword">struct </span><a name="_a75"></a><a class="code" href="structvlan__hdr.html">vlan_hdr</a> *vh = (<span class="keyword">struct </span><a class="code" href="structvlan__hdr.html">vlan_hdr</a> *) (nh + 1);</div>
<div class="line">        uint16_t vlan_tag_be = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(vlan_tag);</div>
<div class="line">        <span class="keywordflow">if</span> ((vm2vm_mode == VM2VM_HARDWARE) &amp;&amp;</div>
<div class="line">            (vh-&gt;<a name="a76"></a><a class="code" href="structvlan__hdr.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> != vlan_tag_be))</div>
<div class="line">            vh-&gt;<a class="code" href="structvlan__hdr.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> = vlan_tag_be;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        m-&gt;ol_flags |= <a name="a77"></a><a class="code" href="rte__mbuf_8h.html#aab0d1c6738680ac92bcf0f9a7ec16215">PKT_TX_VLAN_PKT</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Find the right seg to adjust the data len when offset is</span></div>
<div class="line"><span class="comment">         * bigger than tail room size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vm2vm_mode == VM2VM_HARDWARE)) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(offset &lt;= <a name="a78"></a><a class="code" href="rte__mbuf_8h.html#a257bc8af3e8fde7eb6603bdf4ae0528e">rte_pktmbuf_tailroom</a>(m)))</div>
<div class="line">                m-&gt;data_len += offset;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *seg = m;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">while</span> ((seg-&gt;<a name="a79"></a><a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a> != NULL) &amp;&amp;</div>
<div class="line">                    (offset &gt; <a class="code" href="rte__mbuf_8h.html#a257bc8af3e8fde7eb6603bdf4ae0528e">rte_pktmbuf_tailroom</a>(seg)))</div>
<div class="line">                    seg = seg-&gt;<a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a>;</div>
<div class="line"></div>
<div class="line">                seg-&gt;<a name="a80"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> += offset;</div>
<div class="line">            }</div>
<div class="line">            m-&gt;pkt_len += offset;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        m-&gt;vlan_tci = vlan_tag;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (m-&gt;ol_flags &amp; <a name="a81"></a><a class="code" href="rte__mbuf_8h.html#ad9d8db5f80d34e0a95c56df43d605c87">PKT_TX_TCP_SEG</a>)</div>
<div class="line">        virtio_tx_offload(m);</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;m_table[len] = m;</div>
<div class="line">    len++;</div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx_total++;</div>
<div class="line">        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line">        m_table = (<span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table;</div>
<div class="line">        ret = <a name="a82"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ports[0], (uint16_t)tx_q-&gt;txq_id, m_table, (uint16_t) len);</div>
<div class="line">        <span class="comment">/* Free any buffers not handled by TX and update the port stats. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; len)) {</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m_table[ret]);</div>
<div class="line">            } <span class="keywordflow">while</span> (++ret &lt; len);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        len = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;len = len;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function is called by each data core. It handles all RX/TX registered with the</span></div>
<div class="line"><span class="comment"> * core. For TX the specific lcore linked list is used. For RX, MAC addresses are compared</span></div>
<div class="line"><span class="comment"> * with all devices in the main linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">switch_worker(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool = arg;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = NULL;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keyword">struct </span>lcore_ll_info *lcore_ll;</div>
<div class="line">    <span class="keyword">const</span> uint64_t drain_tsc = (<a name="a83"></a><a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1) / US_PER_S * BURST_TX_DRAIN_US;</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc, ret_count = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> ret, i;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t num_cores = (uint16_t)<a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    uint16_t rx_count = 0;</div>
<div class="line">    uint16_t tx_count;</div>
<div class="line">    uint32_t retry = 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;Procesing on Core %u started\n&quot;</span>, lcore_id);</div>
<div class="line">    lcore_ll = lcore_info[lcore_id].lcore_ll;</div>
<div class="line">    prev_tsc = 0;</div>
<div class="line"></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_cores; i ++) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ids[i] == lcore_id) {</div>
<div class="line">            tx_q-&gt;txq_id = i;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * TX burst queue drain</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; drain_tsc)) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (tx_q-&gt;len) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;TX queue drained after timeout with burst size %u \n&quot;</span>, tx_q-&gt;len);</div>
<div class="line"></div>
<div class="line">                <span class="comment">/*Tx any packets in the queue*/</span></div>
<div class="line">                ret = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ports[0], (uint16_t)tx_q-&gt;txq_id,</div>
<div class="line">                                       (<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table,</div>
<div class="line">                                       (uint16_t)tx_q-&gt;len);</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; tx_q-&gt;len)) {</div>
<div class="line">                    <span class="keywordflow">do</span> {</div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(tx_q-&gt;m_table[ret]);</div>
<div class="line">                    } <span class="keywordflow">while</span> (++ret &lt; tx_q-&gt;len);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                tx_q-&gt;len = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a name="a84"></a><a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(lcore_ll-&gt;ll_root_used);</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Inform the configuration core that we have exited the linked list and that no devices are</span></div>
<div class="line"><span class="comment">         * in use if requested.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ll-&gt;dev_removal_flag == REQUEST_DEV_REMOVAL)</div>
<div class="line">            lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Process devices</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        dev_ll = lcore_ll-&gt;ll_root_used;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            <span class="comment">/*get virtio device ID*/</span></div>
<div class="line">            vdev = dev_ll-&gt;vdev;</div>
<div class="line">            dev = vdev-&gt;dev;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;remove)) {</div>
<div class="line">                dev_ll = dev_ll-&gt;next;</div>
<div class="line">                unlink_vmdq(vdev);</div>
<div class="line">                vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vdev-&gt;ready == DEVICE_RX)) {</div>
<div class="line">                <span class="comment">/*Handle guest RX*/</span></div>
<div class="line">                rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    vdev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (rx_count) {</div>
<div class="line">                    <span class="comment">/*</span></div>
<div class="line"><span class="comment">                    * Retry is enabled and the queue is full then we wait and retry to avoid packet loss</span></div>
<div class="line"><span class="comment">                    * Here MAX_PKT_BURST must be less than virtio queue size</span></div>
<div class="line"><span class="comment">                    */</span></div>
<div class="line">                    <span class="keywordflow">if</span> (enable_retry &amp;&amp; <a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rx_count &gt; rte_vring_available_entries(dev, VIRTIO_RXQ))) {</div>
<div class="line">                        <span class="keywordflow">for</span> (retry = 0; retry &lt; burst_rx_retry_num; retry++) {</div>
<div class="line">                            <a name="a85"></a><a class="code" href="rte__cycles_8h.html#a62a6204f524c4781cae7e9e4a0b01b7f">rte_delay_us</a>(burst_rx_delay_time);</div>
<div class="line">                            <span class="keywordflow">if</span> (rx_count &lt;= rte_vring_available_entries(dev, VIRTIO_RXQ))</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                    ret_count = <a class="code" href="rte__virtio__net_8h.html#accee7f1bb7727ee9e39c452119d632b7">rte_vhost_enqueue_burst</a>(dev, VIRTIO_RXQ, pkts_burst, rx_count);</div>
<div class="line">                    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                        &amp;dev_statistics[dev_ll-&gt;vdev-&gt;dev-&gt;device_fh].rx_total_atomic,</div>
<div class="line">                        rx_count);</div>
<div class="line">                        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                        &amp;dev_statistics[dev_ll-&gt;vdev-&gt;dev-&gt;device_fh].rx_atomic, ret_count);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count)) {</div>
<div class="line">                        rx_count--;</div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[rx_count]);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!vdev-&gt;remove)) {</div>
<div class="line">                <span class="comment">/* Handle guest TX*/</span></div>
<div class="line">                tx_count = <a name="a86"></a><a class="code" href="rte__virtio__net_8h.html#a74e4e31d76c01534a648b10b8b2a4851">rte_vhost_dequeue_burst</a>(dev, VIRTIO_TXQ, mbuf_pool, pkts_burst, MAX_PKT_BURST);</div>
<div class="line">                <span class="comment">/* If this is the first received packet we need to learn the MAC and setup VMDQ */</span></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;ready == DEVICE_MAC_LEARNING) &amp;&amp; tx_count) {</div>
<div class="line">                    <span class="keywordflow">if</span> (vdev-&gt;remove || (link_vmdq(vdev, pkts_burst[0]) == -1)) {</div>
<div class="line">                        <span class="keywordflow">while</span> (tx_count)</div>
<div class="line">                            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[--tx_count]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; tx_count; ++i) {</div>
<div class="line">                    virtio_tx_route(vdev, pkts_burst[i],</div>
<div class="line">                        vlan_tags[(uint16_t)dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>]);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*move to the next device in the list*/</span></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function gets available ring number for zero copy rx.</span></div>
<div class="line"><span class="comment"> * Only one thread will call this funciton for a paticular virtio device,</span></div>
<div class="line"><span class="comment"> * so, it is designed as non-thread-safe function.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t __attribute__((always_inline))</div>
<div class="line">get_available_ring_num_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a87"></a><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq = dev-&gt;virtqueue[VIRTIO_RXQ];</div>
<div class="line">    uint16_t avail_idx;</div>
<div class="line"></div>
<div class="line">    avail_idx = *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a name="a88"></a><a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line">    <span class="keywordflow">return</span> (uint32_t)(avail_idx - vq-&gt;<a name="a89"></a><a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function gets available ring index for zero copy rx,</span></div>
<div class="line"><span class="comment"> * it will retry &#39;burst_rx_retry_num&#39; times till it get enough ring index.</span></div>
<div class="line"><span class="comment"> * Only one thread will call this funciton for a paticular virtio device,</span></div>
<div class="line"><span class="comment"> * so, it is designed as non-thread-safe function.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t __attribute__((always_inline))</div>
<div class="line">get_available_ring_index_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev,</div>
<div class="line">    uint16_t *res_base_idx, uint32_t count)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq = dev-&gt;virtqueue[VIRTIO_RXQ];</div>
<div class="line">    uint16_t avail_idx;</div>
<div class="line">    uint32_t retry = 0;</div>
<div class="line">    uint16_t free_entries;</div>
<div class="line"></div>
<div class="line">    *res_base_idx = vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a>;</div>
<div class="line">    avail_idx = *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line">    free_entries = (avail_idx - *res_base_idx);</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in get_available_ring_index_zcp: &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;avail idx: %d, &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;res base idx:%d, free entries:%d\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh, avail_idx, *res_base_idx,</div>
<div class="line">            free_entries);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * If retry is enabled and the queue is full then we wait</span></div>
<div class="line"><span class="comment">     * and retry to avoid packet loss.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_retry &amp;&amp; <a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(count &gt; free_entries)) {</div>
<div class="line">        <span class="keywordflow">for</span> (retry = 0; retry &lt; burst_rx_retry_num; retry++) {</div>
<div class="line">            <a class="code" href="rte__cycles_8h.html#a62a6204f524c4781cae7e9e4a0b01b7f">rte_delay_us</a>(burst_rx_delay_time);</div>
<div class="line">            avail_idx = *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line">            free_entries = (avail_idx - *res_base_idx);</div>
<div class="line">            <span class="keywordflow">if</span> (count &lt;= free_entries)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*check that we have enough buffers*/</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(count &gt; free_entries))</div>
<div class="line">        count = free_entries;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(count == 0)) {</div>
<div class="line">        LOG_DEBUG(VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Fail in get_available_ring_index_zcp: &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;avail idx: %d, res base idx:%d, free entries:%d\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh, avail_idx,</div>
<div class="line">            *res_base_idx, free_entries);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a> = *res_base_idx + count;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function put descriptor back to used list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">put_desc_to_used_list_zcp(struct <a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq, uint16_t desc_idx)</div>
<div class="line">{</div>
<div class="line">    uint16_t res_cur_idx = vq-&gt;last_used_idx;</div>
<div class="line">    vq-&gt;used-&gt;ring[res_cur_idx &amp; (vq-&gt;size - 1)].<span class="keywordtype">id</span> = (uint32_t)desc_idx;</div>
<div class="line">    vq-&gt;used-&gt;ring[res_cur_idx &amp; (vq-&gt;size - 1)].len = 0;</div>
<div class="line">    <a name="a90"></a><a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line">    *(<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;used-&gt;idx += 1;</div>
<div class="line">    vq-&gt;last_used_idx += 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Kick the guest if necessary. */</span></div>
<div class="line">    if (!(vq-&gt;avail-&gt;flags &amp; VRING_AVAIL_F_NO_INTERRUPT))</div>
<div class="line">        eventfd_write(vq-&gt;callfd, (eventfd_t)1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function get available descriptor from vitio vring and un-attached mbuf</span></div>
<div class="line"><span class="comment"> * from vpool-&gt;ring, and then attach them together. It needs adjust the offset</span></div>
<div class="line"><span class="comment"> * for buff_addr and phys_addr accroding to PMD implementation, otherwise the</span></div>
<div class="line"><span class="comment"> * frame data may be put to wrong location in mbuf.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">attach_rxmbuf_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    uint16_t res_base_idx, desc_idx;</div>
<div class="line">    uint64_t buff_addr, phys_addr;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc;</div>
<div class="line">    <span class="keywordtype">void</span> *obj = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf;</div>
<div class="line">    <span class="keyword">struct </span>vpool *vpool;</div>
<div class="line">    hpa_type addr_type;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev = (<span class="keyword">struct </span>vhost_dev *)dev-&gt;priv;</div>
<div class="line"></div>
<div class="line">    vpool = &amp;vpool_array[vdev-&gt;vmdq_rx_q];</div>
<div class="line">    vq = dev-&gt;virtqueue[VIRTIO_RXQ];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        if (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(get_available_ring_index_zcp(vdev-&gt;dev, &amp;res_base_idx,</div>
<div class="line">                1) != 1))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        desc_idx = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[(res_base_idx) &amp; (vq-&gt;<a name="a91"></a><a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)];</div>
<div class="line"></div>
<div class="line">        desc = &amp;vq-&gt;<a name="a92"></a><a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc_idx];</div>
<div class="line">        <span class="keywordflow">if</span> (desc-&gt;flags &amp; VRING_DESC_F_NEXT) {</div>
<div class="line">            desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc-&gt;next];</div>
<div class="line">            buff_addr = <a name="a93"></a><a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">            phys_addr = gpa_to_hpa(vdev, desc-&gt;addr, desc-&gt;len,</div>
<div class="line">                    &amp;addr_type);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            buff_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev,</div>
<div class="line">                    desc-&gt;addr + vq-&gt;<a name="a94"></a><a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>);</div>
<div class="line">            phys_addr = gpa_to_hpa(vdev,</div>
<div class="line">                    desc-&gt;addr + vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>,</div>
<div class="line">                    desc-&gt;len, &amp;addr_type);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addr_type == PHYS_ADDR_INVALID)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Invalid frame buffer&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; address found when attaching RX frame buffer&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; address!\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line">            put_desc_to_used_list_zcp(vq, desc_idx);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Check if the frame buffer address from guest crosses</span></div>
<div class="line"><span class="comment">         * sub-region or not.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addr_type == PHYS_ADDR_CROSS_SUBREG)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Frame buffer address cross &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;sub-regioin found when attaching RX frame &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;buffer address!\n&quot;</span>,</div>
<div class="line">                dev-&gt;device_fh);</div>
<div class="line">            put_desc_to_used_list_zcp(vq, desc_idx);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(phys_addr == 0));</div>
<div class="line"></div>
<div class="line">    <a name="a95"></a><a class="code" href="rte__ring_8h.html#a242877d9dc94b252277d6336c31b53ae">rte_ring_sc_dequeue</a>(vpool-&gt;ring, &amp;obj);</div>
<div class="line">    mbuf = obj;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(mbuf == NULL)) {</div>
<div class="line">        LOG_DEBUG(VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in attach_rxmbuf_zcp: &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;ring_sc_dequeue fail.\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh);</div>
<div class="line">        put_desc_to_used_list_zcp(vq, desc_idx);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vpool-&gt;buf_size &gt; desc-&gt;len)) {</div>
<div class="line">        LOG_DEBUG(VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in attach_rxmbuf_zcp: frame buffer &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;length(%d) of descriptor idx: %d less than room &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;size required: %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh, desc-&gt;len, desc_idx, vpool-&gt;buf_size);</div>
<div class="line">        put_desc_to_used_list_zcp(vq, desc_idx);</div>
<div class="line">        <a name="a96"></a><a class="code" href="rte__ring_8h.html#a644b1d6866fed20f0a5711e63ecefc38">rte_ring_sp_enqueue</a>(vpool-&gt;ring, obj);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mbuf-&gt;<a name="a97"></a><a class="code" href="structrte__mbuf.html#a9db3d388a1381e68e509017a6e7d0f12">buf_addr</a> = (<span class="keywordtype">void</span> *)(uintptr_t)(buff_addr - RTE_PKTMBUF_HEADROOM);</div>
<div class="line">    mbuf-&gt;<a name="a98"></a>data_off = RTE_PKTMBUF_HEADROOM;</div>
<div class="line">    mbuf-&gt;<a name="a99"></a><a class="code" href="structrte__mbuf.html#a6f9e031fb601226363d0106789df32f7">buf_physaddr</a> = phys_addr - RTE_PKTMBUF_HEADROOM;</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = desc-&gt;len;</div>
<div class="line">    MBUF_HEADROOM_UINT32(mbuf) = (uint32_t)desc_idx;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in attach_rxmbuf_zcp: res base idx:%d, &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;descriptor idx:%d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, res_base_idx, desc_idx);</div>
<div class="line"></div>
<div class="line">    __rte_mbuf_raw_free(mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Detach an attched packet mbuf -</span></div>
<div class="line"><span class="comment"> *  - restore original mbuf address and length values.</span></div>
<div class="line"><span class="comment"> *  - reset pktmbuf data and data_len to their default values.</span></div>
<div class="line"><span class="comment"> *  All other fields of the given packet mbuf will be left intact.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * @param m</span></div>
<div class="line"><span class="comment"> *   The attached packet mbuf.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> pktmbuf_detach_zcp(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *<a name="a100"></a><a class="code" href="rte__cryptodev_8h.html#a9f6b27bed19dd1bf3cff6af57d7cf86f">mp</a> = m-&gt;<a name="a101"></a><a class="code" href="structrte__mbuf.html#aa501505ef15ed551bf0a2ffacfc29bb5">pool</a>;</div>
<div class="line">    <span class="keywordtype">void</span> *buf = <a name="a102"></a><a class="code" href="rte__mbuf_8h.html#a1cb4a6a2a711b320dd16652ca839feab">rte_mbuf_to_baddr</a>(m);</div>
<div class="line">    uint32_t buf_ofs;</div>
<div class="line">    uint32_t buf_len = mp-&gt;<a name="a103"></a><a class="code" href="structrte__mempool.html#ad61e210d2df01bf9c91230fee6a8cf21">elt_size</a> - <span class="keyword">sizeof</span>(*m);</div>
<div class="line">    m-&gt;<a class="code" href="structrte__mbuf.html#a6f9e031fb601226363d0106789df32f7">buf_physaddr</a> = <a name="a104"></a><a class="code" href="rte__mempool_8h.html#a8c8285cccb4078582d361b505891bd0a">rte_mempool_virt2phy</a>(mp, m) + <span class="keyword">sizeof</span>(*m);</div>
<div class="line"></div>
<div class="line">    m-&gt;<a class="code" href="structrte__mbuf.html#a9db3d388a1381e68e509017a6e7d0f12">buf_addr</a> = buf;</div>
<div class="line">    m-&gt;<a name="a105"></a><a class="code" href="structrte__mbuf.html#a7ae671bb1805f6f7313b9301aca17eb6">buf_len</a> = (uint16_t)buf_len;</div>
<div class="line"></div>
<div class="line">    buf_ofs = (RTE_PKTMBUF_HEADROOM &lt;= m-&gt;<a class="code" href="structrte__mbuf.html#a7ae671bb1805f6f7313b9301aca17eb6">buf_len</a>) ?</div>
<div class="line">            RTE_PKTMBUF_HEADROOM : m-&gt;<a class="code" href="structrte__mbuf.html#a7ae671bb1805f6f7313b9301aca17eb6">buf_len</a>;</div>
<div class="line">    m-&gt;data_off = buf_ofs;</div>
<div class="line"></div>
<div class="line">    m-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function is called after packets have been transimited. It fetchs mbuf</span></div>
<div class="line"><span class="comment"> * from vpool-&gt;pool, detached it and put into vpool-&gt;ring. It also update the</span></div>
<div class="line"><span class="comment"> * used index and kick the guest if necessary.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t __attribute__((always_inline))</div>
<div class="line">txmbuf_clean_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct vpool *vpool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq = dev-&gt;virtqueue[VIRTIO_TXQ];</div>
<div class="line">    uint32_t used_idx = vq-&gt;<a name="a106"></a><a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1);</div>
<div class="line">    uint32_t index = 0;</div>
<div class="line">    uint32_t mbuf_count = <a name="a107"></a><a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool-&gt;pool);</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: mbuf count in mempool before &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;clean is: %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, mbuf_count);</div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: mbuf count in  ring before &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;clean  is : %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, <a name="a108"></a><a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool-&gt;ring));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (index = 0; index &lt; mbuf_count; index++) {</div>
<div class="line">        mbuf = __rte_mbuf_raw_alloc(vpool-&gt;pool);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(MBUF_EXT_MEM(mbuf)))</div>
<div class="line">            pktmbuf_detach_zcp(mbuf);</div>
<div class="line">        <a class="code" href="rte__ring_8h.html#a644b1d6866fed20f0a5711e63ecefc38">rte_ring_sp_enqueue</a>(vpool-&gt;ring, mbuf);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update used index buffer information. */</span></div>
<div class="line">        vq-&gt;<a name="a109"></a><a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[used_idx].id = MBUF_HEADROOM_UINT32(mbuf);</div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[used_idx].len = 0;</div>
<div class="line"></div>
<div class="line">        used_idx = (used_idx + 1) &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: mbuf count in mempool after &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;clean is: %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool-&gt;pool));</div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: mbuf count in  ring after &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;clean  is : %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool-&gt;ring));</div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: before updated &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;vq-&gt;last_used_idx:%d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>);</div>
<div class="line"></div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> += mbuf_count;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in txmbuf_clean_zcp: after updated &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;vq-&gt;last_used_idx:%d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    *(<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx += mbuf_count;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Kick guest if required. */</span></div>
<div class="line">    if (!(vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;flags &amp; VRING_AVAIL_F_NO_INTERRUPT))</div>
<div class="line">        eventfd_write(vq-&gt;<a name="a110"></a><a class="code" href="structvhost__virtqueue.html#ae6e4ebc376f11dea075c9ae8a281ab51">callfd</a>, (eventfd_t)1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function is called when a virtio device is destroy.</span></div>
<div class="line"><span class="comment"> * It fetchs mbuf from vpool-&gt;pool, and detached it, and put into vpool-&gt;ring.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mbuf_destroy_zcp(<span class="keyword">struct</span> vpool *vpool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf = NULL;</div>
<div class="line">    uint32_t index, mbuf_count = <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool-&gt;pool);</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">        <span class="stringliteral">&quot;in mbuf_destroy_zcp: mbuf count in mempool before &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;mbuf_destroy_zcp is: %d\n&quot;</span>,</div>
<div class="line">        mbuf_count);</div>
<div class="line">    LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">        <span class="stringliteral">&quot;in mbuf_destroy_zcp: mbuf count in  ring before &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;mbuf_destroy_zcp  is : %d\n&quot;</span>,</div>
<div class="line">        <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool-&gt;ring));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (index = 0; index &lt; mbuf_count; index++) {</div>
<div class="line">        mbuf = __rte_mbuf_raw_alloc(vpool-&gt;pool);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(mbuf != NULL)) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(MBUF_EXT_MEM(mbuf)))</div>
<div class="line">                pktmbuf_detach_zcp(mbuf);</div>
<div class="line">            <a class="code" href="rte__ring_8h.html#a644b1d6866fed20f0a5711e63ecefc38">rte_ring_sp_enqueue</a>(vpool-&gt;ring, (<span class="keywordtype">void</span> *)mbuf);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">        <span class="stringliteral">&quot;in mbuf_destroy_zcp: mbuf count in mempool after &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;mbuf_destroy_zcp is: %d\n&quot;</span>,</div>
<div class="line">        <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool-&gt;pool));</div>
<div class="line">    LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">        <span class="stringliteral">&quot;in mbuf_destroy_zcp: mbuf count in ring after &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;mbuf_destroy_zcp is : %d\n&quot;</span>,</div>
<div class="line">        <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool-&gt;ring));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function update the use flag and counter.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t __attribute__((always_inline))</div>
<div class="line">virtio_dev_rx_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts,</div>
<div class="line">    uint32_t count)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buff;</div>
<div class="line">    <span class="comment">/* The virtio_hdr is initialised to 0. */</span></div>
<div class="line">    <span class="keyword">struct </span>virtio_net_hdr_mrg_rxbuf virtio_hdr</div>
<div class="line">        = {{0, 0, 0, 0, 0, 0}, 0};</div>
<div class="line">    uint64_t buff_hdr_addr = 0;</div>
<div class="line">    uint32_t head[MAX_PKT_BURST], packet_len = 0;</div>
<div class="line">    uint32_t head_idx, packet_success = 0;</div>
<div class="line">    uint16_t res_cur_idx;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) virtio_dev_rx()\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (count == 0)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    vq = dev-&gt;virtqueue[VIRTIO_RXQ];</div>
<div class="line">    count = (count &gt; MAX_PKT_BURST) ? MAX_PKT_BURST : count;</div>
<div class="line"></div>
<div class="line">    res_cur_idx = vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>;</div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Current Index %d| End Index %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, res_cur_idx, res_cur_idx + count);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Retrieve all of the head indexes first to avoid caching issues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (head_idx = 0; head_idx &lt; count; head_idx++)</div>
<div class="line">        head[head_idx] = MBUF_HEADROOM_UINT32(pkts[head_idx]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Prefetch descriptor index. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (packet_success != count) {</div>
<div class="line">        <span class="comment">/* Get descriptor from available ring */</span></div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]];</div>
<div class="line"></div>
<div class="line">        buff = pkts[packet_success];</div>
<div class="line">        LOG_DEBUG(VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in dev_rx_zcp: update the used idx for &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;pkt[%d] descriptor idx: %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh, packet_success,</div>
<div class="line">            MBUF_HEADROOM_UINT32(buff));</div>
<div class="line"></div>
<div class="line">        PRINT_PACKET(dev,</div>
<div class="line">            (uintptr_t)(((uint64_t)(uintptr_t)buff-&gt;<a class="code" href="structrte__mbuf.html#a9db3d388a1381e68e509017a6e7d0f12">buf_addr</a>)</div>
<div class="line">            + RTE_PKTMBUF_HEADROOM),</div>
<div class="line">            <a name="a111"></a><a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff), 0);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Buffer address translation for virtio header. */</span></div>
<div class="line">        buff_hdr_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">        packet_len = <a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff) + vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * If the descriptors are chained the header and data are</span></div>
<div class="line"><span class="comment">         * placed in separate buffers.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (desc-&gt;flags &amp; VRING_DESC_F_NEXT) {</div>
<div class="line">            desc-&gt;len = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>;</div>
<div class="line">            desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc-&gt;next];</div>
<div class="line">            desc-&gt;len = <a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            desc-&gt;len = packet_len;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update used ring with desc information */</span></div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[res_cur_idx &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)].<span class="keywordtype">id</span></div>
<div class="line">            = head[packet_success];</div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[res_cur_idx &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)].len</div>
<div class="line">            = packet_len;</div>
<div class="line">        res_cur_idx++;</div>
<div class="line">        packet_success++;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* A header is required per buffer. */</span></div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>((<span class="keywordtype">void</span> *)(uintptr_t)buff_hdr_addr,</div>
<div class="line">            (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;virtio_hdr, vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>);</div>
<div class="line"></div>
<div class="line">        PRINT_PACKET(dev, (uintptr_t)buff_hdr_addr, vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>, 1);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(packet_success &lt; count)) {</div>
<div class="line">            <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">            <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in dev_rx_zcp: before update used idx: &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;vq.last_used_idx: %d, vq-&gt;used-&gt;idx: %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx);</div>
<div class="line"></div>
<div class="line">    *(<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx += count;</div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> += count;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in dev_rx_zcp: after  update used idx: &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;vq.last_used_idx: %d, vq-&gt;used-&gt;idx: %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>, vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Kick the guest if necessary. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;flags &amp; VRING_AVAIL_F_NO_INTERRUPT))</div>
<div class="line">        eventfd_write(vq-&gt;<a class="code" href="structvhost__virtqueue.html#ae6e4ebc376f11dea075c9ae8a281ab51">callfd</a>, (eventfd_t)1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function routes the TX packet to the correct interface.</span></div>
<div class="line"><span class="comment"> * This may be a local device or the physical port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_route_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m,</div>
<div class="line">    uint32_t desc_idx, uint8_t need_copy)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **m_table;</div>
<div class="line">    <span class="keywordtype">void</span> *obj = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> len, ret, offset = 0;</div>
<div class="line">    <span class="keyword">struct </span>vpool *vpool;</div>
<div class="line">    uint16_t vlan_tag = (uint16_t)vlan_tags[(uint16_t)dev-&gt;device_fh];</div>
<div class="line">    uint16_t vmdq_rx_q = ((<span class="keyword">struct </span>vhost_dev *)dev-&gt;priv)-&gt;vmdq_rx_q;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Add packet to the port tx queue*/</span></div>
<div class="line">    tx_q = &amp;tx_queue_zcp[vmdq_rx_q];</div>
<div class="line">    len = tx_q-&gt;len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate an mbuf and populate the structure. */</span></div>
<div class="line">    vpool = &amp;vpool_array[MAX_QUEUES + vmdq_rx_q];</div>
<div class="line">    <a class="code" href="rte__ring_8h.html#a242877d9dc94b252277d6336c31b53ae">rte_ring_sc_dequeue</a>(vpool-&gt;ring, &amp;obj);</div>
<div class="line">    mbuf = obj;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(mbuf == NULL)) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq = dev-&gt;virtqueue[VIRTIO_TXQ];</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to allocate memory for mbuf.\n&quot;</span>,</div>
<div class="line">            dev-&gt;device_fh);</div>
<div class="line">        put_desc_to_used_list_zcp(vq, desc_idx);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vm2vm_mode == VM2VM_HARDWARE) {</div>
<div class="line">        <span class="comment">/* Avoid using a vlan tag from any vm for external pkt, such as</span></div>
<div class="line"><span class="comment">         * vlan_tags[dev-&gt;device_fh], oterwise, it conflicts when pool</span></div>
<div class="line"><span class="comment">         * selection, MAC address determines it as an external pkt</span></div>
<div class="line"><span class="comment">         * which should go to network, while vlan tag determine it as</span></div>
<div class="line"><span class="comment">         * a vm2vm pkt should forward to another vm. Hardware confuse</span></div>
<div class="line"><span class="comment">         * such a ambiguous situation, so pkt will lost.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        vlan_tag = external_pkt_default_vlan_tag;</div>
<div class="line">        <span class="keywordflow">if</span> (find_local_dest(dev, m, &amp;offset, &amp;vlan_tag) != 0) {</div>
<div class="line">            MBUF_HEADROOM_UINT32(mbuf) = (uint32_t)desc_idx;</div>
<div class="line">            __rte_mbuf_raw_free(mbuf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mbuf-&gt;<a name="a112"></a><a class="code" href="structrte__mbuf.html#a54163d61074a843b5a9560b74f7d3581">nb_segs</a> = m-&gt;nb_segs;</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a> = m-&gt;<a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a>;</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = m-&gt;data_len + offset;</div>
<div class="line">    mbuf-&gt;<a name="a113"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a> = mbuf-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(need_copy)) {</div>
<div class="line">        <span class="comment">/* Copy the packet contents to the mbuf. */</span></div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf, <span class="keywordtype">void</span> *),</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">void</span> *),</div>
<div class="line">            m-&gt;data_len);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        mbuf-&gt;data_off = m-&gt;data_off;</div>
<div class="line">        mbuf-&gt;<a class="code" href="structrte__mbuf.html#a6f9e031fb601226363d0106789df32f7">buf_physaddr</a> = m-&gt;buf_physaddr;</div>
<div class="line">        mbuf-&gt;<a class="code" href="structrte__mbuf.html#a9db3d388a1381e68e509017a6e7d0f12">buf_addr</a> = m-&gt;buf_addr;</div>
<div class="line">    }</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= <a class="code" href="rte__mbuf_8h.html#aab0d1c6738680ac92bcf0f9a7ec16215">PKT_TX_VLAN_PKT</a>;</div>
<div class="line">    mbuf-&gt;<a name="a114"></a><a class="code" href="structrte__mbuf.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> = vlan_tag;</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">l2_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>);</div>
<div class="line">    mbuf-&gt;<a class="code" href="structrte__mbuf.html#a82a34cb6d5935a8c0f043f2783d6b42d">l3_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv4_hdr);</div>
<div class="line">    MBUF_HEADROOM_UINT32(mbuf) = (uint32_t)desc_idx;</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;m_table[len] = mbuf;</div>
<div class="line">    len++;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in tx_route_zcp: pkt: nb_seg: %d, next:%s\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh,</div>
<div class="line">        mbuf-&gt;<a class="code" href="structrte__mbuf.html#a54163d61074a843b5a9560b74f7d3581">nb_segs</a>,</div>
<div class="line">        (mbuf-&gt;<a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a> == NULL) ? <span class="stringliteral">&quot;null&quot;</span> : <span class="stringliteral">&quot;non-null&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        dev_statistics[dev-&gt;device_fh].tx_total++;</div>
<div class="line">        dev_statistics[dev-&gt;device_fh].tx++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line">        m_table = (<span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table;</div>
<div class="line">        ret = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ports[0],</div>
<div class="line">            (uint16_t)tx_q-&gt;txq_id, m_table, (uint16_t) len);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Free any buffers not handled by TX and update</span></div>
<div class="line"><span class="comment">         * the port stats.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; len)) {</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m_table[ret]);</div>
<div class="line">            } <span class="keywordflow">while</span> (++ret &lt; len);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        len = 0;</div>
<div class="line">        txmbuf_clean_zcp(dev, vpool);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;len = len;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function TX all available packets in virtio TX queue for one</span></div>
<div class="line"><span class="comment"> * virtio-net device. If it is first packet, it learns MAC address and</span></div>
<div class="line"><span class="comment"> * setup VMDQ.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_dev_tx_zcp(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> m;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc;</div>
<div class="line">    uint64_t buff_addr = 0, phys_addr;</div>
<div class="line">    uint32_t head[MAX_PKT_BURST];</div>
<div class="line">    uint32_t i;</div>
<div class="line">    uint16_t free_entries, packet_success = 0;</div>
<div class="line">    uint16_t avail_idx;</div>
<div class="line">    uint8_t need_copy = 0;</div>
<div class="line">    hpa_type addr_type;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev = (<span class="keyword">struct </span>vhost_dev *)dev-&gt;priv;</div>
<div class="line"></div>
<div class="line">    vq = dev-&gt;virtqueue[VIRTIO_TXQ];</div>
<div class="line">    avail_idx =  *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If there are no available buffers then return. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a> == avail_idx)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) virtio_dev_tx()\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch available ring to retrieve head indexes. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a> &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the number of free entries in the ring */</span></div>
<div class="line">    free_entries = (avail_idx - vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Limit to MAX_PKT_BURST. */</span></div>
<div class="line">    free_entries</div>
<div class="line">        = (free_entries &gt; MAX_PKT_BURST) ? MAX_PKT_BURST : free_entries;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Buffers available %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, free_entries);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Retrieve all of the head indexes first to avoid caching issues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; free_entries; i++)</div>
<div class="line">        head[i]</div>
<div class="line">            = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[(vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a> + i)</div>
<div class="line">            &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)];</div>
<div class="line"></div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a> += free_entries;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (packet_success &lt; free_entries) {</div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Discard first buffer as it is the virtio header */</span></div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc-&gt;next];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Buffer address translation. */</span></div>
<div class="line">        buff_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">        <span class="comment">/* Need check extra VLAN_HLEN size for inserting VLAN tag */</span></div>
<div class="line">        phys_addr = gpa_to_hpa(vdev, desc-&gt;addr, desc-&gt;len + VLAN_HLEN,</div>
<div class="line">            &amp;addr_type);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(packet_success &lt; (free_entries - 1)))</div>
<div class="line">            <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">            <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success + 1]]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addr_type == PHYS_ADDR_INVALID)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Invalid frame buffer address found&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;when TX packets!\n&quot;</span>,</div>
<div class="line">                dev-&gt;device_fh);</div>
<div class="line">            packet_success++;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Prefetch buffer address. */</span></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>((<span class="keywordtype">void</span> *)(uintptr_t)buff_addr);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Setup dummy mbuf. This is copied to a real mbuf if</span></div>
<div class="line"><span class="comment">         * transmitted out the physical port.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        m.data_len = desc-&gt;len;</div>
<div class="line">        m.nb_segs = 1;</div>
<div class="line">        m.next = NULL;</div>
<div class="line">        m.data_off = 0;</div>
<div class="line">        m.buf_addr = (<span class="keywordtype">void</span> *)(uintptr_t)buff_addr;</div>
<div class="line">        m.buf_physaddr = phys_addr;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Check if the frame buffer address from guest crosses</span></div>
<div class="line"><span class="comment">         * sub-region or not.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addr_type == PHYS_ADDR_CROSS_SUBREG)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Frame buffer address cross &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;sub-regioin found when attaching TX frame &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;buffer address!\n&quot;</span>,</div>
<div class="line">                dev-&gt;device_fh);</div>
<div class="line">            need_copy = 1;</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            need_copy = 0;</div>
<div class="line"></div>
<div class="line">        PRINT_PACKET(dev, (uintptr_t)buff_addr, desc-&gt;len, 0);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * If this is the first received packet we need to learn</span></div>
<div class="line"><span class="comment">         * the MAC and setup VMDQ</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;ready == DEVICE_MAC_LEARNING)) {</div>
<div class="line">            <span class="keywordflow">if</span> (vdev-&gt;remove || (link_vmdq(vdev, &amp;m) == -1)) {</div>
<div class="line">                <span class="comment">/*</span></div>
<div class="line"><span class="comment">                 * Discard frame if device is scheduled for</span></div>
<div class="line"><span class="comment">                 * removal or a duplicate MAC address is found.</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line">                packet_success += free_entries;</div>
<div class="line">                vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> += packet_success;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        virtio_tx_route_zcp(dev, &amp;m, head[packet_success], need_copy);</div>
<div class="line">        packet_success++;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function is called by each data core. It handles all RX/TX registered</span></div>
<div class="line"><span class="comment"> * with the core. For TX the specific lcore linked list is used. For RX, MAC</span></div>
<div class="line"><span class="comment"> * addresses are compared with all devices in the main linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">switch_worker_zcp(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = NULL;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev  *vdev = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keyword">struct </span>lcore_ll_info *lcore_ll;</div>
<div class="line">    <span class="keyword">const</span> uint64_t drain_tsc</div>
<div class="line">        = (<a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1) / US_PER_S</div>
<div class="line">        * BURST_TX_DRAIN_US;</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc, ret_count = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> ret;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    uint16_t count_in_ring, rx_count = 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;Procesing on Core %u started\n&quot;</span>, lcore_id);</div>
<div class="line"></div>
<div class="line">    lcore_ll = lcore_info[lcore_id].lcore_ll;</div>
<div class="line">    prev_tsc = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* TX burst queue drain */</span></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; drain_tsc)) {</div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * Get mbuf from vpool.pool and detach mbuf and</span></div>
<div class="line"><span class="comment">             * put back into vpool.ring.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            dev_ll = lcore_ll-&gt;ll_root_used;</div>
<div class="line">            <span class="keywordflow">while</span> ((dev_ll != NULL) &amp;&amp; (dev_ll-&gt;vdev != NULL)) {</div>
<div class="line">                <span class="comment">/* Get virtio device ID */</span></div>
<div class="line">                vdev = dev_ll-&gt;vdev;</div>
<div class="line">                dev = vdev-&gt;dev;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!vdev-&gt;remove)) {</div>
<div class="line">                    tx_q = &amp;tx_queue_zcp[(uint16_t)vdev-&gt;vmdq_rx_q];</div>
<div class="line">                    if (tx_q-&gt;len) {</div>
<div class="line">                        LOG_DEBUG(VHOST_DATA,</div>
<div class="line">                        <span class="stringliteral">&quot;TX queue drained after timeout&quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot; with burst size %u\n&quot;</span>,</div>
<div class="line">                        tx_q-&gt;len);</div>
<div class="line"></div>
<div class="line">                        <span class="comment">/*</span></div>
<div class="line"><span class="comment">                         * Tx any packets in the queue</span></div>
<div class="line"><span class="comment">                         */</span></div>
<div class="line">                        ret = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(</div>
<div class="line">                            ports[0],</div>
<div class="line">                            (uint16_t)tx_q-&gt;txq_id,</div>
<div class="line">                            (<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)</div>
<div class="line">                            tx_q-&gt;m_table,</div>
<div class="line">                            (uint16_t)tx_q-&gt;len);</div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; tx_q-&gt;len)) {</div>
<div class="line">                            <span class="keywordflow">do</span> {</div>
<div class="line">                                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(</div>
<div class="line">                                    tx_q-&gt;m_table[ret]);</div>
<div class="line">                            } <span class="keywordflow">while</span> (++ret &lt; tx_q-&gt;len);</div>
<div class="line">                        }</div>
<div class="line">                        tx_q-&gt;len = 0;</div>
<div class="line"></div>
<div class="line">                        txmbuf_clean_zcp(dev,</div>
<div class="line">                            &amp;vpool_array[MAX_QUEUES+vdev-&gt;vmdq_rx_q]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                dev_ll = dev_ll-&gt;next;</div>
<div class="line">            }</div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(lcore_ll-&gt;ll_root_used);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Inform the configuration core that we have exited the linked</span></div>
<div class="line"><span class="comment">         * list and that no devices are in use if requested.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ll-&gt;dev_removal_flag == REQUEST_DEV_REMOVAL)</div>
<div class="line">            lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Process devices */</span></div>
<div class="line">        dev_ll = lcore_ll-&gt;ll_root_used;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> ((dev_ll != NULL) &amp;&amp; (dev_ll-&gt;vdev != NULL)) {</div>
<div class="line">            vdev = dev_ll-&gt;vdev;</div>
<div class="line">            dev  = vdev-&gt;dev;</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;remove)) {</div>
<div class="line">                dev_ll = dev_ll-&gt;next;</div>
<div class="line">                unlink_vmdq(vdev);</div>
<div class="line">                vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vdev-&gt;ready == DEVICE_RX)) {</div>
<div class="line">                uint32_t index = vdev-&gt;vmdq_rx_q;</div>
<div class="line">                uint16_t i;</div>
<div class="line">                count_in_ring</div>
<div class="line">                = <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool_array[index].ring);</div>
<div class="line">                uint16_t free_entries</div>
<div class="line">                = (uint16_t)get_available_ring_num_zcp(dev);</div>
<div class="line"></div>
<div class="line">                <span class="comment">/*</span></div>
<div class="line"><span class="comment">                 * Attach all mbufs in vpool.ring and put back</span></div>
<div class="line"><span class="comment">                 * into vpool.pool.</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line">                <span class="keywordflow">for</span> (i = 0;</div>
<div class="line">                i &lt; <a name="a115"></a><a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(free_entries,</div>
<div class="line">                <a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(count_in_ring, MAX_PKT_BURST));</div>
<div class="line">                i++)</div>
<div class="line">                    attach_rxmbuf_zcp(dev);</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* Handle guest RX */</span></div>
<div class="line">                rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    vdev-&gt;vmdq_rx_q, pkts_burst,</div>
<div class="line">                    MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (rx_count) {</div>
<div class="line">                    ret_count = virtio_dev_rx_zcp(dev,</div>
<div class="line">                            pkts_burst, rx_count);</div>
<div class="line">                    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_total</div>
<div class="line">                            += rx_count;</div>
<div class="line">                        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx</div>
<div class="line">                            += ret_count;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count)) {</div>
<div class="line">                        rx_count--;</div>
<div class="line">                        pktmbuf_detach_zcp(</div>
<div class="line">                            pkts_burst[rx_count]);</div>
<div class="line">                        <a class="code" href="rte__ring_8h.html#a644b1d6866fed20f0a5711e63ecefc38">rte_ring_sp_enqueue</a>(</div>
<div class="line">                            vpool_array[index].ring,</div>
<div class="line">                            (<span class="keywordtype">void</span> *)pkts_burst[rx_count]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!vdev-&gt;remove))</div>
<div class="line">                <span class="comment">/* Handle guest TX */</span></div>
<div class="line">                virtio_dev_tx_zcp(dev);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Move to the next device in the list */</span></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Add an entry to a used linked list. A free entry must first be found</span></div>
<div class="line"><span class="comment"> * in the free linked list using get_data_ll_free_entry();</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">add_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set next as NULL and use a compiler barrier to avoid reordering. */</span></div>
<div class="line">    ll_dev-&gt;next = NULL;</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If ll == NULL then this is the first device. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ll) {</div>
<div class="line">        <span class="comment">/* Increment to the tail of the linked list. */</span></div>
<div class="line">        <span class="keywordflow">while</span> ((ll-&gt;next != NULL) )</div>
<div class="line">            ll = ll-&gt;next;</div>
<div class="line"></div>
<div class="line">        ll-&gt;next = ll_dev;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        *ll_root_addr = ll_dev;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove an entry from a used linked list. The entry must then be added to</span></div>
<div class="line"><span class="comment"> * the free linked list using put_data_ll_free_entry().</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">rm_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev_last)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>((ll == NULL) || (ll_dev == NULL)))</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == ll)</div>
<div class="line">        *ll_root_addr = ll_dev-&gt;next;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(ll_dev_last != NULL))</div>
<div class="line">            ll_dev_last-&gt;next = ll_dev-&gt;next;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Remove entry form ll failed.\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Find and return an entry from the free linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">get_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_free == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    ll_dev = ll_free;</div>
<div class="line">    *ll_root_addr = ll_free-&gt;next;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Place an entry back on to the free linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">put_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    ll_dev-&gt;next = ll_free;</div>
<div class="line">    *ll_root_addr = ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Creates a linked list of a given size.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">alloc_data_ll(uint32_t size)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_new;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Malloc and then chain the linked list. */</span></div>
<div class="line">    ll_new = malloc(size * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_net_data_ll));</div>
<div class="line">    <span class="keywordflow">if</span> (ll_new == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Failed to allocate memory for ll_new.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; size - 1; i++) {</div>
<div class="line">        ll_new[i].vdev = NULL;</div>
<div class="line">        ll_new[i].next = &amp;ll_new[i+1];</div>
<div class="line">    }</div>
<div class="line">    ll_new[i].next = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_new;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Create the main linked list along with each individual cores linked list. A used and a free list</span></div>
<div class="line"><span class="comment"> * are created to manage entries.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_data_ll (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    <a name="a116"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> lcore_ll_info));</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Failed to allocate memory for lcore_ll.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;device_num = 0;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;ll_root_used = NULL;</div>
<div class="line">        <span class="keywordflow">if</span> (num_devices % num_switching_cores)</div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free = alloc_data_ll((num_devices / num_switching_cores) + 1);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free = alloc_data_ll(num_devices / num_switching_cores);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate devices up to a maximum of MAX_DEVICES. */</span></div>
<div class="line">    ll_root_free = alloc_data_ll(MIN((num_devices), MAX_DEVICES));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove a device from the specific data core linked list and from the main linked list. Synchonization</span></div>
<div class="line"><span class="comment"> * occurs through the use of the lcore dev_removal_flag. Device is made volatile here to avoid re-ordering</span></div>
<div class="line"><span class="comment"> * of dev-&gt;remove=1 which can cause an infinite loop in the rte_pause loop.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device (<span class="keyword">volatile</span> <span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    dev-&gt;<a name="a117"></a><a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp;= ~VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    vdev = (<span class="keyword">struct </span>vhost_dev *)dev-&gt;<a name="a118"></a><a class="code" href="structvirtio__net.html#a8b6505c37d4ff95854b8b00527e4d9fa">priv</a>;</div>
<div class="line">    <span class="comment">/*set the remove flag. */</span></div>
<div class="line">    vdev-&gt;remove = 1;</div>
<div class="line">    <span class="keywordflow">while</span>(vdev-&gt;ready != DEVICE_SAFE_REMOVE) {</div>
<div class="line">        rte_pause();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from lcore ll */</span></div>
<div class="line">    ll_lcore_dev_cur = lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_lcore_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_lcore_dev_cur-&gt;vdev == vdev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_lcore_dev_last = ll_lcore_dev_cur;</div>
<div class="line">            ll_lcore_dev_cur = ll_lcore_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_lcore_dev_cur == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to find the dev to be destroy.\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from main ll */</span></div>
<div class="line">    ll_main_dev_cur = ll_root_used;</div>
<div class="line">    ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_main_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_main_dev_cur-&gt;vdev == vdev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_main_dev_last = ll_main_dev_cur;</div>
<div class="line">            ll_main_dev_cur = ll_main_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Remove entries from the lcore and main ll. */</span></div>
<div class="line">    rm_data_ll_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used, ll_lcore_dev_cur, ll_lcore_dev_last);</div>
<div class="line">    rm_data_ll_entry(&amp;ll_root_used, ll_main_dev_cur, ll_main_dev_last);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set the dev_removal_flag on each lcore. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag = REQUEST_DEV_REMOVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Once each core has set the dev_removal_flag to ACK_DEV_REMOVAL we can be sure that</span></div>
<div class="line"><span class="comment">     * they can no longer access the device removed from the linked lists and that the devices</span></div>
<div class="line"><span class="comment">     * are no longer in use.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">while</span> (lcore_info[lcore].lcore_ll-&gt;dev_removal_flag != ACK_DEV_REMOVAL) {</div>
<div class="line">            rte_pause();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add the entries back to the lcore and main free ll.*/</span></div>
<div class="line">    put_data_ll_free_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_free, ll_lcore_dev_cur);</div>
<div class="line">    put_data_ll_free_entry(&amp;ll_root_free, ll_main_dev_cur);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Decrement number of device on the lcore. */</span></div>
<div class="line">    lcore_info[vdev-&gt;coreid].lcore_ll-&gt;device_num--;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been removed from data core\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy) {</div>
<div class="line">        <span class="keyword">struct </span>vpool *vpool = &amp;vpool_array[vdev-&gt;vmdq_rx_q];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Stop the RX queue. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (rte_eth_dev_rx_queue_stop(ports[0], vdev-&gt;vmdq_rx_q) != 0) {</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) In destroy_device: Failed to stop &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;rx queue:%d\n&quot;</span>,</div>
<div class="line">                dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">                vdev-&gt;vmdq_rx_q);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in destroy_device: Start put mbuf in &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;mempool back to ring for RX queue: %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;vmdq_rx_q);</div>
<div class="line"></div>
<div class="line">        mbuf_destroy_zcp(vpool);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Stop the TX queue. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (rte_eth_dev_tx_queue_stop(ports[0], vdev-&gt;vmdq_rx_q) != 0) {</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) In destroy_device: Failed to &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;stop tx queue:%d\n&quot;</span>,</div>
<div class="line">                dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;vmdq_rx_q);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        vpool = &amp;vpool_array[vdev-&gt;vmdq_rx_q + MAX_QUEUES];</div>
<div class="line"></div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) destroy_device: Start put mbuf in mempool &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;back to ring for TX queue: %d, dev:(%&quot;</span>PRIu64<span class="stringliteral">&quot;)\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, (vdev-&gt;vmdq_rx_q + MAX_QUEUES),</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">        mbuf_destroy_zcp(vpool);</div>
<div class="line">        <a name="a119"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Calculate the region count of physical continous regions for one particular</span></div>
<div class="line"><span class="comment"> * region of whose vhost virtual address is continous. The particular region</span></div>
<div class="line"><span class="comment"> * start from vva_start, with size of &#39;size&#39; in argument.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t</div>
<div class="line">check_hpa_regions(uint64_t vva_start, uint64_t size)</div>
<div class="line">{</div>
<div class="line">    uint32_t i, nregions = 0, page_size = getpagesize();</div>
<div class="line">    uint64_t cur_phys_addr = 0, next_phys_addr = 0;</div>
<div class="line">    <span class="keywordflow">if</span> (vva_start % page_size) {</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;in check_countinous: vva start(%p) mod page_size(%d) &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;has remainder\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)vva_start, page_size);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (size % page_size) {</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;in check_countinous: &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;size((%&quot;</span>PRIu64<span class="stringliteral">&quot;)) mod page_size(%d) has remainder\n&quot;</span>,</div>
<div class="line">            size, page_size);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; size - page_size; i = i + page_size) {</div>
<div class="line">        cur_phys_addr</div>
<div class="line">            = <a name="a120"></a><a class="code" href="rte__memory_8h.html#a15c786260d675cb7af1299dd4b7a28ee">rte_mem_virt2phy</a>((<span class="keywordtype">void</span> *)(uintptr_t)(vva_start + i));</div>
<div class="line">        next_phys_addr = <a class="code" href="rte__memory_8h.html#a15c786260d675cb7af1299dd4b7a28ee">rte_mem_virt2phy</a>(</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)(vva_start + i + page_size));</div>
<div class="line">        <span class="keywordflow">if</span> ((cur_phys_addr + page_size) != next_phys_addr) {</div>
<div class="line">            ++nregions;</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in check_continuous: hva addr:(%p) is not &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;continuous with hva addr:(%p), diff:%d\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">void</span> *)(uintptr_t)(vva_start + (uint64_t)i),</div>
<div class="line">                (<span class="keywordtype">void</span> *)(uintptr_t)(vva_start + (uint64_t)i</div>
<div class="line">                + page_size), page_size);</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in check_continuous: hpa addr:(%p) is not &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;continuous with hpa addr:(%p), &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;diff:(%&quot;</span>PRIu64<span class="stringliteral">&quot;)\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">void</span> *)(uintptr_t)cur_phys_addr,</div>
<div class="line">                (<span class="keywordtype">void</span> *)(uintptr_t)next_phys_addr,</div>
<div class="line">                (next_phys_addr-cur_phys_addr));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> nregions;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Divide each region whose vhost virtual address is continous into a few</span></div>
<div class="line"><span class="comment"> * sub-regions, make sure the physical address within each sub-region are</span></div>
<div class="line"><span class="comment"> * continous. And fill offset(to GPA) and size etc. information of each</span></div>
<div class="line"><span class="comment"> * sub-region into regions_hpa.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t</div>
<div class="line">fill_hpa_memory_regions(<span class="keyword">struct</span> virtio_memory_regions_hpa *mem_region_hpa, <span class="keyword">struct</span> <a name="_a121"></a><a class="code" href="structvirtio__memory.html">virtio_memory</a> *<a class="code" href="structvirtio__memory.html">virtio_memory</a>)</div>
<div class="line">{</div>
<div class="line">    uint32_t regionidx, regionidx_hpa = 0, i, k, page_size = getpagesize();</div>
<div class="line">    uint64_t cur_phys_addr = 0, next_phys_addr = 0, vva_start;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (mem_region_hpa == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (regionidx = 0; regionidx &lt; virtio_memory-&gt;<a name="a122"></a><a class="code" href="structvirtio__memory.html#a8c698530d035252522c2ba1811858baf">nregions</a>; regionidx++) {</div>
<div class="line">        vva_start = virtio_memory-&gt;<a name="a123"></a><a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a name="a124"></a><a class="code" href="structvirtio__memory__regions.html#a770e0e191260326089cb15208767c198">guest_phys_address</a> +</div>
<div class="line">            virtio_memory-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a name="a125"></a><a class="code" href="structvirtio__memory__regions.html#a07e7aa887598ca959517d7028a4d182a">address_offset</a>;</div>
<div class="line">        mem_region_hpa[regionidx_hpa].guest_phys_address</div>
<div class="line">            = virtio_memory-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a class="code" href="structvirtio__memory__regions.html#a770e0e191260326089cb15208767c198">guest_phys_address</a>;</div>
<div class="line">        mem_region_hpa[regionidx_hpa].host_phys_addr_offset =</div>
<div class="line">            <a class="code" href="rte__memory_8h.html#a15c786260d675cb7af1299dd4b7a28ee">rte_mem_virt2phy</a>((<span class="keywordtype">void</span> *)(uintptr_t)(vva_start)) -</div>
<div class="line">            mem_region_hpa[regionidx_hpa].guest_phys_address;</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;in fill_hpa_regions: guest phys addr start[%d]:(%p)\n&quot;</span>,</div>
<div class="line">            regionidx_hpa,</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">            (mem_region_hpa[regionidx_hpa].guest_phys_address));</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;in fill_hpa_regions: host  phys addr start[%d]:(%p)\n&quot;</span>,</div>
<div class="line">            regionidx_hpa,</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">            (mem_region_hpa[regionidx_hpa].host_phys_addr_offset));</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0, k = 0;</div>
<div class="line">            i &lt; virtio_memory-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a name="a126"></a><a class="code" href="structvirtio__memory__regions.html#ad447c812501af2e4f871e651c05e9852">memory_size</a> -</div>
<div class="line">                page_size;</div>
<div class="line">            i += page_size) {</div>
<div class="line">            cur_phys_addr = <a class="code" href="rte__memory_8h.html#a15c786260d675cb7af1299dd4b7a28ee">rte_mem_virt2phy</a>(</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)(vva_start + i));</div>
<div class="line">            next_phys_addr = <a class="code" href="rte__memory_8h.html#a15c786260d675cb7af1299dd4b7a28ee">rte_mem_virt2phy</a>(</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)(vva_start +</div>
<div class="line">                    i + page_size));</div>
<div class="line">            <span class="keywordflow">if</span> ((cur_phys_addr + page_size) != next_phys_addr) {</div>
<div class="line">                mem_region_hpa[regionidx_hpa].guest_phys_address_end =</div>
<div class="line">                    mem_region_hpa[regionidx_hpa].guest_phys_address +</div>
<div class="line">                    k + page_size;</div>
<div class="line">                mem_region_hpa[regionidx_hpa].memory_size</div>
<div class="line">                    = k + page_size;</div>
<div class="line">                LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;in fill_hpa_regions: guest &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;phys addr end  [%d]:(%p)\n&quot;</span>,</div>
<div class="line">                    regionidx_hpa,</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">                    (mem_region_hpa[regionidx_hpa].guest_phys_address_end));</div>
<div class="line">                LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;in fill_hpa_regions: guest phys addr &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;size [%d]:(%p)\n&quot;</span>,</div>
<div class="line">                    regionidx_hpa,</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">                    (mem_region_hpa[regionidx_hpa].memory_size));</div>
<div class="line">                mem_region_hpa[regionidx_hpa + 1].guest_phys_address</div>
<div class="line">                    = mem_region_hpa[regionidx_hpa].guest_phys_address_end;</div>
<div class="line">                ++regionidx_hpa;</div>
<div class="line">                mem_region_hpa[regionidx_hpa].host_phys_addr_offset =</div>
<div class="line">                    next_phys_addr -</div>
<div class="line">                    mem_region_hpa[regionidx_hpa].guest_phys_address;</div>
<div class="line">                LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;in fill_hpa_regions: guest&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot; phys addr start[%d]:(%p)\n&quot;</span>,</div>
<div class="line">                    regionidx_hpa,</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">                    (mem_region_hpa[regionidx_hpa].guest_phys_address));</div>
<div class="line">                LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;in fill_hpa_regions: host  phys addr &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;start[%d]:(%p)\n&quot;</span>,</div>
<div class="line">                    regionidx_hpa,</div>
<div class="line">                    (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">                    (mem_region_hpa[regionidx_hpa].host_phys_addr_offset));</div>
<div class="line">                k = 0;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                k += page_size;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        mem_region_hpa[regionidx_hpa].guest_phys_address_end</div>
<div class="line">            = mem_region_hpa[regionidx_hpa].guest_phys_address</div>
<div class="line">            + k + page_size;</div>
<div class="line">        mem_region_hpa[regionidx_hpa].memory_size = k + page_size;</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;in fill_hpa_regions: guest phys addr end  &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;[%d]:(%p)\n&quot;</span>, regionidx_hpa,</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">            (mem_region_hpa[regionidx_hpa].guest_phys_address_end));</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;in fill_hpa_regions: guest phys addr size &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;[%d]:(%p)\n&quot;</span>, regionidx_hpa,</div>
<div class="line">            (<span class="keywordtype">void</span> *)(uintptr_t)</div>
<div class="line">            (mem_region_hpa[regionidx_hpa].memory_size));</div>
<div class="line">        ++regionidx_hpa;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> regionidx_hpa;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A new device is added to a data core. First the device is added to the main linked list</span></div>
<div class="line"><span class="comment"> * and the allocated to a specific data core.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device (<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line">    <span class="keywordtype">int</span> lcore, core_add = 0;</div>
<div class="line">    uint32_t device_num_min = num_devices;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    uint32_t regionidx;</div>
<div class="line"></div>
<div class="line">    vdev = <a name="a127"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(<span class="stringliteral">&quot;vhost device&quot;</span>, <span class="keyword">sizeof</span>(*vdev), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (vdev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Couldn&#39;t allocate memory for vhost dev\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    vdev-&gt;dev = dev;</div>
<div class="line">    dev-&gt;<a class="code" href="structvirtio__net.html#a8b6505c37d4ff95854b8b00527e4d9fa">priv</a> = vdev;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy) {</div>
<div class="line">        vdev-&gt;nregions_hpa = dev-&gt;<a name="a128"></a><a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a>-&gt;<a class="code" href="structvirtio__memory.html#a8c698530d035252522c2ba1811858baf">nregions</a>;</div>
<div class="line">        <span class="keywordflow">for</span> (regionidx = 0; regionidx &lt; dev-&gt;<a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a>-&gt;<a class="code" href="structvirtio__memory.html#a8c698530d035252522c2ba1811858baf">nregions</a>; regionidx++) {</div>
<div class="line">            vdev-&gt;nregions_hpa</div>
<div class="line">                += check_hpa_regions(</div>
<div class="line">                    dev-&gt;<a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a>-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a class="code" href="structvirtio__memory__regions.html#a770e0e191260326089cb15208767c198">guest_phys_address</a></div>
<div class="line">                    + dev-&gt;<a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a>-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a class="code" href="structvirtio__memory__regions.html#a07e7aa887598ca959517d7028a4d182a">address_offset</a>,</div>
<div class="line">                    dev-&gt;<a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a>-&gt;<a class="code" href="structvirtio__memory.html#ae6b208cc000ee964ed4da34099fa2e2d">regions</a>[regionidx].<a class="code" href="structvirtio__memory__regions.html#ad447c812501af2e4f871e651c05e9852">memory_size</a>);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        vdev-&gt;regions_hpa = <a name="a129"></a><a class="code" href="rte__malloc_8h.html#a6fb3bee5aa4b21efab0c9c5d5cf2a251">rte_calloc</a>(<span class="stringliteral">&quot;vhost hpa region&quot;</span>,</div>
<div class="line">                           vdev-&gt;nregions_hpa,</div>
<div class="line">                           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_memory_regions_hpa),</div>
<div class="line">                           RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;regions_hpa == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Cannot allocate memory for hpa region\n&quot;</span>);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (fill_hpa_memory_regions(</div>
<div class="line">            vdev-&gt;regions_hpa, dev-&gt;<a class="code" href="structvirtio__net.html#a8659617978f864a0244d8814de7cc910">mem</a></div>
<div class="line">            ) != vdev-&gt;nregions_hpa) {</div>
<div class="line"></div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;hpa memory regions number mismatch: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;[%d]\n&quot;</span>, vdev-&gt;nregions_hpa);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add device to main ll */</span></div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) No free entry found in linked list. Device limit &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;of %d devices per core has been reached\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, num_devices);</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;regions_hpa)</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;vdev = vdev;</div>
<div class="line">    add_data_ll_entry(&amp;ll_root_used, ll_dev);</div>
<div class="line">    vdev-&gt;vmdq_rx_q</div>
<div class="line">        = dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a> * queues_per_pool + vmdq_queue_base;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy) {</div>
<div class="line">        uint32_t index = vdev-&gt;vmdq_rx_q;</div>
<div class="line">        uint32_t count_in_ring, i;</div>
<div class="line">        <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line"></div>
<div class="line">        count_in_ring = <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool_array[index].ring);</div>
<div class="line"></div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in new_device: mbuf count in mempool &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;before attach is: %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">            <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool_array[index].pool));</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in new_device: mbuf count in  ring &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;before attach  is : %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, count_in_ring);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Attach all mbufs in vpool.ring and put back intovpool.pool.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; count_in_ring; i++)</div>
<div class="line">            attach_rxmbuf_zcp(dev);</div>
<div class="line"></div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in new_device: mbuf count in &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;mempool after attach is: %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">            <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool_array[index].pool));</div>
<div class="line">        LOG_DEBUG(VHOST_CONFIG, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) in new_device: mbuf count in &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;ring after attach  is : %d\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">            <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool_array[index].ring));</div>
<div class="line"></div>
<div class="line">        tx_q = &amp;tx_queue_zcp[(uint16_t)vdev-&gt;vmdq_rx_q];</div>
<div class="line">        tx_q-&gt;txq_id = vdev-&gt;vmdq_rx_q;</div>
<div class="line"></div>
<div class="line">        if (rte_eth_dev_tx_queue_start(ports[0], vdev-&gt;vmdq_rx_q) != 0) {</div>
<div class="line">            <span class="keyword">struct </span>vpool *vpool = &amp;vpool_array[vdev-&gt;vmdq_rx_q];</div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) In new_device: Failed to start &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;tx queue:%d\n&quot;</span>,</div>
<div class="line">                dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;vmdq_rx_q);</div>
<div class="line"></div>
<div class="line">            mbuf_destroy_zcp(vpool);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (rte_eth_dev_rx_queue_start(ports[0], vdev-&gt;vmdq_rx_q) != 0) {</div>
<div class="line">            <span class="keyword">struct </span>vpool *vpool = &amp;vpool_array[vdev-&gt;vmdq_rx_q];</div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) In new_device: Failed to start &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;rx queue:%d\n&quot;</span>,</div>
<div class="line">                dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;vmdq_rx_q);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Stop the TX queue. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (rte_eth_dev_tx_queue_stop(ports[0],</div>
<div class="line">                vdev-&gt;vmdq_rx_q) != 0) {</div>
<div class="line">                LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) In new_device: Failed to &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;stop tx queue:%d\n&quot;</span>,</div>
<div class="line">                    dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;vmdq_rx_q);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            mbuf_destroy_zcp(vpool);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*reset ready flag*/</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    vdev-&gt;remove = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find a suitable lcore to add the device. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll-&gt;device_num &lt; device_num_min) {</div>
<div class="line">            device_num_min = lcore_info[lcore].lcore_ll-&gt;device_num;</div>
<div class="line">            core_add = lcore;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Add device to lcore ll */</span></div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;lcore_info[core_add].lcore_ll-&gt;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to add device to data core\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">        destroy_device(dev);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;vdev = vdev;</div>
<div class="line">    vdev-&gt;coreid = core_add;</div>
<div class="line"></div>
<div class="line">    add_data_ll_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used, ll_dev);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>], 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> device_statistics));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Disable notifications. */</span></div>
<div class="line">    rte_vhost_enable_guest_notification(dev, VIRTIO_RXQ, 0);</div>
<div class="line">    rte_vhost_enable_guest_notification(dev, VIRTIO_TXQ, 0);</div>
<div class="line">    lcore_info[vdev-&gt;coreid].lcore_ll-&gt;device_num++;</div>
<div class="line">    dev-&gt;<a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> |= VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been added to data core %d\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;coreid);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * These callback allow devices to be added to the data core when configuration</span></div>
<div class="line"><span class="comment"> * has been fully complete.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a130"></a><a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> <a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> =</div>
<div class="line">{</div>
<div class="line">    .<a name="a131"></a><a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a> =  <a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a132"></a><a class="code" href="structvirtio__net__device__ops.html#a1eb7d99f01386abe9b892985d778eabd">destroy_device</a>,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This is a thread will wake up after a period to print stats if the user has</span></div>
<div class="line"><span class="comment"> * enabled them.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    uint64_t tx_dropped, rx_dropped;</div>
<div class="line">    uint64_t tx, tx_total, rx, rx_total;</div>
<div class="line">    uint32_t device_fh;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> top_left[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>,<span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        sleep(enable_stats);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;%s%s&quot;</span>, clr, top_left);</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;\nDevice statistics ====================================&quot;</span>);</div>
<div class="line"></div>
<div class="line">        dev_ll = ll_root_used;</div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            device_fh = (uint32_t)dev_ll-&gt;vdev-&gt;dev-&gt;device_fh;</div>
<div class="line">            tx_total = dev_statistics[device_fh].tx_total;</div>
<div class="line">            tx = dev_statistics[device_fh].tx;</div>
<div class="line">            tx_dropped = tx_total - tx;</div>
<div class="line">            if (zero_copy == 0) {</div>
<div class="line">                rx_total = <a name="a133"></a><a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                    &amp;dev_statistics[device_fh].rx_total_atomic);</div>
<div class="line">                rx = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                    &amp;dev_statistics[device_fh].rx_atomic);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                rx_total = dev_statistics[device_fh].rx_total;</div>
<div class="line">                rx = dev_statistics[device_fh].rx;</div>
<div class="line">            }</div>
<div class="line">            rx_dropped = rx_total - rx;</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;\nStatistics for device %&quot;</span>PRIu32<span class="stringliteral">&quot; ------------------------------&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    device_fh,</div>
<div class="line">                    tx_total,</div>
<div class="line">                    tx_dropped,</div>
<div class="line">                    tx,</div>
<div class="line">                    rx_total,</div>
<div class="line">                    rx_dropped,</div>
<div class="line">                    rx);</div>
<div class="line"></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n======================================================\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">setup_mempool_tbl(<span class="keywordtype">int</span> socket, uint32_t index, <span class="keywordtype">char</span> *pool_name,</div>
<div class="line">    <span class="keywordtype">char</span> *ring_name, uint32_t nb_mbuf)</div>
<div class="line">{</div>
<div class="line">    vpool_array[index].pool = <a name="a134"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(pool_name, nb_mbuf,</div>
<div class="line">        MBUF_CACHE_SIZE_ZCP, 0, MBUF_DATA_SIZE_ZCP, socket);</div>
<div class="line">    <span class="keywordflow">if</span> (vpool_array[index].pool != NULL) {</div>
<div class="line">        vpool_array[index].ring</div>
<div class="line">            = <a name="a135"></a><a class="code" href="rte__ring_8h.html#a5556487d8ec76cacfc059b66d8b77c98">rte_ring_create</a>(ring_name,</div>
<div class="line">                <a name="a136"></a><a class="code" href="rte__common_8h.html#a5a85fd1038be9376de166494057e6aa1">rte_align32pow2</a>(nb_mbuf + 1),</div>
<div class="line">                socket, <a name="a137"></a><a class="code" href="rte__ring_8h.html#a127c66adbeab4653a47649993b94f35b">RING_F_SP_ENQ</a> | <a name="a138"></a><a class="code" href="rte__ring_8h.html#a421a61b2f94cdf65b3a6ac146c492fb9">RING_F_SC_DEQ</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vpool_array[index].ring != NULL)) {</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in setup_mempool_tbl: mbuf count in &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;mempool is: %d\n&quot;</span>,</div>
<div class="line">                <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool_array[index].pool));</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in setup_mempool_tbl: mbuf count in &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;ring   is: %d\n&quot;</span>,</div>
<div class="line">                <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool_array[index].ring));</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;ring_create(%s) failed&quot;</span>,</div>
<div class="line">                ring_name);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Need consider head room. */</span></div>
<div class="line">        vpool_array[index].buf_size = VIRTIO_DESCRIPTOR_LEN_ZCP;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;mempool_create(%s) failed&quot;</span>, pool_name);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* When we receive a INT signal, unregister vhost driver */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sigint_handler(<a name="a139"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Unregister vhost driver. */</span></div>
<div class="line">    <span class="keywordtype">int</span> ret = rte_vhost_driver_unregister((<span class="keywordtype">char</span> *)&amp;dev_basename);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;vhost driver unregister failure.\n&quot;</span>);</div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main function, does initialisation and calls the per-lcore functions. The CUSE</span></div>
<div class="line"><span class="comment"> * device is also registered here to handle the IOCTLs.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id, core_id = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports, valid_num_ports;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    uint16_t queue_id;</div>
<div class="line">    <span class="keyword">static</span> pthread_t tid;</div>
<div class="line">    <span class="keywordtype">char</span> thread_name[RTE_MAX_THREAD_NAME_LEN];</div>
<div class="line"></div>
<div class="line">    signal(SIGINT, sigint_handler);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a140"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse app arguments */</span></div>
<div class="line">    ret = us_vhost_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid argument\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id ++)</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a141"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            lcore_ids[core_id ++] = lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>() &gt; RTE_MAX_LCORE)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,<span class="stringliteral">&quot;Not enough cores\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*set the number of swithcing cores available*/</span></div>
<div class="line">    num_switching_cores = <a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>()-1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the number of physical ports. */</span></div>
<div class="line">    nb_ports = <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        nb_ports = RTE_MAX_ETHPORTS;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Update the global var NUM_PORTS and global array PORTS</span></div>
<div class="line"><span class="comment">     * and get value of var VALID_NUM_PORTS according to system ports number</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    valid_num_ports = check_ports_num(nb_ports);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((valid_num_ports ==  0) || (valid_num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy == 0) {</div>
<div class="line">        <span class="comment">/* Create the mbuf pool. */</span></div>
<div class="line">        mbuf_pool = <a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;MBUF_POOL&quot;</span>,</div>
<div class="line">            NUM_MBUFS_PER_PORT * valid_num_ports, MBUF_CACHE_SIZE,</div>
<div class="line">            0, MBUF_DATA_SIZE, <a name="a142"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line">        <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (queue_id = 0; queue_id &lt; MAX_QUEUES + 1; queue_id++)</div>
<div class="line">            vpool_array[queue_id].pool = mbuf_pool;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (vm2vm_mode == VM2VM_HARDWARE) {</div>
<div class="line">            <span class="comment">/* Enable VT loop back to let L2 switch to do it. */</span></div>
<div class="line">            vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>.enable_loop_back = 1;</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Enable loop back for L2 switch in vmdq.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        uint32_t nb_mbuf;</div>
<div class="line">        <span class="keywordtype">char</span> pool_name[<a name="a143"></a><a class="code" href="rte__mempool_8h.html#af6e5aa92b19f0f8d981b7016264456d7">RTE_MEMPOOL_NAMESIZE</a>];</div>
<div class="line">        <span class="keywordtype">char</span> ring_name[<a class="code" href="rte__mempool_8h.html#af6e5aa92b19f0f8d981b7016264456d7">RTE_MEMPOOL_NAMESIZE</a>];</div>
<div class="line"></div>
<div class="line">        nb_mbuf = num_rx_descriptor</div>
<div class="line">            + num_switching_cores * MBUF_CACHE_SIZE_ZCP</div>
<div class="line">            + num_switching_cores * MAX_PKT_BURST;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (queue_id = 0; queue_id &lt; MAX_QUEUES; queue_id++) {</div>
<div class="line">            snprintf(pool_name, <span class="keyword">sizeof</span>(pool_name),</div>
<div class="line">                <span class="stringliteral">&quot;rxmbuf_pool_%u&quot;</span>, queue_id);</div>
<div class="line">            snprintf(ring_name, <span class="keyword">sizeof</span>(ring_name),</div>
<div class="line">                <span class="stringliteral">&quot;rxmbuf_ring_%u&quot;</span>, queue_id);</div>
<div class="line">            setup_mempool_tbl(<a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>(), queue_id,</div>
<div class="line">                pool_name, ring_name, nb_mbuf);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        nb_mbuf = num_tx_descriptor</div>
<div class="line">                + num_switching_cores * MBUF_CACHE_SIZE_ZCP</div>
<div class="line">                + num_switching_cores * MAX_PKT_BURST;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (queue_id = 0; queue_id &lt; MAX_QUEUES; queue_id++) {</div>
<div class="line">            snprintf(pool_name, <span class="keyword">sizeof</span>(pool_name),</div>
<div class="line">                <span class="stringliteral">&quot;txmbuf_pool_%u&quot;</span>, queue_id);</div>
<div class="line">            snprintf(ring_name, <span class="keyword">sizeof</span>(ring_name),</div>
<div class="line">                <span class="stringliteral">&quot;txmbuf_ring_%u&quot;</span>, queue_id);</div>
<div class="line">            setup_mempool_tbl(<a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>(),</div>
<div class="line">                (queue_id + MAX_QUEUES),</div>
<div class="line">                pool_name, ring_name, nb_mbuf);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (vm2vm_mode == VM2VM_HARDWARE) {</div>
<div class="line">            <span class="comment">/* Enable VT loop back to let L2 switch to do it. */</span></div>
<div class="line">            vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>.enable_loop_back = 1;</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Enable loop back for L2 switch in vmdq.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Set log level. */</span></div>
<div class="line">    <a name="a144"></a><a class="code" href="rte__log_8h.html#a621efed26cc11c49517acfdd19f0a82f">rte_set_log_level</a>(LOG_LEVEL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Skipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (port_init(portid) != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot initialize network ports\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise all linked lists. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init_data_ll() == -1)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Failed to initialize linked list\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics, 0, <span class="keyword">sizeof</span>(dev_statistics));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable stats if the user option is set. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        ret = pthread_create(&amp;tid, NULL, (<span class="keywordtype">void</span> *)print_stats, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot create print-stats thread\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Set thread_name for aid in debugging.  */</span></div>
<div class="line">        snprintf(thread_name, RTE_MAX_THREAD_NAME_LEN, <span class="stringliteral">&quot;print-stats&quot;</span>);</div>
<div class="line">        ret = <a name="a145"></a><a class="code" href="rte__lcore_8h.html#ac33f55612c0a95f6066e3fdc5886bfed">rte_thread_setname</a>(tid, thread_name);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot set print-stats name\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Launch all data cores. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (zero_copy == 0) {</div>
<div class="line">        <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">            <a name="a146"></a><a class="code" href="rte__launch_8h.html#a7456c48bfd011b04cc1c17baac5aa058">rte_eal_remote_launch</a>(switch_worker,</div>
<div class="line">                mbuf_pool, lcore_id);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        uint32_t count_in_mempool, index, i;</div>
<div class="line">        <span class="keywordflow">for</span> (index = 0; index &lt; 2*MAX_QUEUES; index++) {</div>
<div class="line">            <span class="comment">/* For all RX and TX queues. */</span></div>
<div class="line">            count_in_mempool</div>
<div class="line">                = <a class="code" href="rte__mempool_8h.html#a4e1c868324f15c80e1956ee87249704b">rte_mempool_count</a>(vpool_array[index].pool);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * Transfer all un-attached mbufs from vpool.pool</span></div>
<div class="line"><span class="comment">             * to vpoo.ring.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; count_in_mempool; i++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf</div>
<div class="line">                    = __rte_mbuf_raw_alloc(</div>
<div class="line">                        vpool_array[index].<a class="code" href="structrte__mbuf.html#aa501505ef15ed551bf0a2ffacfc29bb5">pool</a>);</div>
<div class="line">                <a class="code" href="rte__ring_8h.html#a644b1d6866fed20f0a5711e63ecefc38">rte_ring_sp_enqueue</a>(vpool_array[index].ring,</div>
<div class="line">                        (<span class="keywordtype">void</span> *)mbuf);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in main: mbuf count in mempool at initial &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;is: %d\n&quot;</span>, count_in_mempool);</div>
<div class="line">            LOG_DEBUG(VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;in main: mbuf count in  ring at initial  is :&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; %d\n&quot;</span>,</div>
<div class="line">                <a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(vpool_array[index].ring));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id)</div>
<div class="line">            <a class="code" href="rte__launch_8h.html#a7456c48bfd011b04cc1c17baac5aa058">rte_eal_remote_launch</a>(switch_worker_zcp, NULL,</div>
<div class="line">                lcore_id);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    if (mergeable == 0)</div>
<div class="line">        <a class="code" href="rte__virtio__net_8h.html#a3f23978b601f32fec3e70d36395f2856">rte_vhost_feature_disable</a>(1ULL &lt;&lt; VIRTIO_NET_F_MRG_RXBUF);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Register vhost(cuse or user) driver to handle vhost messages. */</span></div>
<div class="line">    ret = rte_vhost_driver_register((<span class="keywordtype">char</span> *)&amp;dev_basename);</div>
<div class="line">    if (ret != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, &quot;vhost driver register failure.\n&quot;);</div>
<div class="line"></div>
<div class="line">    rte_vhost_driver_callback_register(&amp;virtio_net_device_ops);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start CUSE session. */</span></div>
<div class="line">    rte_vhost_driver_session_start();</div>
<div class="line">    return 0;</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
