<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: netmap_compat/lib/compat_netmap.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">netmap_compat/lib/compat_netmap.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;poll.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;net/if.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/resource.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__errno_8h.html">rte_errno.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__spinlock_8h.html">rte_spinlock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;compat_netmap.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>netmap_port {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mempool.html">rte_mempool</a>   *pool;</div>
<div class="line">    <span class="keyword">struct </span>netmap_if     *nmif;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a>   eth_conf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> tx_conf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a3"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> rx_conf;</div>
<div class="line">    int32_t  socket_id;</div>
<div class="line">    uint16_t nr_tx_rings;</div>
<div class="line">    uint16_t nr_rx_rings;</div>
<div class="line">    uint32_t nr_tx_slots;</div>
<div class="line">    uint32_t nr_rx_slots;</div>
<div class="line">    uint16_t tx_burst;</div>
<div class="line">    uint16_t rx_burst;</div>
<div class="line">    uint32_t fd;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>fd_port {</div>
<div class="line">    uint32_t <a name="_a4"></a><a class="code" href="structport.html">port</a>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef POLLRDNORM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POLLRDNORM  0x0040</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef POLLWRNORM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POLLWRNORM  0x0100</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define FD_PORT_FREE    UINT32_MAX</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FD_PORT_RSRV    (FD_PORT_FREE - 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>netmap_state {</div>
<div class="line">    <span class="keyword">struct </span>rte_netmap_conf conf;</div>
<div class="line">    uintptr_t buf_start;</div>
<div class="line">    <span class="keywordtype">void</span>     *mem;</div>
<div class="line">    uint32_t  mem_sz;</div>
<div class="line">    uint32_t  netif_memsz;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define COMPAT_NETMAP_MAX_NOFILE    (2 * RTE_MAX_ETHPORTS)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define COMPAT_NETMAP_MAX_BURST     64</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define COMPAT_NETMAP_MAX_PKT_PER_SYNC  (2 * COMPAT_NETMAP_MAX_BURST)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>netmap_port ports[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>netmap_state netmap;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>fd_port fd_port[COMPAT_NETMAP_MAX_NOFILE];</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> next_fd_start = RLIMIT_NOFILE + 1;</div>
<div class="line"><span class="keyword">static</span> <a name="_a5"></a><a class="code" href="structrte__spinlock__t.html">rte_spinlock_t</a> netmap_lock;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define IDX_TO_FD(x)    ((x) + next_fd_start)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FD_TO_IDX(x)    ((x) - next_fd_start)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FD_VALID(x) ((x) &gt;= next_fd_start &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (x) &lt; (typeof (x))(RTE_DIM(fd_port) + next_fd_start))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define PORT_NUM_RINGS  (2 * netmap.conf.max_rings)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PORT_NUM_SLOTS  (PORT_NUM_RINGS * netmap.conf.max_slots)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BUF_IDX(port, ring, slot)            \</span></div>
<div class="line"><span class="preprocessor">    (((port) * PORT_NUM_RINGS + (ring)) * netmap.conf.max_slots + \</span></div>
<div class="line"><span class="preprocessor">    (slot))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define NETMAP_IF_RING_OFS(rid, rings, slots)   ({\</span></div>
<div class="line"><span class="preprocessor">    struct netmap_if *_if;                    \</span></div>
<div class="line"><span class="preprocessor">    struct netmap_ring *_rg;                  \</span></div>
<div class="line"><span class="preprocessor">    sizeof(*_if) +                            \</span></div>
<div class="line"><span class="preprocessor">    (rings) * sizeof(_if-&gt;ring_ofs[0]) +      \</span></div>
<div class="line"><span class="preprocessor">    (rid) * sizeof(*_rg) +                    \</span></div>
<div class="line"><span class="preprocessor">    (slots) * sizeof(_rg-&gt;slot[0]);           \</span></div>
<div class="line"><span class="preprocessor">    })</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> netmap_unregif(uint32_t idx, uint32_t <a class="code" href="structport.html">port</a>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int32_t</div>
<div class="line">ifname_to_portid(<span class="keyword">const</span> <span class="keywordtype">char</span> *ifname, uint8_t *<a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *endptr;</div>
<div class="line">    uint64_t portid;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line">    portid = strtoul(ifname, &amp;endptr, 10);</div>
<div class="line">    <span class="keywordflow">if</span> (endptr == ifname || *endptr != <span class="charliteral">&#39;\0&#39;</span> ||</div>
<div class="line">            portid &gt;= <a name="a6"></a><a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) || errno != 0)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"></div>
<div class="line">    *port = (uint8_t)portid;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">mbuf_to_slot(<span class="keyword">struct</span> <a name="_a7"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf, <span class="keyword">struct</span> netmap_ring *r, uint32_t index)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *data;</div>
<div class="line">    uint16_t length;</div>
<div class="line"></div>
<div class="line">    data   = <a name="a8"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf, <span class="keywordtype">char</span> *);</div>
<div class="line">    length = <a name="a9"></a><a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (length &gt; r-&gt;nr_buf_size)</div>
<div class="line">        length = 0;</div>
<div class="line"></div>
<div class="line">    r-&gt;slot[index].len = length;</div>
<div class="line">    <a name="a10"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(NETMAP_BUF(r, r-&gt;slot[index].buf_idx), data, length);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">slot_to_mbuf(<span class="keyword">struct</span> netmap_ring *r, uint32_t index, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *data;</div>
<div class="line">    uint16_t length;</div>
<div class="line"></div>
<div class="line">    <a name="a11"></a><a class="code" href="rte__mbuf_8h.html#afc84d82d50361f568dd1d3a0e95d4aa4">rte_pktmbuf_reset</a>(mbuf);</div>
<div class="line">    length = r-&gt;slot[index].len;</div>
<div class="line">    data = <a name="a12"></a><a class="code" href="rte__mbuf_8h.html#ad5b0cd686ad3bcbb83416ca8395a080b">rte_pktmbuf_append</a>(mbuf, length);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (data != NULL)</div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(data, NETMAP_BUF(r, r-&gt;slot[index].buf_idx), length);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int32_t</div>
<div class="line">fd_reserve(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i != <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(fd_port) &amp;&amp; fd_port[i].port != FD_PORT_FREE;</div>
<div class="line">            i++)</div>
<div class="line">        ;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (i == <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(fd_port))</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"></div>
<div class="line">    fd_port[i].port = FD_PORT_RSRV;</div>
<div class="line">    <span class="keywordflow">return</span> IDX_TO_FD(i);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int32_t</div>
<div class="line">fd_release(int32_t fd)</div>
<div class="line">{</div>
<div class="line">    uint32_t idx, port;</div>
<div class="line"></div>
<div class="line">    idx = FD_TO_IDX(fd);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!FD_VALID(fd) || (port = fd_port[idx].port) == FD_PORT_FREE)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if we still have a valid port attached, release the port */</span></div>
<div class="line">    <span class="keywordflow">if</span> (port &lt; <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) &amp;&amp; ports[port].fd == idx) {</div>
<div class="line">        netmap_unregif(idx, port);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fd_port[idx].port = FD_PORT_FREE;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">check_nmreq(<span class="keyword">struct</span> nmreq *req, uint8_t *port)</div>
<div class="line">{</div>
<div class="line">    int32_t rc;</div>
<div class="line">    uint8_t portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (req == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (req-&gt;nr_version != NETMAP_API) {</div>
<div class="line">        req-&gt;nr_version = NETMAP_API;</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((rc = ifname_to_portid(req-&gt;nr_name, &amp;portid)) != 0) {</div>
<div class="line">            <a name="a13"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;Invalid interface name:\&quot;%s\&quot; &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;in NIOCGINFO call\n&quot;</span>, req-&gt;nr_name);</div>
<div class="line">        <span class="keywordflow">return</span> rc;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ports[portid].pool == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;Misconfigured portid %hhu\n&quot;</span>, portid);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    *port = portid;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ioctl_niocginfo(<a name="a14"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> * param)</div>
<div class="line">{</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keyword">struct </span>nmreq *req;</div>
<div class="line">    int32_t rc;</div>
<div class="line"></div>
<div class="line">    req = (<span class="keyword">struct </span>nmreq *)param;</div>
<div class="line">    <span class="keywordflow">if</span> ((rc = check_nmreq(req, &amp;portid)) != 0)</div>
<div class="line">        <span class="keywordflow">return</span> rc;</div>
<div class="line"></div>
<div class="line">    req-&gt;nr_tx_rings = (uint16_t)(ports[portid].nr_tx_rings - 1);</div>
<div class="line">    req-&gt;nr_rx_rings = (uint16_t)(ports[portid].nr_rx_rings - 1);</div>
<div class="line">    req-&gt;nr_tx_slots = ports[portid].nr_tx_slots;</div>
<div class="line">    req-&gt;nr_rx_slots = ports[portid].nr_rx_slots;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* in current implementation we have all NETIFs shared aone region. */</span></div>
<div class="line">    req-&gt;nr_memsize = netmap.mem_sz;</div>
<div class="line">    req-&gt;nr_offset = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">netmap_ring_setup(<span class="keyword">struct</span> netmap_ring *ring, uint8_t port, uint32_t ringid,</div>
<div class="line">    uint32_t num_slots)</div>
<div class="line">{</div>
<div class="line">    uint32_t j;</div>
<div class="line"></div>
<div class="line">    ring-&gt;buf_ofs = netmap.buf_start - (uintptr_t)ring;</div>
<div class="line">    ring-&gt;num_slots = num_slots;</div>
<div class="line">    ring-&gt;cur = 0;</div>
<div class="line">    ring-&gt;reserved = 0;</div>
<div class="line">    ring-&gt;nr_buf_size = netmap.conf.max_bufsz;</div>
<div class="line">    ring-&gt;flags = 0;</div>
<div class="line">    ring-&gt;ts.tv_sec = 0;</div>
<div class="line">    ring-&gt;ts.tv_usec = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; ring-&gt;num_slots; j++) {</div>
<div class="line">        ring-&gt;slot[j].buf_idx = BUF_IDX(port, ringid, j);</div>
<div class="line">        ring-&gt;slot[j].len = 0;</div>
<div class="line">        ring-&gt;flags = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">netmap_regif(<span class="keyword">struct</span> nmreq *req, uint32_t idx, uint8_t port)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>netmap_if *nmif;</div>
<div class="line">    <span class="keyword">struct </span>netmap_ring *ring;</div>
<div class="line">    uint32_t i, slots, start_ring;</div>
<div class="line">    int32_t rc;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ports[port].fd &lt; <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(fd_port)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;port %hhu already in use by fd: %u\n&quot;</span>,</div>
<div class="line">            port, IDX_TO_FD(ports[port].fd));</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (fd_port[idx].port != FD_PORT_RSRV) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;fd: %u is misconfigured\n&quot;</span>,</div>
<div class="line">            IDX_TO_FD(idx));</div>
<div class="line">        <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    nmif = ports[port].nmif;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* setup netmap_if fields. */</span></div>
<div class="line">    memset(nmif, 0, netmap.netif_memsz);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* only ALL rings supported right now. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (req-&gt;nr_ringid != 0)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"></div>
<div class="line">    snprintf(nmif-&gt;ni_name, <span class="keyword">sizeof</span>(nmif-&gt;ni_name), <span class="stringliteral">&quot;%s&quot;</span>, req-&gt;nr_name);</div>
<div class="line">    nmif-&gt;ni_version  = req-&gt;nr_version;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Netmap uses ni_(r|t)x_rings + 1 */</span></div>
<div class="line">    nmif-&gt;ni_rx_rings = ports[port].nr_rx_rings - 1;</div>
<div class="line">    nmif-&gt;ni_tx_rings = ports[port].nr_tx_rings - 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Setup TX rings and slots.</span></div>
<div class="line"><span class="comment">     * Refer to the comments in netmap.h for details</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line"></div>
<div class="line">    slots = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nmif-&gt;ni_tx_rings + 1; i++) {</div>
<div class="line"></div>
<div class="line">        nmif-&gt;ring_ofs[i] = NETMAP_IF_RING_OFS(i,</div>
<div class="line">            PORT_NUM_RINGS, slots);</div>
<div class="line"></div>
<div class="line">        ring = NETMAP_TXRING(nmif, i);</div>
<div class="line">        netmap_ring_setup(ring, port, i, ports[port].nr_tx_slots);</div>
<div class="line">        ring-&gt;avail = ring-&gt;num_slots;</div>
<div class="line"></div>
<div class="line">        slots += ports[port].nr_tx_slots;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Setup  RX rings and slots.</span></div>
<div class="line"><span class="comment">     * Refer to the comments in netmap.h for details</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line"></div>
<div class="line">    start_ring = i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (; i &lt; nmif-&gt;ni_rx_rings + 1 + start_ring; i++) {</div>
<div class="line"></div>
<div class="line">        nmif-&gt;ring_ofs[i] = NETMAP_IF_RING_OFS(i,</div>
<div class="line">            PORT_NUM_RINGS, slots);</div>
<div class="line"></div>
<div class="line">        ring = NETMAP_RXRING(nmif, (i - start_ring));</div>
<div class="line">        netmap_ring_setup(ring, port, i, ports[port].nr_rx_slots);</div>
<div class="line">        ring-&gt;avail = 0;</div>
<div class="line"></div>
<div class="line">        slots += ports[port].nr_rx_slots;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((rc = <a name="a15"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port)) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1,</div>
<div class="line">            <span class="stringliteral">&quot;Couldn&#39;t start ethernet device %s (error %d)\n&quot;</span>,</div>
<div class="line">            req-&gt;nr_name, rc);</div>
<div class="line">        <span class="keywordflow">return</span> rc;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* setup fdi &lt;--&gt; port relationtip. */</span></div>
<div class="line">    ports[port].fd = idx;</div>
<div class="line">    fd_port[idx].port = port;</div>
<div class="line"></div>
<div class="line">    req-&gt;nr_memsize = netmap.mem_sz;</div>
<div class="line">    req-&gt;nr_offset = (uintptr_t)nmif - (uintptr_t)netmap.mem;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ioctl_niocregif(int32_t fd, <span class="keywordtype">void</span> * param)</div>
<div class="line">{</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    int32_t rc;</div>
<div class="line">    uint32_t idx;</div>
<div class="line">    <span class="keyword">struct </span>nmreq *req;</div>
<div class="line"></div>
<div class="line">    req = (<span class="keyword">struct </span>nmreq *)param;</div>
<div class="line">    <span class="keywordflow">if</span> ((rc = check_nmreq(req, &amp;portid)) != 0)</div>
<div class="line">        <span class="keywordflow">return</span> rc;</div>
<div class="line"></div>
<div class="line">    idx = FD_TO_IDX(fd);</div>
<div class="line"></div>
<div class="line">    <a name="a16"></a><a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;netmap_lock);</div>
<div class="line">    rc = netmap_regif(req, idx, portid);</div>
<div class="line">    <a name="a17"></a><a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;netmap_lock);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">netmap_unregif(uint32_t idx, uint32_t port)</div>
<div class="line">{</div>
<div class="line">    fd_port[idx].port = FD_PORT_RSRV;</div>
<div class="line">    ports[port].fd = UINT32_MAX;</div>
<div class="line">    <a name="a18"></a><a class="code" href="rte__ethdev_8h.html#a322fa275f154022db7bce02ee95e5612">rte_eth_dev_stop</a>((uint8_t)port);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ioctl_niocunregif(<span class="keywordtype">int</span> fd)</div>
<div class="line">{</div>
<div class="line">    uint32_t idx, port;</div>
<div class="line">    int32_t rc;</div>
<div class="line"></div>
<div class="line">    idx = FD_TO_IDX(fd);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;netmap_lock);</div>
<div class="line"></div>
<div class="line">    port = fd_port[idx].port;</div>
<div class="line">    <span class="keywordflow">if</span> (port &lt; <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) &amp;&amp; ports[port].fd == idx) {</div>
<div class="line">        netmap_unregif(idx, port);</div>
<div class="line">        rc = 0;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1,</div>
<div class="line">            <span class="stringliteral">&quot;%s: %d is not associated with valid port\n&quot;</span>,</div>
<div class="line">            __func__, fd);</div>
<div class="line">        rc = -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;netmap_lock);</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">rx_sync_ring(<span class="keyword">struct</span> netmap_ring *ring, uint8_t port, uint16_t ring_number,</div>
<div class="line">    uint16_t max_burst)</div>
<div class="line">{</div>
<div class="line">    int32_t i, n_rx;</div>
<div class="line">    uint16_t burst_size;</div>
<div class="line">    uint32_t cur_slot, n_free_slots;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *rx_mbufs[COMPAT_NETMAP_MAX_BURST];</div>
<div class="line"></div>
<div class="line">    n_free_slots = ring-&gt;num_slots - (ring-&gt;avail + ring-&gt;reserved);</div>
<div class="line">    n_free_slots = <a name="a19"></a><a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(n_free_slots, max_burst);</div>
<div class="line">    cur_slot = (ring-&gt;cur + ring-&gt;avail) &amp; (ring-&gt;num_slots - 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (n_free_slots) {</div>
<div class="line">        burst_size = (uint16_t)<a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(n_free_slots, <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(rx_mbufs));</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* receive up to burst_size packets from the NIC&#39;s queue */</span></div>
<div class="line">        n_rx = <a name="a20"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(port, ring_number, rx_mbufs,</div>
<div class="line">            burst_size);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (n_rx == 0)</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a21"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_rx &lt; 0))</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Put those n_rx packets in the Netmap structures */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; n_rx ; i++) {</div>
<div class="line">            mbuf_to_slot(rx_mbufs[i], ring, cur_slot);</div>
<div class="line">            <a name="a22"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(rx_mbufs[i]);</div>
<div class="line">            cur_slot = NETMAP_RING_NEXT(ring, cur_slot);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update the Netmap ring structure to reflect the change */</span></div>
<div class="line">        ring-&gt;avail += n_rx;</div>
<div class="line">        n_free_slots -= n_rx;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">rx_sync_if(uint32_t port)</div>
<div class="line">{</div>
<div class="line">    uint16_t burst;</div>
<div class="line">    uint32_t i, rc;</div>
<div class="line">    <span class="keyword">struct </span>netmap_if *nifp;</div>
<div class="line">    <span class="keyword">struct </span>netmap_ring *r;</div>
<div class="line"></div>
<div class="line">    nifp = ports[port].nmif;</div>
<div class="line">    burst = ports[port].rx_burst;</div>
<div class="line">    rc = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nifp-&gt;ni_rx_rings + 1; i++) {</div>
<div class="line">        r = NETMAP_RXRING(nifp, i);</div>
<div class="line">        rx_sync_ring(r, (uint8_t)port, (uint16_t)i, burst);</div>
<div class="line">        rc += r-&gt;avail;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ioctl_niocrxsync(<span class="keywordtype">int</span> fd)</div>
<div class="line">{</div>
<div class="line">    uint32_t idx, port;</div>
<div class="line"></div>
<div class="line">    idx = FD_TO_IDX(fd);</div>
<div class="line">    <span class="keywordflow">if</span> ((port = fd_port[idx].port) &lt; <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) &amp;&amp;</div>
<div class="line">            ports[port].fd == idx) {</div>
<div class="line">        <span class="keywordflow">return</span> rx_sync_if(fd_port[idx].port);</div>
<div class="line">    } <span class="keywordflow">else</span>  {</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">tx_sync_ring(<span class="keyword">struct</span> netmap_ring *ring, uint8_t port, uint16_t ring_number,</div>
<div class="line">    <span class="keyword">struct</span> <a class="code" href="structrte__mempool.html">rte_mempool</a> *pool, uint16_t max_burst)</div>
<div class="line">{</div>
<div class="line">    uint32_t i, n_tx;</div>
<div class="line">    uint16_t burst_size;</div>
<div class="line">    uint32_t cur_slot, n_used_slots;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *tx_mbufs[COMPAT_NETMAP_MAX_BURST];</div>
<div class="line"></div>
<div class="line">    n_used_slots = ring-&gt;num_slots - ring-&gt;avail;</div>
<div class="line">    n_used_slots = <a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(n_used_slots, max_burst);</div>
<div class="line">    cur_slot = (ring-&gt;cur + ring-&gt;avail) &amp; (ring-&gt;num_slots - 1);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (n_used_slots) {</div>
<div class="line">        burst_size = (uint16_t)<a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(n_used_slots, <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tx_mbufs));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; burst_size; i++) {</div>
<div class="line">            tx_mbufs[i] = <a name="a23"></a><a class="code" href="rte__mbuf_8h.html#ad4d1c289d8cffc831dfb77c64f52447b">rte_pktmbuf_alloc</a>(pool);</div>
<div class="line">            <span class="keywordflow">if</span> (tx_mbufs[i] == NULL)</div>
<div class="line">                <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">            slot_to_mbuf(ring, cur_slot, tx_mbufs[i]);</div>
<div class="line">            cur_slot = NETMAP_RING_NEXT(ring, cur_slot);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        n_tx = <a name="a24"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port, ring_number, tx_mbufs,</div>
<div class="line">            burst_size);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update the Netmap ring structure to reflect the change */</span></div>
<div class="line">        ring-&gt;avail += n_tx;</div>
<div class="line">        n_used_slots -= n_tx;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Return the mbufs that failed to transmit to their pool */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_tx != burst_size)) {</div>
<div class="line">            <span class="keywordflow">for</span> (i = n_tx; i &lt; burst_size; i++)</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(tx_mbufs[i]);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">err:</div>
<div class="line">    <span class="keywordflow">for</span> (; i == 0; --i)</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(tx_mbufs[i]);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1,</div>
<div class="line">        <span class="stringliteral">&quot;Couldn&#39;t get mbuf from mempool is the mempool too small?\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">tx_sync_if(uint32_t port)</div>
<div class="line">{</div>
<div class="line">    uint16_t burst;</div>
<div class="line">    uint32_t i, rc;</div>
<div class="line">    <span class="keyword">struct </span>netmap_if *nifp;</div>
<div class="line">    <span class="keyword">struct </span>netmap_ring *r;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *<a name="a25"></a><a class="code" href="rte__cryptodev_8h.html#a9f6b27bed19dd1bf3cff6af57d7cf86f">mp</a>;</div>
<div class="line"></div>
<div class="line">    nifp = ports[port].nmif;</div>
<div class="line">    mp = ports[port].pool;</div>
<div class="line">    burst = ports[port].tx_burst;</div>
<div class="line">    rc = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nifp-&gt;ni_tx_rings + 1; i++) {</div>
<div class="line">        r = NETMAP_TXRING(nifp, i);</div>
<div class="line">        tx_sync_ring(r, (uint8_t)port, (uint16_t)i, mp, burst);</div>
<div class="line">        rc += r-&gt;avail;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">ioctl_nioctxsync(<span class="keywordtype">int</span> fd)</div>
<div class="line">{</div>
<div class="line">    uint32_t idx, port;</div>
<div class="line"></div>
<div class="line">    idx = FD_TO_IDX(fd);</div>
<div class="line">    <span class="keywordflow">if</span> ((port = fd_port[idx].port) &lt; <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) &amp;&amp;</div>
<div class="line">            ports[port].fd == idx) {</div>
<div class="line">        <span class="keywordflow">return</span> tx_sync_if(fd_port[idx].port);</div>
<div class="line">    } <span class="keywordflow">else</span>  {</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">rte_netmap_init(<span class="keyword">const</span> <span class="keyword">struct</span> rte_netmap_conf *conf)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> buf_ofs, nmif_sz, sz;</div>
<div class="line">    <span class="keywordtype">size_t</span> port_rings, port_slots, port_bufs;</div>
<div class="line">    uint32_t i, port_num;</div>
<div class="line"></div>
<div class="line">    port_num = RTE_MAX_ETHPORTS;</div>
<div class="line">    port_rings = 2 * conf-&gt;max_rings;</div>
<div class="line">    port_slots = port_rings * conf-&gt;max_slots;</div>
<div class="line">    port_bufs = port_slots;</div>
<div class="line"></div>
<div class="line">    nmif_sz = NETMAP_IF_RING_OFS(port_rings, port_rings, port_slots);</div>
<div class="line">    sz = nmif_sz * port_num;</div>
<div class="line"></div>
<div class="line">    buf_ofs = <a name="a26"></a><a class="code" href="rte__common_8h.html#a856650153655096752b4c2a29690a15d">RTE_ALIGN_CEIL</a>(sz, RTE_CACHE_LINE_SIZE);</div>
<div class="line">    sz = buf_ofs + port_bufs * conf-&gt;max_bufsz * port_num;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (sz &gt; UINT32_MAX ||</div>
<div class="line">            (netmap.mem = <a name="a27"></a><a class="code" href="rte__malloc_8h.html#aabfa4bb0c1430eb7be96bf847f61113a">rte_zmalloc_socket</a>(__func__, sz,</div>
<div class="line">            RTE_CACHE_LINE_SIZE, conf-&gt;socket_id)) == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;%s: failed to allocate %zu bytes\n&quot;</span>,</div>
<div class="line">            __func__, sz);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    netmap.mem_sz = sz;</div>
<div class="line">    netmap.netif_memsz = nmif_sz;</div>
<div class="line">    netmap.buf_start = (uintptr_t)netmap.mem + buf_ofs;</div>
<div class="line">    netmap.conf = *conf;</div>
<div class="line"></div>
<div class="line">    <a name="a28"></a><a class="code" href="rte__spinlock_8h.html#af3ff11ac862ee94491533486fc0d959c">rte_spinlock_init</a>(&amp;netmap_lock);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Mark all ports as unused and set NETIF pointer. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i != <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports); i++) {</div>
<div class="line">        ports[i].fd = UINT32_MAX;</div>
<div class="line">        ports[i].nmif = (<span class="keyword">struct </span>netmap_if *)</div>
<div class="line">            ((uintptr_t)netmap.mem + nmif_sz * i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Mark all fd_ports as unused. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i != <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(fd_port); i++) {</div>
<div class="line">        fd_port[i].port = FD_PORT_FREE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">rte_netmap_init_port(uint8_t portid, <span class="keyword">const</span> <span class="keyword">struct</span> rte_netmap_port_conf *conf)</div>
<div class="line">{</div>
<div class="line">    int32_t ret;</div>
<div class="line">    uint16_t i;</div>
<div class="line">    uint16_t rx_slots, tx_slots;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (conf == NULL ||</div>
<div class="line">            portid &gt;= <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) ||</div>
<div class="line">            conf-&gt;nr_tx_rings &gt; netmap.conf.max_rings ||</div>
<div class="line">            conf-&gt;nr_rx_rings &gt; netmap.conf.max_rings) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;%s(%hhu): invalid parameters\n&quot;</span>,</div>
<div class="line">            __func__, portid);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">        rx_slots = (uint16_t)<a name="a29"></a><a class="code" href="rte__common_8h.html#a5a85fd1038be9376de166494057e6aa1">rte_align32pow2</a>(conf-&gt;nr_rx_slots);</div>
<div class="line">        tx_slots = (uint16_t)<a class="code" href="rte__common_8h.html#a5a85fd1038be9376de166494057e6aa1">rte_align32pow2</a>(conf-&gt;nr_tx_slots);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (tx_slots &gt; netmap.conf.max_slots ||</div>
<div class="line">            rx_slots &gt; netmap.conf.max_slots) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;%s(%hhu): invalid parameters\n&quot;</span>,</div>
<div class="line">            __func__, portid);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a name="a30"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(portid, conf-&gt;nr_rx_rings,</div>
<div class="line">        conf-&gt;nr_tx_rings, conf-&gt;eth_conf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1, <span class="stringliteral">&quot;Couldn&#39;t configure port %hhu\n&quot;</span>, portid);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; conf-&gt;nr_tx_rings; i++) {</div>
<div class="line">        ret = <a name="a31"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(portid, i, tx_slots,</div>
<div class="line">            conf-&gt;socket_id, NULL);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1,</div>
<div class="line">                <span class="stringliteral">&quot;Couldn&#39;t configure TX queue %&quot;</span>PRIu16<span class="stringliteral">&quot; of &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port %&quot;</span>PRIu8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                i, portid);</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = <a name="a32"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(portid, i, rx_slots,</div>
<div class="line">            conf-&gt;socket_id, NULL, conf-&gt;pool);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, USER1,</div>
<div class="line">                <span class="stringliteral">&quot;Couldn&#39;t configure RX queue %&quot;</span>PRIu16<span class="stringliteral">&quot; of &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port %&quot;</span>PRIu8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                i, portid);</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* copy config to the private storage. */</span></div>
<div class="line">    ports[portid].eth_conf = conf-&gt;eth_conf[0];</div>
<div class="line">    ports[portid].pool = conf-&gt;pool;</div>
<div class="line">    ports[portid].socket_id = conf-&gt;socket_id;</div>
<div class="line">    ports[portid].nr_tx_rings = conf-&gt;nr_tx_rings;</div>
<div class="line">    ports[portid].nr_rx_rings = conf-&gt;nr_rx_rings;</div>
<div class="line">    ports[portid].nr_tx_slots = tx_slots;</div>
<div class="line">    ports[portid].nr_rx_slots = rx_slots;</div>
<div class="line">    ports[portid].tx_burst = conf-&gt;tx_burst;</div>
<div class="line">    ports[portid].rx_burst = conf-&gt;rx_burst;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">rte_netmap_close(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> fd)</div>
<div class="line">{</div>
<div class="line">    int32_t rc;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;netmap_lock);</div>
<div class="line">    rc = fd_release(fd);</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;netmap_lock);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rc &lt; 0) {</div>
<div class="line">        errno =-rc;</div>
<div class="line">        rc = -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> rte_netmap_ioctl(<span class="keywordtype">int</span> fd, uint32_t op, <span class="keywordtype">void</span> *param)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!FD_VALID(fd)) {</div>
<div class="line">        errno = EBADF;</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (op) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> NIOCGINFO:</div>
<div class="line">            ret = ioctl_niocginfo(fd, param);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> NIOCREGIF:</div>
<div class="line">            ret = ioctl_niocregif(fd, param);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> NIOCUNREGIF:</div>
<div class="line">            ret = ioctl_niocunregif(fd);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> NIOCRXSYNC:</div>
<div class="line">            ret = ioctl_niocrxsync(fd);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> NIOCTXSYNC:</div>
<div class="line">            ret = ioctl_nioctxsync(fd);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            ret = -ENOTTY;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        errno = -ret;</div>
<div class="line">        ret = -1;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        ret = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">rte_netmap_mmap(<span class="keywordtype">void</span> *addr, <span class="keywordtype">size_t</span> length,</div>
<div class="line">    <span class="keywordtype">int</span> prot, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> fd, off_t offset)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> cprot = PROT_WRITE | PROT_READ;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!FD_VALID(fd) || length + offset &gt; netmap.mem_sz ||</div>
<div class="line">            (prot &amp; cprot) != cprot ||</div>
<div class="line">            ((flags &amp; MAP_FIXED) != 0 &amp;&amp; addr != NULL)) {</div>
<div class="line"></div>
<div class="line">        errno = EINVAL;</div>
<div class="line">        <span class="keywordflow">return</span> MAP_FAILED;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)((uintptr_t)netmap.mem + (uintptr_t)offset);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">rte_netmap_open(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *pathname, <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> fd;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;netmap_lock);</div>
<div class="line">    fd = fd_reserve();</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;netmap_lock);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fd &lt; 0) {</div>
<div class="line">        errno = -fd;</div>
<div class="line">        fd = -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> fd;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">rte_netmap_poll(<span class="keyword">struct</span> pollfd *fds, nfds_t nfds, <span class="keywordtype">int</span> timeout)</div>
<div class="line">{</div>
<div class="line">    int32_t count_it, ret;</div>
<div class="line">    uint32_t i, idx, port;</div>
<div class="line">    uint32_t want_rx, want_tx;</div>
<div class="line"></div>
<div class="line">    ret = 0;</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; nfds; i++) {</div>
<div class="line"></div>
<div class="line">            count_it = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!FD_VALID(fds[i].fd) || fds[i].events == 0) {</div>
<div class="line">                fds[i].revents = 0;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            idx = FD_TO_IDX(fds[i].fd);</div>
<div class="line">            <span class="keywordflow">if</span> ((port = fd_port[idx].port) &gt;= <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ports) ||</div>
<div class="line">        ports[port].fd != idx) {</div>
<div class="line"></div>
<div class="line">                fds[i].revents |= POLLERR;</div>
<div class="line">                ret++;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            want_rx = fds[i].events &amp; (POLLIN  | POLLRDNORM);</div>
<div class="line">            want_tx = fds[i].events &amp; (POLLOUT | POLLWRNORM);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (want_rx &amp;&amp; rx_sync_if(port) &gt; 0) {</div>
<div class="line">                fds[i].revents = (uint16_t)</div>
<div class="line">                    (fds[i].revents | want_rx);</div>
<div class="line">                count_it = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (want_tx &amp;&amp; tx_sync_if(port) &gt; 0) {</div>
<div class="line">                fds[i].revents = (uint16_t)</div>
<div class="line">                    (fds[i].revents | want_tx);</div>
<div class="line">                count_it = 1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ret += count_it;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> ((ret == 0 &amp;&amp; timeout &lt; 0) || timeout);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
