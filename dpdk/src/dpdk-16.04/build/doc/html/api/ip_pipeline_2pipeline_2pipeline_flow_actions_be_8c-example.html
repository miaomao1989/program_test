<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: ip_pipeline/pipeline/pipeline_flow_actions_be.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ip_pipeline/pipeline/pipeline_flow_actions_be.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2016 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__table__array_8h.html">rte_table_array.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;pipeline_actions_common.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;pipeline_flow_actions_be.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;parser.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;hash_func.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">pipeline_fa_flow_params_set_default(<span class="keyword">struct</span> pipeline_fa_flow_params *params)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (params == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PIPELINE_FA_N_TC_MAX; i++) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__meter__trtcm__params.html">rte_meter_trtcm_params</a> *m = &amp;params-&gt;m[i];</div>
<div class="line"></div>
<div class="line">        m-&gt;<a name="a1"></a><a class="code" href="structrte__meter__trtcm__params.html#a882cbe4a787376c3a4d55bbf0b6e1f13">cir</a> = 1;</div>
<div class="line">        m-&gt;<a name="a2"></a><a class="code" href="structrte__meter__trtcm__params.html#ad914d97dc6b389901af9ddee395827de">cbs</a> = 1;</div>
<div class="line">        m-&gt;<a name="a3"></a><a class="code" href="structrte__meter__trtcm__params.html#a2acc9a04d3a8ffeeb3b95f142ee15be7">pir</a> = 1;</div>
<div class="line">        m-&gt;<a name="a4"></a><a class="code" href="structrte__meter__trtcm__params.html#aac8f0f5688bed97bc62949c37308b13d">pbs</a> = 2;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PIPELINE_FA_N_TC_MAX; i++) {</div>
<div class="line">        <span class="keyword">struct </span>pipeline_fa_policer_params *p = &amp;params-&gt;p[i];</div>
<div class="line">        uint32_t j;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; <a name="a5"></a><a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3aabc1b9f1c718a0bf520cd06be98c4843f">e_RTE_METER_COLORS</a>; j++) {</div>
<div class="line">            <span class="keyword">struct </span>pipeline_fa_policer_action *a = &amp;p-&gt;action[j];</div>
<div class="line"></div>
<div class="line">            a-&gt;drop = 0;</div>
<div class="line">            a-&gt;color = (<span class="keyword">enum</span> <a name="a6"></a><a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a>) j;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    params-&gt;port_id = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>dscp_entry {</div>
<div class="line">    uint32_t traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>pipeline_flow_actions {</div>
<div class="line">    <span class="keyword">struct </span>pipeline p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_params params;</div>
<div class="line">    pipeline_msg_req_handler custom_handlers[PIPELINE_FA_MSG_REQS];</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>dscp_entry dscp[PIPELINE_FA_N_DSCP];</div>
<div class="line">} <a name="a7"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_custom_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> pipeline_msg_req_handler handlers[] = {</div>
<div class="line">    [PIPELINE_MSG_REQ_PING] =</div>
<div class="line">        pipeline_msg_req_ping_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_STATS_PORT_IN] =</div>
<div class="line">        pipeline_msg_req_stats_port_in_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_STATS_PORT_OUT] =</div>
<div class="line">        pipeline_msg_req_stats_port_out_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_STATS_TABLE] =</div>
<div class="line">        pipeline_msg_req_stats_table_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_PORT_IN_ENABLE] =</div>
<div class="line">        pipeline_msg_req_port_in_enable_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_PORT_IN_DISABLE] =</div>
<div class="line">        pipeline_msg_req_port_in_disable_handler,</div>
<div class="line">    [PIPELINE_MSG_REQ_CUSTOM] =</div>
<div class="line">        pipeline_fa_msg_req_custom_handler,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_flow_config_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_flow_config_bulk_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_dscp_config_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_policer_stats_read_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> pipeline_msg_req_handler custom_handlers[] = {</div>
<div class="line">    [PIPELINE_FA_MSG_REQ_FLOW_CONFIG] =</div>
<div class="line">        pipeline_fa_msg_req_flow_config_handler,</div>
<div class="line">    [PIPELINE_FA_MSG_REQ_FLOW_CONFIG_BULK] =</div>
<div class="line">        pipeline_fa_msg_req_flow_config_bulk_handler,</div>
<div class="line">    [PIPELINE_FA_MSG_REQ_DSCP_CONFIG] =</div>
<div class="line">        pipeline_fa_msg_req_dscp_config_handler,</div>
<div class="line">    [PIPELINE_FA_MSG_REQ_POLICER_STATS_READ] =</div>
<div class="line">        pipeline_fa_msg_req_policer_stats_read_handler,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Flow table</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>meter_policer {</div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats stats;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>flow_table_entry {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> head;</div>
<div class="line">    <span class="keyword">struct </span>meter_policer <a name="a9"></a><a class="code" href="rte__cryptodev_8h.html#a9f6b27bed19dd1bf3cff6af57d7cf86f">mp</a>[PIPELINE_FA_N_TC_MAX];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">flow_table_entry_set_meter(<span class="keyword">struct</span> flow_table_entry *entry,</div>
<div class="line">    uint32_t meter_id,</div>
<div class="line">    <span class="keyword">struct</span> pipeline_fa_flow_params *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter = &amp;entry-&gt;mp[meter_id].meter;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__meter__trtcm__params.html">rte_meter_trtcm_params</a> *meter_params = &amp;params-&gt;m[meter_id];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a name="a10"></a><a class="code" href="rte__meter_8h.html#aaaa33ed2bcea0c512d9b798911b96081">rte_meter_trtcm_config</a>(meter, meter_params);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">flow_table_entry_set_policer(<span class="keyword">struct</span> flow_table_entry *entry,</div>
<div class="line">    uint32_t policer_id,</div>
<div class="line">    <span class="keyword">struct</span> pipeline_fa_flow_params *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *p0 = &amp;entry-&gt;mp[policer_id].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *p1 = &amp;params-&gt;p[policer_id];</div>
<div class="line"></div>
<div class="line">    memcpy(p0, p1, <span class="keyword">sizeof</span>(*p0));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">flow_table_entry_set_port_id(<span class="keyword">struct</span> pipeline_flow_actions *p,</div>
<div class="line">    <span class="keyword">struct</span> flow_table_entry *entry,</div>
<div class="line">    <span class="keyword">struct</span> pipeline_fa_flow_params *params)</div>
<div class="line">{</div>
<div class="line">    entry-&gt;head.action = <a name="a11"></a><a class="code" href="rte__pipeline_8h.html#a6376b240935404d998f003d113651572ac8c58609785d844989b7d9eb1e6db8aa">RTE_PIPELINE_ACTION_PORT</a>;</div>
<div class="line">    entry-&gt;head.port_id = p-&gt;p.port_out_id[params-&gt;port_id];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">flow_table_entry_set_default(<span class="keyword">struct</span> pipeline_flow_actions *p,</div>
<div class="line">    <span class="keyword">struct</span> flow_table_entry *entry)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_flow_params params;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    pipeline_fa_flow_params_set_default(&amp;params);</div>
<div class="line"></div>
<div class="line">    memset(entry, 0, <span class="keyword">sizeof</span>(*entry));</div>
<div class="line"></div>
<div class="line">    flow_table_entry_set_port_id(p, entry, &amp;params);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PIPELINE_FA_N_TC_MAX; i++) {</div>
<div class="line">        <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">        status = flow_table_entry_set_meter(entry, i, &amp;params);</div>
<div class="line">        <span class="keywordflow">if</span> (status)</div>
<div class="line">            <span class="keywordflow">return</span> status;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PIPELINE_FA_N_TC_MAX; i++)</div>
<div class="line">        flow_table_entry_set_policer(entry, i, &amp;params);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t</div>
<div class="line">pkt_work(</div>
<div class="line">    <span class="keyword">struct</span> <a name="_a12"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt,</div>
<div class="line">    <span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> *table_entry,</div>
<div class="line">    <span class="keywordtype">void</span> *arg,</div>
<div class="line">    uint64_t time)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p = arg;</div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry =</div>
<div class="line">        (<span class="keyword">struct </span>flow_table_entry *) table_entry;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a name="_a13"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt_ip = (<span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *)</div>
<div class="line">        <a name="a14"></a><a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkt, p-&gt;params.ip_hdr_offset);</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *pkt_color = (<span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkt, p-&gt;params.color_offset);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (IP header) */</span></div>
<div class="line">    uint32_t <a name="a15"></a><a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a> = <a name="a16"></a><a class="code" href="rte__byteorder_8h.html#a8630d768a50c489c2000dbb318e8a0ef">rte_bswap16</a>(pkt_ip-&gt;<a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>);</div>
<div class="line">    uint32_t dscp = pkt_ip-&gt;<a name="a17"></a><a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> &gt;&gt; 2;</div>
<div class="line"></div>
<div class="line">    uint32_t tc = p-&gt;dscp[dscp].traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color = p-&gt;dscp[dscp].color;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter = &amp;entry-&gt;mp[tc].meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *policer = &amp;entry-&gt;mp[tc].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats *stats = &amp;entry-&gt;mp[tc].stats;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (entry), compute */</span></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2 = <a name="a18"></a><a class="code" href="rte__meter_8h.html#a4ffda8418d9d6fec25368a3e0dc32b70">rte_meter_trtcm_color_aware_check</a>(meter,</div>
<div class="line">        time,</div>
<div class="line">        total_length,</div>
<div class="line">        color);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3 = policer-&gt;action[color2].color;</div>
<div class="line">    uint64_t drop = policer-&gt;action[color2].drop;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (entry), write (entry, color) */</span></div>
<div class="line">    stats-&gt;n_pkts[color3] += drop ^ 1LLU;</div>
<div class="line">    stats-&gt;n_pkts_drop += drop;</div>
<div class="line">    *pkt_color = color3;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> drop;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t</div>
<div class="line">pkt4_work(</div>
<div class="line">    <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts,</div>
<div class="line">    <span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> **table_entries,</div>
<div class="line">    <span class="keywordtype">void</span> *arg,</div>
<div class="line">    uint64_t time)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p = arg;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry0 =</div>
<div class="line">        (<span class="keyword">struct </span>flow_table_entry *) table_entries[0];</div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry1 =</div>
<div class="line">        (<span class="keyword">struct </span>flow_table_entry *) table_entries[1];</div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry2 =</div>
<div class="line">        (<span class="keyword">struct </span>flow_table_entry *) table_entries[2];</div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry3 =</div>
<div class="line">        (<span class="keyword">struct </span>flow_table_entry *) table_entries[3];</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt0_ip = (<span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[0], p-&gt;params.ip_hdr_offset);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt1_ip = (<span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[1], p-&gt;params.ip_hdr_offset);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt2_ip = (<span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[2], p-&gt;params.ip_hdr_offset);</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt3_ip = (<span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[3], p-&gt;params.ip_hdr_offset);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *pkt0_color = (<span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[0], p-&gt;params.color_offset);</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *pkt1_color = (<span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[1], p-&gt;params.color_offset);</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *pkt2_color = (<span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[2], p-&gt;params.color_offset);</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *pkt3_color = (<span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> *)</div>
<div class="line">        <a class="code" href="rte__port_8h.html#aea4ec54c3c7fbb57e611499ad81609d0">RTE_MBUF_METADATA_UINT32_PTR</a>(pkts[3], p-&gt;params.color_offset);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (IP header) */</span></div>
<div class="line">    uint32_t total_length0 = <a class="code" href="rte__byteorder_8h.html#a8630d768a50c489c2000dbb318e8a0ef">rte_bswap16</a>(pkt0_ip-&gt;<a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>);</div>
<div class="line">    uint32_t dscp0 = pkt0_ip-&gt;<a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> &gt;&gt; 2;</div>
<div class="line"></div>
<div class="line">    uint32_t total_length1 = <a class="code" href="rte__byteorder_8h.html#a8630d768a50c489c2000dbb318e8a0ef">rte_bswap16</a>(pkt1_ip-&gt;<a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>);</div>
<div class="line">    uint32_t dscp1 = pkt1_ip-&gt;<a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> &gt;&gt; 2;</div>
<div class="line"></div>
<div class="line">    uint32_t total_length2 = <a class="code" href="rte__byteorder_8h.html#a8630d768a50c489c2000dbb318e8a0ef">rte_bswap16</a>(pkt2_ip-&gt;<a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>);</div>
<div class="line">    uint32_t dscp2 = pkt2_ip-&gt;<a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> &gt;&gt; 2;</div>
<div class="line"></div>
<div class="line">    uint32_t total_length3 = <a class="code" href="rte__byteorder_8h.html#a8630d768a50c489c2000dbb318e8a0ef">rte_bswap16</a>(pkt3_ip-&gt;<a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>);</div>
<div class="line">    uint32_t dscp3 = pkt3_ip-&gt;<a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> &gt;&gt; 2;</div>
<div class="line"></div>
<div class="line">    uint32_t tc0 = p-&gt;dscp[dscp0].traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color0 = p-&gt;dscp[dscp0].color;</div>
<div class="line"></div>
<div class="line">    uint32_t tc1 = p-&gt;dscp[dscp1].traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color1 = p-&gt;dscp[dscp1].color;</div>
<div class="line"></div>
<div class="line">    uint32_t tc2 = p-&gt;dscp[dscp2].traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2 = p-&gt;dscp[dscp2].color;</div>
<div class="line"></div>
<div class="line">    uint32_t tc3 = p-&gt;dscp[dscp3].traffic_class;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3 = p-&gt;dscp[dscp3].color;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter0 = &amp;entry0-&gt;mp[tc0].meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *policer0 = &amp;entry0-&gt;mp[tc0].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats *stats0 = &amp;entry0-&gt;mp[tc0].stats;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter1 = &amp;entry1-&gt;mp[tc1].meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *policer1 = &amp;entry1-&gt;mp[tc1].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats *stats1 = &amp;entry1-&gt;mp[tc1].stats;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter2 = &amp;entry2-&gt;mp[tc2].meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *policer2 = &amp;entry2-&gt;mp[tc2].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats *stats2 = &amp;entry2-&gt;mp[tc2].stats;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>rte_meter_trtcm *meter3 = &amp;entry3-&gt;mp[tc3].meter;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_params *policer3 = &amp;entry3-&gt;mp[tc3].policer;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats *stats3 = &amp;entry3-&gt;mp[tc3].stats;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (entry), compute, write (entry) */</span></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2_0 = <a class="code" href="rte__meter_8h.html#a4ffda8418d9d6fec25368a3e0dc32b70">rte_meter_trtcm_color_aware_check</a>(</div>
<div class="line">        meter0,</div>
<div class="line">        time,</div>
<div class="line">        total_length0,</div>
<div class="line">        color0);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2_1 = <a class="code" href="rte__meter_8h.html#a4ffda8418d9d6fec25368a3e0dc32b70">rte_meter_trtcm_color_aware_check</a>(</div>
<div class="line">        meter1,</div>
<div class="line">        time,</div>
<div class="line">        total_length1,</div>
<div class="line">        color1);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2_2 = <a class="code" href="rte__meter_8h.html#a4ffda8418d9d6fec25368a3e0dc32b70">rte_meter_trtcm_color_aware_check</a>(</div>
<div class="line">        meter2,</div>
<div class="line">        time,</div>
<div class="line">        total_length2,</div>
<div class="line">        color2);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color2_3 = <a class="code" href="rte__meter_8h.html#a4ffda8418d9d6fec25368a3e0dc32b70">rte_meter_trtcm_color_aware_check</a>(</div>
<div class="line">        meter3,</div>
<div class="line">        time,</div>
<div class="line">        total_length3,</div>
<div class="line">        color3);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3_0 = policer0-&gt;action[color2_0].color;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3_1 = policer1-&gt;action[color2_1].color;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3_2 = policer2-&gt;action[color2_2].color;</div>
<div class="line">    <span class="keyword">enum</span> <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3a">rte_meter_color</a> color3_3 = policer3-&gt;action[color2_3].color;</div>
<div class="line"></div>
<div class="line">    uint64_t drop0 = policer0-&gt;action[color2_0].drop;</div>
<div class="line">    uint64_t drop1 = policer1-&gt;action[color2_1].drop;</div>
<div class="line">    uint64_t drop2 = policer2-&gt;action[color2_2].drop;</div>
<div class="line">    uint64_t drop3 = policer3-&gt;action[color2_3].drop;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read (entry), write (entry, color) */</span></div>
<div class="line">    stats0-&gt;n_pkts[color3_0] += drop0 ^ 1LLU;</div>
<div class="line">    stats0-&gt;n_pkts_drop += drop0;</div>
<div class="line"></div>
<div class="line">    stats1-&gt;n_pkts[color3_1] += drop1 ^ 1LLU;</div>
<div class="line">    stats1-&gt;n_pkts_drop += drop1;</div>
<div class="line"></div>
<div class="line">    stats2-&gt;n_pkts[color3_2] += drop2 ^ 1LLU;</div>
<div class="line">    stats2-&gt;n_pkts_drop += drop2;</div>
<div class="line"></div>
<div class="line">    stats3-&gt;n_pkts[color3_3] += drop3 ^ 1LLU;</div>
<div class="line">    stats3-&gt;n_pkts_drop += drop3;</div>
<div class="line"></div>
<div class="line">    *pkt0_color = color3_0;</div>
<div class="line">    *pkt1_color = color3_1;</div>
<div class="line">    *pkt2_color = color3_2;</div>
<div class="line">    *pkt3_color = color3_3;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> drop0 | (drop1 &lt;&lt; 1) | (drop2 &lt;&lt; 2) | (drop3 &lt;&lt; 3);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">PIPELINE_TABLE_AH_HIT_DROP_TIME(fa_table_ah_hit, pkt_work, pkt4_work);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a name="a19"></a><a class="code" href="rte__pipeline_8h.html#a690cec4a2e911968eb8036b333396f7f">rte_pipeline_table_action_handler_hit</a></div>
<div class="line">get_fa_table_ah_hit(<a name="a20"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> pipeline_flow_actions *p)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> fa_table_ah_hit;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Argument parsing</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">pipeline_fa_parse_args(<span class="keyword">struct</span> pipeline_fa_params *p,</div>
<div class="line">    <span class="keyword">struct</span> pipeline_params *params)</div>
<div class="line">{</div>
<div class="line">    uint32_t n_flows_present = 0;</div>
<div class="line">    uint32_t n_meters_per_flow_present = 0;</div>
<div class="line">    uint32_t flow_id_offset_present = 0;</div>
<div class="line">    uint32_t ip_hdr_offset_present = 0;</div>
<div class="line">    uint32_t color_offset_present = 0;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Default values */</span></div>
<div class="line">    p-&gt;n_meters_per_flow = 1;</div>
<div class="line">    p-&gt;dscp_enabled = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; params-&gt;n_args; i++) {</div>
<div class="line">        <span class="keywordtype">char</span> *arg_name = params-&gt;args_name[i];</div>
<div class="line">        <span class="keywordtype">char</span> *arg_value = params-&gt;args_value[i];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* n_flows */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(arg_name, <span class="stringliteral">&quot;n_flows&quot;</span>) == 0) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            PIPELINE_PARSE_ERR_DUPLICATE(</div>
<div class="line">                n_flows_present == 0, params-&gt;name,</div>
<div class="line">                arg_name);</div>
<div class="line">            n_flows_present = 1;</div>
<div class="line"></div>
<div class="line">            status = parser_read_uint32(&amp;p-&gt;n_flows,</div>
<div class="line">                arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_INV_VAL(((status != -EINVAL) &amp;&amp;</div>
<div class="line">                (p-&gt;n_flows != 0)), params-&gt;name,</div>
<div class="line">                arg_name, arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_OUT_RNG((status != -ERANGE),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* n_meters_per_flow */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(arg_name, <span class="stringliteral">&quot;n_meters_per_flow&quot;</span>) == 0) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            PIPELINE_PARSE_ERR_DUPLICATE(</div>
<div class="line">                n_meters_per_flow_present == 0,</div>
<div class="line">                params-&gt;name, arg_name);</div>
<div class="line">            n_meters_per_flow_present = 1;</div>
<div class="line"></div>
<div class="line">            status = parser_read_uint32(&amp;p-&gt;n_meters_per_flow,</div>
<div class="line">                arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_INV_VAL(((status != -EINVAL) &amp;&amp;</div>
<div class="line">                (p-&gt;n_meters_per_flow != 0)),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_OUT_RNG(((status != -ERANGE) &amp;&amp;</div>
<div class="line">                (p-&gt;n_meters_per_flow &lt;=</div>
<div class="line">                PIPELINE_FA_N_TC_MAX)), params-&gt;name,</div>
<div class="line">                arg_name, arg_value);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* flow_id_offset */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(arg_name, <span class="stringliteral">&quot;flow_id_offset&quot;</span>) == 0) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            PIPELINE_PARSE_ERR_DUPLICATE(</div>
<div class="line">                flow_id_offset_present == 0,</div>
<div class="line">                params-&gt;name, arg_name);</div>
<div class="line">            flow_id_offset_present = 1;</div>
<div class="line"></div>
<div class="line">            status = parser_read_uint32(&amp;p-&gt;flow_id_offset,</div>
<div class="line">                arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_INV_VAL((status != -EINVAL),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_OUT_RNG((status != -ERANGE),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* ip_hdr_offset */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(arg_name, <span class="stringliteral">&quot;ip_hdr_offset&quot;</span>) == 0) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            PIPELINE_PARSE_ERR_DUPLICATE(</div>
<div class="line">                ip_hdr_offset_present == 0,</div>
<div class="line">                params-&gt;name, arg_name);</div>
<div class="line">            ip_hdr_offset_present = 1;</div>
<div class="line"></div>
<div class="line">            status = parser_read_uint32(&amp;p-&gt;ip_hdr_offset,</div>
<div class="line">                arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_INV_VAL((status != -EINVAL),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_OUT_RNG((status != -ERANGE),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* color_offset */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(arg_name, <span class="stringliteral">&quot;color_offset&quot;</span>) == 0) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            PIPELINE_PARSE_ERR_DUPLICATE(</div>
<div class="line">                color_offset_present == 0, params-&gt;name,</div>
<div class="line">                arg_name);</div>
<div class="line">            color_offset_present = 1;</div>
<div class="line"></div>
<div class="line">            status = parser_read_uint32(&amp;p-&gt;color_offset,</div>
<div class="line">                arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_INV_VAL((status != -EINVAL),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line">            PIPELINE_PARSE_ERR_OUT_RNG((status != -ERANGE),</div>
<div class="line">                params-&gt;name, arg_name, arg_value);</div>
<div class="line"></div>
<div class="line">            p-&gt;dscp_enabled = 1;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Unknown argument */</span></div>
<div class="line">        PIPELINE_PARSE_ERR_INV_ENT(0, params-&gt;name, arg_name);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check that mandatory arguments are present */</span></div>
<div class="line">    PIPELINE_PARSE_ERR_MANDATORY((n_flows_present), params-&gt;name,</div>
<div class="line">        <span class="stringliteral">&quot;n_flows&quot;</span>);</div>
<div class="line">    PIPELINE_PARSE_ERR_MANDATORY((flow_id_offset_present),</div>
<div class="line">        params-&gt;name, <span class="stringliteral">&quot;flow_id_offset&quot;</span>);</div>
<div class="line">    PIPELINE_PARSE_ERR_MANDATORY((ip_hdr_offset_present),</div>
<div class="line">        params-&gt;name, <span class="stringliteral">&quot;ip_hdr_offset&quot;</span>);</div>
<div class="line">    PIPELINE_PARSE_ERR_MANDATORY((color_offset_present), params-&gt;name,</div>
<div class="line">        <span class="stringliteral">&quot;color_offset&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">dscp_init(<span class="keyword">struct</span> pipeline_flow_actions *p)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PIPELINE_FA_N_DSCP; i++) {</div>
<div class="line">        p-&gt;dscp[i].traffic_class = 0;</div>
<div class="line">        p-&gt;dscp[i].color = <a name="a21"></a><a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3aa635687a12163cdd741edb786ba5419ec">e_RTE_METER_GREEN</a>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *pipeline_fa_init(<span class="keyword">struct</span> pipeline_params *params,</div>
<div class="line">    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline *p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p_fa;</div>
<div class="line">    uint32_t size, i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check input arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> (params == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (params-&gt;n_ports_in != params-&gt;n_ports_out)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Memory allocation */</span></div>
<div class="line">    size = <a name="a22"></a><a class="code" href="rte__memory_8h.html#a30eec128f3d71add687a1cbfe48abcbb">RTE_CACHE_LINE_ROUNDUP</a>(</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipeline_flow_actions));</div>
<div class="line">    p = <a name="a23"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(NULL, size, RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (p == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    p_fa = (<span class="keyword">struct </span>pipeline_flow_actions *) p;</div>
<div class="line"></div>
<div class="line">    strcpy(p-&gt;name, params-&gt;name);</div>
<div class="line">    p-&gt;log_level = params-&gt;log_level;</div>
<div class="line"></div>
<div class="line">    PLOG(p, HIGH, <span class="stringliteral">&quot;Flow actions&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> (pipeline_fa_parse_args(&amp;p_fa-&gt;params, params))</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    dscp_init(p_fa);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Pipeline */</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a24"></a><a class="code" href="structrte__pipeline__params.html">rte_pipeline_params</a> pipeline_params = {</div>
<div class="line">            .<a name="a25"></a><a class="code" href="structrte__pipeline__params.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = params-&gt;name,</div>
<div class="line">            .socket_id = params-&gt;socket_id,</div>
<div class="line">            .offset_port_id = 0,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        p-&gt;p = <a name="a26"></a><a class="code" href="rte__pipeline_8h.html#ad650149ed178057bfb54bda0b6e39e05">rte_pipeline_create</a>(&amp;pipeline_params);</div>
<div class="line">        <span class="keywordflow">if</span> (p-&gt;p == NULL) {</div>
<div class="line">            <a name="a27"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Input ports */</span></div>
<div class="line">    p-&gt;n_ports_in = params-&gt;n_ports_in;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;n_ports_in; i++) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a28"></a><a class="code" href="structrte__pipeline__port__in__params.html">rte_pipeline_port_in_params</a> port_params = {</div>
<div class="line">            .<a name="a29"></a><a class="code" href="structrte__pipeline__port__in__params.html#ad8c92480b58ad5e6b7917c16b5ea7b3d">ops</a> = pipeline_port_in_params_get_ops(</div>
<div class="line">                &amp;params-&gt;port_in[i]),</div>
<div class="line">            .arg_create = pipeline_port_in_params_convert(</div>
<div class="line">                &amp;params-&gt;port_in[i]),</div>
<div class="line">            .f_action = NULL,</div>
<div class="line">            .arg_ah = NULL,</div>
<div class="line">            .burst_size = params-&gt;port_in[i].burst_size,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> status = <a name="a30"></a><a class="code" href="rte__pipeline_8h.html#ab0c0f093519ccc9fbb76e7c5696fd266">rte_pipeline_port_in_create</a>(p-&gt;p,</div>
<div class="line">            &amp;port_params,</div>
<div class="line">            &amp;p-&gt;port_in_id[i]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a name="a31"></a><a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Output ports */</span></div>
<div class="line">    p-&gt;n_ports_out = params-&gt;n_ports_out;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;n_ports_out; i++) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a32"></a><a class="code" href="structrte__pipeline__port__out__params.html">rte_pipeline_port_out_params</a> port_params = {</div>
<div class="line">            .<a class="code" href="structrte__pipeline__port__in__params.html#ad8c92480b58ad5e6b7917c16b5ea7b3d">ops</a> = pipeline_port_out_params_get_ops(</div>
<div class="line">                &amp;params-&gt;port_out[i]),</div>
<div class="line">            .arg_create = pipeline_port_out_params_convert(</div>
<div class="line">                &amp;params-&gt;port_out[i]),</div>
<div class="line">            .f_action = NULL,</div>
<div class="line">            .arg_ah = NULL,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> status = <a name="a33"></a><a class="code" href="rte__pipeline_8h.html#a247f58fe13cba38922ccf5c60a2f86bb">rte_pipeline_port_out_create</a>(p-&gt;p,</div>
<div class="line">            &amp;port_params,</div>
<div class="line">            &amp;p-&gt;port_out_id[i]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Tables */</span></div>
<div class="line">    p-&gt;n_tables = 1;</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a34"></a><a class="code" href="structrte__table__array__params.html">rte_table_array_params</a> table_array_params = {</div>
<div class="line">            .<a name="a35"></a><a class="code" href="structrte__table__array__params.html#aafba5a1f8ad65b41148894026098cad7">n_entries</a> = p_fa-&gt;params.n_flows,</div>
<div class="line">            .offset = p_fa-&gt;params.flow_id_offset,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keyword">struct </span><a name="_a36"></a><a class="code" href="structrte__pipeline__table__params.html">rte_pipeline_table_params</a> table_params = {</div>
<div class="line">            .<a name="a37"></a><a class="code" href="structrte__pipeline__table__params.html#ad1966fbeee5c7e1923a4e567b5bcd77d">ops</a> = &amp;<a name="a38"></a><a class="code" href="rte__table__array_8h.html#a0bceb8639a24f2ae41aad51328415a4c">rte_table_array_ops</a>,</div>
<div class="line">            .arg_create = &amp;table_array_params,</div>
<div class="line">            .f_action_hit = get_fa_table_ah_hit(p_fa),</div>
<div class="line">            .f_action_miss = NULL,</div>
<div class="line">            .arg_ah = p_fa,</div>
<div class="line">            .action_data_size =</div>
<div class="line">                <span class="keyword">sizeof</span>(<span class="keyword">struct </span>flow_table_entry) -</div>
<div class="line">                sizeof(struct <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a>),</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">        status = <a name="a39"></a><a class="code" href="rte__pipeline_8h.html#af1cb4d7ac4516443e6f9d82a4beebed6">rte_pipeline_table_create</a>(p-&gt;p,</div>
<div class="line">            &amp;table_params,</div>
<div class="line">            &amp;p-&gt;table_id[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Connecting input ports to tables */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;n_ports_in; i++) {</div>
<div class="line">        <span class="keywordtype">int</span> status = <a name="a40"></a><a class="code" href="rte__pipeline_8h.html#adc4634b81c75f146f3afac17dbbe727c">rte_pipeline_port_in_connect_to_table</a>(p-&gt;p,</div>
<div class="line">            p-&gt;port_in_id[i],</div>
<div class="line">            p-&gt;table_id[0]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable input ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;n_ports_in; i++) {</div>
<div class="line">        <span class="keywordtype">int</span> status = <a name="a41"></a><a class="code" href="rte__pipeline_8h.html#af8a48f99a99731883005dfe93c5406e6">rte_pipeline_port_in_enable</a>(p-&gt;p,</div>
<div class="line">            p-&gt;port_in_id[i]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize table entries */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p_fa-&gt;params.n_flows; i++) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a42"></a><a class="code" href="structrte__table__array__key.html">rte_table_array_key</a> key = {</div>
<div class="line">            .<a name="a43"></a><a class="code" href="structrte__table__array__key.html#af09611129dedc89382e4d7b6427bdb27">pos</a> = i,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keyword">struct </span>flow_table_entry entry;</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> *entry_ptr;</div>
<div class="line">        <span class="keywordtype">int</span> key_found, status;</div>
<div class="line"></div>
<div class="line">        flow_table_entry_set_default(p_fa, &amp;entry);</div>
<div class="line"></div>
<div class="line">        status = <a name="a44"></a><a class="code" href="rte__pipeline_8h.html#a0e90e4a54b6467deb9b449bf8bd5cab4">rte_pipeline_table_entry_add</a>(p-&gt;p,</div>
<div class="line">            p-&gt;table_id[0],</div>
<div class="line">            &amp;key,</div>
<div class="line">            (<span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> *) &amp;entry,</div>
<div class="line">            &amp;key_found,</div>
<div class="line">            &amp;entry_ptr);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check pipeline consistency */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a45"></a><a class="code" href="rte__pipeline_8h.html#ada72ecd95a1a181d1d555dd699f95475">rte_pipeline_check</a>(p-&gt;p) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Message queues */</span></div>
<div class="line">    p-&gt;n_msgq = params-&gt;n_msgq;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;n_msgq; i++)</div>
<div class="line">        p-&gt;msgq_in[i] = params-&gt;msgq_in[i];</div>
<div class="line">    for (i = 0; i &lt; p-&gt;n_msgq; i++)</div>
<div class="line">        p-&gt;msgq_out[i] = params-&gt;msgq_out[i];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Message handlers */</span></div>
<div class="line">    memcpy(p-&gt;handlers, handlers, <span class="keyword">sizeof</span>(p-&gt;handlers));</div>
<div class="line">    memcpy(p_fa-&gt;custom_handlers,</div>
<div class="line">        custom_handlers,</div>
<div class="line">        <span class="keyword">sizeof</span>(p_fa-&gt;custom_handlers));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> p;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pipeline_fa_free(<span class="keywordtype">void</span> *pipeline)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline *p = (<span class="keyword">struct </span>pipeline *) pipeline;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check input arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> (p == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Free resources */</span></div>
<div class="line">    <a class="code" href="rte__pipeline_8h.html#a85ce2e4661092748a84409a1d6eae14c">rte_pipeline_free</a>(p-&gt;p);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(p);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pipeline_fa_track(<span class="keywordtype">void</span> *pipeline,</div>
<div class="line">    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> uint32_t port_in,</div>
<div class="line">    uint32_t *port_out)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline *p = (<span class="keyword">struct </span>pipeline *) pipeline;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check input arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((p == NULL) ||</div>
<div class="line">        (port_in &gt;= p-&gt;n_ports_in) ||</div>
<div class="line">        (port_out == NULL))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (p-&gt;n_ports_in == 1) {</div>
<div class="line">        *port_out = 0;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pipeline_fa_timer(<span class="keywordtype">void</span> *pipeline)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline *p = (<span class="keyword">struct </span>pipeline *) pipeline;</div>
<div class="line"></div>
<div class="line">    pipeline_msg_req_handle(p);</div>
<div class="line">    <a name="a46"></a><a class="code" href="rte__pipeline_8h.html#ac26447a6b0c4b1ec218a9133d790fef1">rte_pipeline_flush</a>(p-&gt;p);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_custom_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p_fa =</div>
<div class="line">            (<span class="keyword">struct </span>pipeline_flow_actions *) p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_custom_msg_req *req = msg;</div>
<div class="line">    pipeline_msg_req_handler f_handle;</div>
<div class="line"></div>
<div class="line">    f_handle = (req-&gt;subtype &lt; PIPELINE_FA_MSG_REQS) ?</div>
<div class="line">        p_fa-&gt;custom_handlers[req-&gt;subtype] :</div>
<div class="line">        pipeline_msg_req_invalid_handler;</div>
<div class="line"></div>
<div class="line">    if (f_handle == NULL)</div>
<div class="line">        f_handle = pipeline_msg_req_invalid_handler;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> f_handle(p, req);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_flow_config_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p_fa = (<span class="keyword">struct </span>pipeline_flow_actions *) p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_flow_config_msg_req *req = msg;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_flow_config_msg_rsp *rsp = msg;</div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry;</div>
<div class="line">    uint32_t mask, i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set flow table entry to default if not configured before */</span></div>
<div class="line">    <span class="keywordflow">if</span> (req-&gt;entry_ptr == NULL) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__table__array__key.html">rte_table_array_key</a> key = {</div>
<div class="line">            .<a class="code" href="structrte__table__array__key.html#af09611129dedc89382e4d7b6427bdb27">pos</a> = req-&gt;flow_id % p_fa-&gt;params.n_flows,</div>
<div class="line">        };</div>
<div class="line"></div>
<div class="line">        <span class="keyword">struct </span>flow_table_entry default_entry;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> key_found, status;</div>
<div class="line"></div>
<div class="line">        flow_table_entry_set_default(p_fa, &amp;default_entry);</div>
<div class="line"></div>
<div class="line">        status = <a class="code" href="rte__pipeline_8h.html#a0e90e4a54b6467deb9b449bf8bd5cab4">rte_pipeline_table_entry_add</a>(p-&gt;p,</div>
<div class="line">            p-&gt;table_id[0],</div>
<div class="line">            &amp;key,</div>
<div class="line">            (<span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> *) &amp;default_entry,</div>
<div class="line">            &amp;key_found,</div>
<div class="line">            (<span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> **) &amp;entry);</div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            rsp-&gt;status = -1;</div>
<div class="line">            <span class="keywordflow">return</span> rsp;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        entry = (<span class="keyword">struct </span>flow_table_entry *) req-&gt;entry_ptr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Meter */</span></div>
<div class="line">    for (i = 0, mask = 1; i &lt; PIPELINE_FA_N_TC_MAX; i++, mask &lt;&lt;= 1) {</div>
<div class="line">        <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ((mask &amp; req-&gt;meter_update_mask) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        status = flow_table_entry_set_meter(entry, i, &amp;req-&gt;params);</div>
<div class="line">        <span class="keywordflow">if</span> (status) {</div>
<div class="line">            rsp-&gt;status = -1;</div>
<div class="line">            <span class="keywordflow">return</span> rsp;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Policer */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0, mask = 1; i &lt; PIPELINE_FA_N_TC_MAX; i++, mask &lt;&lt;= 1) {</div>
<div class="line">        <span class="keywordflow">if</span> ((mask &amp; req-&gt;policer_update_mask) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        flow_table_entry_set_policer(entry, i, &amp;req-&gt;params);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Port */</span></div>
<div class="line">    <span class="keywordflow">if</span> (req-&gt;port_update)</div>
<div class="line">        flow_table_entry_set_port_id(p_fa, entry, &amp;req-&gt;params);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Response */</span></div>
<div class="line">    rsp-&gt;status = 0;</div>
<div class="line">    rsp-&gt;entry_ptr = (<span class="keywordtype">void</span> *) entry;</div>
<div class="line">    <span class="keywordflow">return</span> rsp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_flow_config_bulk_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p_fa = (<span class="keyword">struct </span>pipeline_flow_actions *) p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_flow_config_bulk_msg_req *req = msg;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_flow_config_bulk_msg_rsp *rsp = msg;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; req-&gt;n_flows; i++) {</div>
<div class="line">        <span class="keyword">struct </span>flow_table_entry *entry;</div>
<div class="line">        uint32_t j, mask;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Set flow table entry to default if not configured before */</span></div>
<div class="line">        <span class="keywordflow">if</span> (req-&gt;entry_ptr[i] == NULL) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__table__array__key.html">rte_table_array_key</a> key = {</div>
<div class="line">                .<a class="code" href="structrte__table__array__key.html#af09611129dedc89382e4d7b6427bdb27">pos</a> = req-&gt;flow_id[i] % p_fa-&gt;params.n_flows,</div>
<div class="line">            };</div>
<div class="line"></div>
<div class="line">            <span class="keyword">struct </span>flow_table_entry entry_to_add;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">int</span> key_found, status;</div>
<div class="line"></div>
<div class="line">            flow_table_entry_set_default(p_fa, &amp;entry_to_add);</div>
<div class="line"></div>
<div class="line">            status = <a class="code" href="rte__pipeline_8h.html#a0e90e4a54b6467deb9b449bf8bd5cab4">rte_pipeline_table_entry_add</a>(p-&gt;p,</div>
<div class="line">             p-&gt;table_id[0],</div>
<div class="line">             &amp;key,</div>
<div class="line">             (<span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> *) &amp;entry_to_add,</div>
<div class="line">             &amp;key_found,</div>
<div class="line">             (<span class="keyword">struct</span> <a class="code" href="structrte__pipeline__table__entry.html">rte_pipeline_table_entry</a> **) &amp;entry);</div>
<div class="line">            <span class="keywordflow">if</span> (status) {</div>
<div class="line">                rsp-&gt;n_flows = i;</div>
<div class="line">                <span class="keywordflow">return</span> rsp;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            req-&gt;entry_ptr[i] = (<span class="keywordtype">void</span> *) entry;</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            entry = (<span class="keyword">struct </span>flow_table_entry *) req-&gt;entry_ptr[i];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Meter */</span></div>
<div class="line">        for (j = 0, mask = 1;</div>
<div class="line">            j &lt; PIPELINE_FA_N_TC_MAX;</div>
<div class="line">            j++, mask &lt;&lt;= 1) {</div>
<div class="line">            <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> ((mask &amp; req-&gt;meter_update_mask) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            status = flow_table_entry_set_meter(entry,</div>
<div class="line">                j, &amp;req-&gt;params[i]);</div>
<div class="line">            <span class="keywordflow">if</span> (status) {</div>
<div class="line">                rsp-&gt;n_flows = i;</div>
<div class="line">                <span class="keywordflow">return</span> rsp;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Policer */</span></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0, mask = 1;</div>
<div class="line">            j &lt; PIPELINE_FA_N_TC_MAX;</div>
<div class="line">            j++, mask &lt;&lt;= 1) {</div>
<div class="line">            <span class="keywordflow">if</span> ((mask &amp; req-&gt;policer_update_mask) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            flow_table_entry_set_policer(entry,</div>
<div class="line">             j, &amp;req-&gt;params[i]);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Port */</span></div>
<div class="line">        <span class="keywordflow">if</span> (req-&gt;port_update)</div>
<div class="line">            flow_table_entry_set_port_id(p_fa,</div>
<div class="line">             entry, &amp;req-&gt;params[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Response */</span></div>
<div class="line">    rsp-&gt;n_flows = i;</div>
<div class="line">    <span class="keywordflow">return</span> rsp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_dscp_config_handler(<span class="keyword">struct</span> pipeline *p, <span class="keywordtype">void</span> *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_flow_actions *p_fa = (<span class="keyword">struct </span>pipeline_flow_actions *) p;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_dscp_config_msg_req *req = msg;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_dscp_config_msg_rsp *rsp = msg;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check request */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((req-&gt;dscp &gt;= PIPELINE_FA_N_DSCP) ||</div>
<div class="line">        (req-&gt;traffic_class &gt;= PIPELINE_FA_N_TC_MAX) ||</div>
<div class="line">        (req-&gt;color &gt;= <a class="code" href="rte__meter_8h.html#a9fdad5fa95e62568e827ab7d0c792f3aabc1b9f1c718a0bf520cd06be98c4843f">e_RTE_METER_COLORS</a>)) {</div>
<div class="line">        rsp-&gt;status = -1;</div>
<div class="line">        <span class="keywordflow">return</span> rsp;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    p_fa-&gt;dscp[req-&gt;dscp].traffic_class = req-&gt;traffic_class;</div>
<div class="line">    p_fa-&gt;dscp[req-&gt;dscp].color = req-&gt;color;</div>
<div class="line">    rsp-&gt;status = 0;</div>
<div class="line">    <span class="keywordflow">return</span> rsp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">pipeline_fa_msg_req_policer_stats_read_handler(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> pipeline *p,</div>
<div class="line">    <span class="keywordtype">void</span> *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats_msg_req *req = msg;</div>
<div class="line">    <span class="keyword">struct </span>pipeline_fa_policer_stats_msg_rsp *rsp = msg;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>flow_table_entry *entry = req-&gt;entry_ptr;</div>
<div class="line">    uint32_t policer_id = req-&gt;policer_id;</div>
<div class="line">    <span class="keywordtype">int</span> clear = req-&gt;clear;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check request */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((req-&gt;entry_ptr == NULL) ||</div>
<div class="line">        (req-&gt;policer_id &gt;= PIPELINE_FA_N_TC_MAX)) {</div>
<div class="line">        rsp-&gt;status = -1;</div>
<div class="line">        <span class="keywordflow">return</span> rsp;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    memcpy(&amp;rsp-&gt;stats,</div>
<div class="line">        &amp;entry-&gt;mp[policer_id].stats,</div>
<div class="line">        <span class="keyword">sizeof</span>(rsp-&gt;stats));</div>
<div class="line">    <span class="keywordflow">if</span> (clear)</div>
<div class="line">        memset(&amp;entry-&gt;mp[policer_id].stats,</div>
<div class="line">            0, <span class="keyword">sizeof</span>(entry-&gt;mp[policer_id].stats));</div>
<div class="line">    rsp-&gt;status = 0;</div>
<div class="line">    <span class="keywordflow">return</span> rsp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>pipeline_be_ops pipeline_flow_actions_be_ops = {</div>
<div class="line">    .f_init = pipeline_fa_init,</div>
<div class="line">    .f_free = pipeline_fa_free,</div>
<div class="line">    .f_run = NULL,</div>
<div class="line">    .f_timer = pipeline_fa_timer,</div>
<div class="line">    .f_track = pipeline_fa_track,</div>
<div class="line">};</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
