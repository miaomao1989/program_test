<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: tep_termination/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">tep_termination/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_ether.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_vlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/eventfd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__virtio__net_8h.html">rte_virtio_net.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vxlan.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vxlan_setup.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* the maximum number of external ports supported */</span></div>
<div class="line"><span class="preprocessor">#define MAX_SUP_PORTS 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define NUM_MBUFS_PER_PORT ((MAX_QUEUES * RTE_TEST_RX_DESC_DEFAULT) +\</span></div>
<div class="line"><span class="preprocessor">                (nb_switching_cores * MAX_PKT_BURST) +\</span></div>
<div class="line"><span class="preprocessor">                (nb_switching_cores * \</span></div>
<div class="line"><span class="preprocessor">                RTE_TEST_TX_DESC_DEFAULT) +\</span></div>
<div class="line"><span class="preprocessor">                (nb_switching_cores * MBUF_CACHE_SIZE))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBUF_CACHE_SIZE 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_SIZE (2048 + sizeof(struct rte_mbuf) + RTE_PKTMBUF_HEADROOM)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_PKT_BURST 32    </span><span class="comment">/* Max burst size for RX/TX */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_TX_DRAIN_US 100   </span><span class="comment">/* TX drain every ~100us */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Defines how long we wait between retries on RX */</span></div>
<div class="line"><span class="preprocessor">#define BURST_RX_WAIT_US 15</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BURST_RX_RETRIES 4  </span><span class="comment">/* Number of retries on RX. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define JUMBO_FRAME_MAX_SIZE    0x2600</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* State of virtio device. */</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_MAC_LEARNING 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_RX       1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_SAFE_REMOVE  2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Config_core_flag status definitions. */</span></div>
<div class="line"><span class="preprocessor">#define REQUEST_DEV_REMOVAL 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ACK_DEV_REMOVAL     0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Configurable number of RX/TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Get first 4 bytes in mbuf headroom. */</span></div>
<div class="line"><span class="preprocessor">#define MBUF_HEADROOM_UINT32(mbuf) (*(uint32_t *)((uint8_t *)(mbuf) \</span></div>
<div class="line"><span class="preprocessor">        + sizeof(struct rte_mbuf)))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define INVALID_PORT_ID 0xFF</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Size of buffers used for snprintfs. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PRINT_BUFF 6072</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Maximum character device basename size. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_BASENAME_SZ 20</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Maximum long option length for option parsing. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_LONG_OPT_SZ 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Used to compare MAC addresses. */</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_CMP 0xFFFFFFFFFFFFULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CMD_LINE_OPT_NB_DEVICES &quot;nb-devices&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_UDP_PORT &quot;udp-port&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_TX_CHECKSUM &quot;tx-checksum&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_TSO_SEGSZ &quot;tso-segsz&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_FILTER_TYPE &quot;filter-type&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_ENCAP &quot;encap&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_DECAP &quot;decap&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_RX_RETRY &quot;rx-retry&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_RX_RETRY_DELAY &quot;rx-retry-delay&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_RX_RETRY_NUM &quot;rx-retry-num&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_STATS &quot;stats&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_DEV_BASENAME &quot;dev-basename&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*Number of switching cores enabled*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t nb_switching_cores;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* number of devices/queues to support*/</span></div>
<div class="line">uint16_t nb_devices = 2;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* max ring descriptor, ixgbe, i40e, e1000 all are 4096. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_RING_DESC 4096</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>vpool {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *pool;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__ring.html">rte_ring</a> *ring;</div>
<div class="line">    uint32_t buf_size;</div>
<div class="line">} vpool_array[MAX_QUEUES+MAX_QUEUES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* UDP tunneling port */</span></div>
<div class="line">uint16_t udp_port = 4789;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* enable/disable inner TX checksum */</span></div>
<div class="line">uint8_t tx_checksum = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* TCP segment size */</span></div>
<div class="line">uint16_t tso_segsz = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* enable/disable decapsulation */</span></div>
<div class="line">uint8_t rx_decap = 1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* enable/disable encapsulation */</span></div>
<div class="line">uint8_t tx_encap = 1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* RX filter type for tunneling packet */</span></div>
<div class="line">uint8_t filter_idx = 1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* overlay packet operation */</span></div>
<div class="line"><span class="keyword">struct </span>ol_switch_ops overlay_options = {</div>
<div class="line">    .port_configure = vxlan_port_init,</div>
<div class="line">    .tunnel_setup = vxlan_link,</div>
<div class="line">    .tunnel_destroy = vxlan_unlink,</div>
<div class="line">    .tx_handle = vxlan_tx_pkts,</div>
<div class="line">    .rx_handle = vxlan_rx_pkts,</div>
<div class="line">    .param_handle = NULL,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable stats. */</span></div>
<div class="line">uint32_t enable_stats = 0;</div>
<div class="line"><span class="comment">/* Enable retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_retry = 1;</div>
<div class="line"><span class="comment">/* Specify timeout (in useconds) between retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_delay_time = BURST_RX_WAIT_US;</div>
<div class="line"><span class="comment">/* Specify the number of retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_retry_num = BURST_RX_RETRIES;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Character device basename. Can be set by user. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> dev_basename[MAX_BASENAME_SZ] = <span class="stringliteral">&quot;vhost-net&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> lcore_ids[RTE_MAX_LCORE];</div>
<div class="line">uint8_t ports[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> nb_ports; </div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structether__addr.html">ether_addr</a> ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* heads for the main used and free linked lists for the data path. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_used;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_free;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>lcore_info lcore_info[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Used for queueing bursts of TX packets. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table {</div>
<div class="line">    <span class="keywordtype">unsigned</span> len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> txq_id;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a3"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_table[MAX_PKT_BURST];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* TX queue for each data core. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table lcore_tx_queue[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>device_statistics dev_statistics[MAX_DEVICES];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_basename(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* parse number string */</span></div>
<div class="line">    <span class="keywordflow">if</span> (strlen(q_arg) &gt;= MAX_BASENAME_SZ)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        snprintf((<span class="keywordtype">char</span> *)&amp;dev_basename, MAX_BASENAME_SZ, <span class="stringliteral">&quot;%s&quot;</span>, q_arg);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_num_opt(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg, uint32_t max_valid_value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse unsigned int string */</span></div>
<div class="line">    num = strtoul(q_arg, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((q_arg[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num &gt; max_valid_value)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> num;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">tep_termination_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    <a name="a4"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --udp-port: UDP destination port for VXLAN packet\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --nb-devices[1-64]: The number of virtIO device\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --tx-checksum [0|1]: inner Tx checksum offload\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --tso-segsz [0-N]: TCP segment size\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --decap [0|1]: tunneling packet decapsulation\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --encap [0|1]: tunneling packet encapsulation\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               --filter-type[1-3]: filter type for tunneling packet\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;                   1: Inner MAC and tenent ID\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;                   2: Inner MAC and VLAN, and tenent ID\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;                   3: Outer MAC, Inner MAC and tenent ID\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       -p PORTMASK: Set mask for ports to be used by application\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry [0|1]: disable/enable(default) retries on rx.&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;        Enable retry if destintation queue is full\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-delay [0-N]: timeout(in usecond) between retries on RX.&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;        This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-num [0-N]: the number of retries on rx.&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;        This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --stats [0-N]: 0: Disable stats, N: Time in seconds to print stats\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --dev-basename: The basename to be used for the character device.\n&quot;</span>,</div>
<div class="line">           prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">tep_termination_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {CMD_LINE_OPT_NB_DEVICES, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_UDP_PORT, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_TX_CHECKSUM, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_TSO_SEGSZ, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_DECAP, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_ENCAP, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_FILTER_TYPE, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_RX_RETRY, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_RX_RETRY_DELAY, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_RX_RETRY_NUM, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_STATS, required_argument, NULL, 0},</div>
<div class="line">        {CMD_LINE_OPT_DEV_BASENAME, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, 0, 0},</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:&quot;</span>,</div>
<div class="line">            long_option, &amp;option_index)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* Portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;Invalid portmask\n&quot;</span>);</div>
<div class="line">                tep_termination_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_NB_DEVICES,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_NB_DEVICES))) {</div>
<div class="line">                ret = parse_num_opt(optarg, MAX_DEVICES);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;Invalid argument for nb-devices [0-%d]\n&quot;</span>,</div>
<div class="line">                    MAX_DEVICES);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    nb_devices = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable retries on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_RX_RETRY,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_RX_RETRY))) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for rx-retry [0|1]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_retry = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_TSO_SEGSZ,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_TSO_SEGSZ))) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT16_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for TCP segment size [0-N]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    tso_segsz = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                    CMD_LINE_OPT_UDP_PORT,</div>
<div class="line">                    <span class="keyword">sizeof</span>(CMD_LINE_OPT_UDP_PORT))) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT16_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for UDP port [0-N]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    udp_port = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the retries delay time (in useconds) on RX.*/</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_RX_RETRY_DELAY,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_RX_RETRY_DELAY))) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for rx-retry-delay [0-N]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    burst_rx_delay_time = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Specify the retries number on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_RX_RETRY_NUM,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_RX_RETRY_NUM))) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for rx-retry-num [0-N]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    burst_rx_retry_num = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_TX_CHECKSUM,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_TX_CHECKSUM))) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for tx-checksum [0|1]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    tx_checksum = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                    CMD_LINE_OPT_FILTER_TYPE,</div>
<div class="line">                    <span class="keyword">sizeof</span>(CMD_LINE_OPT_FILTER_TYPE))) {</div>
<div class="line">                ret = parse_num_opt(optarg, 3);</div>
<div class="line">                <span class="keywordflow">if</span> ((ret == -1) || (ret == 0)) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for filter type [1-3]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    filter_idx = ret - 1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable encapsulation on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_DECAP,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_DECAP))) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for decap [0|1]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    rx_decap = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable encapsulation on TX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_ENCAP,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_ENCAP))) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for encap [0|1]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    tx_encap = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable stats. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_STATS,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_STATS))) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                            <span class="stringliteral">&quot;Invalid argument for stats [0..N]\n&quot;</span>);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_stats = ret;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Set character device basename. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                CMD_LINE_OPT_DEV_BASENAME,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_DEV_BASENAME))) {</div>
<div class="line">                <span class="keywordflow">if</span> (us_vhost_parse_basename(optarg) == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for character &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;device basename (Max %d characters)\n&quot;</span>,</div>
<div class="line">                        MAX_BASENAME_SZ);</div>
<div class="line">                    tep_termination_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Invalid option - print options. */</span></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            tep_termination_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enabled_port_mask &amp; (1 &lt;&lt; i))</div>
<div class="line">            ports[nb_ports++] = (uint8_t)i;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((nb_ports ==  0) || (nb_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>, nb_ports,</div>
<div class="line">            MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span></div>
<div class="line">check_ports_num(<span class="keywordtype">unsigned</span> max_nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> valid_nb_ports = nb_ports;</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; max_nb_ports) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port number(%u) &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; exceeds total system port number(%u)\n&quot;</span>,</div>
<div class="line">            nb_ports, max_nb_ports);</div>
<div class="line">        nb_ports = max_nb_ports;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="keywordflow">if</span> (ports[portid] &gt;= max_nb_ports) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;\nSpecified port ID(%u) exceeds max &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; system port ID(%u)\n&quot;</span>,</div>
<div class="line">                ports[portid], (max_nb_ports - 1));</div>
<div class="line">            ports[portid] = INVALID_PORT_ID;</div>
<div class="line">            valid_nb_ports--;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> valid_nb_ports;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_route(struct vhost_dev *vdev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **m_table;</div>
<div class="line">    <span class="keywordtype">unsigned</span> len, ret = 0;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a name="a5"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span><a name="_a6"></a><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = vdev-&gt;dev;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: MAC address is external\n&quot;</span>,</div>
<div class="line">        dev-&gt;<a name="a7"></a><a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add packet to the port tx queue */</span></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    len = tx_q-&gt;len;</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;m_table[len] = m;</div>
<div class="line">    len++;</div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx_total++;</div>
<div class="line">        dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].tx++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a8"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line">        m_table = (<span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table;</div>
<div class="line">        ret = overlay_options.tx_handle(ports[0],</div>
<div class="line">            (uint16_t)tx_q-&gt;txq_id, m_table,</div>
<div class="line">            (uint16_t)tx_q-&gt;len);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Free any buffers not handled by TX and update</span></div>
<div class="line"><span class="comment">         * the port stats.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; len)) {</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                <a name="a9"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m_table[ret]);</div>
<div class="line">            } <span class="keywordflow">while</span> (++ret &lt; len);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        len = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;len = len;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">switch_worker(<a name="a10"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool = arg;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = NULL;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keyword">struct </span>lcore_ll_info *lcore_ll;</div>
<div class="line">    <span class="keyword">const</span> uint64_t drain_tsc = (<a name="a11"></a><a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1)</div>
<div class="line">                    / US_PER_S * BURST_TX_DRAIN_US;</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc, ret_count = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, ret = 0;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t num_cores = (uint16_t)<a name="a12"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    uint16_t rx_count = 0;</div>
<div class="line">    uint16_t tx_count;</div>
<div class="line">    uint32_t retry = 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;Procesing on Core %u started\n&quot;</span>, lcore_id);</div>
<div class="line">    lcore_ll = lcore_info[lcore_id].lcore_ll;</div>
<div class="line">    prev_tsc = 0;</div>
<div class="line"></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_cores; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ids[i] == lcore_id) {</div>
<div class="line">            tx_q-&gt;txq_id = i;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * TX burst queue drain</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; drain_tsc)) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (tx_q-&gt;len) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;TX queue drained after &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;timeout with burst size %u\n&quot;</span>,</div>
<div class="line">                    tx_q-&gt;len);</div>
<div class="line">                ret = overlay_options.tx_handle(ports[0],</div>
<div class="line">                    (uint16_t)tx_q-&gt;txq_id,</div>
<div class="line">                    (<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table,</div>
<div class="line">                    (uint16_t)tx_q-&gt;len);</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; tx_q-&gt;len)) {</div>
<div class="line">                    <span class="keywordflow">do</span> {</div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(tx_q-&gt;m_table[ret]);</div>
<div class="line">                    } <span class="keywordflow">while</span> (++ret &lt; tx_q-&gt;len);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                tx_q-&gt;len = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a name="a13"></a><a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(lcore_ll-&gt;ll_root_used);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ll-&gt;dev_removal_flag == REQUEST_DEV_REMOVAL)</div>
<div class="line">            lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Process devices</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        dev_ll = lcore_ll-&gt;ll_root_used;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            vdev = dev_ll-&gt;vdev;</div>
<div class="line">            dev = vdev-&gt;dev;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;remove)) {</div>
<div class="line">                dev_ll = dev_ll-&gt;next;</div>
<div class="line">                overlay_options.tunnel_destroy(vdev);</div>
<div class="line">                vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a14"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vdev-&gt;ready == DEVICE_RX)) {</div>
<div class="line">                <span class="comment">/* Handle guest RX */</span></div>
<div class="line">                rx_count = <a name="a15"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    vdev-&gt;rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (rx_count) {</div>
<div class="line">                    <span class="comment">/*</span></div>
<div class="line"><span class="comment">                    * Retry is enabled and the queue is</span></div>
<div class="line"><span class="comment">                    * full then we wait and retry to</span></div>
<div class="line"><span class="comment">                    * avoid packet loss. Here MAX_PKT_BURST</span></div>
<div class="line"><span class="comment">                    * must be less than virtio queue size</span></div>
<div class="line"><span class="comment">                    */</span></div>
<div class="line">                    <span class="keywordflow">if</span> (enable_retry &amp;&amp; <a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rx_count &gt;</div>
<div class="line">                        rte_vring_available_entries(dev, VIRTIO_RXQ))) {</div>
<div class="line">                        <span class="keywordflow">for</span> (retry = 0; retry &lt; burst_rx_retry_num;</div>
<div class="line">                            retry++) {</div>
<div class="line">                            <a name="a16"></a><a class="code" href="rte__cycles_8h.html#a62a6204f524c4781cae7e9e4a0b01b7f">rte_delay_us</a>(burst_rx_delay_time);</div>
<div class="line">                            <span class="keywordflow">if</span> (rx_count &lt;= rte_vring_available_entries(dev, VIRTIO_RXQ))</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    ret_count = overlay_options.rx_handle(dev, pkts_burst, rx_count);</div>
<div class="line">                    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                        <a name="a17"></a><a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                        &amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_total_atomic,</div>
<div class="line">                        rx_count);</div>
<div class="line">                        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                        &amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_atomic, ret_count);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count)) {</div>
<div class="line">                        rx_count--;</div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[rx_count]);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!vdev-&gt;remove)) {</div>
<div class="line">                <span class="comment">/* Handle guest TX*/</span></div>
<div class="line">                tx_count = <a name="a18"></a><a class="code" href="rte__virtio__net_8h.html#a74e4e31d76c01534a648b10b8b2a4851">rte_vhost_dequeue_burst</a>(dev,</div>
<div class="line">                        VIRTIO_TXQ, mbuf_pool,</div>
<div class="line">                        pkts_burst, MAX_PKT_BURST);</div>
<div class="line">                <span class="comment">/* If this is the first received packet we need to learn the MAC */</span></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;ready == DEVICE_MAC_LEARNING) &amp;&amp; tx_count) {</div>
<div class="line">                    <span class="keywordflow">if</span> (vdev-&gt;remove ||</div>
<div class="line">                        (overlay_options.tunnel_setup(vdev, pkts_burst[0]) == -1)) {</div>
<div class="line">                        <span class="keywordflow">while</span> (tx_count)</div>
<div class="line">                            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[--tx_count]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">while</span> (tx_count)</div>
<div class="line">                    virtio_tx_route(vdev, pkts_burst[--tx_count]);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* move to the next device in the list */</span></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">add_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set next as NULL and use a compiler barrier to avoid reordering. */</span></div>
<div class="line">    ll_dev-&gt;next = NULL;</div>
<div class="line">    <a name="a19"></a><a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If ll == NULL then this is the first device. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ll) {</div>
<div class="line">        <span class="comment">/* Increment to the tail of the linked list. */</span></div>
<div class="line">        <span class="keywordflow">while</span> (ll-&gt;next != NULL)</div>
<div class="line">            ll = ll-&gt;next;</div>
<div class="line"></div>
<div class="line">        ll-&gt;next = ll_dev;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        *ll_root_addr = ll_dev;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">rm_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev_last)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>((ll == NULL) || (ll_dev == NULL)))</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == ll)</div>
<div class="line">        *ll_root_addr = ll_dev-&gt;next;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(ll_dev_last != NULL))</div>
<div class="line">            ll_dev_last-&gt;next = ll_dev-&gt;next;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Remove entry form ll failed.\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">get_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_free == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    ll_dev = ll_free;</div>
<div class="line">    *ll_root_addr = ll_free-&gt;next;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">put_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr,</div>
<div class="line">    <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    ll_dev-&gt;next = ll_free;</div>
<div class="line">    *ll_root_addr = ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">alloc_data_ll(uint32_t size)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_new;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Malloc and then chain the linked list. */</span></div>
<div class="line">    ll_new = malloc(size * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_net_data_ll));</div>
<div class="line">    <span class="keywordflow">if</span> (ll_new == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;Failed to allocate memory for ll_new.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; size - 1; i++) {</div>
<div class="line">        ll_new[i].vdev = NULL;</div>
<div class="line">        ll_new[i].next = &amp;ll_new[i+1];</div>
<div class="line">    }</div>
<div class="line">    ll_new[i].next = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_new;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_data_ll(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    <a name="a20"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll =</div>
<div class="line">            malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> lcore_ll_info));</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to allocate memory for lcore_ll.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;device_num = 0;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;ll_root_used = NULL;</div>
<div class="line">        <span class="keywordflow">if</span> (nb_devices % nb_switching_cores)</div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free =</div>
<div class="line">                alloc_data_ll((nb_devices / nb_switching_cores)</div>
<div class="line">                        + 1);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free =</div>
<div class="line">                alloc_data_ll(nb_devices / nb_switching_cores);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate devices up to a maximum of MAX_DEVICES. */</span></div>
<div class="line">    ll_root_free = alloc_data_ll(MIN((nb_devices), MAX_DEVICES));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device(<span class="keyword">volatile</span> <span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    dev-&gt;<a name="a21"></a><a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp;= ~VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    vdev = (<span class="keyword">struct </span>vhost_dev *)dev-&gt;<a name="a22"></a><a class="code" href="structvirtio__net.html#a8b6505c37d4ff95854b8b00527e4d9fa">priv</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* set the remove flag. */</span></div>
<div class="line">    vdev-&gt;remove = 1;</div>
<div class="line">    while (vdev-&gt;ready != DEVICE_SAFE_REMOVE)</div>
<div class="line">        rte_pause();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from lcore ll */</span></div>
<div class="line">    ll_lcore_dev_cur = lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_lcore_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_lcore_dev_cur-&gt;vdev == vdev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_lcore_dev_last = ll_lcore_dev_cur;</div>
<div class="line">            ll_lcore_dev_cur = ll_lcore_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_lcore_dev_cur == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to find the dev to be destroy.\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from main ll */</span></div>
<div class="line">    ll_main_dev_cur = ll_root_used;</div>
<div class="line">    ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_main_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_main_dev_cur-&gt;vdev == vdev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_main_dev_last = ll_main_dev_cur;</div>
<div class="line">            ll_main_dev_cur = ll_main_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Remove entries from the lcore and main ll. */</span></div>
<div class="line">    rm_data_ll_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used,</div>
<div class="line">            ll_lcore_dev_cur, ll_lcore_dev_last);</div>
<div class="line">    rm_data_ll_entry(&amp;ll_root_used, ll_main_dev_cur, ll_main_dev_last);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set the dev_removal_flag on each lcore. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag =</div>
<div class="line">            REQUEST_DEV_REMOVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Once each core has set the dev_removal_flag to</span></div>
<div class="line"><span class="comment">     * ACK_DEV_REMOVAL we can be sure that they can no longer access</span></div>
<div class="line"><span class="comment">     * the device removed from the linked lists and that the devices</span></div>
<div class="line"><span class="comment">     * are no longer in use.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">while</span> (lcore_info[lcore].lcore_ll-&gt;dev_removal_flag</div>
<div class="line">            != ACK_DEV_REMOVAL)</div>
<div class="line">            rte_pause();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add the entries back to the lcore and main free ll.*/</span></div>
<div class="line">    put_data_ll_free_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_free,</div>
<div class="line">                ll_lcore_dev_cur);</div>
<div class="line">    put_data_ll_free_entry(&amp;ll_root_free, ll_main_dev_cur);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Decrement number of device on the lcore. */</span></div>
<div class="line">    lcore_info[vdev-&gt;coreid].lcore_ll-&gt;device_num--;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been removed &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;from data core\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line"></div>
<div class="line">    <a name="a23"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device(<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line">    <span class="keywordtype">int</span> lcore, core_add = 0;</div>
<div class="line">    uint32_t device_num_min = nb_devices;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line"></div>
<div class="line">    vdev = <a name="a24"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(<span class="stringliteral">&quot;vhost device&quot;</span>, <span class="keyword">sizeof</span>(*vdev), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (vdev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Couldn&#39;t allocate memory for vhost dev\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    vdev-&gt;dev = dev;</div>
<div class="line">    dev-&gt;<a class="code" href="structvirtio__net.html#a8b6505c37d4ff95854b8b00527e4d9fa">priv</a> = vdev;</div>
<div class="line">    <span class="comment">/* Add device to main ll */</span></div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) No free entry found in&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; linked list Device limit of %d devices per core&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; has been reached\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, nb_devices);</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;regions_hpa)</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;vdev = vdev;</div>
<div class="line">    add_data_ll_entry(&amp;ll_root_used, ll_dev);</div>
<div class="line">    vdev-&gt;rx_q = dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* reset ready flag */</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    vdev-&gt;remove = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find a suitable lcore to add the device. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll-&gt;device_num &lt; device_num_min) {</div>
<div class="line">            device_num_min = lcore_info[lcore].lcore_ll-&gt;device_num;</div>
<div class="line">            core_add = lcore;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Add device to lcore ll */</span></div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;lcore_info[core_add].lcore_ll-&gt;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to add device to data core\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">        destroy_device(dev);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev-&gt;regions_hpa);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vdev);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;vdev = vdev;</div>
<div class="line">    vdev-&gt;coreid = core_add;</div>
<div class="line"></div>
<div class="line">    add_data_ll_entry(&amp;lcore_info[vdev-&gt;coreid].lcore_ll-&gt;ll_root_used,</div>
<div class="line">            ll_dev);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>], 0,</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> device_statistics));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Disable notifications. */</span></div>
<div class="line">    rte_vhost_enable_guest_notification(dev, VIRTIO_RXQ, 0);</div>
<div class="line">    rte_vhost_enable_guest_notification(dev, VIRTIO_TXQ, 0);</div>
<div class="line">    lcore_info[vdev-&gt;coreid].lcore_ll-&gt;device_num++;</div>
<div class="line">    dev-&gt;<a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> |= VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been added to data core %d\n&quot;</span>,</div>
<div class="line">        dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, vdev-&gt;coreid);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a25"></a><a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> <a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> = {</div>
<div class="line">    .<a name="a26"></a><a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a> =  <a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a27"></a><a class="code" href="structvirtio__net__device__ops.html#a1eb7d99f01386abe9b892985d778eabd">destroy_device</a>,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    uint64_t tx_dropped, rx_dropped;</div>
<div class="line">    uint64_t tx, tx_total, rx, rx_total, rx_ip_csum, rx_l4_csum;</div>
<div class="line">    uint32_t device_fh;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> top_left[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        sleep(enable_stats);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;%s%s&quot;</span>, clr, top_left);</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;\nDevice statistics ================================&quot;</span>);</div>
<div class="line"></div>
<div class="line">        dev_ll = ll_root_used;</div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            device_fh = (uint32_t)dev_ll-&gt;vdev-&gt;dev-&gt;device_fh;</div>
<div class="line">            tx_total = dev_statistics[device_fh].tx_total;</div>
<div class="line">            tx = dev_statistics[device_fh].tx;</div>
<div class="line">            tx_dropped = tx_total - tx;</div>
<div class="line"></div>
<div class="line">            rx_total = <a name="a28"></a><a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                &amp;dev_statistics[device_fh].rx_total_atomic);</div>
<div class="line">            rx = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                &amp;dev_statistics[device_fh].rx_atomic);</div>
<div class="line">            rx_dropped = rx_total - rx;</div>
<div class="line">            rx_ip_csum = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                &amp;dev_statistics[device_fh].rx_bad_ip_csum);</div>
<div class="line">            rx_l4_csum = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(</div>
<div class="line">                &amp;dev_statistics[device_fh].rx_bad_l4_csum);</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;\nStatistics for device %&quot;</span>PRIu32<span class="stringliteral">&quot; ----------&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX bad IP csum:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX bad L4 csum:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    device_fh,</div>
<div class="line">                    tx_total,</div>
<div class="line">                    tx_dropped,</div>
<div class="line">                    tx,</div>
<div class="line">                    rx_total,</div>
<div class="line">                    rx_ip_csum,</div>
<div class="line">                    rx_l4_csum,</div>
<div class="line">                    rx_dropped,</div>
<div class="line">                    rx);</div>
<div class="line"></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n================================================\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id, core_id = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports, valid_nb_ports;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    uint16_t queue_id;</div>
<div class="line">    <span class="keyword">static</span> pthread_t tid;</div>
<div class="line">    <span class="keywordtype">char</span> thread_name[RTE_MAX_THREAD_NAME_LEN];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a29"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a30"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse app arguments */</span></div>
<div class="line">    ret = tep_termination_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid argument\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++)</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a31"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            lcore_ids[core_id++] = lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* set the number of swithcing cores available */</span></div>
<div class="line">    nb_switching_cores = <a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>()-1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the number of physical ports. */</span></div>
<div class="line">    nb_ports = <a name="a32"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        nb_ports = RTE_MAX_ETHPORTS;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Update the global var NB_PORTS and global array PORTS</span></div>
<div class="line"><span class="comment">     * and get value of var VALID_NB_PORTS according to system ports number</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    valid_nb_ports = check_ports_num(nb_ports);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((valid_nb_ports == 0) || (valid_nb_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>, nb_ports,</div>
<div class="line">            MAX_SUP_PORTS);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Create the mbuf pool. */</span></div>
<div class="line">    mbuf_pool = <a name="a33"></a><a class="code" href="rte__mempool_8h.html#a7dc1d01a45144e3203c36d1800cb8f17">rte_mempool_create</a>(</div>
<div class="line">            <span class="stringliteral">&quot;MBUF_POOL&quot;</span>,</div>
<div class="line">            NUM_MBUFS_PER_PORT</div>
<div class="line">            * valid_nb_ports,</div>
<div class="line">            MBUF_SIZE, MBUF_CACHE_SIZE,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a34"></a><a class="code" href="structrte__pktmbuf__pool__private.html">rte_pktmbuf_pool_private</a>),</div>
<div class="line">            <a name="a35"></a><a class="code" href="rte__mbuf_8h.html#af714a7341cb37bc2530ac07c84c829b6">rte_pktmbuf_pool_init</a>, NULL,</div>
<div class="line">            <a name="a36"></a><a class="code" href="rte__mbuf_8h.html#a7c0d0b427cb071856f2ff0805d608e35">rte_pktmbuf_init</a>, NULL,</div>
<div class="line">            <a name="a37"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>(), 0);</div>
<div class="line">    <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (queue_id = 0; queue_id &lt; MAX_QUEUES + 1; queue_id++)</div>
<div class="line">        vpool_array[queue_id].pool = mbuf_pool;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set log level. */</span></div>
<div class="line">    <a name="a38"></a><a class="code" href="rte__log_8h.html#a621efed26cc11c49517acfdd19f0a82f">rte_set_log_level</a>(LOG_LEVEL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Skipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (overlay_options.port_configure(portid, mbuf_pool) != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot initialize network ports\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise all linked lists. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init_data_ll() == -1)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Failed to initialize linked list\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics, 0, <span class="keyword">sizeof</span>(dev_statistics));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable stats if the user option is set. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        ret = pthread_create(&amp;tid, NULL, (<span class="keywordtype">void</span> *)print_stats, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create print-stats thread\n&quot;</span>);</div>
<div class="line">        snprintf(thread_name, RTE_MAX_THREAD_NAME_LEN, <span class="stringliteral">&quot;print-stats&quot;</span>);</div>
<div class="line">        ret = <a name="a39"></a><a class="code" href="rte__lcore_8h.html#ac33f55612c0a95f6066e3fdc5886bfed">rte_thread_setname</a>(tid, thread_name);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Cannot set print-stats name\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Launch all data cores. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">        <a name="a40"></a><a class="code" href="rte__launch_8h.html#a7456c48bfd011b04cc1c17baac5aa058">rte_eal_remote_launch</a>(switch_worker,</div>
<div class="line">            mbuf_pool, lcore_id);</div>
<div class="line">    }</div>
<div class="line">    <a name="a41"></a><a class="code" href="rte__virtio__net_8h.html#a3f23978b601f32fec3e70d36395f2856">rte_vhost_feature_disable</a>(1ULL &lt;&lt; VIRTIO_NET_F_MRG_RXBUF);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Register CUSE device to handle IOCTLs. */</span></div>
<div class="line">    ret = rte_vhost_driver_register((<span class="keywordtype">char</span> *)&amp;dev_basename);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;CUSE device setup failure.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    rte_vhost_driver_callback_register(&amp;virtio_net_device_ops);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start CUSE session. */</span></div>
<div class="line">    rte_vhost_driver_session_start();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
