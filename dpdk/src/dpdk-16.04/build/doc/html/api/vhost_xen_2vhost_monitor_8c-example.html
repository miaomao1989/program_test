<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vhost_xen/vhost_monitor.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vhost_xen/vhost_monitor.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/eventfd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;xen/xen-compat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#if __XEN_LATEST_INTERFACE_VERSION__ &lt; 0x00040200</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;xs.h&gt;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;xenstore.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_pci.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;virtio-net.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;xen_vhost.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>virtio_watch {</div>
<div class="line">    <span class="keyword">struct </span>xs_handle *xs;</div>
<div class="line">    <span class="keywordtype">int</span> watch_fd;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* device ops to add/remove device to/from data core. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> const *notify_ops;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* root address of the linked list in the configuration core. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_config_ll *ll_root = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* root address of VM. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>xen_guestlist guest_root;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_watch watch;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vq_vring_init(<span class="keyword">struct</span> <a name="_a1"></a><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num, uint8_t *p,</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> align)</div>
<div class="line">{</div>
<div class="line">    vq-&gt;<a name="a2"></a><a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> = num;</div>
<div class="line">    vq-&gt;<a name="a3"></a><a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a> = (<span class="keyword">struct </span>vring_desc *) p;</div>
<div class="line">    vq-&gt;<a name="a4"></a><a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a> = (<span class="keyword">struct </span>vring_avail *) (p +</div>
<div class="line">        num * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> vring_desc));</div>
<div class="line">    vq-&gt;<a name="a5"></a><a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a> = (<span class="keywordtype">void</span> *)</div>
<div class="line">        <a name="a6"></a><a class="code" href="rte__common_8h.html#a856650153655096752b4c2a29690a15d">RTE_ALIGN_CEIL</a>( (uintptr_t)(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[num]), align);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_watch(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>xs_handle *xs;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">int</span> fd;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* get a connection to the daemon */</span></div>
<div class="line">    xs = xs_daemon_open();</div>
<div class="line">    <span class="keywordflow">if</span> (xs == NULL) {</div>
<div class="line">        <a name="a7"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;xs_daemon_open failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = xs_watch(xs, <span class="stringliteral">&quot;/local/domain&quot;</span>, <span class="stringliteral">&quot;mytoken&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (ret == 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;%s: xs_watch failed\n&quot;</span>, __func__);</div>
<div class="line">        xs_daemon_close(xs);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* We are notified of read availability on the watch via the file descriptor. */</span></div>
<div class="line">    fd = xs_fileno(xs);</div>
<div class="line">    watch.xs = xs;</div>
<div class="line">    watch.watch_fd = fd;</div>
<div class="line"></div>
<div class="line">    TAILQ_INIT(&amp;guest_root);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>xen_guest *</div>
<div class="line">get_xen_guest(<span class="keywordtype">int</span> dom_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest = NULL;</div>
<div class="line"></div>
<div class="line">    TAILQ_FOREACH(guest, &amp;guest_root, next) {</div>
<div class="line">        <span class="keywordflow">if</span>(guest-&gt;dom_id == dom_id)</div>
<div class="line">            <span class="keywordflow">return</span> guest;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>xen_guest *</div>
<div class="line">add_xen_guest(int32_t dom_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((guest = get_xen_guest(dom_id)) != NULL)</div>
<div class="line">        <span class="keywordflow">return</span> guest;</div>
<div class="line"></div>
<div class="line">    guest = calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> xen_guest));</div>
<div class="line">    <span class="keywordflow">if</span> (guest) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: return newly created guest with %d rings\n&quot;</span>, __func__, guest-&gt;vring_num);</div>
<div class="line">        TAILQ_INSERT_TAIL(&amp;guest_root, guest, next);</div>
<div class="line">        guest-&gt;dom_id = dom_id;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> guest;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cleanup_device(<span class="keyword">struct</span> virtio_net_config_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev-&gt;dev.virtqueue_rx) {</div>
<div class="line">        <a name="a8"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(ll_dev-&gt;dev.virtqueue_rx);</div>
<div class="line">        ll_dev-&gt;dev.virtqueue_rx = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev-&gt;dev.virtqueue_tx) {</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(ll_dev-&gt;dev.virtqueue_tx);</div>
<div class="line">        ll_dev-&gt;dev.virtqueue_tx = NULL;</div>
<div class="line">    }</div>
<div class="line">    free(ll_dev);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Add entry containing a device to the device configuration linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">add_config_ll_entry(<span class="keyword">struct</span> virtio_net_config_ll *new_ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *ll_dev = ll_root;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If ll_dev == NULL then this is the first device so go to else */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev) {</div>
<div class="line">        <span class="comment">/* If the 1st device_id != 0 then we insert our device here. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (ll_dev-&gt;dev.device_fh != 0) {</div>
<div class="line">            new_ll_dev-&gt;dev.device_fh = 0;</div>
<div class="line">            new_ll_dev-&gt;next = ll_dev;</div>
<div class="line">            ll_root = new_ll_dev;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* increment through the ll until we find un unused device_id,</span></div>
<div class="line"><span class="comment">             * insert the device at that entry</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            <span class="keywordflow">while</span> ((ll_dev-&gt;next != NULL) &amp;&amp; (ll_dev-&gt;dev.device_fh == (ll_dev-&gt;next-&gt;dev.device_fh - 1)))</div>
<div class="line">                ll_dev = ll_dev-&gt;next;</div>
<div class="line"></div>
<div class="line">            new_ll_dev-&gt;dev.device_fh = ll_dev-&gt;dev.device_fh + 1;</div>
<div class="line">            new_ll_dev-&gt;next = ll_dev-&gt;next;</div>
<div class="line">            ll_dev-&gt;next = new_ll_dev;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        ll_root = new_ll_dev;</div>
<div class="line">        ll_root-&gt;dev.device_fh = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove an entry from the device configuration linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_config_ll *</div>
<div class="line">rm_config_ll_entry(<span class="keyword">struct</span> virtio_net_config_ll *ll_dev, <span class="keyword">struct</span> virtio_net_config_ll *ll_dev_last)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* First remove the device and then clean it up. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == ll_root) {</div>
<div class="line">        ll_root = ll_dev-&gt;next;</div>
<div class="line">        cleanup_device(ll_dev);</div>
<div class="line">        <span class="keywordflow">return</span> ll_root;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        ll_dev_last-&gt;next = ll_dev-&gt;next;</div>
<div class="line">        cleanup_device(ll_dev);</div>
<div class="line">        <span class="keywordflow">return</span> ll_dev_last-&gt;next;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Retrieves an entry from the devices configuration linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_config_ll *</div>
<div class="line">get_config_ll_entry(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> virtio_idx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dom_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *ll_dev = ll_root;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Loop through linked list until the dom_id is found. */</span></div>
<div class="line">    <span class="keywordflow">while</span> (ll_dev != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_dev-&gt;dev.dom_id == dom_id &amp;&amp; ll_dev-&gt;dev.virtio_idx == virtio_idx)</div>
<div class="line">            <span class="keywordflow">return</span> ll_dev;</div>
<div class="line">        ll_dev = ll_dev-&gt;next;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialise all variables in device structure.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">init_dev(<span class="keyword">struct</span> <a name="_a9"></a><a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <a name="a10"></a><a class="code" href="rte__common_8h.html#aaedd6d14e7370916fee58e0f69d8c37a">RTE_SET_USED</a>(dev);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct</span></div>
<div class="line">virtio_net_config_ll *new_device(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> virtio_idx, <span class="keyword">struct</span> xen_guest *guest)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *new_ll_dev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *virtqueue_rx, *virtqueue_tx;</div>
<div class="line">    <span class="keywordtype">size_t</span> <a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a>, vq_ring_size, vq_size = VQ_DESC_NUM;</div>
<div class="line">    <span class="keywordtype">void</span> *vq_ring_virt_mem;</div>
<div class="line">    uint64_t gpa;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup device and virtqueues. */</span></div>
<div class="line">    new_ll_dev   = calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_net_config_ll));</div>
<div class="line">    virtqueue_rx = <a name="a11"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(NULL, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a>), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    virtqueue_tx = <a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(NULL, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a>), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (new_ll_dev == NULL || virtqueue_rx == NULL || virtqueue_tx == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    new_ll_dev-&gt;dev.virtqueue_rx = virtqueue_rx;</div>
<div class="line">    new_ll_dev-&gt;dev.virtqueue_tx = virtqueue_tx;</div>
<div class="line">    new_ll_dev-&gt;dev.dom_id       = guest-&gt;dom_id;</div>
<div class="line">    new_ll_dev-&gt;dev.virtio_idx   = virtio_idx;</div>
<div class="line">    <span class="comment">/* Initialise device and virtqueues. */</span></div>
<div class="line">    init_dev(&amp;new_ll_dev-&gt;dev);</div>
<div class="line"></div>
<div class="line">    size = vring_size(vq_size, VIRTIO_PCI_VRING_ALIGN);</div>
<div class="line">    vq_ring_size = <a class="code" href="rte__common_8h.html#a856650153655096752b4c2a29690a15d">RTE_ALIGN_CEIL</a>(size, VIRTIO_PCI_VRING_ALIGN);</div>
<div class="line">    (void)vq_ring_size;</div>
<div class="line"></div>
<div class="line">    vq_ring_virt_mem = guest-&gt;vring[virtio_idx].rxvring_addr;</div>
<div class="line">    vq_vring_init(virtqueue_rx, vq_size, vq_ring_virt_mem, VIRTIO_PCI_VRING_ALIGN);</div>
<div class="line">    virtqueue_rx-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> = vq_size;</div>
<div class="line">    virtqueue_rx-&gt;<a name="a12"></a><a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>virtio_net_hdr);</div>
<div class="line"></div>
<div class="line">    vq_ring_virt_mem = guest-&gt;vring[virtio_idx].txvring_addr;</div>
<div class="line">    vq_vring_init(virtqueue_tx, vq_size, vq_ring_virt_mem, VIRTIO_PCI_VRING_ALIGN);</div>
<div class="line">    virtqueue_tx-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> = vq_size;</div>
<div class="line">    memcpy(&amp;new_ll_dev-&gt;dev.mac_address, &amp;guest-&gt;vring[virtio_idx].addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a13"></a><a class="code" href="structether__addr.html">ether_addr</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* virtio_memory has to be one per domid */</span></div>
<div class="line">    new_ll_dev-&gt;dev.mem = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a14"></a><a class="code" href="structvirtio__memory.html">virtio_memory</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a15"></a><a class="code" href="structvirtio__memory__regions.html">virtio_memory_regions</a>) * MAX_XENVIRT_MEMPOOL);</div>
<div class="line">    new_ll_dev-&gt;dev.mem-&gt;nregions = guest-&gt;pool_num;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; guest-&gt;pool_num; i++) {</div>
<div class="line">        gpa = new_ll_dev-&gt;dev.mem-&gt;regions[i].guest_phys_address =</div>
<div class="line">                (uint64_t)((uintptr_t)guest-&gt;mempool[i].gva);</div>
<div class="line">        new_ll_dev-&gt;dev.mem-&gt;regions[i].guest_phys_address_end =</div>
<div class="line">                gpa + guest-&gt;mempool[i].mempfn_num * getpagesize();</div>
<div class="line">        new_ll_dev-&gt;dev.mem-&gt;regions[i].address_offset =</div>
<div class="line">                (uint64_t)((uintptr_t)guest-&gt;mempool[i].hva -</div>
<div class="line">                    (uintptr_t)gpa);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    new_ll_dev-&gt;next = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add entry to device configuration linked list. */</span></div>
<div class="line">    add_config_ll_entry(new_ll_dev);</div>
<div class="line">    <span class="keywordflow">return</span> new_ll_dev;</div>
<div class="line">err:</div>
<div class="line">    free(new_ll_dev);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(virtqueue_rx);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(virtqueue_tx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_guest(<span class="keyword">struct</span> xen_guest *guest)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; guest-&gt;vring_num; i++)</div>
<div class="line">        cleanup_vring(&amp;guest-&gt;vring[i]);</div>
<div class="line">    <span class="comment">/* clean mempool */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; guest-&gt;pool_num; i++)</div>
<div class="line">        cleanup_mempool(&amp;guest-&gt;mempool[i]);</div>
<div class="line">    free(guest);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function will cleanup the device and remove it from device configuration linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> virtio_idx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dom_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *ll_dev_cur_ctx, *ll_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *ll_dev_cur = ll_root;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* clean virtio device */</span></div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest = NULL;</div>
<div class="line">    guest = get_xen_guest(dom_id);</div>
<div class="line">    <span class="keywordflow">if</span> (guest == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find the linked list entry for the device to be removed. */</span></div>
<div class="line">    ll_dev_cur_ctx = get_config_ll_entry(virtio_idx, dom_id);</div>
<div class="line">    <span class="keywordflow">while</span> (ll_dev_cur != NULL) {</div>
<div class="line">        <span class="comment">/* If the device is found or a device that doesn&#39;t exist is found then it is removed. */</span></div>
<div class="line">        <span class="keywordflow">if</span>  (ll_dev_cur == ll_dev_cur_ctx) {</div>
<div class="line">            <span class="keywordflow">if</span> ((ll_dev_cur-&gt;dev.flags &amp; VIRTIO_DEV_RUNNING))</div>
<div class="line">                notify_ops-&gt;<a name="a16"></a><a class="code" href="structvirtio__net__device__ops.html#a1eb7d99f01386abe9b892985d778eabd">destroy_device</a>(&amp;(ll_dev_cur-&gt;dev));</div>
<div class="line">            ll_dev_cur = rm_config_ll_entry(ll_dev_cur, ll_dev_last);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_dev_last = ll_dev_cur;</div>
<div class="line">            ll_dev_cur = ll_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s guest:%p vring:%p rxvring:%p txvring:%p flag:%p\n&quot;</span>,</div>
<div class="line">        __func__, guest, &amp;guest-&gt;vring[virtio_idx], guest-&gt;vring[virtio_idx].rxvring_addr, guest-&gt;vring[virtio_idx].txvring_addr, guest-&gt;vring[virtio_idx].flag);</div>
<div class="line">    cleanup_vring(&amp;guest-&gt;vring[virtio_idx]);</div>
<div class="line">    guest-&gt;vring[virtio_idx].removed = 1;</div>
<div class="line">    guest-&gt;vring_num -= 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">watch_unmap_event(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest  = NULL;</div>
<div class="line">    <span class="keywordtype">bool</span> remove_request;</div>
<div class="line"></div>
<div class="line">    TAILQ_FOREACH(guest, &amp;guest_root, next) {</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; MAX_VIRTIO; i++) {</div>
<div class="line">            <span class="keywordflow">if</span> (guest-&gt;vring[i].dom_id &amp;&amp; guest-&gt;vring[i].removed == 0 &amp;&amp; *guest-&gt;vring[i].flag == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;\n\n&quot;</span>);</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  #####%s:  (%d, %d) to be removed\n&quot;</span>,</div>
<div class="line">                    __func__,</div>
<div class="line">                    guest-&gt;vring[i].dom_id,</div>
<div class="line">                    i);</div>
<div class="line">                destroy_device(i, guest-&gt;dom_id);</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: DOM %u, vring num: %d\n&quot;</span>,</div>
<div class="line">                    __func__,</div>
<div class="line">                    guest-&gt;dom_id,</div>
<div class="line">                    guest-&gt;vring_num);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">_find_next_remove:</div>
<div class="line">    guest = NULL;</div>
<div class="line">    remove_request = <span class="keyword">false</span>;</div>
<div class="line">    TAILQ_FOREACH(guest, &amp;guest_root, next) {</div>
<div class="line">        <span class="keywordflow">if</span> (guest-&gt;vring_num == 0) {</div>
<div class="line">            remove_request = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (remove_request == <span class="keyword">true</span>) {</div>
<div class="line">        TAILQ_REMOVE(&amp;guest_root, guest, next);</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  #####%s: destroy guest (%d)\n&quot;</span>, __func__, guest-&gt;dom_id);</div>
<div class="line">        destroy_guest(guest);</div>
<div class="line">        <span class="keywordflow">goto</span> _find_next_remove;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * OK, if the guest starts first, it is ok.</span></div>
<div class="line"><span class="comment"> * if host starts first, it is ok.</span></div>
<div class="line"><span class="comment"> * if guest starts, and has run for sometime, and host stops and restarts,</span></div>
<div class="line"><span class="comment"> * then last_used_idx  0? how to solve this. */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> virtio_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t len, e_num;</div>
<div class="line">    uint32_t i,j;</div>
<div class="line">    <span class="keywordtype">char</span> **dom;</div>
<div class="line">    <span class="keywordtype">char</span> *status;</div>
<div class="line">    <span class="keywordtype">int</span> dom_id;</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">char</span> node[PATH_MAX];</div>
<div class="line">    xs_transaction_t th;</div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *net_config;</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    <span class="keywordtype">int</span> val;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init env for watch the node */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init_watch() &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    dom = xs_directory(watch.xs, XBT_NULL, <span class="stringliteral">&quot;/local/domain&quot;</span>, &amp;e_num);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; e_num; i++) {</div>
<div class="line">        errno = 0;</div>
<div class="line">        dom_id = strtol(dom[i], &amp;end, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (errno != 0 || end == NULL || dom_id == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; RTE_MAX_ETHPORTS; j++) {</div>
<div class="line">            snprintf(node, PATH_MAX, <span class="stringliteral">&quot;%s%d&quot;</span>, VIRTIO_START, j);</div>
<div class="line">            snprintf(path, PATH_MAX, XEN_VM_NODE_FMT,</div>
<div class="line">                    dom_id, node);</div>
<div class="line"></div>
<div class="line">            th = xs_transaction_start(watch.xs);</div>
<div class="line">            status = xs_read(watch.xs, th, path, &amp;len);</div>
<div class="line">            xs_transaction_end(watch.xs, th, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (status == NULL)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* if there&#39;s any valid virtio device */</span></div>
<div class="line">            errno = 0;</div>
<div class="line">            val = strtol(status, &amp;end, 0);</div>
<div class="line">            <span class="keywordflow">if</span> (errno != 0 || end == NULL || dom_id == 0)</div>
<div class="line">                val = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (val == 1) {</div>
<div class="line">                guest = add_xen_guest(dom_id);</div>
<div class="line">                <span class="keywordflow">if</span> (guest == NULL)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  there&#39;s a new virtio existed, new a virtio device\n\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  parse_vringnode dom_id %d virtioidx %d\n&quot;</span>,dom_id,j);</div>
<div class="line">                <span class="keywordflow">if</span> (parse_vringnode(guest, j)) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  there is invalid information in xenstore\n&quot;</span>);</div>
<div class="line">                    TAILQ_REMOVE(&amp;guest_root, guest, next);</div>
<div class="line">                    destroy_guest(guest);</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="comment">/*if pool_num &gt; 0, then mempool has already been parsed*/</span></div>
<div class="line">                <span class="keywordflow">if</span> (guest-&gt;pool_num == 0 &amp;&amp; parse_mempoolnode(guest)) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  there is error information in xenstore\n&quot;</span>);</div>
<div class="line">                    TAILQ_REMOVE(&amp;guest_root, guest, next);</div>
<div class="line">                    destroy_guest(guest);</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                net_config = new_device(j, guest);</div>
<div class="line">                <span class="comment">/* every thing is ready now, added into data core */</span></div>
<div class="line">                notify_ops-&gt;<a name="a17"></a><a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a>(&amp;net_config-&gt;dev);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(dom);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">virtio_monitor_loop(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> **vec;</div>
<div class="line">    xs_transaction_t th;</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dom_id;</div>
<div class="line">    uint32_t virtio_idx;</div>
<div class="line">    <span class="keyword">struct </span>xen_guest *guest;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_config_ll *net_config;</div>
<div class="line">    <span class="keyword">enum</span> fieldnames {</div>
<div class="line">        FLD_NULL = 0,</div>
<div class="line">        FLD_LOCAL,</div>
<div class="line">        FLD_DOMAIN,</div>
<div class="line">        FLD_ID,</div>
<div class="line">        FLD_CONTROL,</div>
<div class="line">        FLD_DPDK,</div>
<div class="line">        FLD_NODE,</div>
<div class="line">        _NUM_FLD</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">char</span> *str_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">char</span> *str;</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line"></div>
<div class="line">    virtio_init();</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        watch_unmap_event();</div>
<div class="line"></div>
<div class="line">        usleep(50);</div>
<div class="line">        vec = xs_check_watch(watch.xs);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (vec == NULL)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        th = xs_transaction_start(watch.xs);</div>
<div class="line"></div>
<div class="line">        buf = xs_read(watch.xs, th, vec[XS_WATCH_PATH],&amp;len);</div>
<div class="line">        xs_transaction_end(watch.xs, th, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (buf) {</div>
<div class="line">            <span class="comment">/* theres&#39; some node for vhost existed */</span></div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a18"></a><a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(vec[XS_WATCH_PATH], strnlen(vec[XS_WATCH_PATH], PATH_MAX),</div>
<div class="line">                        str_fld, _NUM_FLD, <span class="charliteral">&#39;/&#39;</span>) == _NUM_FLD) {</div>
<div class="line">                <span class="keywordflow">if</span> (strstr(str_fld[FLD_NODE], VIRTIO_START)) {</div>
<div class="line">                    errno = 0;</div>
<div class="line">                    str = str_fld[FLD_ID];</div>
<div class="line">                    dom_id = strtoul(str, &amp;end, 0);</div>
<div class="line">                    <span class="keywordflow">if</span> (errno != 0 || end == NULL || end == str ) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;invalid domain id\n&quot;</span>);</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    errno = 0;</div>
<div class="line">                    str = str_fld[FLD_NODE] + <span class="keyword">sizeof</span>(VIRTIO_START) - 1;</div>
<div class="line">                    virtio_idx = strtoul(str, &amp;end, 0);</div>
<div class="line">                    <span class="keywordflow">if</span> (errno != 0 || end == NULL || end == str</div>
<div class="line">                            || virtio_idx &gt; MAX_VIRTIO) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;invalid virtio idx\n&quot;</span>);</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    }</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  #####virtio dev (%d, %d) is started\n&quot;</span>, dom_id, virtio_idx);</div>
<div class="line"></div>
<div class="line">                    guest = add_xen_guest(dom_id);</div>
<div class="line">                    <span class="keywordflow">if</span> (guest == NULL)</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    guest-&gt;dom_id = dom_id;</div>
<div class="line">                    <span class="keywordflow">if</span> (parse_vringnode(guest, virtio_idx)) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  there is invalid information in xenstore\n&quot;</span>);</div>
<div class="line">                        <span class="comment">/*guest newly created? guest existed ?*/</span></div>
<div class="line">                        TAILQ_REMOVE(&amp;guest_root, guest, next);</div>
<div class="line">                        destroy_guest(guest);</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">/*if pool_num &gt; 0, then mempool has already been parsed*/</span></div>
<div class="line">                    <span class="keywordflow">if</span> (guest-&gt;pool_num == 0 &amp;&amp; parse_mempoolnode(guest)) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  there is error information in xenstore\n&quot;</span>);</div>
<div class="line">                        TAILQ_REMOVE(&amp;guest_root, guest, next);</div>
<div class="line">                        destroy_guest(guest);</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">                    net_config = new_device(virtio_idx, guest);</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  Add to dataplane core\n&quot;</span>);</div>
<div class="line">                    notify_ops-&gt;<a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a>(&amp;net_config-&gt;dev);</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        free(vec);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Register ops so that we can add/remove device to data core.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">init_virtio_xen(<span class="keyword">struct</span> <a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> <span class="keyword">const</span> *<span class="keyword">const</span> ops)</div>
<div class="line">{</div>
<div class="line">    notify_ops = ops;</div>
<div class="line">    <span class="keywordflow">if</span> (xenhost_init())</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
