<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: tep_termination/vxlan_setup.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">tep_termination/vxlan_setup.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_ether.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_vlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__udp_8h.html">rte_udp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rte__virtio__net_8h.html">rte_virtio_net.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vxlan.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vxlan_setup.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define IPV4_HEADER_LEN 20</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define UDP_HEADER_LEN  8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define VXLAN_HEADER_LEN 8</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IP_VERSION 0x40</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IP_HDRLEN  0x05 </span><span class="comment">/* default IP header length == five 32-bits words. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IP_DEFTTL  64   </span><span class="comment">/* from RFC 1340. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IP_VHL_DEF (IP_VERSION | IP_HDRLEN)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IP_DN_FRAGMENT_FLAG 0x0040</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Used to compare MAC addresses. */</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_CMP 0xFFFFFFFFFFFFULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Configurable number of RX/TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Default inner VLAN ID */</span></div>
<div class="line"><span class="preprocessor">#define INNER_VLAN_ID 100</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* VXLAN device */</span></div>
<div class="line"><span class="keyword">struct </span>vxlan_conf vxdev;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> app_ip_hdr[VXLAN_N_PORTS];</div>
<div class="line"><span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structether__hdr.html">ether_hdr</a> app_l2_hdr[VXLAN_N_PORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* local VTEP IP address */</span></div>
<div class="line">uint8_t vxlan_multicast_ips[2][4] = { {239, 1, 1, 1 }, {239, 1, 2, 1 } };</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Remote VTEP IP address */</span></div>
<div class="line">uint8_t vxlan_overlay_ips[2][4] = { {192, 168, 10, 1}, {192, 168, 30, 1} };</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Remote VTEP MAC address */</span></div>
<div class="line">uint8_t peer_mac[6] = {0x00, 0x11, 0x01, 0x00, 0x00, 0x01};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* VXLAN RX filter type */</span></div>
<div class="line">uint8_t tep_filter_type[] = {RTE_TUNNEL_FILTER_IMAC_TENID,</div>
<div class="line">            RTE_TUNNEL_FILTER_IMAC_IVLAN_TENID,</div>
<div class="line">            RTE_TUNNEL_FILTER_OMAC_TENID_IMAC,};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Options for configuring ethernet port */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf = {</div>
<div class="line">    .<a name="a3"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a4"></a><a class="code" href="structrte__eth__rxmode.html#a7aa0d86e260af96607d007c7361ab21e">split_hdr_size</a> = 0,</div>
<div class="line">        .header_split   = 0, </div>
<div class="line">        .hw_ip_checksum = 0, </div>
<div class="line">        .hw_vlan_filter = 0, </div>
<div class="line">        .jumbo_frame    = 0, </div>
<div class="line">        .hw_strip_crc   = 0, </div>
<div class="line">    },</div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a5"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> uint16_t tenant_id_conf[] = {</div>
<div class="line">    1000, 1000, 1001, 1001, 1002, 1002, 1003, 1003,</div>
<div class="line">    1004, 1004, 1005, 1005, 1006, 1006, 1007, 1007,</div>
<div class="line">    1008, 1008, 1009, 1009, 1010, 1010, 1011, 1011,</div>
<div class="line">    1012, 1012, 1013, 1013, 1014, 1014, 1015, 1015,</div>
<div class="line">    1016, 1016, 1017, 1017, 1018, 1018, 1019, 1019,</div>
<div class="line">    1020, 1020, 1021, 1021, 1022, 1022, 1023, 1023,</div>
<div class="line">    1024, 1024, 1025, 1025, 1026, 1026, 1027, 1027,</div>
<div class="line">    1028, 1028, 1029, 1029, 1030, 1030, 1031, 1031,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">vxlan_port_init(uint8_t <a name="_a6"></a><a class="code" href="structport.html">port</a>, <span class="keyword">struct</span> <a name="_a7"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    uint16_t rx_rings, tx_rings = (uint16_t)<a name="a9"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t rx_ring_size = RTE_TEST_RX_DESC_DEFAULT;</div>
<div class="line">    <span class="keyword">const</span> uint16_t tx_ring_size = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a10"></a><a class="code" href="structrte__eth__udp__tunnel.html">rte_eth_udp_tunnel</a> tunnel_udp;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a11"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> *rxconf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a12"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> *txconf;</div>
<div class="line">    <span class="keyword">struct </span>vxlan_conf *pconf = &amp;vxdev;</div>
<div class="line"></div>
<div class="line">    pconf-&gt;dst_port = udp_port;</div>
<div class="line"></div>
<div class="line">    <a name="a13"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (dev_info.max_rx_queues &gt; MAX_QUEUES) {</div>
<div class="line">        <a name="a14"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;please define MAX_QUEUES no less than %u in %s\n&quot;</span>,</div>
<div class="line">            dev_info.max_rx_queues, __FILE__);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    rxconf = &amp;dev_info.default_rxconf;</div>
<div class="line">    txconf = &amp;dev_info.default_txconf;</div>
<div class="line">    txconf-&gt;<a name="a15"></a><a class="code" href="structrte__eth__txconf.html#a80d79f1953993347e9b0312a2096f86e">txq_flags</a> = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port &gt;= <a name="a16"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>())</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    rx_rings = nb_devices;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Configure ethernet device. */</span></div>
<div class="line">    retval = <a name="a17"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, rx_rings, tx_rings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup the queues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rx_rings; q++) {</div>
<div class="line">        retval = <a name="a18"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, q, rx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port),</div>
<div class="line">                        rxconf,</div>
<div class="line">                        mbuf_pool);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; tx_rings; q++) {</div>
<div class="line">        retval = <a name="a19"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, q, tx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port),</div>
<div class="line">                        txconf);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the device. */</span></div>
<div class="line">    retval  = <a name="a20"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Configure UDP port for UDP tunneling */</span></div>
<div class="line">    tunnel_udp.udp_port = udp_port;</div>
<div class="line">    tunnel_udp.prot_type = RTE_TUNNEL_TYPE_VXLAN;</div>
<div class="line">    retval = <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#a702411d38d91dd6f8c6c16789fea14db">rte_eth_dev_udp_tunnel_port_add</a>(port, &amp;tunnel_udp);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    <a name="a22"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(port, &amp;ports_eth_addr[port]);</div>
<div class="line">    <a name="a23"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, PORT, <span class="stringliteral">&quot;Port %u MAC: %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8</div>
<div class="line">            <span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)port,</div>
<div class="line">            ports_eth_addr[port].addr_bytes[0],</div>
<div class="line">            ports_eth_addr[port].addr_bytes[1],</div>
<div class="line">            ports_eth_addr[port].addr_bytes[2],</div>
<div class="line">            ports_eth_addr[port].addr_bytes[3],</div>
<div class="line">            ports_eth_addr[port].addr_bytes[4],</div>
<div class="line">            ports_eth_addr[port].addr_bytes[5]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (tso_segsz != 0) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">        <a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line">        <span class="keywordflow">if</span> ((dev_info.tx_offload_capa &amp; DEV_TX_OFFLOAD_TCP_TSO) == 0)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, PORT,</div>
<div class="line">                <span class="stringliteral">&quot;hardware TSO offload is not supported\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">vxlan_rx_process(<span class="keyword">struct</span> <a name="_a24"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rx_decap)</div>
<div class="line">        ret = decapsulation(pkt);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vxlan_tx_process(uint8_t queue_id, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (tx_encap)</div>
<div class="line">        encapsulation(pkt, queue_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function learns the MAC address of the device and set init</span></div>
<div class="line"><span class="comment"> * L2 header and L3 header info.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">vxlan_link(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *pkt_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a25"></a><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = vdev-&gt;dev;</div>
<div class="line">    uint64_t portid = dev-&gt;<a name="a26"></a><a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *ip;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a name="_a27"></a><a class="code" href="structrte__eth__tunnel__filter__conf.html">rte_eth_tunnel_filter_conf</a> tunnel_filter_conf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a28"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(portid &gt; VXLAN_N_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) WARNING: Not configuring device,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;as already have %d ports for VXLAN.&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, VXLAN_N_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Learn MAC address of guest device from packet */</span></div>
<div class="line">    pkt_hdr = <a name="a29"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a30"></a><a class="code" href="rte__ether_8h.html#ab962929f8a778e1d675fe86361954bc3">is_same_ether_addr</a>(&amp;(pkt_hdr-&gt;<a name="a31"></a><a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>), &amp;vdev-&gt;mac_address)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) WARNING: This device is using an existing&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; MAC address and has not been registered.\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a32"></a><a class="code" href="rte__ether_8h.html#abf4fcaacb1ad2010711b7c880ec2ed20">ETHER_ADDR_LEN</a>; i++) {</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[i] =</div>
<div class="line">            vxdev.port[portid].vport_mac.addr_bytes[i] =</div>
<div class="line">            pkt_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a name="a33"></a><a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[i];</div>
<div class="line">        vxdev.port[portid].peer_mac.addr_bytes[i] = peer_mac[i];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    memset(&amp;tunnel_filter_conf, 0,</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structrte__eth__tunnel__filter__conf.html">rte_eth_tunnel_filter_conf</a>));</div>
<div class="line"></div>
<div class="line">    <a name="a34"></a><a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[0], &amp;tunnel_filter_conf.outer_mac);</div>
<div class="line">    tunnel_filter_conf.filter_type = tep_filter_type[filter_idx];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* inner MAC */</span></div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;vdev-&gt;mac_address, &amp;tunnel_filter_conf.inner_mac);</div>
<div class="line"></div>
<div class="line">    tunnel_filter_conf.queue_id = vdev-&gt;rx_q;</div>
<div class="line">    tunnel_filter_conf.tenant_id = tenant_id_conf[vdev-&gt;rx_q];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (tep_filter_type[filter_idx] == RTE_TUNNEL_FILTER_IMAC_IVLAN_TENID)</div>
<div class="line">        tunnel_filter_conf.inner_vlan = INNER_VLAN_ID;</div>
<div class="line"></div>
<div class="line">    tunnel_filter_conf.tunnel_type = RTE_TUNNEL_TYPE_VXLAN;</div>
<div class="line"></div>
<div class="line">    ret = <a name="a35"></a><a class="code" href="rte__ethdev_8h.html#a07f393d559fc9f72efe892413cb8208d">rte_eth_dev_filter_ctrl</a>(ports[0],</div>
<div class="line">        RTE_ETH_FILTER_TUNNEL,</div>
<div class="line">        <a name="a36"></a><a class="code" href="rte__eth__ctrl_8h.html#aa04c5276c9394e64bd94fac950bba9b7a882958eb0c8ace333823773114bc85f0">RTE_ETH_FILTER_ADD</a>,</div>
<div class="line">        &amp;tunnel_filter_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;%d Failed to add device MAC address to cloud filter\n&quot;</span>,</div>
<div class="line">        vdev-&gt;rx_q);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Print out inner MAC and VNI info. */</span></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) MAC_ADDRESS %02x:%02x:%02x:%02x:%02x:%02x and VNI %d registered\n&quot;</span>,</div>
<div class="line">        vdev-&gt;rx_q,</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[0],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[1],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[2],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[3],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[4],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[5],</div>
<div class="line">        tenant_id_conf[vdev-&gt;rx_q]);</div>
<div class="line"></div>
<div class="line">    vxdev.port[portid].vport_id = portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {</div>
<div class="line">        <span class="comment">/* Local VTEP IP */</span></div>
<div class="line">        vxdev.port_ip |= vxlan_multicast_ips[portid][i] &lt;&lt; (8 * i);</div>
<div class="line">        <span class="comment">/* Remote VTEP IP */</span></div>
<div class="line">        vxdev.port[portid].peer_ip |=</div>
<div class="line">            vxlan_overlay_ips[portid][i] &lt;&lt; (8 * i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vxdev.out_key = tenant_id_conf[vdev-&gt;rx_q];</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;vxdev.port[portid].peer_mac,</div>
<div class="line">            &amp;app_l2_hdr[portid].d_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[0],</div>
<div class="line">            &amp;app_l2_hdr[portid].s_addr);</div>
<div class="line">    app_l2_hdr[portid].ether_type = <a name="a37"></a><a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(<a name="a38"></a><a class="code" href="rte__ether_8h.html#a08cc3337f1584270c6f9de9bffd14b2b">ETHER_TYPE_IPv4</a>);</div>
<div class="line"></div>
<div class="line">    ip = &amp;app_ip_hdr[portid];</div>
<div class="line">    ip-&gt;<a name="a39"></a><a class="code" href="structipv4__hdr.html#a0f143df6fd0e09aba2963a160e33ce16">version_ihl</a> = IP_VHL_DEF;</div>
<div class="line">    ip-&gt;<a name="a40"></a><a class="code" href="structipv4__hdr.html#ad9000ab1449737219532b889f0da0f02">type_of_service</a> = 0;</div>
<div class="line">    ip-&gt;<a name="a41"></a><a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a> = 0;</div>
<div class="line">    ip-&gt;<a name="a42"></a><a class="code" href="structipv4__hdr.html#ad051e090f3817f4549df7dc178790f45">packet_id</a> = 0;</div>
<div class="line">    ip-&gt;<a name="a43"></a><a class="code" href="structipv4__hdr.html#a5e6d9f74c7f28441e7adf6ae4867cc78">fragment_offset</a> = IP_DN_FRAGMENT_FLAG;</div>
<div class="line">    ip-&gt;<a name="a44"></a><a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a> = IP_DEFTTL;</div>
<div class="line">    ip-&gt;<a name="a45"></a><a class="code" href="structipv4__hdr.html#a513eb1be3a24fe8df91530edd4517ade">next_proto_id</a> = IPPROTO_UDP;</div>
<div class="line">    ip-&gt;<a name="a46"></a><a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a> = 0;</div>
<div class="line">    ip-&gt;<a name="a47"></a><a class="code" href="structipv4__hdr.html#a6a462ff6ecd832025b4f8934f226d5b5">src_addr</a> = vxdev.port_ip;</div>
<div class="line">    ip-&gt;<a name="a48"></a><a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a> = vxdev.port[portid].peer_ip;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set device as ready for RX. */</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_RX;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">vxlan_unlink(<span class="keyword">struct</span> vhost_dev *vdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i = 0, rx_count;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__tunnel__filter__conf.html">rte_eth_tunnel_filter_conf</a> tunnel_filter_conf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vdev-&gt;ready == DEVICE_RX) {</div>
<div class="line">        memset(&amp;tunnel_filter_conf, 0,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structrte__eth__tunnel__filter__conf.html">rte_eth_tunnel_filter_conf</a>));</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[0], &amp;tunnel_filter_conf.outer_mac);</div>
<div class="line">        <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;vdev-&gt;mac_address, &amp;tunnel_filter_conf.inner_mac);</div>
<div class="line">        tunnel_filter_conf.tenant_id = tenant_id_conf[vdev-&gt;rx_q];</div>
<div class="line">        tunnel_filter_conf.filter_type = tep_filter_type[filter_idx];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (tep_filter_type[filter_idx] ==</div>
<div class="line">            RTE_TUNNEL_FILTER_IMAC_IVLAN_TENID)</div>
<div class="line">            tunnel_filter_conf.inner_vlan = INNER_VLAN_ID;</div>
<div class="line"></div>
<div class="line">        tunnel_filter_conf.queue_id = vdev-&gt;rx_q;</div>
<div class="line">        tunnel_filter_conf.tunnel_type = RTE_TUNNEL_TYPE_VXLAN;</div>
<div class="line"></div>
<div class="line">        ret = <a class="code" href="rte__ethdev_8h.html#a07f393d559fc9f72efe892413cb8208d">rte_eth_dev_filter_ctrl</a>(ports[0],</div>
<div class="line">                RTE_ETH_FILTER_TUNNEL,</div>
<div class="line">                <a name="a49"></a><a class="code" href="rte__eth__ctrl_8h.html#aa04c5276c9394e64bd94fac950bba9b7afee5d5303ad409c59512fa08331e18e1">RTE_ETH_FILTER_DELETE</a>,</div>
<div class="line">                &amp;tunnel_filter_conf);</div>
<div class="line">        <span class="keywordflow">if</span> (ret) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">                <span class="stringliteral">&quot;%d Failed to add device MAC address to cloud filter\n&quot;</span>,</div>
<div class="line">                vdev-&gt;rx_q);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rte__ether_8h.html#abf4fcaacb1ad2010711b7c880ec2ed20">ETHER_ADDR_LEN</a>; i++)</div>
<div class="line">            vdev-&gt;mac_address.addr_bytes[i] = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Clear out the receive buffers */</span></div>
<div class="line">        rx_count = <a name="a50"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                (uint16_t)vdev-&gt;rx_q,</div>
<div class="line">                pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (rx_count) {</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++)</div>
<div class="line">                <a name="a51"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[i]);</div>
<div class="line"></div>
<div class="line">            rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)vdev-&gt;rx_q,</div>
<div class="line">                    pkts_burst, MAX_PKT_BURST);</div>
<div class="line">        }</div>
<div class="line">        vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Transmit packets after encapsulating */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">vxlan_tx_pkts(uint8_t port_id, uint16_t queue_id,</div>
<div class="line">        <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **tx_pkts, uint16_t nb_pkts) {</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">    uint16_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_pkts; i++)</div>
<div class="line">        vxlan_tx_process(queue_id, tx_pkts[i]);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a52"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port_id, queue_id, tx_pkts, nb_pkts);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check for decapsulation and pass packets directly to VIRTIO device */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">vxlan_rx_pkts(<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts_burst,</div>
<div class="line">        uint32_t rx_count)</div>
<div class="line">{</div>
<div class="line">    uint32_t i = 0;</div>
<div class="line">    uint32_t count = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_valid[rx_count];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">            <a name="a53"></a><a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                &amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_bad_ip_csum,</div>
<div class="line">                (pkts_burst[i]-&gt;<a name="a54"></a><a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a name="a55"></a><a class="code" href="rte__mbuf_8h.html#ad63578554776ee75a77d98241031ab7a">PKT_RX_IP_CKSUM_BAD</a>)</div>
<div class="line">                != 0);</div>
<div class="line">            <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(</div>
<div class="line">                &amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>].rx_bad_ip_csum,</div>
<div class="line">                (pkts_burst[i]-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a name="a56"></a><a class="code" href="rte__mbuf_8h.html#a185cd397ccf014163c7d0d1a76d65eb9">PKT_RX_L4_CKSUM_BAD</a>)</div>
<div class="line">                != 0);</div>
<div class="line">        }</div>
<div class="line">        ret = vxlan_rx_process(pkts_burst[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 0))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        pkts_valid[count] = pkts_burst[i];</div>
<div class="line">            count++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a name="a57"></a><a class="code" href="rte__virtio__net_8h.html#accee7f1bb7727ee9e39c452119d632b7">rte_vhost_enqueue_burst</a>(dev, VIRTIO_RXQ, pkts_valid, count);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
