<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: qos_sched/args.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">qos_sched/args.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;locale.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define APP_NAME &quot;qos_sched&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_OPT_VALUES 8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SYS_CPU_DIR &quot;/sys/devices/system/cpu/cpu%u/topology/&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> uint32_t app_master_core = 1;</div>
<div class="line"><span class="keyword">static</span> uint32_t app_numa_mask;</div>
<div class="line"><span class="keyword">static</span> uint64_t app_used_core_mask = 0;</div>
<div class="line"><span class="keyword">static</span> uint64_t app_used_port_mask = 0;</div>
<div class="line"><span class="keyword">static</span> uint64_t app_used_rx_port_mask = 0;</div>
<div class="line"><span class="keyword">static</span> uint64_t app_used_tx_port_mask = 0;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> usage[] =</div>
<div class="line">    <span class="stringliteral">&quot;                                                                               \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    %s &lt;APP PARAMS&gt;                                                            \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;                                                                               \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;Application mandatory parameters:                                              \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --pfc \&quot;RX PORT, TX PORT, RX LCORE, WT LCORE\&quot; : Packet flow configuration \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           multiple pfc can be configured in command line                      \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;                                                                               \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;Application optional parameters:                                               \n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    --i     : run in interactive mode (default value is %u)                    \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --mst I : master core index (default value is %u)                          \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --rsz \&quot;A, B, C\&quot; :   Ring sizes                                           \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           A = Size (in number of buffer descriptors) of each of the NIC RX    \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               rings read by the I/O RX lcores (default value is %u)           \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           B = Size (in number of elements) of each of the SW rings used by the\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               I/O RX lcores to send packets to worker lcores (default value is\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               %u)                                                             \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           C = Size (in number of buffer descriptors) of each of the NIC TX    \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               rings written by worker lcores (default value is %u)            \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --bsz \&quot;A, B, C, D\&quot;: Burst sizes                                          \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           A = I/O RX lcore read burst size from NIC RX (default value is %u)  \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           B = I/O RX lcore write burst size to output SW rings,               \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               Worker lcore read burst size from input SW rings,               \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;               QoS enqueue size (default value is %u)                          \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           C = QoS dequeue size (default value is %u)                          \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           D = Worker lcore write burst size to NIC TX (default value is %u)   \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --msz M : Mempool size (in number of mbufs) for each pfc (default %u)      \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --rth \&quot;A, B, C\&quot; :   RX queue threshold parameters                        \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           A = RX prefetch threshold (default value is %u)                     \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           B = RX host threshold (default value is %u)                         \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           C = RX write-back threshold (default value is %u)                   \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --tth \&quot;A, B, C\&quot; :   TX queue threshold parameters                        \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           A = TX prefetch threshold (default value is %u)                     \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           B = TX host threshold (default value is %u)                         \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;           C = TX write-back threshold (default value is %u)                   \n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;    --cfg FILE : profile configuration to load                                 \n&quot;</span></div>
<div class="line">;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* display usage */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">app_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    printf(usage, prgname, APP_INTERACTIVE_DEFAULT, app_master_core,</div>
<div class="line">        APP_RX_DESC_DEFAULT, APP_RING_SIZE, APP_TX_DESC_DEFAULT,</div>
<div class="line">        MAX_PKT_RX_BURST, PKT_ENQUEUE, PKT_DEQUEUE,</div>
<div class="line">        MAX_PKT_TX_BURST, NB_MBUF,</div>
<div class="line">        RX_PTHRESH, RX_HTHRESH, RX_WTHRESH,</div>
<div class="line">        TX_PTHRESH, TX_HTHRESH, TX_WTHRESH</div>
<div class="line">        );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> str_is(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keyword">const</span> <span class="keywordtype">char</span> *is)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> strcmp(str, is) == 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* returns core mask used by DPDK */</span></div>
<div class="line"><span class="keyword">static</span> uint64_t</div>
<div class="line">app_eal_core_mask(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line">    uint64_t cm = 0;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__config.html">rte_config</a> *cfg = <a name="a1"></a><a class="code" href="rte__eal_8h.html#aab31145149c10993848d863b34d3d96f">rte_eal_get_configuration</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (cfg-&gt;<a name="a2"></a><a class="code" href="structrte__config.html#a79a713f1c76515dd44c9ba8b55d090b5">lcore_role</a>[i] == ROLE_RTE)</div>
<div class="line">            cm |= (1ULL &lt;&lt; i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    cm |= (1ULL &lt;&lt; cfg-&gt;<a name="a3"></a><a class="code" href="structrte__config.html#abe59d1b8baa4c39f023b18bd28bfd555">master_lcore</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* returns total number of cores presented in a system */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t</div>
<div class="line">app_cpu_core_count(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i, len;</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX];</div>
<div class="line">    uint32_t ncores = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; RTE_MAX_LCORE; i++) {</div>
<div class="line">        len = snprintf(path, <span class="keyword">sizeof</span>(path), SYS_CPU_DIR, i);</div>
<div class="line">        <span class="keywordflow">if</span> (len &lt;= 0 || (<span class="keywordtype">unsigned</span>)len &gt;= <span class="keyword">sizeof</span>(path))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (access(path, F_OK) == 0)</div>
<div class="line">            ncores++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ncores;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* returns:</span></div>
<div class="line"><span class="comment">     number of values parsed</span></div>
<div class="line"><span class="comment">    -1 in case of error</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_opt_vals(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str, <span class="keywordtype">char</span> separator, uint32_t n_vals, uint32_t *opt_vals)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *string;</div>
<div class="line">    uint32_t i, n_tokens;</div>
<div class="line">    <span class="keywordtype">char</span> *tokens[MAX_OPT_VALUES];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (conf_str == NULL || opt_vals == NULL || n_vals == 0 || n_vals &gt; MAX_OPT_VALUES)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* duplicate configuration string before splitting it to tokens */</span></div>
<div class="line">    <span class="keywordtype">string</span> = strdup(conf_str);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keywordtype">string</span> == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    n_tokens = <a name="a4"></a><a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(<span class="keywordtype">string</span>, strnlen(<span class="keywordtype">string</span>, 32), tokens, n_vals, separator);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; n_tokens; i++) {</div>
<div class="line">        opt_vals[i] = (uint32_t)atol(tokens[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(<span class="keywordtype">string</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> n_tokens;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_ring_conf(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint32_t vals[3];</div>
<div class="line"></div>
<div class="line">    ret = app_parse_opt_vals(conf_str, <span class="charliteral">&#39;,&#39;</span>, 3, vals);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 3)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">    ring_conf.rx_size = vals[0];</div>
<div class="line">    ring_conf.ring_size = vals[1];</div>
<div class="line">    ring_conf.tx_size = vals[2];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_rth_conf(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint32_t vals[3];</div>
<div class="line"></div>
<div class="line">    ret = app_parse_opt_vals(conf_str, <span class="charliteral">&#39;,&#39;</span>, 3, vals);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 3)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">    rx_thresh.pthresh = (uint8_t)vals[0];</div>
<div class="line">    rx_thresh.hthresh = (uint8_t)vals[1];</div>
<div class="line">    rx_thresh.wthresh = (uint8_t)vals[2];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_tth_conf(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint32_t vals[3];</div>
<div class="line"></div>
<div class="line">    ret = app_parse_opt_vals(conf_str, <span class="charliteral">&#39;,&#39;</span>, 3, vals);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 3)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">    tx_thresh.pthresh = (uint8_t)vals[0];</div>
<div class="line">    tx_thresh.hthresh = (uint8_t)vals[1];</div>
<div class="line">    tx_thresh.wthresh = (uint8_t)vals[2];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_flow_conf(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint32_t vals[5];</div>
<div class="line">    <span class="keyword">struct </span>flow_conf *pconf;</div>
<div class="line">    uint64_t mask;</div>
<div class="line"></div>
<div class="line">    ret = app_parse_opt_vals(conf_str, <span class="charliteral">&#39;,&#39;</span>, 6, vals);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 4 || ret &gt; 5)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">    pconf = &amp;qos_conf[nb_pfc];</div>
<div class="line"></div>
<div class="line">    pconf-&gt;rx_port = (uint8_t)vals[0];</div>
<div class="line">    pconf-&gt;tx_port = (uint8_t)vals[1];</div>
<div class="line">    pconf-&gt;rx_core = (uint8_t)vals[2];</div>
<div class="line">    pconf-&gt;wt_core = (uint8_t)vals[3];</div>
<div class="line">    <span class="keywordflow">if</span> (ret == 5)</div>
<div class="line">        pconf-&gt;tx_core = (uint8_t)vals[4];</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        pconf-&gt;tx_core = pconf-&gt;wt_core;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pconf-&gt;rx_core == pconf-&gt;wt_core) {</div>
<div class="line">        <a name="a5"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: rx thread and worker thread cannot share same core\n&quot;</span>, nb_pfc);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pconf-&gt;rx_port &gt;= RTE_MAX_ETHPORTS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: invalid rx port %&quot;</span>PRIu8<span class="stringliteral">&quot; index\n&quot;</span>,</div>
<div class="line">                nb_pfc, pconf-&gt;rx_port);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (pconf-&gt;tx_port &gt;= RTE_MAX_ETHPORTS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: invalid tx port %&quot;</span>PRIu8<span class="stringliteral">&quot; index\n&quot;</span>,</div>
<div class="line">                nb_pfc, pconf-&gt;rx_port);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mask = 1lu &lt;&lt; pconf-&gt;rx_port;</div>
<div class="line">    <span class="keywordflow">if</span> (app_used_rx_port_mask &amp; mask) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: rx port %&quot;</span>PRIu8<span class="stringliteral">&quot; is used already\n&quot;</span>,</div>
<div class="line">                nb_pfc, pconf-&gt;rx_port);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    app_used_rx_port_mask |= mask;</div>
<div class="line">    app_used_port_mask |= mask;</div>
<div class="line"></div>
<div class="line">    mask = 1lu &lt;&lt; pconf-&gt;tx_port;</div>
<div class="line">    <span class="keywordflow">if</span> (app_used_tx_port_mask &amp; mask) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: port %&quot;</span>PRIu8<span class="stringliteral">&quot; is used already\n&quot;</span>,</div>
<div class="line">                nb_pfc, pconf-&gt;tx_port);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    app_used_tx_port_mask |= mask;</div>
<div class="line">    app_used_port_mask |= mask;</div>
<div class="line"></div>
<div class="line">    mask = 1lu &lt;&lt; pconf-&gt;rx_core;</div>
<div class="line">    app_used_core_mask |= mask;</div>
<div class="line"></div>
<div class="line">    mask = 1lu &lt;&lt; pconf-&gt;wt_core;</div>
<div class="line">    app_used_core_mask |= mask;</div>
<div class="line"></div>
<div class="line">    mask = 1lu &lt;&lt; pconf-&gt;tx_core;</div>
<div class="line">    app_used_core_mask |= mask;</div>
<div class="line"></div>
<div class="line">    nb_pfc++;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">app_parse_burst_conf(<span class="keyword">const</span> <span class="keywordtype">char</span> *conf_str)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint32_t vals[4];</div>
<div class="line"></div>
<div class="line">    ret = app_parse_opt_vals(conf_str, <span class="charliteral">&#39;,&#39;</span>, 4, vals);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 4)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"></div>
<div class="line">    burst_conf.rx_burst    = (uint16_t)vals[0];</div>
<div class="line">    burst_conf.ring_burst  = (uint16_t)vals[1];</div>
<div class="line">    burst_conf.qos_dequeue = (uint16_t)vals[2];</div>
<div class="line">    burst_conf.tx_burst    = (uint16_t)vals[3];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parses the argument given in the command line of the application,</span></div>
<div class="line"><span class="comment"> * calculates mask for used cores and initializes EAL with calculated core mask</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">app_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *optname;</div>
<div class="line">    <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    uint32_t i, nb_lcores;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option lgopts[] = {</div>
<div class="line">        { <span class="stringliteral">&quot;pfc&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;mst&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;rsz&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;bsz&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;msz&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;rth&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;tth&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { <span class="stringliteral">&quot;cfg&quot;</span>, 1, 0, 0 },</div>
<div class="line">        { NULL,  0, 0, 0 }</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize EAL first */</span></div>
<div class="line">    ret = <a name="a6"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* set en_US locale to print big numbers with &#39;,&#39; */</span></div>
<div class="line">    setlocale(LC_NUMERIC, <span class="stringliteral">&quot;en_US.utf-8&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;i&quot;</span>,</div>
<div class="line">        lgopts, &amp;option_index)) != EOF) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">                printf(<span class="stringliteral">&quot;Interactive-mode selected\n&quot;</span>);</div>
<div class="line">                interactive = 1;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="comment">/* long options */</span></div>
<div class="line">            <span class="keywordflow">case</span> 0:</div>
<div class="line">                optname = lgopts[option_index].name;</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;pfc&quot;</span>)) {</div>
<div class="line">                    ret = app_parse_flow_conf(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid pipe configuration %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;mst&quot;</span>)) {</div>
<div class="line">                    app_master_core = (uint32_t)atoi(optarg);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;rsz&quot;</span>)) {</div>
<div class="line">                    ret = app_parse_ring_conf(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid ring configuration %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;bsz&quot;</span>)) {</div>
<div class="line">                    ret = app_parse_burst_conf(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid burst configuration %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;msz&quot;</span>)) {</div>
<div class="line">                    mp_size = atoi(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (mp_size &lt;= 0) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid mempool size %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;rth&quot;</span>)) {</div>
<div class="line">                    ret = app_parse_rth_conf(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid RX threshold configuration %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;tth&quot;</span>)) {</div>
<div class="line">                    ret = app_parse_tth_conf(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid TX threshold configuration %s\n&quot;</span>, optarg);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (str_is(optname, <span class="stringliteral">&quot;cfg&quot;</span>)) {</div>
<div class="line">                    cfg_profile = optarg;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                app_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* check master core index validity */</span></div>
<div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt;= app_master_core; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (app_used_core_mask &amp; (1u &lt;&lt; app_master_core)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Master core index is not configured properly\n&quot;</span>);</div>
<div class="line">            app_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    app_used_core_mask |= 1u &lt;&lt; app_master_core;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((app_used_core_mask != app_eal_core_mask()) ||</div>
<div class="line">            (app_master_core != <a name="a7"></a><a class="code" href="rte__lcore_8h.html#ab99d72ae5d1c5f533625422934283700">rte_get_master_lcore</a>())) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;EAL core mask not configured properly, must be %&quot;</span> PRIx64</div>
<div class="line">                <span class="stringliteral">&quot; instead of %&quot;</span> PRIx64 <span class="stringliteral">&quot;\n&quot;</span> , app_used_core_mask, app_eal_core_mask());</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (nb_pfc == 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Packet flow not configured!\n&quot;</span>);</div>
<div class="line">        app_usage(prgname);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* sanity check for cores assignment */</span></div>
<div class="line">    nb_lcores = app_cpu_core_count();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; nb_pfc; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (qos_conf[i].rx_core &gt;= nb_lcores) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: invalid RX lcore index %u\n&quot;</span>, i + 1,</div>
<div class="line">                    qos_conf[i].rx_core);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (qos_conf[i].wt_core &gt;= nb_lcores) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: invalid WT lcore index %u\n&quot;</span>, i + 1,</div>
<div class="line">                    qos_conf[i].wt_core);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        uint32_t rx_sock = <a name="a8"></a><a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(qos_conf[i].rx_core);</div>
<div class="line">        uint32_t wt_sock = <a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(qos_conf[i].wt_core);</div>
<div class="line">        <span class="keywordflow">if</span> (rx_sock != wt_sock) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;pfc %u: RX and WT must be on the same socket\n&quot;</span>, i + 1);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        app_numa_mask |= 1 &lt;&lt; <a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(qos_conf[i].rx_core);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
