<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: performance-thread/pthread_shim/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">performance-thread/pthread_shim/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__timer_8h.html">rte_timer.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;lthread_api.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;lthread_diag_api.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;pthread_shim.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define DEBUG_APP 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HELLOW_WORLD_MAX_LTHREADS 10</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">__thread <span class="keywordtype">int</span> print_count;</div>
<div class="line">__thread pthread_mutex_t print_lock;</div>
<div class="line"></div>
<div class="line">__thread pthread_mutex_t exit_lock;</div>
<div class="line">__thread pthread_cond_t exit_cond;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A simple thread that demonstrates use of a mutex, a condition</span></div>
<div class="line"><span class="comment"> * variable, thread local storage, explicit yield, and thread exit.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The thread uses a mutex to protect a shared counter which is incremented</span></div>
<div class="line"><span class="comment"> * and then it waits on condition variable before exiting.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The thread argument is stored in and retrieved from TLS, using</span></div>
<div class="line"><span class="comment"> * the pthread key create, get and set specific APIs.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The thread yields while holding the mutex, to provide opportunity</span></div>
<div class="line"><span class="comment"> * for other threads to contend.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * All of the pthread API functions used by this thread are actually</span></div>
<div class="line"><span class="comment"> * resolved to corresponding lthread functions by the pthread shim</span></div>
<div class="line"><span class="comment"> * implemented in pthread_shim.c</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">void</span> *helloworld_pthread(<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keywordtype">void</span> *helloworld_pthread(<span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    pthread_key_t key;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* create a key for TLS */</span></div>
<div class="line">    pthread_key_create(&amp;key, NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* store the arg in TLS */</span></div>
<div class="line">    pthread_setspecific(key, arg);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* grab lock and increment shared counter */</span></div>
<div class="line">    pthread_mutex_lock(&amp;print_lock);</div>
<div class="line">    print_count++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* yield thread to give opportunity for lock contention */</span></div>
<div class="line">    pthread_yield();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* retrieve arg from TLS */</span></div>
<div class="line">    uint64_t thread_no = (uint64_t) pthread_getspecific(key);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Hello - lcore = %d count = %d thread_no = %d thread_id = %p\n&quot;</span>,</div>
<div class="line">            sched_getcpu(),</div>
<div class="line">            print_count,</div>
<div class="line">            (<span class="keywordtype">int</span>) thread_no,</div>
<div class="line">            (<span class="keywordtype">void</span> *)pthread_self());</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* release the lock */</span></div>
<div class="line">    pthread_mutex_unlock(&amp;print_lock);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * wait on condition variable</span></div>
<div class="line"><span class="comment">     * before exiting</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    pthread_mutex_lock(&amp;exit_lock);</div>
<div class="line">    pthread_cond_wait(&amp;exit_cond, &amp;exit_lock);</div>
<div class="line">    pthread_mutex_unlock(&amp;exit_lock);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* exit */</span></div>
<div class="line">    pthread_exit((<span class="keywordtype">void</span> *) thread_no);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This is the initial thread</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * It demonstrates pthread, mutex and condition variable creation,</span></div>
<div class="line"><span class="comment"> * broadcast and pthread join APIs.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This initial thread must always start life as an lthread.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This thread creates many more threads then waits a short time</span></div>
<div class="line"><span class="comment"> * before signalling them to exit using a broadcast.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * All of the pthread API functions used by this thread are actually</span></div>
<div class="line"><span class="comment"> * resolved to corresponding lthread functions by the pthread shim</span></div>
<div class="line"><span class="comment"> * implemented in pthread_shim.c</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * After all threads have finished the lthread scheduler is shutdown</span></div>
<div class="line"><span class="comment"> * and normal pthread operation is restored</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">__thread pthread_t tid[HELLOW_WORLD_MAX_LTHREADS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> initial_lthread(<span class="keywordtype">void</span> *args);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> initial_lthread(<span class="keywordtype">void</span> *args __attribute__((unused)))</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore = (int) <a name="a0"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * We can now enable pthread API override</span></div>
<div class="line"><span class="comment">     * and start to use the pthread APIs</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    pthread_override_set(1);</div>
<div class="line"></div>
<div class="line">    uint64_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize mutex for shared counter */</span></div>
<div class="line">    print_count = 0;</div>
<div class="line">    pthread_mutex_init(&amp;print_lock, NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize mutex and condition variable controlling thread exit */</span></div>
<div class="line">    pthread_mutex_init(&amp;exit_lock, NULL);</div>
<div class="line">    pthread_cond_init(&amp;exit_cond, NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* spawn a number of threads */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; HELLOW_WORLD_MAX_LTHREADS; i++) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Not strictly necessary but</span></div>
<div class="line"><span class="comment">         * for the sake of this example</span></div>
<div class="line"><span class="comment">         * use an attribute to pass the desired lcore</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        pthread_attr_t attr;</div>
<div class="line">        cpu_set_t cpuset;</div>
<div class="line"></div>
<div class="line">        CPU_ZERO(&amp;cpuset);</div>
<div class="line">        CPU_SET(lcore, &amp;cpuset);</div>
<div class="line">        pthread_attr_init(&amp;attr);</div>
<div class="line">        pthread_attr_setaffinity_np(&amp;attr, <span class="keyword">sizeof</span>(cpu_set_t), &amp;cpuset);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* create the thread */</span></div>
<div class="line">        pthread_create(&amp;tid[i], &amp;attr, helloworld_pthread, (<span class="keywordtype">void</span> *) i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wait for 1s to allow threads</span></div>
<div class="line"><span class="comment">     * to block on the condition variable</span></div>
<div class="line"><span class="comment">     * N.B. nanosleep() is resolved to lthread_sleep()</span></div>
<div class="line"><span class="comment">     * by the shim.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keyword">struct </span>timespec time;</div>
<div class="line"></div>
<div class="line">    time.tv_sec = 1;</div>
<div class="line">    time.tv_nsec = 0;</div>
<div class="line">    nanosleep(&amp;time, NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wake up all the threads */</span></div>
<div class="line">    pthread_cond_broadcast(&amp;exit_cond);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wait for them to finish */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; HELLOW_WORLD_MAX_LTHREADS; i++) {</div>
<div class="line"></div>
<div class="line">        uint64_t thread_no;</div>
<div class="line"></div>
<div class="line">        pthread_join(tid[i], (<span class="keywordtype">void</span> *) &amp;thread_no);</div>
<div class="line">        <span class="keywordflow">if</span> (thread_no != i)</div>
<div class="line">            printf(<span class="stringliteral">&quot;error on thread exit\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    pthread_cond_destroy(&amp;exit_cond);</div>
<div class="line">    pthread_mutex_destroy(&amp;print_lock);</div>
<div class="line">    pthread_mutex_destroy(&amp;exit_lock);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* shutdown the lthread scheduler */</span></div>
<div class="line">    lthread_scheduler_shutdown(<a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line">    lthread_detach();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* This thread creates a single initial lthread</span></div>
<div class="line"><span class="comment"> * and then runs the scheduler</span></div>
<div class="line"><span class="comment"> * An instance of this thread is created on each thread</span></div>
<div class="line"><span class="comment"> * in the core mask</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">lthread_scheduler(<span class="keywordtype">void</span> *args);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">lthread_scheduler(<span class="keywordtype">void</span> *args __attribute__((unused)))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* create initial thread  */</span></div>
<div class="line">    <span class="keyword">struct </span>lthread *lt;</div>
<div class="line"></div>
<div class="line">    lthread_create(&amp;lt, -1, initial_lthread, (<span class="keywordtype">void</span> *) NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* run the lthread scheduler */</span></div>
<div class="line">    lthread_run();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* restore genuine pthread operation */</span></div>
<div class="line">    pthread_override_set(0);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> num_sched = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* basic DPDK initialization is all that is necessary to run lthreads*/</span></div>
<div class="line">    <span class="keywordtype">int</span> ret = <a name="a1"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a2"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid EAL parameters\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* enable timer subsystem */</span></div>
<div class="line">    <a name="a3"></a><a class="code" href="rte__timer_8h.html#a8d518f0091fc8475df83aec716c2be02">rte_timer_subsystem_init</a>();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if DEBUG_APP</span></div>
<div class="line"><span class="preprocessor"></span>    lthread_diagnostic_set_mask(LT_DIAG_ALL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* create a scheduler on every core in the core mask</span></div>
<div class="line"><span class="comment">     * and launch an initial lthread that will spawn many more.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a4"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            num_sched++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* set the number of schedulers, this forces all schedulers synchronize</span></div>
<div class="line"><span class="comment">     * before entering their main loop</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    lthread_num_schedulers_set(num_sched);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* launch all threads */</span></div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(lthread_scheduler, (<span class="keywordtype">void</span> *)NULL, <a name="a6"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2ada39ec34f33f669f99bd28ab7c58a952ac">CALL_MASTER</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wait for threads to stop */</span></div>
<div class="line">    <a name="a7"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">        <a name="a8"></a><a class="code" href="rte__launch_8h.html#a1282dc7cd7e6793afab3ef29239ddf54">rte_eal_wait_lcore</a>(lcore_id);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
