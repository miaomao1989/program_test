<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: load_balancer/runtime.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">load_balancer/runtime.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__prefetch_8h.html">rte_prefetch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__random_8h.html">rte_random.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lpm_8h.html">rte_lpm.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef APP_LCORE_IO_FLUSH</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_LCORE_IO_FLUSH           1000000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_LCORE_WORKER_FLUSH</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_LCORE_WORKER_FLUSH       1000000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_STATS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_STATS                    1000000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define APP_IO_RX_DROP_ALL_PACKETS   0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_DROP_ALL_PACKETS  0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_DROP_ALL_PACKETS   0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_IO_RX_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_RX_PREFETCH_ENABLE    1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_WORKER_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_PREFETCH_ENABLE   1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_IO_TX_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_PREFETCH_ENABLE    1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if APP_IO_RX_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_RX_PREFETCH0(p)       rte_prefetch0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_RX_PREFETCH1(p)       rte_prefetch1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_RX_PREFETCH0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_RX_PREFETCH1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if APP_WORKER_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_PREFETCH0(p)      rte_prefetch0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_PREFETCH1(p)      rte_prefetch1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_PREFETCH0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_WORKER_PREFETCH1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if APP_IO_TX_PREFETCH_ENABLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_PREFETCH0(p)       rte_prefetch0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_PREFETCH1(p)       rte_prefetch1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_PREFETCH0(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_IO_TX_PREFETCH1(p)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_io_rx_buffer_to_send (</div>
<div class="line">    <span class="keyword">struct</span> app_lcore_params_io *lp,</div>
<div class="line">    uint32_t worker,</div>
<div class="line">    <span class="keyword">struct</span> <a name="_a0"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf,</div>
<div class="line">    uint32_t bsz)</div>
<div class="line">{</div>
<div class="line">    uint32_t pos;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    pos = lp-&gt;rx.mbuf_out[worker].n_mbufs;</div>
<div class="line">    lp-&gt;rx.mbuf_out[worker].array[pos ++] = mbuf;</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a1"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(pos &lt; bsz)) {</div>
<div class="line">        lp-&gt;rx.mbuf_out[worker].n_mbufs = pos;</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a name="a2"></a><a class="code" href="rte__ring_8h.html#a3edf3304fd8532a9a645a37aa8c124ce">rte_ring_sp_enqueue_bulk</a>(</div>
<div class="line">        lp-&gt;rx.rings[worker],</div>
<div class="line">        (<span class="keywordtype">void</span> **) lp-&gt;rx.mbuf_out[worker].array,</div>
<div class="line">        bsz);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a3"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret == -ENOBUFS)) {</div>
<div class="line">        uint32_t k;</div>
<div class="line">        <span class="keywordflow">for</span> (k = 0; k &lt; bsz; k ++) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = lp-&gt;rx.mbuf_out[worker].array[k];</div>
<div class="line">            <a name="a4"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    lp-&gt;rx.mbuf_out[worker].n_mbufs = 0;</div>
<div class="line">    lp-&gt;rx.mbuf_out_flush[worker] = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_STATS</span></div>
<div class="line"><span class="preprocessor"></span>    lp-&gt;rx.rings_iters[worker] ++;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(ret == 0)) {</div>
<div class="line">        lp-&gt;rx.rings_count[worker] ++;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lp-&gt;rx.rings_iters[worker] == APP_STATS)) {</div>
<div class="line">        <span class="keywordtype">unsigned</span> lcore = <a name="a5"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;\tI/O RX %u out (worker %u): enq success rate = %.2f\n&quot;</span>,</div>
<div class="line">            lcore,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)worker,</div>
<div class="line">            ((<span class="keywordtype">double</span>) lp-&gt;rx.rings_count[worker]) / ((<span class="keywordtype">double</span>) lp-&gt;rx.rings_iters[worker]));</div>
<div class="line">        lp-&gt;rx.rings_iters[worker] = 0;</div>
<div class="line">        lp-&gt;rx.rings_count[worker] = 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_io_rx(</div>
<div class="line">    <span class="keyword">struct</span> app_lcore_params_io *lp,</div>
<div class="line">    uint32_t n_workers,</div>
<div class="line">    uint32_t bsz_rd,</div>
<div class="line">    uint32_t bsz_wr,</div>
<div class="line">    uint8_t pos_lb)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf_1_0, *mbuf_1_1, *mbuf_2_0, *mbuf_2_1;</div>
<div class="line">    uint8_t *data_1_0, *data_1_1 = NULL;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; lp-&gt;rx.n_nic_queues; i ++) {</div>
<div class="line">        uint8_t <a name="_a6"></a><a class="code" href="structport.html">port</a> = lp-&gt;rx.nic_queues[i].port;</div>
<div class="line">        uint8_t queue = lp-&gt;rx.nic_queues[i].queue;</div>
<div class="line">        uint32_t n_mbufs, j;</div>
<div class="line"></div>
<div class="line">        n_mbufs = <a name="a7"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(</div>
<div class="line">            port,</div>
<div class="line">            queue,</div>
<div class="line">            lp-&gt;rx.mbuf_in.array,</div>
<div class="line">            (uint16_t) bsz_rd);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_mbufs == 0)) {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_STATS</span></div>
<div class="line"><span class="preprocessor"></span>        lp-&gt;rx.nic_queues_iters[i] ++;</div>
<div class="line">        lp-&gt;rx.nic_queues_count[i] += n_mbufs;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lp-&gt;rx.nic_queues_iters[i] == APP_STATS)) {</div>
<div class="line">            <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structrte__eth__stats.html">rte_eth_stats</a> stats;</div>
<div class="line">            <span class="keywordtype">unsigned</span> lcore = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">            <a name="a9"></a><a class="code" href="rte__ethdev_8h.html#a97567472450b31ef53950fb2ef47298b">rte_eth_stats_get</a>(port, &amp;stats);</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;I/O RX %u in (NIC port %u): NIC drop ratio = %.2f avg burst size = %.2f\n&quot;</span>,</div>
<div class="line">                lcore,</div>
<div class="line">                (<span class="keywordtype">unsigned</span>) port,</div>
<div class="line">                (<span class="keywordtype">double</span>) stats.imissed / (<span class="keywordtype">double</span>) (stats.imissed + stats.ipackets),</div>
<div class="line">                ((<span class="keywordtype">double</span>) lp-&gt;rx.nic_queues_count[i]) / ((<span class="keywordtype">double</span>) lp-&gt;rx.nic_queues_iters[i]));</div>
<div class="line">            lp-&gt;rx.nic_queues_iters[i] = 0;</div>
<div class="line">            lp-&gt;rx.nic_queues_count[i] = 0;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if APP_IO_RX_DROP_ALL_PACKETS</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">for</span> (j = 0; j &lt; n_mbufs; j ++) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt = lp-&gt;rx.mbuf_in.array[j];</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        mbuf_1_0 = lp-&gt;rx.mbuf_in.array[0];</div>
<div class="line">        mbuf_1_1 = lp-&gt;rx.mbuf_in.array[1];</div>
<div class="line">        data_1_0 = <a name="a10"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf_1_0, uint8_t *);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(n_mbufs &gt; 1)) {</div>
<div class="line">            data_1_1 = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf_1_1, uint8_t *);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        mbuf_2_0 = lp-&gt;rx.mbuf_in.array[2];</div>
<div class="line">        mbuf_2_1 = lp-&gt;rx.mbuf_in.array[3];</div>
<div class="line">        APP_IO_RX_PREFETCH0(mbuf_2_0);</div>
<div class="line">        APP_IO_RX_PREFETCH0(mbuf_2_1);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j + 3 &lt; n_mbufs; j += 2) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf_0_0, *mbuf_0_1;</div>
<div class="line">            uint8_t *data_0_0, *data_0_1;</div>
<div class="line">            uint32_t worker_0, worker_1;</div>
<div class="line"></div>
<div class="line">            mbuf_0_0 = mbuf_1_0;</div>
<div class="line">            mbuf_0_1 = mbuf_1_1;</div>
<div class="line">            data_0_0 = data_1_0;</div>
<div class="line">            data_0_1 = data_1_1;</div>
<div class="line"></div>
<div class="line">            mbuf_1_0 = mbuf_2_0;</div>
<div class="line">            mbuf_1_1 = mbuf_2_1;</div>
<div class="line">            data_1_0 = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf_2_0, uint8_t *);</div>
<div class="line">            data_1_1 = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf_2_1, uint8_t *);</div>
<div class="line">            APP_IO_RX_PREFETCH0(data_1_0);</div>
<div class="line">            APP_IO_RX_PREFETCH0(data_1_1);</div>
<div class="line"></div>
<div class="line">            mbuf_2_0 = lp-&gt;rx.mbuf_in.array[j+4];</div>
<div class="line">            mbuf_2_1 = lp-&gt;rx.mbuf_in.array[j+5];</div>
<div class="line">            APP_IO_RX_PREFETCH0(mbuf_2_0);</div>
<div class="line">            APP_IO_RX_PREFETCH0(mbuf_2_1);</div>
<div class="line"></div>
<div class="line">            worker_0 = data_0_0[pos_lb] &amp; (n_workers - 1);</div>
<div class="line">            worker_1 = data_0_1[pos_lb] &amp; (n_workers - 1);</div>
<div class="line"></div>
<div class="line">            app_lcore_io_rx_buffer_to_send(lp, worker_0, mbuf_0_0, bsz_wr);</div>
<div class="line">            app_lcore_io_rx_buffer_to_send(lp, worker_1, mbuf_0_1, bsz_wr);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Handle the last 1, 2 (when n_mbufs is even) or 3 (when n_mbufs is odd) packets  */</span></div>
<div class="line">        <span class="keywordflow">for</span> ( ; j &lt; n_mbufs; j += 1) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf;</div>
<div class="line">            uint8_t *data;</div>
<div class="line">            uint32_t worker;</div>
<div class="line"></div>
<div class="line">            mbuf = mbuf_1_0;</div>
<div class="line">            mbuf_1_0 = mbuf_1_1;</div>
<div class="line">            mbuf_1_1 = mbuf_2_0;</div>
<div class="line">            mbuf_2_0 = mbuf_2_1;</div>
<div class="line"></div>
<div class="line">            data = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf, uint8_t *);</div>
<div class="line"></div>
<div class="line">            APP_IO_RX_PREFETCH0(mbuf_1_0);</div>
<div class="line"></div>
<div class="line">            worker = data[pos_lb] &amp; (n_workers - 1);</div>
<div class="line"></div>
<div class="line">            app_lcore_io_rx_buffer_to_send(lp, worker, mbuf, bsz_wr);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_io_rx_flush(<span class="keyword">struct</span> app_lcore_params_io *lp, uint32_t n_workers)</div>
<div class="line">{</div>
<div class="line">    uint32_t worker;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (worker = 0; worker &lt; n_workers; worker ++) {</div>
<div class="line">        <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>((lp-&gt;rx.mbuf_out_flush[worker] == 0) ||</div>
<div class="line">                   (lp-&gt;rx.mbuf_out[worker].n_mbufs == 0))) {</div>
<div class="line">            lp-&gt;rx.mbuf_out_flush[worker] = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = <a class="code" href="rte__ring_8h.html#a3edf3304fd8532a9a645a37aa8c124ce">rte_ring_sp_enqueue_bulk</a>(</div>
<div class="line">            lp-&gt;rx.rings[worker],</div>
<div class="line">            (<span class="keywordtype">void</span> **) lp-&gt;rx.mbuf_out[worker].array,</div>
<div class="line">            lp-&gt;rx.mbuf_out[worker].n_mbufs);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 0)) {</div>
<div class="line">            uint32_t k;</div>
<div class="line">            <span class="keywordflow">for</span> (k = 0; k &lt; lp-&gt;rx.mbuf_out[worker].n_mbufs; k ++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt_to_free = lp-&gt;rx.mbuf_out[worker].array[k];</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt_to_free);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lp-&gt;rx.mbuf_out[worker].n_mbufs = 0;</div>
<div class="line">        lp-&gt;rx.mbuf_out_flush[worker] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_io_tx(</div>
<div class="line">    <span class="keyword">struct</span> app_lcore_params_io *lp,</div>
<div class="line">    uint32_t n_workers,</div>
<div class="line">    uint32_t bsz_rd,</div>
<div class="line">    uint32_t bsz_wr)</div>
<div class="line">{</div>
<div class="line">    uint32_t worker;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (worker = 0; worker &lt; n_workers; worker ++) {</div>
<div class="line">        uint32_t i;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; lp-&gt;tx.n_nic_ports; i ++) {</div>
<div class="line">            uint8_t port = lp-&gt;tx.nic_ports[i];</div>
<div class="line">            <span class="keyword">struct </span><a name="_a11"></a><a class="code" href="structrte__ring.html">rte_ring</a> *ring = lp-&gt;tx.rings[port][worker];</div>
<div class="line">            uint32_t n_mbufs, n_pkts;</div>
<div class="line">            <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">            n_mbufs = lp-&gt;tx.mbuf_out[port].n_mbufs;</div>
<div class="line">            ret = <a name="a12"></a><a class="code" href="rte__ring_8h.html#a7ac8ee1c24db28362b48358cce8e5005">rte_ring_sc_dequeue_bulk</a>(</div>
<div class="line">                ring,</div>
<div class="line">                (<span class="keywordtype">void</span> **) &amp;lp-&gt;tx.mbuf_out[port].array[n_mbufs],</div>
<div class="line">                bsz_rd);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret == -ENOENT)) {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            n_mbufs += bsz_rd;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_IO_TX_DROP_ALL_PACKETS</span></div>
<div class="line"><span class="preprocessor"></span>            {</div>
<div class="line">                uint32_t j;</div>
<div class="line">                APP_IO_TX_PREFETCH0(lp-&gt;tx.mbuf_out[port].array[0]);</div>
<div class="line">                APP_IO_TX_PREFETCH0(lp-&gt;tx.mbuf_out[port].array[1]);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">for</span> (j = 0; j &lt; n_mbufs; j ++) {</div>
<div class="line">                    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(j &lt; n_mbufs - 2)) {</div>
<div class="line">                        APP_IO_TX_PREFETCH0(lp-&gt;tx.mbuf_out[port].array[j + 2]);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(lp-&gt;tx.mbuf_out[port].array[j]);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                lp-&gt;tx.mbuf_out[port].n_mbufs = 0;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_mbufs &lt; bsz_wr)) {</div>
<div class="line">                lp-&gt;tx.mbuf_out[port].n_mbufs = n_mbufs;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            n_pkts = <a name="a13"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(</div>
<div class="line">                port,</div>
<div class="line">                0,</div>
<div class="line">                lp-&gt;tx.mbuf_out[port].array,</div>
<div class="line">                (uint16_t) n_mbufs);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_STATS</span></div>
<div class="line"><span class="preprocessor"></span>            lp-&gt;tx.nic_ports_iters[port] ++;</div>
<div class="line">            lp-&gt;tx.nic_ports_count[port] += n_pkts;</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lp-&gt;tx.nic_ports_iters[port] == APP_STATS)) {</div>
<div class="line">                <span class="keywordtype">unsigned</span> lcore = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">                printf(<span class="stringliteral">&quot;\t\t\tI/O TX %u out (port %u): avg burst size = %.2f\n&quot;</span>,</div>
<div class="line">                    lcore,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>) port,</div>
<div class="line">                    ((<span class="keywordtype">double</span>) lp-&gt;tx.nic_ports_count[port]) / ((<span class="keywordtype">double</span>) lp-&gt;tx.nic_ports_iters[port]));</div>
<div class="line">                lp-&gt;tx.nic_ports_iters[port] = 0;</div>
<div class="line">                lp-&gt;tx.nic_ports_count[port] = 0;</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_pkts &lt; n_mbufs)) {</div>
<div class="line">                uint32_t k;</div>
<div class="line">                <span class="keywordflow">for</span> (k = n_pkts; k &lt; n_mbufs; k ++) {</div>
<div class="line">                    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt_to_free = lp-&gt;tx.mbuf_out[<a name="a14"></a><a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].array[k];</div>
<div class="line">                    <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt_to_free);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            lp-&gt;tx.mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs = 0;</div>
<div class="line">            lp-&gt;tx.mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_io_tx_flush(<span class="keyword">struct</span> app_lcore_params_io *lp)</div>
<div class="line">{</div>
<div class="line">    uint8_t <a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (port = 0; port &lt; lp-&gt;tx.n_nic_ports; port ++) {</div>
<div class="line">        uint32_t n_pkts;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>((lp-&gt;tx.mbuf_out_flush[port] == 0) ||</div>
<div class="line">                   (lp-&gt;tx.mbuf_out[port].n_mbufs == 0))) {</div>
<div class="line">            lp-&gt;tx.mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        n_pkts = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(</div>
<div class="line">            port,</div>
<div class="line">            0,</div>
<div class="line">            lp-&gt;tx.mbuf_out[port].array,</div>
<div class="line">            (uint16_t) lp-&gt;tx.mbuf_out[port].n_mbufs);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n_pkts &lt; lp-&gt;tx.mbuf_out[port].n_mbufs)) {</div>
<div class="line">            uint32_t k;</div>
<div class="line">            <span class="keywordflow">for</span> (k = n_pkts; k &lt; lp-&gt;tx.mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs; k ++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt_to_free = lp-&gt;tx.mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].array[k];</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt_to_free);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lp-&gt;tx.mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs = 0;</div>
<div class="line">        lp-&gt;tx.mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_main_loop_io(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t lcore = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>app_lcore_params_io *lp = &amp;app.lcore_params[lcore].io;</div>
<div class="line">    uint32_t n_workers = app_get_lcores_worker();</div>
<div class="line">    uint64_t i = 0;</div>
<div class="line"></div>
<div class="line">    uint32_t bsz_rx_rd = app.burst_size_io_rx_read;</div>
<div class="line">    uint32_t bsz_rx_wr = app.burst_size_io_rx_write;</div>
<div class="line">    uint32_t bsz_tx_rd = app.burst_size_io_tx_read;</div>
<div class="line">    uint32_t bsz_tx_wr = app.burst_size_io_tx_write;</div>
<div class="line"></div>
<div class="line">    uint8_t pos_lb = app.pos_lb;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( ; ; ) {</div>
<div class="line">        <span class="keywordflow">if</span> (APP_LCORE_IO_FLUSH &amp;&amp; (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(i == APP_LCORE_IO_FLUSH))) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(lp-&gt;rx.n_nic_queues &gt; 0)) {</div>
<div class="line">                app_lcore_io_rx_flush(lp, n_workers);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(lp-&gt;tx.n_nic_ports &gt; 0)) {</div>
<div class="line">                app_lcore_io_tx_flush(lp);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            i = 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(lp-&gt;rx.n_nic_queues &gt; 0)) {</div>
<div class="line">            app_lcore_io_rx(lp, n_workers, bsz_rx_rd, bsz_rx_wr, pos_lb);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(lp-&gt;tx.n_nic_ports &gt; 0)) {</div>
<div class="line">            app_lcore_io_tx(lp, n_workers, bsz_tx_rd, bsz_tx_wr);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        i ++;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_worker(</div>
<div class="line">    <span class="keyword">struct</span> app_lcore_params_worker *lp,</div>
<div class="line">    uint32_t bsz_rd,</div>
<div class="line">    uint32_t bsz_wr)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; lp-&gt;n_rings_in; i ++) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__ring.html">rte_ring</a> *ring_in = lp-&gt;rings_in[i];</div>
<div class="line">        uint32_t j;</div>
<div class="line">        <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">        ret = <a class="code" href="rte__ring_8h.html#a7ac8ee1c24db28362b48358cce8e5005">rte_ring_sc_dequeue_bulk</a>(</div>
<div class="line">            ring_in,</div>
<div class="line">            (<span class="keywordtype">void</span> **) lp-&gt;mbuf_in.array,</div>
<div class="line">            bsz_rd);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret == -ENOENT)) {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_WORKER_DROP_ALL_PACKETS</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">for</span> (j = 0; j &lt; bsz_rd; j ++) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt = lp-&gt;mbuf_in.array[j];</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        APP_WORKER_PREFETCH1(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(lp-&gt;mbuf_in.array[0], <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *));</div>
<div class="line">        APP_WORKER_PREFETCH0(lp-&gt;mbuf_in.array[1]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; bsz_rd; j ++) {</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt;</div>
<div class="line">            <span class="keyword">struct </span><a name="_a15"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *<a class="code" href="structipv4__hdr.html">ipv4_hdr</a>;</div>
<div class="line">            uint32_t ipv4_dst, pos;</div>
<div class="line">            uint32_t port;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(j &lt; bsz_rd - 1)) {</div>
<div class="line">                APP_WORKER_PREFETCH1(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(lp-&gt;mbuf_in.array[j+1], <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *));</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(j &lt; bsz_rd - 2)) {</div>
<div class="line">                APP_WORKER_PREFETCH0(lp-&gt;mbuf_in.array[j+2]);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            pkt = lp-&gt;mbuf_in.array[j];</div>
<div class="line">            ipv4_hdr = <a name="a16"></a><a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(pkt,</div>
<div class="line">                               <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">                               <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a17"></a><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">            ipv4_dst = <a name="a18"></a><a class="code" href="rte__byteorder_8h.html#a980e02d221d693034bc63088d27888f7">rte_be_to_cpu_32</a>(ipv4_hdr-&gt;<a name="a19"></a><a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a name="a20"></a><a class="code" href="rte__lpm_8h.html#a1bab3e9f44549b0490a5e2f1e7e21ede">rte_lpm_lookup</a>(lp-&gt;lpm_table, ipv4_dst, &amp;port) != 0)) {</div>
<div class="line">                port = pkt-&gt;<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            pos = lp-&gt;mbuf_out[port].n_mbufs;</div>
<div class="line"></div>
<div class="line">            lp-&gt;mbuf_out[port].array[pos ++] = pkt;</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(pos &lt; bsz_wr)) {</div>
<div class="line">                lp-&gt;mbuf_out[port].n_mbufs = pos;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ret = <a class="code" href="rte__ring_8h.html#a3edf3304fd8532a9a645a37aa8c124ce">rte_ring_sp_enqueue_bulk</a>(</div>
<div class="line">                lp-&gt;rings_out[port],</div>
<div class="line">                (<span class="keywordtype">void</span> **) lp-&gt;mbuf_out[port].array,</div>
<div class="line">                bsz_wr);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if APP_STATS</span></div>
<div class="line"><span class="preprocessor"></span>            lp-&gt;rings_out_iters[port] ++;</div>
<div class="line">            <span class="keywordflow">if</span> (ret == 0) {</div>
<div class="line">                lp-&gt;rings_out_count[port] += 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (lp-&gt;rings_out_iters[port] == APP_STATS){</div>
<div class="line">                printf(<span class="stringliteral">&quot;\t\tWorker %u out (NIC port %u): enq success rate = %.2f\n&quot;</span>,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>) lp-&gt;worker_id,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>) port,</div>
<div class="line">                    ((<span class="keywordtype">double</span>) lp-&gt;rings_out_count[port]) / ((<span class="keywordtype">double</span>) lp-&gt;rings_out_iters[port]));</div>
<div class="line">                lp-&gt;rings_out_iters[port] = 0;</div>
<div class="line">                lp-&gt;rings_out_count[port] = 0;</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret == -ENOBUFS)) {</div>
<div class="line">                uint32_t k;</div>
<div class="line">                <span class="keywordflow">for</span> (k = 0; k &lt; bsz_wr; k ++) {</div>
<div class="line">                    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt_to_free = lp-&gt;mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].array[k];</div>
<div class="line">                    <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt_to_free);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            lp-&gt;mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs = 0;</div>
<div class="line">            lp-&gt;mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_worker_flush(<span class="keyword">struct</span> app_lcore_params_worker *lp)</div>
<div class="line">{</div>
<div class="line">    uint32_t <a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (port = 0; port &lt; APP_MAX_NIC_PORTS; port ++) {</div>
<div class="line">        <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lp-&gt;rings_out[port] == NULL)) {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>((lp-&gt;mbuf_out_flush[port] == 0) ||</div>
<div class="line">                   (lp-&gt;mbuf_out[port].n_mbufs == 0))) {</div>
<div class="line">            lp-&gt;mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = <a class="code" href="rte__ring_8h.html#a3edf3304fd8532a9a645a37aa8c124ce">rte_ring_sp_enqueue_bulk</a>(</div>
<div class="line">            lp-&gt;rings_out[port],</div>
<div class="line">            (<span class="keywordtype">void</span> **) lp-&gt;mbuf_out[port].array,</div>
<div class="line">            lp-&gt;mbuf_out[port].n_mbufs);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 0)) {</div>
<div class="line">            uint32_t k;</div>
<div class="line">            <span class="keywordflow">for</span> (k = 0; k &lt; lp-&gt;mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs; k ++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt_to_free = lp-&gt;mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].array[k];</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkt_to_free);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lp-&gt;mbuf_out[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>].n_mbufs = 0;</div>
<div class="line">        lp-&gt;mbuf_out_flush[<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>] = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">app_lcore_main_loop_worker(<span class="keywordtype">void</span>) {</div>
<div class="line">    uint32_t lcore = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>app_lcore_params_worker *lp = &amp;app.lcore_params[lcore].worker;</div>
<div class="line">    uint64_t i = 0;</div>
<div class="line"></div>
<div class="line">    uint32_t bsz_rd = app.burst_size_worker_read;</div>
<div class="line">    uint32_t bsz_wr = app.burst_size_worker_write;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( ; ; ) {</div>
<div class="line">        <span class="keywordflow">if</span> (APP_LCORE_WORKER_FLUSH &amp;&amp; (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(i == APP_LCORE_WORKER_FLUSH))) {</div>
<div class="line">            app_lcore_worker_flush(lp);</div>
<div class="line">            i = 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        app_lcore_worker(lp, bsz_rd, bsz_wr);</div>
<div class="line"></div>
<div class="line">        i ++;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">app_lcore_main_loop(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>app_lcore_params *lp;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore;</div>
<div class="line"></div>
<div class="line">    lcore = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    lp = &amp;app.lcore_params[lcore];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (lp-&gt;type == e_APP_LCORE_IO) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Logical core %u (I/O) main loop.\n&quot;</span>, lcore);</div>
<div class="line">        app_lcore_main_loop_io();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (lp-&gt;type == e_APP_LCORE_WORKER) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Logical core %u (worker %u) main loop.\n&quot;</span>,</div>
<div class="line">            lcore,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>) lp-&gt;worker.worker_id);</div>
<div class="line">        app_lcore_main_loop_worker();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
