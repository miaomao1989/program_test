<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: multi_process/client_server_mp/mp_client/client.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">multi_process/client_server_mp/mp_client/client.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2016 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;common.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Number of packets to attempt to read from queue */</span></div>
<div class="line"><span class="preprocessor">#define PKT_READ_SIZE  ((uint16_t)32)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* our client id number - tells us which rx queue to read, and NIC TX</span></div>
<div class="line"><span class="comment"> * queue to write to. */</span></div>
<div class="line"><span class="keyword">static</span> uint8_t client_id = 0;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MBQ_CAPACITY 32</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* maps input ports to output ports for packets */</span></div>
<div class="line"><span class="keyword">static</span> uint8_t output_ports[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* buffers up a set of packet that are ready to send */</span></div>
<div class="line"><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__eth__dev__tx__buffer.html">rte_eth_dev_tx_buffer</a> *tx_buffer[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* shared data from server. We update statistics here */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">struct </span>tx_stats *tx_stats;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * print a usage message</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *progname)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Usage: %s [EAL args] -- -n &lt;client_id&gt;\n\n&quot;</span>, progname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Convert the client id number from a string to an int.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_client_num(<span class="keyword">const</span> <span class="keywordtype">char</span> *client)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> temp;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (client == NULL || *client == <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    temp = strtoul(client, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> (end == NULL || *end != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    client_id = (uint8_t)temp;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the application arguments to the client app.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_app_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> option_index, opt;</div>
<div class="line">    <span class="keywordtype">char</span> **argvopt = argv;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *progname = NULL;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option lgopts[] = { <span class="comment">/* no long options */</span></div>
<div class="line">        {NULL, 0, 0, 0 }</div>
<div class="line">    };</div>
<div class="line">    progname = argv[0];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argvopt, <span class="stringliteral">&quot;n:&quot;</span>, lgopts,</div>
<div class="line">        &amp;option_index)) != EOF){</div>
<div class="line">        <span class="keywordflow">switch</span> (opt){</div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div>
<div class="line">                <span class="keywordflow">if</span> (parse_client_num(optarg) != 0){</div>
<div class="line">                    usage(progname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                usage(progname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Tx buffer error callback</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">flush_tx_error_callback(<span class="keyword">struct</span> <a name="_a1"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **unsent, uint16_t count,</div>
<div class="line">        <span class="keywordtype">void</span> *userdata) {</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    uint8_t port_id = (uintptr_t)userdata;</div>
<div class="line"></div>
<div class="line">    tx_stats-&gt;tx_drop[port_id] += count;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* free the mbufs which failed from transmit */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)</div>
<div class="line">        <a name="a2"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(unsent[i]);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">configure_tx_buffer(uint8_t port_id, uint16_t size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize TX buffers */</span></div>
<div class="line">    tx_buffer[port_id] = <a name="a3"></a><a class="code" href="rte__malloc_8h.html#aabfa4bb0c1430eb7be96bf847f61113a">rte_zmalloc_socket</a>(<span class="stringliteral">&quot;tx_buffer&quot;</span>,</div>
<div class="line">            <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#aff24ae3f48be43275b50966c3573a7a9">RTE_ETH_TX_BUFFER_SIZE</a>(size), 0,</div>
<div class="line">            rte_eth_dev_socket_id(port_id));</div>
<div class="line">    <span class="keywordflow">if</span> (tx_buffer[port_id] == NULL)</div>
<div class="line">        <a name="a5"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot allocate buffer for tx on port %u\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">unsigned</span>) port_id);</div>
<div class="line"></div>
<div class="line">    <a name="a6"></a><a class="code" href="rte__ethdev_8h.html#ac5323444ecbe84309a5fcc03aa3c99cb">rte_eth_tx_buffer_init</a>(tx_buffer[port_id], size);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a7"></a><a class="code" href="rte__ethdev_8h.html#aacd4952d9f45acd463e203c21db9a7bb">rte_eth_tx_buffer_set_err_callback</a>(tx_buffer[port_id],</div>
<div class="line">            flush_tx_error_callback, (<span class="keywordtype">void</span> *)(intptr_t)port_id);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot set error callback for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;tx buffer on port %u\n&quot;</span>, (<span class="keywordtype">unsigned</span>) port_id);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * set up output ports so that all traffic on port gets sent out</span></div>
<div class="line"><span class="comment"> * its paired port. Index using actual port numbers since that is</span></div>
<div class="line"><span class="comment"> * what comes in the mbuf structure.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">configure_output_ports(<span class="keyword">const</span> <span class="keyword">struct</span> port_info *ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">if</span> (ports-&gt;num_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Too many ethernet ports. RTE_MAX_ETHPORTS = %u\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">unsigned</span>)RTE_MAX_ETHPORTS);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; ports-&gt;num_ports - 1; i+=2){</div>
<div class="line">        uint8_t p1 = ports-&gt;id[i];</div>
<div class="line">        uint8_t p2 = ports-&gt;id[i+1];</div>
<div class="line">        output_ports[p1] = p2;</div>
<div class="line">        output_ports[p2] = p1;</div>
<div class="line"></div>
<div class="line">        configure_tx_buffer(p1, MBQ_CAPACITY);</div>
<div class="line">        configure_tx_buffer(p2, MBQ_CAPACITY);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function performs routing of packets</span></div>
<div class="line"><span class="comment"> * Just sends each input packet out an output port based solely on the input</span></div>
<div class="line"><span class="comment"> * port it arrived on.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">handle_packet(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> sent;</div>
<div class="line">    <span class="keyword">const</span> uint8_t in_port = buf-&gt;<a name="a8"></a><a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line">    <span class="keyword">const</span> uint8_t out_port = output_ports[in_port];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__dev__tx__buffer.html">rte_eth_dev_tx_buffer</a> *buffer = tx_buffer[out_port];</div>
<div class="line"></div>
<div class="line">    sent = <a name="a9"></a><a class="code" href="rte__ethdev_8h.html#a1b95c114276a21717b20be4cbf112223">rte_eth_tx_buffer</a>(out_port, client_id, buffer, buf);</div>
<div class="line">    <span class="keywordflow">if</span> (sent)</div>
<div class="line">        tx_stats-&gt;tx[out_port] += sent;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Application main function - loops through</span></div>
<div class="line"><span class="comment"> * receiving and processing packets. Never returns</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a10"></a><a class="code" href="structrte__memzone.html">rte_memzone</a> *mz;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a11"></a><a class="code" href="structrte__ring.html">rte_ring</a> *rx_ring;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a12"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *<a name="a13"></a><a class="code" href="rte__cryptodev_8h.html#a9f6b27bed19dd1bf3cff6af57d7cf86f">mp</a>;</div>
<div class="line">    <span class="keyword">struct </span>port_info *ports;</div>
<div class="line">    <span class="keywordtype">int</span> need_flush = 0; <span class="comment">/* indicates whether we have unsent packets */</span></div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    <span class="keywordtype">void</span> *pkts[PKT_READ_SIZE];</div>
<div class="line">    uint16_t sent;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((retval = <a name="a14"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv)) &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    argc -= retval;</div>
<div class="line">    argv += retval;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (parse_app_args(argc, argv) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid command-line arguments\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>() == 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;No Ethernet ports - bye\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    rx_ring = <a name="a16"></a><a class="code" href="rte__ring_8h.html#ad26dd65732f16f720eca5e1aa94e2a8a">rte_ring_lookup</a>(get_rx_queue_name(client_id));</div>
<div class="line">    <span class="keywordflow">if</span> (rx_ring == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot get RX ring - is server process running?\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    mp = <a name="a17"></a><a class="code" href="rte__mempool_8h.html#a3a5887135fc6329a35780b0053e769ad">rte_mempool_lookup</a>(PKTMBUF_POOL_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (mp == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot get mempool for mbufs\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    mz = <a name="a18"></a><a class="code" href="rte__memzone_8h.html#aa772ef84e73ac173503c16f243766993">rte_memzone_lookup</a>(MZ_PORT_INFO);</div>
<div class="line">    <span class="keywordflow">if</span> (mz == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot get port info structure\n&quot;</span>);</div>
<div class="line">    ports = mz-&gt;<a name="a19"></a><a class="code" href="structrte__memzone.html#ae5bd6c22dbf0f6b5b0ae0233f8eb3704">addr</a>;</div>
<div class="line">    tx_stats = &amp;(ports-&gt;tx_stats[client_id]);</div>
<div class="line"></div>
<div class="line">    configure_output_ports(ports);</div>
<div class="line"></div>
<div class="line">    <a name="a20"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Finished Process Init.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nClient process %d handling packets\n&quot;</span>, client_id);</div>
<div class="line">    printf(<span class="stringliteral">&quot;[Press Ctrl-C to quit ...]\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        uint16_t i, rx_pkts = PKT_READ_SIZE;</div>
<div class="line">        uint8_t <a name="_a21"></a><a class="code" href="structport.html">port</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* try dequeuing max possible packets first, if that fails, get the</span></div>
<div class="line"><span class="comment">         * most we can. Loop body should only execute once, maximum */</span></div>
<div class="line">        <span class="keywordflow">while</span> (rx_pkts &gt; 0 &amp;&amp;</div>
<div class="line">                <a name="a22"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a name="a23"></a><a class="code" href="rte__ring_8h.html#aa783f1ffa07e03ed6a9e29d9bb03c52a">rte_ring_dequeue_bulk</a>(rx_ring, pkts, rx_pkts) != 0))</div>
<div class="line">            rx_pkts = (uint16_t)<a name="a24"></a><a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(<a name="a25"></a><a class="code" href="rte__ring_8h.html#abc8376d2c6e609707d52032860880b34">rte_ring_count</a>(rx_ring), PKT_READ_SIZE);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rx_pkts == 0)){</div>
<div class="line">            <span class="keywordflow">if</span> (need_flush)</div>
<div class="line">                <span class="keywordflow">for</span> (port = 0; port &lt; ports-&gt;num_ports; port++) {</div>
<div class="line">                    sent = <a name="a26"></a><a class="code" href="rte__ethdev_8h.html#a36c34e92e00757f6f1c50a8c99a3a92d">rte_eth_tx_buffer_flush</a>(ports-&gt;id[port], client_id,</div>
<div class="line">                            tx_buffer[port]);</div>
<div class="line">                    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(sent))</div>
<div class="line">                        tx_stats-&gt;tx[port] += sent;</div>
<div class="line">                }</div>
<div class="line">            need_flush = 0;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; rx_pkts; i++)</div>
<div class="line">            handle_packet(pkts[i]);</div>
<div class="line"></div>
<div class="line">        need_flush = 1;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
