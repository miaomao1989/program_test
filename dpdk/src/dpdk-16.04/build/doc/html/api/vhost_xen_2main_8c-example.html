<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vhost_xen/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vhost_xen/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_ether.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_vlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/eventfd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;virtio-net.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;xen_vhost.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_QUEUES 128</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* the maximum number of external ports supported */</span></div>
<div class="line"><span class="preprocessor">#define MAX_SUP_PORTS 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Calculate the number of buffers needed per port</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define NUM_MBUFS_PER_PORT ((MAX_QUEUES*RTE_TEST_RX_DESC_DEFAULT) +     \</span></div>
<div class="line"><span class="preprocessor">                            (num_switching_cores*MAX_PKT_BURST) +           \</span></div>
<div class="line"><span class="preprocessor">                            (num_switching_cores*RTE_TEST_TX_DESC_DEFAULT) +\</span></div>
<div class="line"><span class="preprocessor">                            (num_switching_cores*MBUF_CACHE_SIZE))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBUF_CACHE_SIZE 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * RX and TX Prefetch, Host, and Write-back threshold values should be</span></div>
<div class="line"><span class="comment"> * carefully set for optimal performance. Consult the network</span></div>
<div class="line"><span class="comment"> * controller&#39;s datasheet and supporting DPDK documentation for guidance</span></div>
<div class="line"><span class="comment"> * on how these parameters should be set.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define RX_PTHRESH 8 </span><span class="comment">/* Default values of RX prefetch threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RX_HTHRESH 8 </span><span class="comment">/* Default values of RX host threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RX_WTHRESH 4 </span><span class="comment">/* Default values of RX write-back threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * These default values are optimized for use with the Intel(R) 82599 10 GbE</span></div>
<div class="line"><span class="comment"> * Controller and the DPDK ixgbe PMD. Consider using other values for other</span></div>
<div class="line"><span class="comment"> * network controllers and/or network drivers.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define TX_PTHRESH 36 </span><span class="comment">/* Default values of TX prefetch threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TX_HTHRESH 0  </span><span class="comment">/* Default values of TX host threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TX_WTHRESH 0  </span><span class="comment">/* Default values of TX write-back threshold reg. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_PKT_BURST 32        </span><span class="comment">/* Max burst size for RX/TX */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_MRG_PKT_BURST 16    </span><span class="comment">/* Max burst for merge buffers. Set to 1 due to performance issue. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_TX_DRAIN_US 100   </span><span class="comment">/* TX drain every ~100us */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* State of virtio device. */</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_NOT_READY     0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_READY         1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DEVICE_SAFE_REMOVE   2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Config_core_flag status definitions. */</span></div>
<div class="line"><span class="preprocessor">#define REQUEST_DEV_REMOVAL 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ACK_DEV_REMOVAL 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Configurable number of RX/TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define INVALID_PORT_ID 0xFF</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Max number of devices. Limited by vmdq. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_DEVICES 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Size of buffers used for snprintfs. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PRINT_BUFF 6072</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Maximum long option length for option parsing. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_LONG_OPT_SZ 64</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Used to compare MAC addresses. */</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_CMP 0xFFFFFFFFFFFF</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*Number of switching cores enabled*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_switching_cores = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* number of devices/queues to support*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_queues = 0;</div>
<div class="line">uint32_t num_devices = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable VM2VM communications. If this is disabled then the MAC address compare is skipped. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_vm2vm = 1;</div>
<div class="line"><span class="comment">/* Enable stats. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_stats = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* empty vmdq configuration structure. Filled in programatically */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> vmdq_conf_default = {</div>
<div class="line">    .<a name="a1"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a2"></a><a class="code" href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">mq_mode</a>        = <a name="a3"></a><a class="code" href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c">ETH_MQ_RX_VMDQ_ONLY</a>,</div>
<div class="line">        .split_hdr_size = 0,</div>
<div class="line">        .header_split   = 0, </div>
<div class="line">        .hw_ip_checksum = 0, </div>
<div class="line">        .hw_vlan_filter = 0, </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * It is necessary for 1G NIC such as I350,</span></div>
<div class="line"><span class="comment">         * this fixes bug of ipv4 forwarding in guest can&#39;t</span></div>
<div class="line"><span class="comment">         * forward pakets from one virtio dev to another virtio dev.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .hw_vlan_strip  = 1, </div>
<div class="line">        .jumbo_frame    = 0, </div>
<div class="line">        .hw_strip_crc   = 0, </div>
<div class="line">    },</div>
<div class="line"></div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">    .rx_adv_conf = {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * should be overridden separately in code with</span></div>
<div class="line"><span class="comment">         * appropriate values</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .vmdq_rx_conf = {</div>
<div class="line">            .nb_queue_pools = <a name="a5"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae">ETH_8_POOLS</a>,</div>
<div class="line">            .enable_default_pool = 0,</div>
<div class="line">            .default_pool = 0,</div>
<div class="line">            .nb_pool_maps = 0,</div>
<div class="line">            .pool_map = {{0, 0},},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> lcore_ids[RTE_MAX_LCORE];</div>
<div class="line"><span class="keyword">static</span> uint8_t ports[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> num_ports = 0; </div>
<div class="line"><span class="keyword">const</span> uint16_t vlan_tags[] = {</div>
<div class="line">    1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007,</div>
<div class="line">    1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015,</div>
<div class="line">    1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023,</div>
<div class="line">    1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031,</div>
<div class="line">    1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039,</div>
<div class="line">    1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047,</div>
<div class="line">    1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055,</div>
<div class="line">    1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a6"></a><a class="code" href="structether__addr.html">ether_addr</a> vmdq_ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* heads for the main used and free linked lists for the data path. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_used = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *ll_root_free = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Array of data core structures containing information on individual core linked lists. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>lcore_info lcore_info[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Used for queueing bursts of TX packets. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table {</div>
<div class="line">    <span class="keywordtype">unsigned</span> len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> txq_id;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_table[MAX_PKT_BURST];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* TX queue for each data core. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table lcore_tx_queue[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Vlan header struct used to insert vlan tags on TX. */</span></div>
<div class="line"><span class="keyword">struct </span>vlan_ethhdr {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   h_dest[ETH_ALEN];</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   h_source[ETH_ALEN];</div>
<div class="line">    __be16          h_vlan_proto;</div>
<div class="line">    __be16          h_vlan_TCI;</div>
<div class="line">    __be16          h_vlan_encapsulated_proto;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Header lengths. */</span></div>
<div class="line"><span class="preprocessor">#define VLAN_HLEN       4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define VLAN_ETH_HLEN   18</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Per-device statistics struct */</span></div>
<div class="line"><span class="keyword">struct </span>device_statistics {</div>
<div class="line">    uint64_t tx_total;</div>
<div class="line">    <a name="_a8"></a><a class="code" href="structrte__atomic64__t.html">rte_atomic64_t</a> rx_total;</div>
<div class="line">    uint64_t tx;</div>
<div class="line">    <a class="code" href="structrte__atomic64__t.html">rte_atomic64_t</a> rx;</div>
<div class="line">} <a name="a9"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"><span class="keyword">struct </span>device_statistics dev_statistics[MAX_DEVICES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Builds up the correct configuration for VMDQ VLAN pool map</span></div>
<div class="line"><span class="comment"> * according to the pool &amp; queue limits.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">get_eth_conf(<span class="keyword">struct</span> <a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> *eth_conf, uint32_t num_devices)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_eth_vmdq_rx_conf conf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    memset(&amp;conf, 0, <span class="keyword">sizeof</span>(conf));</div>
<div class="line">    conf.nb_queue_pools = (<span class="keyword">enum</span> <a name="a10"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0d">rte_eth_nb_pools</a>)num_devices;</div>
<div class="line">    conf.nb_pool_maps = num_devices;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; conf.nb_pool_maps; i++) {</div>
<div class="line">        conf.pool_map[i].vlan_id = vlan_tags[ i ];</div>
<div class="line">        conf.pool_map[i].pools = (1UL &lt;&lt; i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    (void)(<a name="a11"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(eth_conf, &amp;vmdq_conf_default, <span class="keyword">sizeof</span>(*eth_conf)));</div>
<div class="line">    (void)(<a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;eth_conf-&gt;<a name="a12"></a><a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a name="a13"></a><a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>, &amp;conf,</div>
<div class="line">           <span class="keyword">sizeof</span>(eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a8229e3f2f1bdcc64b2c97f4b8aaf3889">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>)));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Validate the device number according to the max pool number gotten form dev_info</span></div>
<div class="line"><span class="comment"> * If the device number is invalid, give the error message and return -1.</span></div>
<div class="line"><span class="comment"> * Each device must have its own pool.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">validate_num_devices(uint32_t max_nb_devices)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (num_devices &gt; max_nb_devices) {</div>
<div class="line">        <a name="a14"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;invalid number of devices\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialises a given port using global settings and with the rx buffers</span></div>
<div class="line"><span class="comment"> * coming from the mbuf_pool passed as parameter</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">port_init(uint8_t <a name="_a15"></a><a class="code" href="structport.html">port</a>, <span class="keyword">struct</span> <a name="_a16"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a17"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a18"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> *rxconf;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf;</div>
<div class="line">    uint16_t rx_rings, tx_rings = (uint16_t)<a name="a19"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t rx_ring_size = RTE_TEST_RX_DESC_DEFAULT, tx_ring_size = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* The max pool number from dev_info will be used to validate the pool number specified in cmd line */</span></div>
<div class="line">    <a name="a20"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a> (port, &amp;dev_info);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*configure the number of supported virtio devices based on VMDQ limits */</span></div>
<div class="line">    num_devices = dev_info.max_vmdq_pools;</div>
<div class="line">    num_queues = dev_info.max_rx_queues;</div>
<div class="line"></div>
<div class="line">    retval = validate_num_devices(MAX_DEVICES);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get port configuration. */</span></div>
<div class="line">    retval = get_eth_conf(&amp;port_conf, num_devices);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port &gt;= <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>()) <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    rx_rings = (uint16_t)num_queues,</div>
<div class="line">    <span class="comment">/* Configure ethernet device. */</span></div>
<div class="line">    retval = <a name="a22"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, rx_rings, tx_rings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line">    rxconf = &amp;dev_info.default_rxconf;</div>
<div class="line">    rxconf-&gt;<a name="a23"></a><a class="code" href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rx_drop_en</a> = 1;</div>
<div class="line">    <span class="comment">/* Setup the queues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rx_rings; q ++) {</div>
<div class="line">        retval = <a name="a24"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, q, rx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port), rxconf,</div>
<div class="line">                        mbuf_pool);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; tx_rings; q ++) {</div>
<div class="line">        retval = <a name="a25"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, q, tx_ring_size,</div>
<div class="line">                        rte_eth_dev_socket_id(port),</div>
<div class="line">                        NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the device. */</span></div>
<div class="line">    retval  = <a name="a26"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <a name="a27"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(port, &amp;vmdq_ports_eth_addr[port]);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Max virtio devices supported: %u\n&quot;</span>, num_devices);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Port %u MAC: %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8</div>
<div class="line">            <span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)port,</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[0],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[1],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[2],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[3],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[4],</div>
<div class="line">            vmdq_ports_eth_addr[port].addr_bytes[5]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the portmask provided at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse num options at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_num_opt(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg, uint32_t max_valid_value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse unsigned int string */</span></div>
<div class="line">    num = strtoul(q_arg, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((q_arg[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num &gt; max_valid_value)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> num;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Display usage</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">us_vhost_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK --vm2vm [0|1] --stats [0-N] --nb-devices ND\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       -p PORTMASK: Set mask for ports to be used by application\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vm2vm [0|1]: disable/enable(default) vm2vm comms\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --stats [0-N]: 0: Disable stats, N: Time in seconds to print stats\n&quot;</span>,</div>
<div class="line">           prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the arguments given in the command line of the application.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;vm2vm&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;stats&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, 0, 0}</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:&quot;</span>,long_option, &amp;option_index)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* Portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid portmask\n&quot;</span>);</div>
<div class="line">                us_vhost_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="comment">/* Enable/disable vm2vm comms. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;vm2vm&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for vm2vm [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_vm2vm = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Enable/disable stats. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;stats&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for stats [0..N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_stats = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Invalid option - print options. */</span></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            us_vhost_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enabled_port_mask &amp; (1 &lt;&lt; i))</div>
<div class="line">            ports[num_ports++] = (uint8_t)i;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((num_ports ==  0) || (num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update the global var NUM_PORTS and array PORTS according to system ports number</span></div>
<div class="line"><span class="comment"> * and return valid ports number</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> check_ports_num(<span class="keywordtype">unsigned</span> nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> valid_num_ports = num_ports;</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_ports &gt; nb_ports) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port number(%u) exceeds total system port number(%u)\n&quot;</span>,</div>
<div class="line">            num_ports, nb_ports);</div>
<div class="line">        num_ports = nb_ports;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; num_ports; portid ++) {</div>
<div class="line">        <span class="keywordflow">if</span> (ports[portid] &gt;= nb_ports) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port ID(%u) exceeds max system port ID(%u)\n&quot;</span>,</div>
<div class="line">                ports[portid], (nb_ports - 1));</div>
<div class="line">            ports[portid] = INVALID_PORT_ID;</div>
<div class="line">            valid_num_ports--;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> valid_num_ports;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Macro to print out packet contents. Wrapped in debug define so that the</span></div>
<div class="line"><span class="comment"> * data path is not effected when debug is disabled.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PRINT_PACKET(device, addr, size, header) do {                                                               \</span></div>
<div class="line"><span class="preprocessor">    char *pkt_addr = (char*)(addr);                                                                                 \</span></div>
<div class="line"><span class="preprocessor">    unsigned int index;                                                                                             \</span></div>
<div class="line"><span class="preprocessor">    char packet[MAX_PRINT_BUFF];                                                                                    \</span></div>
<div class="line"><span class="preprocessor">                                                                                                                    \</span></div>
<div class="line"><span class="preprocessor">    if ((header))                                                                                                   \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet, MAX_PRINT_BUFF, &quot;(%&quot;PRIu64&quot;) Header size %d: &quot;, (device-&gt;device_fh), (size));              \</span></div>
<div class="line"><span class="preprocessor">    else                                                                                                            \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet, MAX_PRINT_BUFF, &quot;(%&quot;PRIu64&quot;) Packet size %d: &quot;, (device-&gt;device_fh), (size));              \</span></div>
<div class="line"><span class="preprocessor">    for (index = 0; index &lt; (size); index++) {                                                                      \</span></div>
<div class="line"><span class="preprocessor">        snprintf(packet + strnlen(packet, MAX_PRINT_BUFF), MAX_PRINT_BUFF - strnlen(packet, MAX_PRINT_BUFF),    \</span></div>
<div class="line"><span class="preprocessor">            &quot;%02hhx &quot;, pkt_addr[index]);                                                                            \</span></div>
<div class="line"><span class="preprocessor">    }                                                                                                               \</span></div>
<div class="line"><span class="preprocessor">    snprintf(packet + strnlen(packet, MAX_PRINT_BUFF), MAX_PRINT_BUFF - strnlen(packet, MAX_PRINT_BUFF), &quot;\n&quot;); \</span></div>
<div class="line"><span class="preprocessor">                                                                                                                    \</span></div>
<div class="line"><span class="preprocessor">    LOG_DEBUG(VHOST_DATA, &quot;%s&quot;, packet);                                                                                    \</span></div>
<div class="line"><span class="preprocessor">} while(0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PRINT_PACKET(device, addr, size, header) do{} while(0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function to convert guest physical addresses to vhost virtual addresses. This</span></div>
<div class="line"><span class="comment"> * is used to convert virtio buffer addresses.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t __attribute__((always_inline))</div>
<div class="line"><a name="a28"></a><a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(struct <a name="_a29"></a><a class="code" href="structvirtio__net.html">virtio_net</a> *dev, uint64_t guest_pa)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a30"></a><a class="code" href="structvirtio__memory__regions.html">virtio_memory_regions</a> *region;</div>
<div class="line">    uint32_t regionidx;</div>
<div class="line">    uint64_t vhost_va = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (regionidx = 0; regionidx &lt; dev-&gt;mem-&gt;nregions; regionidx++) {</div>
<div class="line">        region = &amp;dev-&gt;mem-&gt;regions[regionidx];</div>
<div class="line">        <span class="keywordflow">if</span> ((guest_pa &gt;= region-&gt;<a name="a31"></a><a class="code" href="structvirtio__memory__regions.html#a770e0e191260326089cb15208767c198">guest_phys_address</a>) &amp;&amp;</div>
<div class="line">            (guest_pa &lt;= region-&gt;<a name="a32"></a><a class="code" href="structvirtio__memory__regions.html#a4c60f2e827edd2d959aa0c7c6be9f99c">guest_phys_address_end</a>)) {</div>
<div class="line">            vhost_va = region-&gt;<a name="a33"></a><a class="code" href="structvirtio__memory__regions.html#a07e7aa887598ca959517d7028a4d182a">address_offset</a> + guest_pa;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) GPA %p| VVA %p\n&quot;</span>,</div>
<div class="line">        dev-&gt;device_fh, (<span class="keywordtype">void</span>*)(uintptr_t)guest_pa, (<span class="keywordtype">void</span>*)(uintptr_t)vhost_va);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> vhost_va;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function adds buffers to the virtio devices RX virtqueue. Buffers can</span></div>
<div class="line"><span class="comment"> * be received from the physical port or from another virtio device. A packet</span></div>
<div class="line"><span class="comment"> * count is returned to indicate the number of packets that were succesfully</span></div>
<div class="line"><span class="comment"> * added to the RX queue.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t __attribute__((always_inline))</div>
<div class="line">virtio_dev_rx(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts, uint32_t count)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a34"></a><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buff;</div>
<div class="line">    <span class="comment">/* The virtio_hdr is initialised to 0. */</span></div>
<div class="line">    <span class="keyword">struct </span>virtio_net_hdr_mrg_rxbuf virtio_hdr = {{0,0,0,0,0,0},0};</div>
<div class="line">    uint64_t buff_addr = 0;</div>
<div class="line">    uint64_t buff_hdr_addr = 0;</div>
<div class="line">    uint32_t head[MAX_PKT_BURST], packet_len = 0;</div>
<div class="line">    uint32_t head_idx, packet_success = 0;</div>
<div class="line">    uint16_t avail_idx, res_cur_idx;</div>
<div class="line">    uint16_t res_base_idx, res_end_idx;</div>
<div class="line">    uint16_t free_entries;</div>
<div class="line">    uint8_t success = 0;</div>
<div class="line">    <span class="keywordtype">void</span> *userdata;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) virtio_dev_rx()\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line">    vq = dev-&gt;virtqueue_rx;</div>
<div class="line">    count = (count &gt; MAX_PKT_BURST) ? MAX_PKT_BURST : count;</div>
<div class="line">    <span class="comment">/* As many data cores may want access to available buffers, they need to be reserved. */</span></div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line"></div>
<div class="line">        res_base_idx = vq-&gt;<a name="a35"></a><a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a>;</div>
<div class="line"></div>
<div class="line">        avail_idx = *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a name="a36"></a><a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line"></div>
<div class="line">        free_entries = (avail_idx - res_base_idx);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*check that we have enough buffers*/</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a37"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(count &gt; free_entries))</div>
<div class="line">            count = free_entries;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (count == 0)</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        res_end_idx = res_base_idx + count;</div>
<div class="line">        <span class="comment">/* vq-&gt;last_used_idx_res is atomically updated. */</span></div>
<div class="line">        success = <a name="a38"></a><a class="code" href="rte__atomic_8h.html#a139f8a9c5fdbc2a41b752268d93ff772">rte_atomic16_cmpset</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#abad4e60efa62398f28ecdc51c6a96ad2">last_used_idx_res</a>, res_base_idx,</div>
<div class="line">                                    res_end_idx);</div>
<div class="line">    } <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(success == 0));</div>
<div class="line">    res_cur_idx = res_base_idx;</div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Current Index %d| End Index %d\n&quot;</span>, dev-&gt;device_fh, res_cur_idx, res_end_idx);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch available ring to retrieve indexes. */</span></div>
<div class="line">    <a name="a39"></a><a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[res_cur_idx &amp; (vq-&gt;<a name="a40"></a><a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Retrieve all of the head indexes first to avoid caching issues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (head_idx = 0; head_idx &lt; count; head_idx++)</div>
<div class="line">        head[head_idx] = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[(res_cur_idx + head_idx) &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Prefetch descriptor index. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a name="a41"></a><a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (res_cur_idx != res_end_idx) {</div>
<div class="line">        <span class="comment">/* Get descriptor from available ring */</span></div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]];</div>
<div class="line">        <span class="comment">/* Prefetch descriptor address. */</span></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(desc);</div>
<div class="line"></div>
<div class="line">        buff = pkts[packet_success];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Convert from gpa to vva (guest physical addr -&gt; vhost virtual addr) */</span></div>
<div class="line">        buff_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">        <span class="comment">/* Prefetch buffer address. */</span></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>((<span class="keywordtype">void</span>*)(uintptr_t)buff_addr);</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Copy virtio_hdr to packet and increment buffer address */</span></div>
<div class="line">            buff_hdr_addr = buff_addr;</div>
<div class="line">            packet_len = <a name="a42"></a><a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff) + vq-&gt;<a name="a43"></a><a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * If the descriptors are chained the header and data are placed in</span></div>
<div class="line"><span class="comment">             * separate buffers.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            <span class="keywordflow">if</span> (desc-&gt;flags &amp; VRING_DESC_F_NEXT) {</div>
<div class="line">                desc-&gt;len = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>;</div>
<div class="line">                desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc-&gt;next];</div>
<div class="line">                <span class="comment">/* Buffer address translation. */</span></div>
<div class="line">                buff_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">                desc-&gt;len = <a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                buff_addr += vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>;</div>
<div class="line">                desc-&gt;len = packet_len;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update used ring with desc information */</span></div>
<div class="line">        vq-&gt;<a name="a44"></a><a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[res_cur_idx &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)].<span class="keywordtype">id</span> = head[packet_success];</div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[res_cur_idx &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)].len = packet_len;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Copy mbuf data to buffer */</span></div>
<div class="line">        userdata = <a name="a45"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(buff, <span class="keywordtype">void</span> *);</div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>((<span class="keywordtype">void</span> *)(uintptr_t)buff_addr, userdata, <a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(buff));</div>
<div class="line"></div>
<div class="line">        res_cur_idx++;</div>
<div class="line">        packet_success++;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* mergeable is disabled then a header is required per buffer. */</span></div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>((<span class="keywordtype">void</span> *)(uintptr_t)buff_hdr_addr, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;virtio_hdr, vq-&gt;<a class="code" href="structvhost__virtqueue.html#a8a936aeef098e6f6b0724dd8f468e11c">vhost_hlen</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (res_cur_idx &lt; res_end_idx) {</div>
<div class="line">            <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">            <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a46"></a><a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Wait until it&#39;s our turn to add our buffer to the used ring. */</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vq-&gt;<a name="a47"></a><a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> != res_base_idx))</div>
<div class="line">        rte_pause();</div>
<div class="line"></div>
<div class="line">    *(<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx += count;</div>
<div class="line"></div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> = res_end_idx;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Compares a packet destination MAC address to a device MAC address.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> __attribute__((always_inline))</div>
<div class="line">ether_addr_cmp(struct <a class="code" href="structether__addr.html">ether_addr</a> *ea, struct <a class="code" href="structether__addr.html">ether_addr</a> *eb)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> ((*(uint64_t *)ea ^ *(uint64_t *)eb) &amp; MAC_ADDR_CMP) == 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function registers mac along with a</span></div>
<div class="line"><span class="comment"> * vlan tag to a VMDQ.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">link_vmdq(<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line"></div>
<div class="line">    dev_ll = ll_root_used;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> ((dev != dev_ll-&gt;dev) &amp;&amp; ether_addr_cmp(&amp;dev-&gt;mac_address, &amp;dev_ll-&gt;dev-&gt;mac_address)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) WARNING: This device is using an existing MAC address and has not been registered.\n&quot;</span>, dev-&gt;<a name="a48"></a><a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        dev_ll = dev_ll-&gt;next;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* vlan_tag currently uses the device_id. */</span></div>
<div class="line">    dev-&gt;vlan_tag = vlan_tags[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>];</div>
<div class="line">    dev-&gt;vmdq_rx_q = dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a> * (num_queues/num_devices);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Print out VMDQ registration info. */</span></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) MAC_ADDRESS %02x:%02x:%02x:%02x:%02x:%02x and VLAN_TAG %d registered\n&quot;</span>,</div>
<div class="line">        dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>,</div>
<div class="line">        dev-&gt;mac_address.addr_bytes[0], dev-&gt;mac_address.addr_bytes[1],</div>
<div class="line">        dev-&gt;mac_address.addr_bytes[2], dev-&gt;mac_address.addr_bytes[3],</div>
<div class="line">        dev-&gt;mac_address.addr_bytes[4], dev-&gt;mac_address.addr_bytes[5],</div>
<div class="line">        dev-&gt;vlan_tag);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Register the MAC address. */</span></div>
<div class="line">    ret = <a name="a49"></a><a class="code" href="rte__ethdev_8h.html#aa2b81750086f5f9e55cf65e5cf9f2c58">rte_eth_dev_mac_addr_add</a>(ports[0], &amp;dev-&gt;mac_address, (uint32_t)dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to add device MAC address to VMDQ\n&quot;</span>,</div>
<div class="line">                                        dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable stripping of the vlan tag as we handle routing. */</span></div>
<div class="line">    <a name="a50"></a><a class="code" href="rte__ethdev_8h.html#a15fd035ce805444a3df4738a5c53fa62">rte_eth_dev_set_vlan_strip_on_queue</a>(ports[0], dev-&gt;vmdq_rx_q, 1);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line">    <span class="comment">/* Set device as ready for RX. */</span></div>
<div class="line">    dev-&gt;ready = DEVICE_READY;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Removes MAC address and vlan tag from VMDQ. Ensures that nothing is adding buffers to the RX</span></div>
<div class="line"><span class="comment"> * queue before disabling RX on the device.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">unlink_vmdq(<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> rx_count;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (dev-&gt;ready == DEVICE_READY) {</div>
<div class="line">        <span class="comment">/*clear MAC and VLAN settings*/</span></div>
<div class="line">        <a name="a51"></a><a class="code" href="rte__ethdev_8h.html#ad6dce3e24e3443c64da7f5ace3ddf36b">rte_eth_dev_mac_addr_remove</a>(ports[0], &amp;dev-&gt;mac_address);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)</div>
<div class="line">            dev-&gt;mac_address.addr_bytes[i] = 0;</div>
<div class="line"></div>
<div class="line">        dev-&gt;vlan_tag = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*Clear out the receive buffers*/</span></div>
<div class="line">        rx_count = <a name="a52"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)dev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (rx_count) {</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++)</div>
<div class="line">                <a name="a53"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[i]);</div>
<div class="line"></div>
<div class="line">            rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)dev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        dev-&gt;ready = DEVICE_NOT_READY;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Check if the packet destination MAC address is for a local device. If so then put</span></div>
<div class="line"><span class="comment"> * the packet on that devices RX queue. If not then return.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_local(struct <a class="code" href="structvirtio__net.html">virtio_net</a> *dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a54"></a><a class="code" href="structether__hdr.html">ether_hdr</a> *pkt_hdr;</div>
<div class="line">    uint64_t ret = 0;</div>
<div class="line"></div>
<div class="line">    pkt_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*get the used devices list*/</span></div>
<div class="line">    dev_ll = ll_root_used;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a55"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(dev_ll-&gt;dev-&gt;ready == DEVICE_READY) &amp;&amp; ether_addr_cmp(&amp;(pkt_hdr-&gt;<a name="a56"></a><a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a>),</div>
<div class="line">                          &amp;dev_ll-&gt;dev-&gt;mac_address)) {</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Drop the packet if the TX packet is destined for the TX device. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (dev_ll-&gt;dev-&gt;device_fh == dev-&gt;device_fh) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: Source and destination MAC addresses are the same. Dropping packet.\n&quot;</span>,</div>
<div class="line">                            dev_ll-&gt;dev-&gt;device_fh);</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">            LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: MAC address is local\n&quot;</span>, dev_ll-&gt;dev-&gt;device_fh);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (dev_ll-&gt;dev-&gt;remove) {</div>
<div class="line">                <span class="comment">/*drop the packet if the device is marked for removal*/</span></div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device is marked for removal\n&quot;</span>, dev_ll-&gt;dev-&gt;device_fh);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">/*send the packet to the local virtio device*/</span></div>
<div class="line">                ret = virtio_dev_rx(dev_ll-&gt;dev, &amp;m, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                    <a name="a57"></a><a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;dev_statistics[dev_ll-&gt;dev-&gt;device_fh].rx_total, 1);</div>
<div class="line">                    <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;dev_statistics[dev_ll-&gt;dev-&gt;device_fh].rx, ret);</div>
<div class="line">                    dev_statistics[dev-&gt;device_fh].tx_total++;</div>
<div class="line">                    dev_statistics[dev-&gt;device_fh].tx += ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">        dev_ll = dev_ll-&gt;next;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function routes the TX packet to the correct interface. This may be a local device</span></div>
<div class="line"><span class="comment"> * or the physical port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_tx_route(struct <a class="code" href="structvirtio__net.html">virtio_net</a>* dev, struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, struct <a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool, uint16_t vlan_tag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">struct </span>vlan_ethhdr *<a name="_a58"></a><a class="code" href="structvlan__hdr.html">vlan_hdr</a>;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **m_table;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *mbuf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> len, ret;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a name="a59"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*check if destination is local VM*/</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_vm2vm &amp;&amp; (virtio_tx_local(dev, m) == 0)) {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) TX: MAC address is external\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Add packet to the port tx queue*/</span></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    len = tx_q-&gt;len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate an mbuf and populate the structure. */</span></div>
<div class="line">    mbuf = <a name="a60"></a><a class="code" href="rte__mbuf_8h.html#ad4d1c289d8cffc831dfb77c64f52447b">rte_pktmbuf_alloc</a>(mbuf_pool);</div>
<div class="line">    <span class="keywordflow">if</span>(!mbuf)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    mbuf-&gt;<a name="a61"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = m-&gt;data_len + VLAN_HLEN;</div>
<div class="line">    mbuf-&gt;<a name="a62"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a> = mbuf-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Copy ethernet header to mbuf. */</span></div>
<div class="line">    <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf, <span class="keywordtype">void</span>*),</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">const</span> <span class="keywordtype">void</span>*), ETH_HLEN);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup vlan header. Bytes need to be re-ordered for network with htons()*/</span></div>
<div class="line">    vlan_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(mbuf, <span class="keyword">struct</span> vlan_ethhdr *);</div>
<div class="line">    vlan_hdr-&gt;h_vlan_encapsulated_proto = vlan_hdr-&gt;h_vlan_proto;</div>
<div class="line">    vlan_hdr-&gt;h_vlan_proto = htons(ETH_P_8021Q);</div>
<div class="line">    vlan_hdr-&gt;h_vlan_TCI = htons(vlan_tag);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Copy the remaining packet contents to the mbuf. */</span></div>
<div class="line">    <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(<a name="a63"></a><a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(mbuf, <span class="keywordtype">void</span> *, VLAN_ETH_HLEN),</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m, <span class="keyword">const</span> <span class="keywordtype">void</span> *, ETH_HLEN),</div>
<div class="line">        (m-&gt;data_len - ETH_HLEN));</div>
<div class="line">    tx_q-&gt;m_table[len] = mbuf;</div>
<div class="line">    len++;</div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        dev_statistics[dev-&gt;device_fh].tx_total++;</div>
<div class="line">        dev_statistics[dev-&gt;device_fh].tx++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line">        m_table = (<span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table;</div>
<div class="line">        ret = <a name="a64"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ports[0], (uint16_t)tx_q-&gt;txq_id, m_table, (uint16_t) len);</div>
<div class="line">        <span class="comment">/* Free any buffers not handled by TX and update the port stats. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; len)) {</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m_table[ret]);</div>
<div class="line">            } <span class="keywordflow">while</span> (++ret &lt; len);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        len = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tx_q-&gt;len = len;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> __attribute__((always_inline))</div>
<div class="line">virtio_dev_tx(struct <a class="code" href="structvirtio__net.html">virtio_net</a>* dev, struct <a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> m;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvhost__virtqueue.html">vhost_virtqueue</a> *vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc;</div>
<div class="line">    uint64_t buff_addr = 0;</div>
<div class="line">    uint32_t head[MAX_PKT_BURST];</div>
<div class="line">    uint32_t used_idx;</div>
<div class="line">    uint32_t i;</div>
<div class="line">    uint16_t free_entries, packet_success = 0;</div>
<div class="line">    uint16_t avail_idx;</div>
<div class="line"></div>
<div class="line">    vq = dev-&gt;virtqueue_tx;</div>
<div class="line">    avail_idx = *((<span class="keyword">volatile</span> uint16_t *)&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;idx);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If there are no available buffers then return. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> == avail_idx)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) virtio_dev_tx()\n&quot;</span>, dev-&gt;device_fh);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch available ring to retrieve head indexes. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*get the number of free entries in the ring*/</span></div>
<div class="line">    free_entries = avail_idx - vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>;</div>
<div class="line">    free_entries = <a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(free_entries &lt; MAX_PKT_BURST) ? free_entries : MAX_PKT_BURST;</div>
<div class="line"></div>
<div class="line">    LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Buffers available %d\n&quot;</span>, dev-&gt;device_fh, free_entries);</div>
<div class="line">    <span class="comment">/* Retrieve all of the head indexes first to avoid caching issues. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; free_entries; i++)</div>
<div class="line">        head[i] = vq-&gt;<a class="code" href="structvhost__virtqueue.html#a6c181d4605d8de183004c6ee63ae3046">avail</a>-&gt;ring[(vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> + i) &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1)];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">    <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (packet_success &lt; free_entries) {</div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success]];</div>
<div class="line">        <span class="comment">/* Prefetch descriptor address. */</span></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(desc);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (packet_success &lt; (free_entries - 1)) {</div>
<div class="line">            <span class="comment">/* Prefetch descriptor index. */</span></div>
<div class="line">            <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(&amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[head[packet_success+1]]);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Update used index buffer information. */</span></div>
<div class="line">        used_idx = vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a> &amp; (vq-&gt;<a class="code" href="structvhost__virtqueue.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> - 1);</div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[used_idx].id = head[packet_success];</div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;ring[used_idx].len = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Discard first buffer as it is the virtio header */</span></div>
<div class="line">        desc = &amp;vq-&gt;<a class="code" href="structvhost__virtqueue.html#ac0aa00a5fc55ec7c4c07ba7e959e88f5">desc</a>[desc-&gt;next];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Buffer address translation. */</span></div>
<div class="line">        buff_addr = <a class="code" href="rte__virtio__net_8h.html#af20489aab1783f920417533cf835c458">gpa_to_vva</a>(dev, desc-&gt;addr);</div>
<div class="line">        <span class="comment">/* Prefetch buffer address. */</span></div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>((<span class="keywordtype">void</span>*)(uintptr_t)buff_addr);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Setup dummy mbuf. This is copied to a real mbuf if transmitted out the physical port. */</span></div>
<div class="line">        m.data_len = desc-&gt;len;</div>
<div class="line">        m.data_off = 0;</div>
<div class="line">        m.nb_segs = 1;</div>
<div class="line"></div>
<div class="line">        virtio_tx_route(dev, &amp;m, mbuf_pool, 0);</div>
<div class="line"></div>
<div class="line">        vq-&gt;<a class="code" href="structvhost__virtqueue.html#aade3f3cc791e8b7ecd501359c7459cf2">last_used_idx</a>++;</div>
<div class="line">        packet_success++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line">    vq-&gt;<a class="code" href="structvhost__virtqueue.html#aaf8d0a5380260c817567cdcd15a1d74f">used</a>-&gt;idx += packet_success;</div>
<div class="line">    <span class="comment">/* Kick guest if required. */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function is called by each data core. It handles all RX/TX registered with the</span></div>
<div class="line"><span class="comment"> * core. For TX the specific lcore linked list is used. For RX, MAC addresses are compared</span></div>
<div class="line"><span class="comment"> * with all devices in the main linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">switch_worker(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool = arg;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvirtio__net.html">virtio_net</a> *dev = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keyword">struct </span>lcore_ll_info *lcore_ll;</div>
<div class="line">    <span class="keyword">const</span> uint64_t drain_tsc = (<a name="a65"></a><a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1) / US_PER_S * BURST_TX_DRAIN_US;</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc, ret_count = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> ret, i;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">const</span> uint16_t num_cores = (uint16_t)<a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line">    uint16_t rx_count = 0;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;Procesing on Core %u started \n&quot;</span>, lcore_id);</div>
<div class="line">    lcore_ll = lcore_info[lcore_id].lcore_ll;</div>
<div class="line">    prev_tsc = 0;</div>
<div class="line"></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_cores; i ++) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ids[i] == lcore_id) {</div>
<div class="line">            tx_q-&gt;txq_id = i;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * TX burst queue drain</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; drain_tsc)) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (tx_q-&gt;len) {</div>
<div class="line">                LOG_DEBUG(VHOST_DATA, <span class="stringliteral">&quot;TX queue drained after timeout with burst size %u \n&quot;</span>, tx_q-&gt;len);</div>
<div class="line"></div>
<div class="line">                <span class="comment">/*Tx any packets in the queue*/</span></div>
<div class="line">                ret = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ports[0], (uint16_t)tx_q-&gt;txq_id,</div>
<div class="line">                                       (<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)tx_q-&gt;m_table,</div>
<div class="line">                                       (uint16_t)tx_q-&gt;len);</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; tx_q-&gt;len)) {</div>
<div class="line">                    <span class="keywordflow">do</span> {</div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(tx_q-&gt;m_table[ret]);</div>
<div class="line">                    } <span class="keywordflow">while</span> (++ret &lt; tx_q-&gt;len);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                tx_q-&gt;len = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Inform the configuration core that we have exited the linked list and that no devices are</span></div>
<div class="line"><span class="comment">         * in use if requested.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ll-&gt;dev_removal_flag == REQUEST_DEV_REMOVAL)</div>
<div class="line">            lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Process devices</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        dev_ll = lcore_ll-&gt;ll_root_used;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            <span class="comment">/*get virtio device ID*/</span></div>
<div class="line">            dev = dev_ll-&gt;dev;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(dev-&gt;remove)) {</div>
<div class="line">                dev_ll = dev_ll-&gt;next;</div>
<div class="line">                unlink_vmdq(dev);</div>
<div class="line">                dev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(dev-&gt;ready == DEVICE_READY)) {</div>
<div class="line">                <span class="comment">/*Handle guest RX*/</span></div>
<div class="line">                rx_count = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)dev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (rx_count) {</div>
<div class="line">                    ret_count = virtio_dev_rx(dev, pkts_burst, rx_count);</div>
<div class="line">                    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">                        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;dev_statistics[dev_ll-&gt;dev-&gt;device_fh].rx_total, rx_count);</div>
<div class="line">                        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;dev_statistics[dev_ll-&gt;dev-&gt;device_fh].rx, ret_count);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count)) {</div>
<div class="line">                        rx_count--;</div>
<div class="line">                        <a name="a66"></a><a class="code" href="rte__mbuf_8h.html#a69d0817dfeb1385ae5056d67ea4eb245">rte_pktmbuf_free_seg</a>(pkts_burst[rx_count]);</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!dev-&gt;remove))</div>
<div class="line">                <span class="comment">/*Handle guest TX*/</span></div>
<div class="line">                virtio_dev_tx(dev, mbuf_pool);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*move to the next device in the list*/</span></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Add an entry to a used linked list. A free entry must first be found in the free linked list</span></div>
<div class="line"><span class="comment"> * using get_data_ll_free_entry();</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">add_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr, <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set next as NULL and use a compiler barrier to avoid reordering. */</span></div>
<div class="line">    ll_dev-&gt;next = NULL;</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#abad8d9be1c14d7bc543cc8fac35ada27">rte_compiler_barrier</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If ll == NULL then this is the first device. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (ll) {</div>
<div class="line">        <span class="comment">/* Increment to the tail of the linked list. */</span></div>
<div class="line">        <span class="keywordflow">while</span> ((ll-&gt;next != NULL) )</div>
<div class="line">            ll = ll-&gt;next;</div>
<div class="line"></div>
<div class="line">        ll-&gt;next = ll_dev;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        *ll_root_addr = ll_dev;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove an entry from a used linked list. The entry must then be added to the free linked list</span></div>
<div class="line"><span class="comment"> * using put_data_ll_free_entry().</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">rm_data_ll_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr, <span class="keyword">struct</span> virtio_net_data_ll *ll_dev, <span class="keyword">struct</span> virtio_net_data_ll *ll_dev_last)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == ll)</div>
<div class="line">        *ll_root_addr = ll_dev-&gt;next;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        ll_dev_last-&gt;next = ll_dev-&gt;next;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Find and return an entry from the free linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">get_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_free == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    ll_dev = ll_free;</div>
<div class="line">    *ll_root_addr = ll_free-&gt;next;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Place an entry back on to the free linked list.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">put_data_ll_free_entry(<span class="keyword">struct</span> virtio_net_data_ll **ll_root_addr, <span class="keyword">struct</span> virtio_net_data_ll *ll_dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_free = *ll_root_addr;</div>
<div class="line"></div>
<div class="line">    ll_dev-&gt;next = ll_free;</div>
<div class="line">    *ll_root_addr = ll_dev;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Creates a linked list of a given size.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtio_net_data_ll *</div>
<div class="line">alloc_data_ll(uint32_t size)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_new;</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Malloc and then chain the linked list. */</span></div>
<div class="line">    ll_new = malloc(size * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> virtio_net_data_ll));</div>
<div class="line">    <span class="keywordflow">if</span> (ll_new == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Failed to allocate memory for ll_new.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; size - 1; i++) {</div>
<div class="line">        ll_new[i].dev = NULL;</div>
<div class="line">        ll_new[i].next = &amp;ll_new[i+1];</div>
<div class="line">    }</div>
<div class="line">    ll_new[i].next = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ll_new;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Create the main linked list along with each individual cores linked list. A used and a free list</span></div>
<div class="line"><span class="comment"> * are created to manage entries.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_data_ll (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    <a name="a67"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> lcore_ll_info));</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG, <span class="stringliteral">&quot;Failed to allocate memory for lcore_ll.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;device_num = 0;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;ll_root_used = NULL;</div>
<div class="line">        <span class="keywordflow">if</span> (num_devices % num_switching_cores)</div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free = alloc_data_ll((num_devices / num_switching_cores) + 1);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            lcore_info[lcore].lcore_ll-&gt;ll_root_free = alloc_data_ll(num_devices / num_switching_cores);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate devices up to a maximum of MAX_DEVICES. */</span></div>
<div class="line">    ll_root_free = alloc_data_ll(MIN((num_devices), MAX_DEVICES));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove a device from the specific data core linked list and from the main linked list. The</span></div>
<div class="line"><span class="comment"> * rx/tx thread must be set the flag to indicate that it is safe to remove the device.</span></div>
<div class="line"><span class="comment"> * used.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device (<span class="keyword">volatile</span> <span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_cur;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_lcore_dev_last = NULL;</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"></div>
<div class="line">    dev-&gt;<a name="a68"></a><a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> &amp;= ~VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*set the remove flag. */</span></div>
<div class="line">    dev-&gt;remove = 1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(dev-&gt;ready != DEVICE_SAFE_REMOVE) {</div>
<div class="line">        rte_pause();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from lcore ll */</span></div>
<div class="line">    ll_lcore_dev_cur = lcore_info[dev-&gt;coreid].lcore_ll-&gt;ll_root_used;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_lcore_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_lcore_dev_cur-&gt;dev == dev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_lcore_dev_last = ll_lcore_dev_cur;</div>
<div class="line">            ll_lcore_dev_cur = ll_lcore_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Search for entry to be removed from main ll */</span></div>
<div class="line">    ll_main_dev_cur = ll_root_used;</div>
<div class="line">    ll_main_dev_last = NULL;</div>
<div class="line">    <span class="keywordflow">while</span> (ll_main_dev_cur != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ll_main_dev_cur-&gt;dev == dev) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ll_main_dev_last = ll_main_dev_cur;</div>
<div class="line">            ll_main_dev_cur = ll_main_dev_cur-&gt;next;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ll_lcore_dev_cur == NULL || ll_main_dev_cur == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;%s: could find device in per_cpu list or main_list\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Remove entries from the lcore and main ll. */</span></div>
<div class="line">    rm_data_ll_entry(&amp;lcore_info[ll_lcore_dev_cur-&gt;dev-&gt;coreid].lcore_ll-&gt;ll_root_used, ll_lcore_dev_cur, ll_lcore_dev_last);</div>
<div class="line">    rm_data_ll_entry(&amp;ll_root_used, ll_main_dev_cur, ll_main_dev_last);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set the dev_removal_flag on each lcore. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        lcore_info[lcore].lcore_ll-&gt;dev_removal_flag = REQUEST_DEV_REMOVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Once each core has set the dev_removal_flag to ACK_DEV_REMOVAL we can be sure that</span></div>
<div class="line"><span class="comment">     * they can no longer access the device removed from the linked lists and that the devices</span></div>
<div class="line"><span class="comment">     * are no longer in use.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">while</span> (lcore_info[lcore].lcore_ll-&gt;dev_removal_flag != ACK_DEV_REMOVAL) {</div>
<div class="line">            rte_pause();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add the entries back to the lcore and main free ll.*/</span></div>
<div class="line">    put_data_ll_free_entry(&amp;lcore_info[ll_lcore_dev_cur-&gt;dev-&gt;coreid].lcore_ll-&gt;ll_root_free, ll_lcore_dev_cur);</div>
<div class="line">    put_data_ll_free_entry(&amp;ll_root_free, ll_main_dev_cur);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Decrement number of device on the lcore. */</span></div>
<div class="line">    lcore_info[ll_lcore_dev_cur-&gt;dev-&gt;coreid].lcore_ll-&gt;device_num--;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;  #####(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been removed from data core\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A new device is added to a data core. First the device is added to the main linked list</span></div>
<div class="line"><span class="comment"> * and the allocated to a specific data core.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device (<span class="keyword">struct</span> <a class="code" href="structvirtio__net.html">virtio_net</a> *dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *ll_dev;</div>
<div class="line">    <span class="keywordtype">int</span> lcore, core_add = 0;</div>
<div class="line">    uint32_t device_num_min = num_devices;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Add device to main ll */</span></div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) No free entry found in linked list. Device limit &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;of %d devices per core has been reached\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, num_devices);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;dev = dev;</div>
<div class="line">    add_data_ll_entry(&amp;ll_root_used, ll_dev);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*reset ready flag*/</span></div>
<div class="line">    dev-&gt;ready = DEVICE_NOT_READY;</div>
<div class="line">    dev-&gt;remove = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find a suitable lcore to add the device. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].lcore_ll-&gt;device_num &lt; device_num_min) {</div>
<div class="line">            device_num_min = lcore_info[lcore].lcore_ll-&gt;device_num;</div>
<div class="line">            core_add = lcore;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Add device to lcore ll */</span></div>
<div class="line">    ll_dev-&gt;dev-&gt;coreid = core_add;</div>
<div class="line">    ll_dev = get_data_ll_free_entry(&amp;lcore_info[ll_dev-&gt;dev-&gt;coreid].lcore_ll-&gt;ll_root_free);</div>
<div class="line">    <span class="keywordflow">if</span> (ll_dev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Failed to add device to data core\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>);</div>
<div class="line">        destroy_device(dev);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ll_dev-&gt;dev = dev;</div>
<div class="line">    add_data_ll_entry(&amp;lcore_info[ll_dev-&gt;dev-&gt;coreid].lcore_ll-&gt;ll_root_used, ll_dev);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics[dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>], 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> device_statistics));</div>
<div class="line"></div>
<div class="line">    lcore_info[ll_dev-&gt;dev-&gt;coreid].lcore_ll-&gt;device_num++;</div>
<div class="line">    dev-&gt;<a class="code" href="structvirtio__net.html#a773b39d480759f67926cb18ae2219281">flags</a> |= VIRTIO_DEV_RUNNING;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;(%&quot;</span>PRIu64<span class="stringliteral">&quot;) Device has been added to data core %d\n&quot;</span>, dev-&gt;<a class="code" href="structvirtio__net.html#a4efa26479ebe2bb358366ef6de84a54a">device_fh</a>, dev-&gt;coreid);</div>
<div class="line"></div>
<div class="line">    link_vmdq(dev);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * These callback allow devices to be added to the data core when configuration</span></div>
<div class="line"><span class="comment"> * has been fully complete.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a69"></a><a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> <a class="code" href="structvirtio__net__device__ops.html">virtio_net_device_ops</a> =</div>
<div class="line">{</div>
<div class="line">    .<a name="a70"></a><a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a> =  <a class="code" href="structvirtio__net__device__ops.html#a25d4cfb5322fe3bd258584bf66d72373">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a71"></a><a class="code" href="structvirtio__net__device__ops.html#a1eb7d99f01386abe9b892985d778eabd">destroy_device</a>,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This is a thread will wake up after a period to print stats if the user has</span></div>
<div class="line"><span class="comment"> * enabled them.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtio_net_data_ll *dev_ll;</div>
<div class="line">    uint64_t tx_dropped, rx_dropped;</div>
<div class="line">    uint64_t tx, tx_total, rx, rx_total;</div>
<div class="line">    uint32_t device_fh;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> top_left[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>,<span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        sleep(enable_stats);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;%s%s&quot;</span>, clr, top_left);</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;\nDevice statistics ====================================&quot;</span>);</div>
<div class="line"></div>
<div class="line">        dev_ll = ll_root_used;</div>
<div class="line">        <span class="keywordflow">while</span> (dev_ll != NULL) {</div>
<div class="line">            device_fh = (uint32_t)dev_ll-&gt;dev-&gt;device_fh;</div>
<div class="line">            tx_total = dev_statistics[device_fh].tx_total;</div>
<div class="line">            tx = dev_statistics[device_fh].tx;</div>
<div class="line">            tx_dropped = tx_total - tx;</div>
<div class="line">            rx_total = <a name="a72"></a><a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;dev_statistics[device_fh].rx_total);</div>
<div class="line">            rx = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;dev_statistics[device_fh].rx);</div>
<div class="line">            rx_dropped = rx_total - rx;</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;\nStatistics for device %&quot;</span>PRIu32<span class="stringliteral">&quot; ------------------------------&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nTX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX total:        %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX dropped:      %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;\nRX successful:       %&quot;</span>PRIu64<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    device_fh,</div>
<div class="line">                    tx_total,</div>
<div class="line">                    tx_dropped,</div>
<div class="line">                    tx,</div>
<div class="line">                    rx_total,</div>
<div class="line">                    rx_dropped,</div>
<div class="line">                    rx);</div>
<div class="line"></div>
<div class="line">            dev_ll = dev_ll-&gt;next;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n======================================================\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> init_virtio_net(<span class="keyword">struct</span> virtio_net_device_ops <span class="keyword">const</span> * <span class="keyword">const</span> ops);</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main function, does initialisation and calls the per-lcore functions. The CUSE</span></div>
<div class="line"><span class="comment"> * device is also registered here to handle the IOCTLs.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id, core_id = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports, valid_num_ports;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keyword">static</span> pthread_t tid;</div>
<div class="line">    <span class="keywordtype">char</span> thread_name[RTE_MAX_THREAD_NAME_LEN];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a73"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a74"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse app arguments */</span></div>
<div class="line">    ret = us_vhost_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid argument\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id ++)</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a75"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            lcore_ids[core_id ++] = lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>() &gt; RTE_MAX_LCORE)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,<span class="stringliteral">&quot;Not enough cores\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*set the number of swithcing cores available*/</span></div>
<div class="line">    num_switching_cores = <a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>()-1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the number of physical ports. */</span></div>
<div class="line">    nb_ports = <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        nb_ports = RTE_MAX_ETHPORTS;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Update the global var NUM_PORTS and global array PORTS</span></div>
<div class="line"><span class="comment">     * and get value of var VALID_NUM_PORTS according to system ports number</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    valid_num_ports = check_ports_num(nb_ports);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((valid_num_ports ==  0) || (valid_num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create the mbuf pool. */</span></div>
<div class="line">    mbuf_pool = <a name="a76"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;MBUF_POOL&quot;</span>,</div>
<div class="line">        NUM_MBUFS_PER_PORT * valid_num_ports, MBUF_CACHE_SIZE, 0,</div>
<div class="line">        RTE_MBUF_DEFAULT_BUF_SIZE, <a name="a77"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set log level. */</span></div>
<div class="line">    <a name="a78"></a><a class="code" href="rte__log_8h.html#a621efed26cc11c49517acfdd19f0a82f">rte_set_log_level</a>(LOG_LEVEL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Skipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (port_init(portid, mbuf_pool) != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot initialize network ports\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise all linked lists. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init_data_ll() == -1)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Failed to initialize linked list\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device stats */</span></div>
<div class="line">    memset(&amp;dev_statistics, 0, <span class="keyword">sizeof</span>(dev_statistics));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable stats if the user option is set. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        ret = pthread_create(&amp;tid, NULL, (<span class="keywordtype">void</span> *)print_stats, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot create print-stats thread\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Set thread_name for aid in debugging. */</span></div>
<div class="line">        snprintf(thread_name, RTE_MAX_THREAD_NAME_LEN, <span class="stringliteral">&quot;print-xen-stats&quot;</span>);</div>
<div class="line">        ret = <a name="a79"></a><a class="code" href="rte__lcore_8h.html#ac33f55612c0a95f6066e3fdc5886bfed">rte_thread_setname</a>(tid, thread_name);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot set print-stats name\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Launch all data cores. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">        <a name="a80"></a><a class="code" href="rte__launch_8h.html#a7456c48bfd011b04cc1c17baac5aa058">rte_eal_remote_launch</a>(switch_worker, mbuf_pool, lcore_id);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    init_virtio_xen(&amp;virtio_net_device_ops);</div>
<div class="line"></div>
<div class="line">    virtio_monitor_loop();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
