<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vm_power_manager/channel_manager.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vm_power_manager/channel_manager.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/un.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/select.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__spinlock_8h.html">rte_spinlock.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;libvirt/libvirt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;channel_manager.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;channel_commands.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;channel_monitor.h&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_CHANNEL_MANAGER RTE_LOGTYPE_USER1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define ITERATIVE_BITMASK_CHECK_64(mask_u64b, i) \</span></div>
<div class="line"><span class="preprocessor">        for (i = 0; mask_u64b; mask_u64b &amp;= ~(1ULL &lt;&lt; i++)) \</span></div>
<div class="line"><span class="preprocessor">        if ((mask_u64b &gt;&gt; i) &amp; 1) \</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/* Global pointer to libvirt connection */</span></div>
<div class="line"><span class="keyword">static</span> virConnectPtr global_vir_conn_ptr;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *global_cpumaps;</div>
<div class="line"><span class="keyword">static</span> virVcpuInfo *global_vircpuinfo;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> global_maplen;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> global_n_host_cpus;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Represents a single Virtual Machine</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>virtual_machine_info {</div>
<div class="line">    <span class="keywordtype">char</span> name[CHANNEL_MGR_MAX_NAME_LEN];</div>
<div class="line">    <a name="_a0"></a><a class="code" href="structrte__atomic64__t.html">rte_atomic64_t</a> pcpu_mask[CHANNEL_CMDS_MAX_CPUS];</div>
<div class="line">    <span class="keyword">struct </span>channel_info *channels[CHANNEL_CMDS_MAX_VM_CHANNELS];</div>
<div class="line">    uint64_t channel_mask;</div>
<div class="line">    uint8_t num_channels;</div>
<div class="line">    <span class="keyword">enum</span> vm_status status;</div>
<div class="line">    virDomainPtr domainPtr;</div>
<div class="line">    virDomainInfo info;</div>
<div class="line">    <a name="_a1"></a><a class="code" href="structrte__spinlock__t.html">rte_spinlock_t</a> config_spinlock;</div>
<div class="line">    LIST_ENTRY(virtual_machine_info) vms_info;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">LIST_HEAD(, virtual_machine_info) vm_list_head;</div>
<div class="line"></div>
<div class="line">static struct virtual_machine_info *</div>
<div class="line">find_domain_by_name(const <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *info;</div>
<div class="line">    LIST_FOREACH(info, &amp;vm_list_head, vms_info) {</div>
<div class="line">        <span class="keywordflow">if</span> (!strncmp(info-&gt;name, name, CHANNEL_MGR_MAX_NAME_LEN-1))</div>
<div class="line">            <span class="keywordflow">return</span> info;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">update_pcpus_mask(<span class="keyword">struct</span> virtual_machine_info *vm_info)</div>
<div class="line">{</div>
<div class="line">    virVcpuInfoPtr cpuinfo;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, j;</div>
<div class="line">    <span class="keywordtype">int</span> n_vcpus;</div>
<div class="line">    uint64_t mask;</div>
<div class="line"></div>
<div class="line">    memset(global_cpumaps, 0, CHANNEL_CMDS_MAX_CPUS*global_maplen);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        n_vcpus = virDomainGetVcpuPinInfo(vm_info-&gt;domainPtr,</div>
<div class="line">                vm_info-&gt;info.nrVirtCpu, global_cpumaps, global_maplen,</div>
<div class="line">                VIR_DOMAIN_AFFECT_CONFIG);</div>
<div class="line">        <span class="keywordflow">if</span> (n_vcpus &lt; 0) {</div>
<div class="line">            <a name="a2"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting vCPU info for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;in-active VM &#39;%s&#39;\n&quot;</span>, vm_info-&gt;name);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">goto</span> update_pcpus;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    memset(global_vircpuinfo, 0, <span class="keyword">sizeof</span>(*global_vircpuinfo)*</div>
<div class="line">            CHANNEL_CMDS_MAX_CPUS);</div>
<div class="line"></div>
<div class="line">    cpuinfo = global_vircpuinfo;</div>
<div class="line"></div>
<div class="line">    n_vcpus = virDomainGetVcpus(vm_info-&gt;domainPtr, cpuinfo,</div>
<div class="line">            CHANNEL_CMDS_MAX_CPUS, global_cpumaps, global_maplen);</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting vCPU info for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;active VM &#39;%s&#39;\n&quot;</span>, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">update_pcpus:</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus &gt;= CHANNEL_CMDS_MAX_CPUS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Number of vCPUS(%u) is out of range &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;0...%d\n&quot;</span>, n_vcpus, CHANNEL_CMDS_MAX_CPUS-1);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus != vm_info-&gt;info.nrVirtCpu) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Updating the number of vCPUs for VM &#39;%s&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; from %d -&gt; %d\n&quot;</span>, vm_info-&gt;name, vm_info-&gt;info.nrVirtCpu,</div>
<div class="line">                n_vcpus);</div>
<div class="line">        vm_info-&gt;info.nrVirtCpu = n_vcpus;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; vm_info-&gt;info.nrVirtCpu; i++) {</div>
<div class="line">        mask = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; global_n_host_cpus; j++) {</div>
<div class="line">            <span class="keywordflow">if</span> (VIR_CPU_USABLE(global_cpumaps, global_maplen, i, j) &gt; 0) {</div>
<div class="line">                mask |= 1ULL &lt;&lt; j;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <a name="a3"></a><a class="code" href="rte__atomic_8h.html#ab708e84e61d19fc13ed9f7047b42da37">rte_atomic64_set</a>(&amp;vm_info-&gt;pcpu_mask[i], mask);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_pcpus_mask(<span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> vcpu, uint64_t core_mask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i = 0;</div>
<div class="line">    <span class="keywordtype">int</span> flags = VIR_DOMAIN_AFFECT_LIVE|VIR_DOMAIN_AFFECT_CONFIG;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    uint64_t mask = core_mask;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vcpu &gt;= CHANNEL_CMDS_MAX_CPUS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;vCPU(%u) exceeds max allowable(%d)\n&quot;</span>,</div>
<div class="line">                vcpu, CHANNEL_CMDS_MAX_CPUS-1);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to set vCPU(%u) to pCPU &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;mask(0x%&quot;</span>PRIx64<span class="stringliteral">&quot;) for VM &#39;%s&#39;, VM is not active\n&quot;</span>,</div>
<div class="line">                vcpu, core_mask, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vcpu &gt;= vm_info-&gt;info.nrVirtCpu) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;vCPU(%u) exceeds the assigned number of &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;vCPUs(%u)\n&quot;</span>, vcpu, vm_info-&gt;info.nrVirtCpu);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    memset(global_cpumaps, 0 , CHANNEL_CMDS_MAX_CPUS * global_maplen);</div>
<div class="line">    ITERATIVE_BITMASK_CHECK_64(mask, i) {</div>
<div class="line">        VIR_USE_CPU(global_cpumaps, i);</div>
<div class="line">        <span class="keywordflow">if</span> (i &gt;= global_n_host_cpus) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;CPU(%u) exceeds the available &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;number of CPUs(%u)\n&quot;</span>, i, global_n_host_cpus);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (virDomainPinVcpuFlags(vm_info-&gt;domainPtr, vcpu, global_cpumaps,</div>
<div class="line">            global_maplen, flags) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to set vCPU(%u) to pCPU &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;mask(0x%&quot;</span>PRIx64<span class="stringliteral">&quot;) for VM &#39;%s&#39;\n&quot;</span>, vcpu, core_mask,</div>
<div class="line">                vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#ab708e84e61d19fc13ed9f7047b42da37">rte_atomic64_set</a>(&amp;vm_info-&gt;pcpu_mask[vcpu], core_mask);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_pcpu(<span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> vcpu, <span class="keywordtype">unsigned</span> core_num)</div>
<div class="line">{</div>
<div class="line">    uint64_t mask = 1ULL &lt;&lt; core_num;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> set_pcpus_mask(vm_name, vcpu, mask);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint64_t</div>
<div class="line">get_pcpus_mask(<span class="keyword">struct</span> channel_info *chan_info, <span class="keywordtype">unsigned</span> vcpu)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info =</div>
<div class="line">            (<span class="keyword">struct </span>virtual_machine_info *)chan_info-&gt;priv_info;</div>
<div class="line">    <span class="keywordflow">return</span> <a name="a4"></a><a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;vm_info-&gt;pcpu_mask[vcpu]);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">channel_exists(<span class="keyword">struct</span> virtual_machine_info *vm_info, <span class="keywordtype">unsigned</span> channel_num)</div>
<div class="line">{</div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info-&gt;channel_mask &amp; (1ULL &lt;&lt; channel_num)) {</div>
<div class="line">        <a name="a6"></a><a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">open_non_blocking_channel(<span class="keyword">struct</span> channel_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret, flags;</div>
<div class="line">    <span class="keyword">struct </span>sockaddr_un sock_addr;</div>
<div class="line">    fd_set soc_fd_set;</div>
<div class="line">    <span class="keyword">struct </span>timeval tv;</div>
<div class="line"></div>
<div class="line">    info-&gt;fd = socket(AF_UNIX, SOCK_STREAM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (info-&gt;fd == -1) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) creating socket for &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                strerror(errno),</div>
<div class="line">                info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    sock_addr.sun_family = AF_UNIX;</div>
<div class="line">    memcpy(&amp;sock_addr.sun_path, info-&gt;channel_path,</div>
<div class="line">            strlen(info-&gt;channel_path)+1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get current flags */</span></div>
<div class="line">    flags = fcntl(info-&gt;fd, F_GETFL, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (flags &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) fcntl get flags socket for&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Set to Non Blocking */</span></div>
<div class="line">    flags |= O_NONBLOCK;</div>
<div class="line">    <span class="keywordflow">if</span> (fcntl(info-&gt;fd, F_SETFL, flags) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) setting non-blocking &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;socket for &#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ret = connect(info-&gt;fd, (<span class="keyword">struct</span> sockaddr *)&amp;sock_addr,</div>
<div class="line">            <span class="keyword">sizeof</span>(sock_addr));</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        <span class="comment">/* ECONNREFUSED error is given when VM is not active */</span></div>
<div class="line">        <span class="keywordflow">if</span> (errno == ECONNREFUSED) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM is not active or has not &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;activated its endpoint to channel %s\n&quot;</span>,</div>
<div class="line">                    info-&gt;channel_path);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Wait for tv_sec if in progress */</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EINPROGRESS) {</div>
<div class="line">            tv.tv_sec = 2;</div>
<div class="line">            tv.tv_usec = 0;</div>
<div class="line">            FD_ZERO(&amp;soc_fd_set);</div>
<div class="line">            FD_SET(info-&gt;fd, &amp;soc_fd_set);</div>
<div class="line">            <span class="keywordflow">if</span> (select(info-&gt;fd+1, NULL, &amp;soc_fd_set, NULL, &amp;tv) &gt; 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Timeout or error on channel &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>, info-&gt;channel_path);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* Any other error */</span></div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) connecting socket&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot; for &#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_channel_info(<span class="keyword">struct</span> virtual_machine_info **vm_info_dptr,</div>
<div class="line">        <span class="keyword">struct</span> channel_info **chan_info_dptr, <span class="keywordtype">unsigned</span> channel_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info = *chan_info_dptr;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info = *vm_info_dptr;</div>
<div class="line"></div>
<div class="line">    chan_info-&gt;channel_num = channel_num;</div>
<div class="line">    chan_info-&gt;priv_info = (<span class="keywordtype">void</span> *)vm_info;</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_DISCONNECTED;</div>
<div class="line">    <span class="keywordflow">if</span> (open_non_blocking_channel(chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could not open channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39; for VM &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (add_channel_to_monitor(&amp;chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could add channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39; to epoll ctl for VM &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;num_channels++;</div>
<div class="line">    vm_info-&gt;channel_mask |= 1ULL &lt;&lt; channel_num;</div>
<div class="line">    vm_info-&gt;channels[channel_num] = chan_info;</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_CONNECTED;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_all_channels(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    DIR *d;</div>
<div class="line">    <span class="keyword">struct </span>dirent *dir;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info;</div>
<div class="line">    <span class="keywordtype">char</span> *token, *remaining, *tail_ptr;</div>
<div class="line">    <span class="keywordtype">char</span> socket_name[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">unsigned</span> channel_num;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_enabled = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* verify VM exists */</span></div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; not found&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; during channel discovery\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; is not active\n&quot;</span>, vm_name);</div>
<div class="line">        vm_info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    d = opendir(CHANNEL_MGR_SOCKET_PATH);</div>
<div class="line">    <span class="keywordflow">if</span> (d == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error opening directory &#39;%s&#39;: %s\n&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, strerror(errno));</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> ((dir = readdir(d)) != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (!strncmp(dir-&gt;d_name, <span class="stringliteral">&quot;.&quot;</span>, 1) ||</div>
<div class="line">                !strncmp(dir-&gt;d_name, <span class="stringliteral">&quot;..&quot;</span>, 2))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        snprintf(socket_name, <span class="keyword">sizeof</span>(socket_name), <span class="stringliteral">&quot;%s&quot;</span>, dir-&gt;d_name);</div>
<div class="line">        remaining = socket_name;</div>
<div class="line">        <span class="comment">/* Extract vm_name from &quot;&lt;vm_name&gt;.&lt;channel_num&gt;&quot; */</span></div>
<div class="line">        token = strsep(&amp;remaining, <span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (remaining == NULL)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(vm_name, token, CHANNEL_MGR_MAX_NAME_LEN))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* remaining should contain only &lt;channel_num&gt; */</span></div>
<div class="line">        errno = 0;</div>
<div class="line">        channel_num = (unsigned)strtol(remaining, &amp;tail_ptr, 0);</div>
<div class="line">        <span class="keywordflow">if</span> ((errno != 0) || (remaining[0] == <span class="charliteral">&#39;\0&#39;</span>) ||</div>
<div class="line">                tail_ptr == NULL || (*tail_ptr != <span class="charliteral">&#39;\0&#39;</span>)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Malformed channel name&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;%s&#39; found it should be in the form of &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;&lt;guest_name&gt;.&lt;channel_num&gt;(decimal)&#39;\n&quot;</span>,</div>
<div class="line">                    dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (channel_num &gt;= CHANNEL_CMDS_MAX_VM_CHANNELS) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel number(%u) is &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;greater than max allowable: %d, skipping &#39;%s%s&#39;\n&quot;</span>,</div>
<div class="line">                    channel_num, CHANNEL_CMDS_MAX_VM_CHANNELS-1,</div>
<div class="line">                    CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* if channel has not been added previously */</span></div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_num))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        chan_info = <a name="a7"></a><a class="code" href="rte__malloc_8h.html#afb7316a4ec228ed9b8ffc1864b03d85b">rte_malloc</a>(NULL, <span class="keyword">sizeof</span>(*chan_info),</div>
<div class="line">                RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (chan_info == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;channel &#39;%s%s&#39;\n&quot;</span>, CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        snprintf(chan_info-&gt;channel_path,</div>
<div class="line">                <span class="keyword">sizeof</span>(chan_info-&gt;channel_path), <span class="stringliteral">&quot;%s%s&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (setup_channel_info(&amp;vm_info, &amp;chan_info, channel_num) &lt; 0) {</div>
<div class="line">            <a name="a8"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(chan_info);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        num_channels_enabled++;</div>
<div class="line">    }</div>
<div class="line">    closedir(d);</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_enabled;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_channels(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> *channel_list,</div>
<div class="line">        <span class="keywordtype">unsigned</span> len_channel_list)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info;</div>
<div class="line">    <span class="keywordtype">char</span> socket_path[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_enabled = 0;</div>
<div class="line"></div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; is not active\n&quot;</span>, vm_name);</div>
<div class="line">        vm_info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; len_channel_list; i++) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (channel_list[i] &gt;= CHANNEL_CMDS_MAX_VM_CHANNELS) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel(%u) is out of range &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;0...%d\n&quot;</span>, channel_list[i],</div>
<div class="line">                            CHANNEL_CMDS_MAX_VM_CHANNELS-1);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_list[i])) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel already exists, skipping  &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;%s.%u&#39;\n&quot;</span>, vm_name, i);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        snprintf(socket_path, <span class="keyword">sizeof</span>(socket_path), <span class="stringliteral">&quot;%s%s.%u&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, vm_name, channel_list[i]);</div>
<div class="line">        errno = 0;</div>
<div class="line">        <span class="keywordflow">if</span> (access(socket_path, F_OK) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel path &#39;%s&#39; error: &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;%s\n&quot;</span>, socket_path, strerror(errno));</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        chan_info = <a class="code" href="rte__malloc_8h.html#afb7316a4ec228ed9b8ffc1864b03d85b">rte_malloc</a>(NULL, <span class="keyword">sizeof</span>(*chan_info),</div>
<div class="line">                RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (chan_info == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;channel &#39;%s&#39;\n&quot;</span>, socket_path);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        snprintf(chan_info-&gt;channel_path,</div>
<div class="line">                <span class="keyword">sizeof</span>(chan_info-&gt;channel_path), <span class="stringliteral">&quot;%s%s.%u&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, vm_name, channel_list[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (setup_channel_info(&amp;vm_info, &amp;chan_info, channel_list[i]) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(chan_info);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        num_channels_enabled++;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_enabled;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">remove_channel(<span class="keyword">struct</span> channel_info **chan_info_dptr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info = *chan_info_dptr;</div>
<div class="line"></div>
<div class="line">    close(chan_info-&gt;fd);</div>
<div class="line"></div>
<div class="line">    vm_info = (<span class="keyword">struct </span>virtual_machine_info *)chan_info-&gt;priv_info;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;channel_mask &amp;= ~(1ULL &lt;&lt; chan_info-&gt;channel_num);</div>
<div class="line">    vm_info-&gt;num_channels--;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(chan_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_channel_status_all(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keyword">enum</span> channel_status status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    uint64_t mask;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_changed = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!(status == CHANNEL_MGR_CHANNEL_CONNECTED ||</div>
<div class="line">            status == CHANNEL_MGR_CHANNEL_DISABLED)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channels can only be enabled or &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;disabled: Unable to change status for VM &#39;%s&#39;\n&quot;</span>, vm_name);</div>
<div class="line">    }</div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to disable channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    mask = vm_info-&gt;channel_mask;</div>
<div class="line">    ITERATIVE_BITMASK_CHECK_64(mask, i) {</div>
<div class="line">        vm_info-&gt;channels[i]-&gt;status = status;</div>
<div class="line">        num_channels_changed++;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_changed;</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_channel_status(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> *channel_list,</div>
<div class="line">        <span class="keywordtype">unsigned</span> len_channel_list, <span class="keyword">enum</span> channel_status status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_changed = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!(status == CHANNEL_MGR_CHANNEL_CONNECTED ||</div>
<div class="line">            status == CHANNEL_MGR_CHANNEL_DISABLED)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channels can only be enabled or &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;disabled: Unable to change status for VM &#39;%s&#39;\n&quot;</span>, vm_name);</div>
<div class="line">    }</div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; len_channel_list; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_list[i])) {</div>
<div class="line">            <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">            vm_info-&gt;channels[channel_list[i]]-&gt;status = status;</div>
<div class="line">            <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">            num_channels_changed++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_changed;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">get_info_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keyword">struct</span> vm_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, channel_num = 0;</div>
<div class="line">    uint64_t mask;</div>
<div class="line"></div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    info-&gt;status = CHANNEL_MGR_VM_ACTIVE;</div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr))</div>
<div class="line">        info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"></div>
<div class="line">    mask = vm_info-&gt;channel_mask;</div>
<div class="line">    ITERATIVE_BITMASK_CHECK_64(mask, i) {</div>
<div class="line">        info-&gt;channels[channel_num].channel_num = i;</div>
<div class="line">        memcpy(info-&gt;channels[channel_num].channel_path,</div>
<div class="line">                vm_info-&gt;channels[i]-&gt;channel_path, UNIX_PATH_MAX);</div>
<div class="line">        info-&gt;channels[channel_num].status = vm_info-&gt;channels[i]-&gt;status;</div>
<div class="line">        info-&gt;channels[channel_num].fd = vm_info-&gt;channels[i]-&gt;fd;</div>
<div class="line">        channel_num++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    info-&gt;num_channels = channel_num;</div>
<div class="line">    info-&gt;num_vcpus = vm_info-&gt;info.nrVirtCpu;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"></div>
<div class="line">    memcpy(info-&gt;name, vm_info-&gt;name, <span class="keyword">sizeof</span>(vm_info-&gt;name));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; info-&gt;num_vcpus; i++) {</div>
<div class="line">        info-&gt;pcpu_mask[i] = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;vm_info-&gt;pcpu_mask[i]);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *new_domain;</div>
<div class="line">    virDomainPtr dom_ptr;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (find_domain_by_name(vm_name) != NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add VM: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already exists\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;No connection to hypervisor exists\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    dom_ptr = virDomainLookupByName(global_vir_conn_ptr, vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (dom_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error on VM lookup with libvirt: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    new_domain = <a class="code" href="rte__malloc_8h.html#afb7316a4ec228ed9b8ffc1864b03d85b">rte_malloc</a>(<span class="stringliteral">&quot;virtual_machine_info&quot;</span>, <span class="keyword">sizeof</span>(*new_domain),</div>
<div class="line">            RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (new_domain == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to allocate memory for VM &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    new_domain-&gt;domainPtr = dom_ptr;</div>
<div class="line">    <span class="keywordflow">if</span> (virDomainGetInfo(new_domain-&gt;domainPtr, &amp;new_domain-&gt;info) != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to get libvirt VM info\n&quot;</span>);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (new_domain-&gt;info.nrVirtCpu &gt; CHANNEL_CMDS_MAX_CPUS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error the number of virtual CPUs(%u) is &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;greater than allowable(%d)\n&quot;</span>, new_domain-&gt;info.nrVirtCpu,</div>
<div class="line">                CHANNEL_CMDS_MAX_CPUS);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; CHANNEL_CMDS_MAX_CPUS; i++) {</div>
<div class="line">        <a name="a9"></a><a class="code" href="rte__atomic_8h.html#ad9de295b330d870b6acae34c9968bc0c">rte_atomic64_init</a>(&amp;new_domain-&gt;pcpu_mask[i]);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (update_pcpus_mask(new_domain) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting physical CPU pinning\n&quot;</span>);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    strncpy(new_domain-&gt;name, vm_name, <span class="keyword">sizeof</span>(new_domain-&gt;name));</div>
<div class="line">    new_domain-&gt;channel_mask = 0;</div>
<div class="line">    new_domain-&gt;num_channels = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(dom_ptr))</div>
<div class="line">        new_domain-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        new_domain-&gt;status = CHANNEL_MGR_VM_ACTIVE;</div>
<div class="line"></div>
<div class="line">    <a name="a10"></a><a class="code" href="rte__spinlock_8h.html#af3ff11ac862ee94491533486fc0d959c">rte_spinlock_init</a>(&amp;(new_domain-&gt;config_spinlock));</div>
<div class="line">    LIST_INSERT_HEAD(&amp;vm_list_head, new_domain, vms_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">remove_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info = find_domain_by_name(vm_name);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to remove VM: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info-&gt;num_channels != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to remove VM &#39;%s&#39;, there are &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;%&quot;</span>PRId8<span class="stringliteral">&quot; channels still active\n&quot;</span>,</div>
<div class="line">                vm_name, vm_info-&gt;num_channels);</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    LIST_REMOVE(vm_info, vms_info);</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vm_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">disconnect_hypervisor(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr != NULL) {</div>
<div class="line">        virConnectClose(global_vir_conn_ptr);</div>
<div class="line">        global_vir_conn_ptr = NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">connect_hypervisor(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr != NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error connecting to %s, connection &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already established\n&quot;</span>, path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    global_vir_conn_ptr = virConnectOpen(path);</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error failed to open connection to &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;Hypervisor &#39;%s&#39;\n&quot;</span>, path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">channel_manager_init(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div>
<div class="line">{</div>
<div class="line">    virNodeInfo info;</div>
<div class="line"></div>
<div class="line">    LIST_INIT(&amp;vm_list_head);</div>
<div class="line">    <span class="keywordflow">if</span> (connect_hypervisor(path) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to initialize channel manager\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    global_maplen = VIR_CPU_MAPLEN(CHANNEL_CMDS_MAX_CPUS);</div>
<div class="line"></div>
<div class="line">    global_vircpuinfo = <a name="a11"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(NULL, <span class="keyword">sizeof</span>(*global_vircpuinfo) *</div>
<div class="line">            CHANNEL_CMDS_MAX_CPUS, RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (global_vircpuinfo == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for CPU Info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> error;</div>
<div class="line">    }</div>
<div class="line">    global_cpumaps = <a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(NULL, CHANNEL_CMDS_MAX_CPUS * global_maplen,</div>
<div class="line">            RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (global_cpumaps == NULL) {</div>
<div class="line">        <span class="keywordflow">goto</span> error;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (virNodeGetInfo(global_vir_conn_ptr, &amp;info)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to retrieve node Info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> error;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    global_n_host_cpus = (unsigned)info.cpus;</div>
<div class="line"></div>
<div class="line">    if (global_n_host_cpus &gt; CHANNEL_CMDS_MAX_CPUS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;The number of host CPUs(%u) exceeds the &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;maximum of %u. No cores over %u should be used.\n&quot;</span>,</div>
<div class="line">                global_n_host_cpus, CHANNEL_CMDS_MAX_CPUS,</div>
<div class="line">                CHANNEL_CMDS_MAX_CPUS - 1);</div>
<div class="line">        global_n_host_cpus = CHANNEL_CMDS_MAX_CPUS;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">error:</div>
<div class="line">    disconnect_hypervisor();</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">channel_manager_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    uint64_t mask;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line"></div>
<div class="line">    LIST_FOREACH(vm_info, &amp;vm_list_head, vms_info) {</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"></div>
<div class="line">        mask = vm_info-&gt;channel_mask;</div>
<div class="line">        ITERATIVE_BITMASK_CHECK_64(mask, i) {</div>
<div class="line">            remove_channel_from_monitor(vm_info-&gt;channels[i]);</div>
<div class="line">            close(vm_info-&gt;channels[i]-&gt;fd);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vm_info-&gt;channels[i]);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"></div>
<div class="line">        LIST_REMOVE(vm_info, vms_info);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(vm_info);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(global_cpumaps);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(global_vircpuinfo);</div>
<div class="line">    disconnect_hypervisor();</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
