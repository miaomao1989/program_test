<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: performance-thread/l3fwd-thread/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">performance-thread/l3fwd-thread/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;rte_vect.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__prefetch_8h.html">rte_prefetch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__random_8h.html">rte_random.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__udp_8h.html">rte_udp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_etheraddr.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;lthread_api.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define APP_LOOKUP_EXACT_MATCH          0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_LOOKUP_LPM                  1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Enable cpu-load stats 0-off, 1-on */</span></div>
<div class="line"><span class="preprocessor">#define APP_CPU_LOAD                 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_LOOKUP_METHOD</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_LOOKUP_METHOD             APP_LOOKUP_LPM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  When set to zero, simple forwaring path is eanbled.</span></div>
<div class="line"><span class="comment"> *  When set to one, optimized forwarding path is enabled.</span></div>
<div class="line"><span class="comment"> *  Note that LPM optimisation path uses SSE4.1 instructions.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_LPM) &amp;&amp; !defined(__SSE4_1__))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ENABLE_MULTI_BUFFER_OPTIMIZE    0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ENABLE_MULTI_BUFFER_OPTIMIZE    1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="rte__hash_8h.html">rte_hash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#elif (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="rte__lpm_8h.html">rte_lpm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lpm6_8h.html">rte_lpm6.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#error &quot;APP_LOOKUP_METHOD set to incorrect value&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_L3FWD RTE_LOGTYPE_USER1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_JUMBO_PKT_LEN  9600</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IPV6_ADDR_LEN 16</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MEMPOOL_CACHE_SIZE 256</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This expression is used to calculate the number of mbufs needed depending on</span></div>
<div class="line"><span class="comment"> * user input, taking into account memory for rx and tx hardware rings, cache</span></div>
<div class="line"><span class="comment"> * per lcore and mtable per port per lcore. RTE_MAX is used to ensure that</span></div>
<div class="line"><span class="comment"> * NB_MBUF never goes below a minimum value of 8192</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define NB_MBUF RTE_MAX(\</span></div>
<div class="line"><span class="preprocessor">        (nb_ports*nb_rx_queue*RTE_TEST_RX_DESC_DEFAULT +       \</span></div>
<div class="line"><span class="preprocessor">        nb_ports*nb_lcores*MAX_PKT_BURST +                     \</span></div>
<div class="line"><span class="preprocessor">        nb_ports*n_tx_queue*RTE_TEST_TX_DESC_DEFAULT +         \</span></div>
<div class="line"><span class="preprocessor">        nb_lcores*MEMPOOL_CACHE_SIZE),                         \</span></div>
<div class="line"><span class="preprocessor">        (unsigned)8192)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_PKT_BURST     32</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_TX_DRAIN_US 100 </span><span class="comment">/* TX drain every ~100us */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Try to avoid TX buffering if we have at least MAX_TX_BURST packets to send.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define MAX_TX_BURST  (MAX_PKT_BURST / 2)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BURST_SIZE    MAX_TX_BURST</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define NB_SOCKETS 8</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Configure how many packets ahead to prefetch, when reading packets */</span></div>
<div class="line"><span class="preprocessor">#define PREFETCH_OFFSET 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Used to mark destination port as &#39;invalid&#39;. */</span></div>
<div class="line"><span class="preprocessor">#define BAD_PORT    ((uint16_t)-1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define FWDSTEP 4</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Configurable number of RX/TX ring descriptors</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> uint16_t nb_rxd = RTE_TEST_RX_DESC_DEFAULT;</div>
<div class="line"><span class="keyword">static</span> uint16_t nb_txd = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">static</span> uint64_t dest_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structether__addr.html">ether_addr</a> ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> __m128i val_eth[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* replace first 12B of the ethernet header. */</span></div>
<div class="line"><span class="preprocessor">#define MASK_ETH 0x3f</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> promiscuous_on; </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> numa_on = 1;    </div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> ipv6;           </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD == 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_CPU RTE_MAX_LCORE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CPU_LOAD_TIMEOUT_US (5 * 1000 * 1000)  </span></div>
<div class="line"><span class="preprocessor">#define CPU_PROCESS     0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CPU_POLL        1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CPU_COUNTER 2</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>cpu_load {</div>
<div class="line">    uint16_t       n_cpu;</div>
<div class="line">    uint64_t       counter;</div>
<div class="line">    uint64_t       hits[MAX_CPU_COUNTER][MAX_CPU];</div>
<div class="line">} <a name="a1"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>cpu_load cpu_load;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> cpu_load_lcore_id = -1;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define SET_CPU_BUSY(thread, counter) \</span></div>
<div class="line"><span class="preprocessor">        thread-&gt;conf.busy[counter] = 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define SET_CPU_IDLE(thread, counter) \</span></div>
<div class="line"><span class="preprocessor">        thread-&gt;conf.busy[counter] = 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IS_CPU_BUSY(thread, counter) \</span></div>
<div class="line"><span class="preprocessor">        (thread-&gt;conf.busy[counter] &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define SET_CPU_BUSY(thread, counter)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SET_CPU_IDLE(thread, counter)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IS_CPU_BUSY(thread, counter) 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table {</div>
<div class="line">    uint16_t len;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_table[MAX_PKT_BURST];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>lcore_rx_queue {</div>
<div class="line">    uint8_t port_id;</div>
<div class="line">    uint8_t queue_id;</div>
<div class="line">} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_RX_QUEUE_PER_LCORE 16</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_TX_QUEUE_PER_PORT  RTE_MAX_ETHPORTS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_RX_QUEUE_PER_PORT  128</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_LCORE_PARAMS       1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">struct </span>rx_thread_params {</div>
<div class="line">    uint8_t port_id;</div>
<div class="line">    uint8_t queue_id;</div>
<div class="line">    uint8_t lcore_id;</div>
<div class="line">    uint8_t thread_id;</div>
<div class="line">} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rx_thread_params rx_thread_params_array[MAX_LCORE_PARAMS];</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rx_thread_params rx_thread_params_array_default[] = {</div>
<div class="line">    {0, 0, 2, 0},</div>
<div class="line">    {0, 1, 2, 1},</div>
<div class="line">    {0, 2, 2, 2},</div>
<div class="line">    {1, 0, 2, 3},</div>
<div class="line">    {1, 1, 2, 4},</div>
<div class="line">    {1, 2, 2, 5},</div>
<div class="line">    {2, 0, 2, 6},</div>
<div class="line">    {3, 0, 3, 7},</div>
<div class="line">    {3, 1, 3, 8},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rx_thread_params *rx_thread_params =</div>
<div class="line">        rx_thread_params_array_default;</div>
<div class="line"><span class="keyword">static</span> uint16_t nb_rx_thread_params = <a name="a3"></a><a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(rx_thread_params_array_default);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>tx_thread_params {</div>
<div class="line">    uint8_t lcore_id;</div>
<div class="line">    uint8_t thread_id;</div>
<div class="line">} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>tx_thread_params tx_thread_params_array[MAX_LCORE_PARAMS];</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>tx_thread_params tx_thread_params_array_default[] = {</div>
<div class="line">    {4, 0},</div>
<div class="line">    {5, 1},</div>
<div class="line">    {6, 2},</div>
<div class="line">    {7, 3},</div>
<div class="line">    {8, 4},</div>
<div class="line">    {9, 5},</div>
<div class="line">    {10, 6},</div>
<div class="line">    {11, 7},</div>
<div class="line">    {12, 8},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>tx_thread_params *tx_thread_params =</div>
<div class="line">        tx_thread_params_array_default;</div>
<div class="line"><span class="keyword">static</span> uint16_t nb_tx_thread_params = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tx_thread_params_array_default);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf = {</div>
<div class="line">    .<a name="a5"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a6"></a><a class="code" href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">mq_mode</a> = <a name="a7"></a><a class="code" href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3eaa06694239b7ecf1efa3c9243b9e7b4c0">ETH_MQ_RX_RSS</a>,</div>
<div class="line">        .max_rx_pkt_len = <a name="a8"></a><a class="code" href="rte__ether_8h.html#aaebedff0cce73327398dd3139ba50e43">ETHER_MAX_LEN</a>,</div>
<div class="line">        .split_hdr_size = 0,</div>
<div class="line">        .header_split   = 0, </div>
<div class="line">        .hw_ip_checksum = 1, </div>
<div class="line">        .hw_vlan_filter = 0, </div>
<div class="line">        .jumbo_frame    = 0, </div>
<div class="line">        .hw_strip_crc   = 0, </div>
<div class="line">    },</div>
<div class="line">    .rx_adv_conf = {</div>
<div class="line">        .rss_conf = {</div>
<div class="line">            .rss_key = NULL,</div>
<div class="line">            .rss_hf = ETH_RSS_TCP,</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a9"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a10"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *pktmbuf_pool[NB_SOCKETS];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef RTE_MACHINE_CPUFLAG_SSE4_2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="rte__hash__crc_8h.html">rte_hash_crc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#define DEFAULT_HASH_FUNC       rte_hash_crc</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="rte__jhash_8h.html">rte_jhash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#define DEFAULT_HASH_FUNC       rte_jhash</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>ipv4_5tuple {</div>
<div class="line">    uint32_t ip_dst;</div>
<div class="line">    uint32_t ip_src;</div>
<div class="line">    uint16_t port_dst;</div>
<div class="line">    uint16_t port_src;</div>
<div class="line">    uint8_t  proto;</div>
<div class="line">} __attribute__((__packed__));</div>
<div class="line"></div>
<div class="line"><span class="keyword">union </span>ipv4_5tuple_host {</div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        uint8_t  pad0;</div>
<div class="line">        uint8_t  proto;</div>
<div class="line">        uint16_t pad1;</div>
<div class="line">        uint32_t ip_src;</div>
<div class="line">        uint32_t ip_dst;</div>
<div class="line">        uint16_t port_src;</div>
<div class="line">        uint16_t port_dst;</div>
<div class="line">    };</div>
<div class="line">    __m128i xmm;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define XMM_NUM_IN_IPV6_5TUPLE 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>ipv6_5tuple {</div>
<div class="line">    uint8_t  ip_dst[IPV6_ADDR_LEN];</div>
<div class="line">    uint8_t  ip_src[IPV6_ADDR_LEN];</div>
<div class="line">    uint16_t port_dst;</div>
<div class="line">    uint16_t port_src;</div>
<div class="line">    uint8_t  proto;</div>
<div class="line">} __attribute__((__packed__));</div>
<div class="line"></div>
<div class="line"><span class="keyword">union </span>ipv6_5tuple_host {</div>
<div class="line">    <span class="keyword">struct </span>{</div>
<div class="line">        uint16_t pad0;</div>
<div class="line">        uint8_t  proto;</div>
<div class="line">        uint8_t  pad1;</div>
<div class="line">        uint8_t  ip_src[IPV6_ADDR_LEN];</div>
<div class="line">        uint8_t  ip_dst[IPV6_ADDR_LEN];</div>
<div class="line">        uint16_t port_src;</div>
<div class="line">        uint16_t port_dst;</div>
<div class="line">        uint64_t reserve;</div>
<div class="line">    };</div>
<div class="line">    __m128i xmm[XMM_NUM_IN_IPV6_5TUPLE];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ipv4_l3fwd_route {</div>
<div class="line">    <span class="keyword">struct </span>ipv4_5tuple key;</div>
<div class="line">    uint8_t if_out;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ipv6_l3fwd_route {</div>
<div class="line">    <span class="keyword">struct </span>ipv6_5tuple key;</div>
<div class="line">    uint8_t if_out;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>ipv4_l3fwd_route ipv4_l3fwd_route_array[] = {</div>
<div class="line">    {{<a name="a11"></a><a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(101, 0, 0, 0), <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(100, 10, 0, 1),  101, 11, IPPROTO_TCP}, 0},</div>
<div class="line">    {{<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(201, 0, 0, 0), <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(200, 20, 0, 1),  102, 12, IPPROTO_TCP}, 1},</div>
<div class="line">    {{<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(111, 0, 0, 0), <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(100, 30, 0, 1),  101, 11, IPPROTO_TCP}, 2},</div>
<div class="line">    {{<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(211, 0, 0, 0), <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(200, 40, 0, 1),  102, 12, IPPROTO_TCP}, 3},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>ipv6_l3fwd_route ipv6_l3fwd_route_array[] = {</div>
<div class="line">    {{</div>
<div class="line">    {0xfe, 0x80, 0, 0, 0, 0, 0, 0, 0x02, 0x1e, 0x67, 0xff, 0xfe, 0, 0, 0},</div>
<div class="line">    {0xfe, 0x80, 0, 0, 0, 0, 0, 0, 0x02, 0x1b, 0x21, 0xff, 0xfe, 0x91, 0x38,</div>
<div class="line">            0x05},</div>
<div class="line">    101, 11, IPPROTO_TCP}, 0},</div>
<div class="line"></div>
<div class="line">    {{</div>
<div class="line">    {0xfe, 0x90, 0, 0, 0, 0, 0, 0, 0x02, 0x1e, 0x67, 0xff, 0xfe, 0, 0, 0},</div>
<div class="line">    {0xfe, 0x90, 0, 0, 0, 0, 0, 0, 0x02, 0x1b, 0x21, 0xff, 0xfe, 0x91, 0x38,</div>
<div class="line">            0x05},</div>
<div class="line">    102, 12, IPPROTO_TCP}, 1},</div>
<div class="line"></div>
<div class="line">    {{</div>
<div class="line">    {0xfe, 0xa0, 0, 0, 0, 0, 0, 0, 0x02, 0x1e, 0x67, 0xff, 0xfe, 0, 0, 0},</div>
<div class="line">    {0xfe, 0xa0, 0, 0, 0, 0, 0, 0, 0x02, 0x1b, 0x21, 0xff, 0xfe, 0x91, 0x38,</div>
<div class="line">            0x05},</div>
<div class="line">    101, 11, IPPROTO_TCP}, 2},</div>
<div class="line"></div>
<div class="line">    {{</div>
<div class="line">    {0xfe, 0xb0, 0, 0, 0, 0, 0, 0, 0x02, 0x1e, 0x67, 0xff, 0xfe, 0, 0, 0},</div>
<div class="line">    {0xfe, 0xb0, 0, 0, 0, 0, 0, 0, 0x02, 0x1b, 0x21, 0xff, 0xfe, 0x91, 0x38,</div>
<div class="line">            0x05},</div>
<div class="line">    102, 12, IPPROTO_TCP}, 3},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>rte_hash lookup_struct_t;</div>
<div class="line"><span class="keyword">static</span> lookup_struct_t *ipv4_l3fwd_lookup_struct[NB_SOCKETS];</div>
<div class="line"><span class="keyword">static</span> lookup_struct_t *ipv6_l3fwd_lookup_struct[NB_SOCKETS];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef RTE_ARCH_X86_64</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/* default to 4 million hash entries (approx) */</span></div>
<div class="line"><span class="preprocessor">#define L3FWD_HASH_ENTRIES (1024*1024*4)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/* 32-bit has less address-space for hugepage memory, limit to 1M entries */</span></div>
<div class="line"><span class="preprocessor">#define L3FWD_HASH_ENTRIES (1024*1024*1)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HASH_ENTRY_NUMBER_DEFAULT 4</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> uint32_t hash_entry_number = HASH_ENTRY_NUMBER_DEFAULT;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t</div>
<div class="line">ipv4_hash_crc(<span class="keyword">const</span> <span class="keywordtype">void</span> *data, <a name="a12"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> uint32_t data_len,</div>
<div class="line">        uint32_t init_val)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">union </span>ipv4_5tuple_host *k;</div>
<div class="line">    uint32_t t;</div>
<div class="line">    <span class="keyword">const</span> uint32_t *p;</div>
<div class="line"></div>
<div class="line">    k = data;</div>
<div class="line">    t = k-&gt;proto;</div>
<div class="line">    p = (<span class="keyword">const</span> uint32_t *)&amp;k-&gt;port_src;</div>
<div class="line"></div>
<div class="line">#ifdef RTE_MACHINE_CPUFLAG_SSE4_2</div>
<div class="line">    init_val = <a name="a13"></a><a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(t, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(k-&gt;ip_src, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(k-&gt;ip_dst, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*p, init_val);</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* RTE_MACHINE_CPUFLAG_SSE4_2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    init_val = <a name="a14"></a><a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(t, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(k-&gt;ip_src, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(k-&gt;ip_dst, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(*p, init_val);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* RTE_MACHINE_CPUFLAG_SSE4_2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> init_val;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t</div>
<div class="line">ipv6_hash_crc(<span class="keyword">const</span> <span class="keywordtype">void</span> *data, <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> uint32_t data_len,</div>
<div class="line">        uint32_t init_val)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">union </span>ipv6_5tuple_host *k;</div>
<div class="line">    uint32_t t;</div>
<div class="line">    <span class="keyword">const</span> uint32_t *p;</div>
<div class="line"><span class="preprocessor">#ifdef RTE_MACHINE_CPUFLAG_SSE4_2</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">const</span> uint32_t *ip_src0, *ip_src1, *ip_src2, *ip_src3;</div>
<div class="line">    <span class="keyword">const</span> uint32_t *ip_dst0, *ip_dst1, *ip_dst2, *ip_dst3;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* RTE_MACHINE_CPUFLAG_SSE4_2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    k = data;</div>
<div class="line">    t = k-&gt;proto;</div>
<div class="line">    p = (<span class="keyword">const</span> uint32_t *)&amp;k-&gt;port_src;</div>
<div class="line"></div>
<div class="line">#ifdef RTE_MACHINE_CPUFLAG_SSE4_2</div>
<div class="line">    ip_src0 = (<span class="keyword">const</span> uint32_t *) k-&gt;ip_src;</div>
<div class="line">    ip_src1 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_src + 4);</div>
<div class="line">    ip_src2 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_src + 8);</div>
<div class="line">    ip_src3 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_src + 12);</div>
<div class="line">    ip_dst0 = (<span class="keyword">const</span> uint32_t *) k-&gt;ip_dst;</div>
<div class="line">    ip_dst1 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_dst + 4);</div>
<div class="line">    ip_dst2 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_dst + 8);</div>
<div class="line">    ip_dst3 = (<span class="keyword">const</span> uint32_t *)(k-&gt;ip_dst + 12);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(t, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_src0, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_src1, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_src2, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_src3, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_dst0, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_dst1, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_dst2, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*ip_dst3, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__crc__arm64_8h.html#a0949738185ca264529df4760e5ac3444">rte_hash_crc_4byte</a>(*p, init_val);</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* RTE_MACHINE_CPUFLAG_SSE4_2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    init_val = <a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(t, init_val);</div>
<div class="line">    init_val = <a name="a15"></a><a class="code" href="rte__jhash_8h.html#a5a6d3c6a6da332e3768fa41e879e0e10">rte_jhash</a>(k-&gt;ip_src, <span class="keyword">sizeof</span>(uint8_t) * IPV6_ADDR_LEN, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__jhash_8h.html#a5a6d3c6a6da332e3768fa41e879e0e10">rte_jhash</a>(k-&gt;ip_dst, <span class="keyword">sizeof</span>(uint8_t) * IPV6_ADDR_LEN, init_val);</div>
<div class="line">    init_val = <a class="code" href="rte__jhash_8h.html#a53a47650245dedc1cb89f56fc9a63a96">rte_jhash_1word</a>(*p, init_val);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* RTE_MACHINE_CPUFLAG_SSE4_2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">return</span> init_val;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define IPV4_L3FWD_NUM_ROUTES RTE_DIM(ipv4_l3fwd_route_array)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV6_L3FWD_NUM_ROUTES RTE_DIM(ipv6_l3fwd_route_array)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> uint8_t ipv4_l3fwd_out_if[L3FWD_HASH_ENTRIES] <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"><span class="keyword">static</span> uint8_t ipv6_l3fwd_out_if[L3FWD_HASH_ENTRIES] <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">struct </span>ipv4_l3fwd_route {</div>
<div class="line">    uint32_t ip;</div>
<div class="line">    uint8_t  depth;</div>
<div class="line">    uint8_t  if_out;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ipv6_l3fwd_route {</div>
<div class="line">    uint8_t ip[16];</div>
<div class="line">    uint8_t depth;</div>
<div class="line">    uint8_t if_out;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>ipv4_l3fwd_route ipv4_l3fwd_route_array[] = {</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(1, 1, 1, 0), 24, 0},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(2, 1, 1, 0), 24, 1},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(3, 1, 1, 0), 24, 2},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(4, 1, 1, 0), 24, 3},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(5, 1, 1, 0), 24, 4},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(6, 1, 1, 0), 24, 5},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(7, 1, 1, 0), 24, 6},</div>
<div class="line">    {<a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(8, 1, 1, 0), 24, 7},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>ipv6_l3fwd_route ipv6_l3fwd_route_array[] = {</div>
<div class="line">    {{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 0},</div>
<div class="line">    {{2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 1},</div>
<div class="line">    {{3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 2},</div>
<div class="line">    {{4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 3},</div>
<div class="line">    {{5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 4},</div>
<div class="line">    {{6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 5},</div>
<div class="line">    {{7, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 6},</div>
<div class="line">    {{8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}, 48, 7},</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define IPV4_L3FWD_NUM_ROUTES RTE_DIM(ipv4_l3fwd_route_array)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV6_L3FWD_NUM_ROUTES RTE_DIM(ipv6_l3fwd_route_array)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IPV4_L3FWD_LPM_MAX_RULES         1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV6_L3FWD_LPM_MAX_RULES         1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV6_L3FWD_LPM_NUMBER_TBL8S (1 &lt;&lt; 16)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>rte_lpm lookup_struct_t;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>rte_lpm6 lookup6_struct_t;</div>
<div class="line"><span class="keyword">static</span> lookup_struct_t *ipv4_l3fwd_lookup_struct[NB_SOCKETS];</div>
<div class="line"><span class="keyword">static</span> lookup6_struct_t *ipv6_l3fwd_lookup_struct[NB_SOCKETS];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>lcore_conf {</div>
<div class="line">    lookup_struct_t *ipv4_lookup_struct;</div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span>    lookup6_struct_t *ipv6_lookup_struct;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    lookup_struct_t *ipv6_lookup_struct;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">void</span> *data;</div>
<div class="line">} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>lcore_conf lcore_conf[RTE_MAX_LCORE];</div>
<div class="line"><a name="a16"></a><a class="code" href="rte__per__lcore_8h.html#a27c3960b94fa50a6468c900dd0a01fe5">RTE_DEFINE_PER_LCORE</a>(<span class="keyword">struct</span> lcore_conf *, lcore_conf);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_RX_QUEUE_PER_THREAD 16</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_TX_PORT_PER_THREAD  RTE_MAX_ETHPORTS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_TX_QUEUE_PER_PORT   RTE_MAX_ETHPORTS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_RX_QUEUE_PER_PORT   128</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAX_RX_THREAD 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_TX_THREAD 1024</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_THREAD    (MAX_RX_THREAD + MAX_TX_THREAD)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> lthreads_on = 1; </div>
<div class="line"><a name="_a17"></a><a class="code" href="structrte__atomic16__t.html">rte_atomic16_t</a> rx_counter;  </div>
<div class="line"><a class="code" href="structrte__atomic16__t.html">rte_atomic16_t</a> tx_counter;  </div>
<div class="line"><span class="keyword">struct </span>thread_conf {</div>
<div class="line">    uint16_t lcore_id;      </div>
<div class="line">    uint16_t cpu_id;        </div>
<div class="line">    uint16_t thread_id;     </div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">int</span> busy[MAX_CPU_COUNTER];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>thread_rx_conf {</div>
<div class="line">    <span class="keyword">struct </span>thread_conf conf;</div>
<div class="line"></div>
<div class="line">    uint16_t n_rx_queue;</div>
<div class="line">    <span class="keyword">struct </span>lcore_rx_queue rx_queue_list[MAX_RX_QUEUE_PER_LCORE];</div>
<div class="line"></div>
<div class="line">    uint16_t n_ring;        </div>
<div class="line">    <span class="keyword">struct </span><a name="_a18"></a><a class="code" href="structrte__ring.html">rte_ring</a> *ring[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keyword">struct </span>lthread_cond *ready[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordtype">int</span> busy[MAX_CPU_COUNTER];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line">uint16_t n_rx_thread;</div>
<div class="line"><span class="keyword">struct </span>thread_rx_conf rx_thread[MAX_RX_THREAD];</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>thread_tx_conf {</div>
<div class="line">    <span class="keyword">struct </span>thread_conf conf;</div>
<div class="line"></div>
<div class="line">    uint16_t tx_queue_id[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table tx_mbufs[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ring.html">rte_ring</a> *ring;</div>
<div class="line">    <span class="keyword">struct </span>lthread_cond **ready;</div>
<div class="line"></div>
<div class="line">} <a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line">uint16_t n_tx_thread;</div>
<div class="line"><span class="keyword">struct </span>thread_tx_conf tx_thread[MAX_TX_THREAD];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Send burst of packets on an output interface */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">send_burst(<span class="keyword">struct</span> thread_tx_conf *qconf, uint16_t n, uint8_t <a name="_a19"></a><a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **m_table;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint16_t queueid;</div>
<div class="line"></div>
<div class="line">    queueid = qconf-&gt;tx_queue_id[<a name="a20"></a><a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>];</div>
<div class="line">    m_table = (<span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **)qconf-&gt;tx_mbufs[port].m_table;</div>
<div class="line"></div>
<div class="line">    ret = <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port, queueid, m_table, n);</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a22"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; n)) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">            <a name="a23"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m_table[ret]);</div>
<div class="line">        } <span class="keywordflow">while</span> (++ret &lt; n);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enqueue a single packet, and send burst if queue is filled */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">send_single_packet(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint8_t port)</div>
<div class="line">{</div>
<div class="line">    uint16_t len;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *qconf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (lthreads_on)</div>
<div class="line">        qconf = (<span class="keyword">struct </span>thread_tx_conf *)lthread_get_data();</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        qconf = (<span class="keyword">struct </span>thread_tx_conf *)<a name="a24"></a><a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;data;</div>
<div class="line"></div>
<div class="line">    len = qconf-&gt;tx_mbufs[port].len;</div>
<div class="line">    qconf-&gt;tx_mbufs[port].m_table[len] = m;</div>
<div class="line">    len++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* enough pkts to be sent */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line">        send_burst(qconf, MAX_PKT_BURST, port);</div>
<div class="line">        len = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    qconf-&gt;tx_mbufs[port].len = len;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_LPM) &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (ENABLE_MULTI_BUFFER_OPTIMIZE == 1))</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((always_inline)) void</div>
<div class="line">send_packetsx4(uint8_t port,</div>
<div class="line">    struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m[], uint32_t num)</div>
<div class="line">{</div>
<div class="line">    uint32_t len, j, n;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *qconf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (lthreads_on)</div>
<div class="line">        qconf = (<span class="keyword">struct </span>thread_tx_conf *)lthread_get_data();</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        qconf = (<span class="keyword">struct </span>thread_tx_conf *)<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;data;</div>
<div class="line"></div>
<div class="line">    len = qconf-&gt;tx_mbufs[port].len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * If TX buffer for that queue is empty, and we have enough packets,</span></div>
<div class="line"><span class="comment">     * then send them straightway.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (num &gt;= MAX_TX_BURST &amp;&amp; len == 0) {</div>
<div class="line">        n = <a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port, qconf-&gt;tx_queue_id[port], m, num);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n &lt; num)) {</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[n]);</div>
<div class="line">            } <span class="keywordflow">while</span> (++n &lt; num);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Put packets into TX buffer for that queue.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line"></div>
<div class="line">    n = len + num;</div>
<div class="line">    n = (n &gt; MAX_PKT_BURST) ? MAX_PKT_BURST - len : num;</div>
<div class="line"></div>
<div class="line">    j = 0;</div>
<div class="line">    <span class="keywordflow">switch</span> (n % FWDSTEP) {</div>
<div class="line">    <span class="keywordflow">while</span> (j &lt; n) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:</div>
<div class="line">        qconf-&gt;tx_mbufs[port].m_table[len + j] = m[j];</div>
<div class="line">        j++;</div>
<div class="line">    <span class="keywordflow">case</span> 3:</div>
<div class="line">        qconf-&gt;tx_mbufs[port].m_table[len + j] = m[j];</div>
<div class="line">        j++;</div>
<div class="line">    <span class="keywordflow">case</span> 2:</div>
<div class="line">        qconf-&gt;tx_mbufs[port].m_table[len + j] = m[j];</div>
<div class="line">        j++;</div>
<div class="line">    <span class="keywordflow">case</span> 1:</div>
<div class="line">        qconf-&gt;tx_mbufs[port].m_table[len + j] = m[j];</div>
<div class="line">        j++;</div>
<div class="line">    }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    len += n;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* enough pkts to be sent */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(len == MAX_PKT_BURST)) {</div>
<div class="line"></div>
<div class="line">        send_burst(qconf, MAX_PKT_BURST, port);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* copy rest of the packets into the TX buffer. */</span></div>
<div class="line">        len = num - n;</div>
<div class="line">        j = 0;</div>
<div class="line">        <span class="keywordflow">switch</span> (len % FWDSTEP) {</div>
<div class="line">        <span class="keywordflow">while</span> (j &lt; len) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            qconf-&gt;tx_mbufs[port].m_table[j] = m[n + j];</div>
<div class="line">            j++;</div>
<div class="line">        <span class="keywordflow">case</span> 3:</div>
<div class="line">            qconf-&gt;tx_mbufs[port].m_table[j] = m[n + j];</div>
<div class="line">            j++;</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">            qconf-&gt;tx_mbufs[port].m_table[j] = m[n + j];</div>
<div class="line">            j++;</div>
<div class="line">        <span class="keywordflow">case</span> 1:</div>
<div class="line">            qconf-&gt;tx_mbufs[port].m_table[j] = m[n + j];</div>
<div class="line">            j++;</div>
<div class="line">        }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    qconf-&gt;tx_mbufs[port].len = len;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_LOOKUP_LPM */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">is_valid_ipv4_pkt(<span class="keyword">struct</span> <a name="_a25"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *pkt, uint32_t link_len)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* From http://www.rfc-editor.org/rfc/rfc1812.txt section 5.2.2 */</span></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * 1. The packet length reported by the Link Layer must be large</span></div>
<div class="line"><span class="comment">     * enough to hold the minimum length legal IP datagram (20 bytes).</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (link_len &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structipv4__hdr.html">ipv4_hdr</a>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* 2. The IP checksum must be correct. */</span></div>
<div class="line">    <span class="comment">/* this is checked in H/W */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * 3. The IP version number must be 4. If the version number is not 4</span></div>
<div class="line"><span class="comment">     * then the packet may be another version of IP, such as IPng or</span></div>
<div class="line"><span class="comment">     * ST-II.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (((pkt-&gt;<a name="a26"></a><a class="code" href="structipv4__hdr.html#a0f143df6fd0e09aba2963a160e33ce16">version_ihl</a>) &gt;&gt; 4) != 4)</div>
<div class="line">        <span class="keywordflow">return</span> -3;</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * 4. The IP header length field must be large enough to hold the</span></div>
<div class="line"><span class="comment">     * minimum length legal IP datagram (20 bytes = 5 words).</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((pkt-&gt;<a class="code" href="structipv4__hdr.html#a0f143df6fd0e09aba2963a160e33ce16">version_ihl</a> &amp; 0xf) &lt; 5)</div>
<div class="line">        <span class="keywordflow">return</span> -4;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * 5. The IP total length field must be large enough to hold the IP</span></div>
<div class="line"><span class="comment">     * datagram header, whose length is specified in the IP header length</span></div>
<div class="line"><span class="comment">     * field.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a27"></a><a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(pkt-&gt;<a name="a28"></a><a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a>) &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structipv4__hdr.html">ipv4_hdr</a>))</div>
<div class="line">        <span class="keywordflow">return</span> -5;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> __m128i mask0;</div>
<div class="line"><span class="keyword">static</span> __m128i mask1;</div>
<div class="line"><span class="keyword">static</span> __m128i mask2;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint8_t</div>
<div class="line">get_ipv4_dst_port(<span class="keywordtype">void</span> *<a class="code" href="structipv4__hdr.html">ipv4_hdr</a>, uint8_t portid,</div>
<div class="line">        lookup_struct_t *ipv4_l3fwd_lookup_struct)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">    <span class="keyword">union </span>ipv4_5tuple_host key;</div>
<div class="line"></div>
<div class="line">    ipv4_hdr = (uint8_t *)ipv4_hdr + <a name="a29"></a><a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live);</div>
<div class="line">    __m128i data = _mm_loadu_si128((__m128i *)(ipv4_hdr));</div>
<div class="line">    <span class="comment">/* Get 5 tuple: dst port, src port, dst IP address, src IP address and</span></div>
<div class="line"><span class="comment">       protocol */</span></div>
<div class="line">    key.xmm = _mm_and_si128(data, mask0);</div>
<div class="line">    <span class="comment">/* Find destination port */</span></div>
<div class="line">    ret = <a name="a30"></a><a class="code" href="rte__hash_8h.html#a62ff0b837d39bbff00863feabf15e224">rte_hash_lookup</a>(ipv4_l3fwd_lookup_struct, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;key);</div>
<div class="line">    <span class="keywordflow">return</span> (uint8_t)((ret &lt; 0) ? portid : ipv4_l3fwd_out_if[ret]);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint8_t</div>
<div class="line">get_ipv6_dst_port(<span class="keywordtype">void</span> *<a name="_a31"></a><a class="code" href="structipv6__hdr.html">ipv6_hdr</a>, uint8_t portid,</div>
<div class="line">        lookup_struct_t *ipv6_l3fwd_lookup_struct)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line">    <span class="keyword">union </span>ipv6_5tuple_host key;</div>
<div class="line"></div>
<div class="line">    ipv6_hdr = (uint8_t *)ipv6_hdr + <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv6_hdr, payload_len);</div>
<div class="line">    __m128i data0 = _mm_loadu_si128((__m128i *)(ipv6_hdr));</div>
<div class="line">    __m128i data1 = _mm_loadu_si128((__m128i *)(((uint8_t *)ipv6_hdr) +</div>
<div class="line">            <span class="keyword">sizeof</span>(__m128i)));</div>
<div class="line">    __m128i data2 = _mm_loadu_si128((__m128i *)(((uint8_t *)ipv6_hdr) +</div>
<div class="line">            <span class="keyword">sizeof</span>(__m128i) + <span class="keyword">sizeof</span>(__m128i)));</div>
<div class="line">    <span class="comment">/* Get part of 5 tuple: src IP address lower 96 bits and protocol */</span></div>
<div class="line">    key.xmm[0] = _mm_and_si128(data0, mask1);</div>
<div class="line">    <span class="comment">/* Get part of 5 tuple: dst IP address lower 96 bits and src IP address</span></div>
<div class="line"><span class="comment">       higher 32 bits */</span></div>
<div class="line">    key.xmm[1] = data1;</div>
<div class="line">    <span class="comment">/* Get part of 5 tuple: dst port and src port and dst IP address higher</span></div>
<div class="line"><span class="comment">       32 bits */</span></div>
<div class="line">    key.xmm[2] = _mm_and_si128(data2, mask2);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Find destination port */</span></div>
<div class="line">    ret = <a class="code" href="rte__hash_8h.html#a62ff0b837d39bbff00863feabf15e224">rte_hash_lookup</a>(ipv6_l3fwd_lookup_struct, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;key);</div>
<div class="line">    <span class="keywordflow">return</span> (uint8_t)((ret &lt; 0) ? portid : ipv6_l3fwd_out_if[ret]);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint8_t</div>
<div class="line">get_ipv4_dst_port(<span class="keywordtype">void</span> *ipv4_hdr, uint8_t portid,</div>
<div class="line">        lookup_struct_t *ipv4_l3fwd_lookup_struct)</div>
<div class="line">{</div>
<div class="line">    uint32_t next_hop;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (uint8_t)((<a name="a32"></a><a class="code" href="rte__lpm_8h.html#a1bab3e9f44549b0490a5e2f1e7e21ede">rte_lpm_lookup</a>(ipv4_l3fwd_lookup_struct,</div>
<div class="line">        <a name="a33"></a><a class="code" href="rte__byteorder_8h.html#a980e02d221d693034bc63088d27888f7">rte_be_to_cpu_32</a>(((<span class="keyword">struct</span> ipv4_hdr *)ipv4_hdr)-&gt;dst_addr),</div>
<div class="line">        &amp;next_hop) == 0) ? next_hop : portid);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint8_t</div>
<div class="line">get_ipv6_dst_port(<span class="keywordtype">void</span> *ipv6_hdr,  uint8_t portid,</div>
<div class="line">        lookup6_struct_t *ipv6_l3fwd_lookup_struct)</div>
<div class="line">{</div>
<div class="line">    uint8_t next_hop;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (uint8_t) ((<a name="a34"></a><a class="code" href="rte__lpm6_8h.html#a08d20578eb3f70f25b4b1d6cf4013601">rte_lpm6_lookup</a>(ipv6_l3fwd_lookup_struct,</div>
<div class="line">            ((<span class="keyword">struct</span> ipv6_hdr *)ipv6_hdr)-&gt;dst_addr, &amp;next_hop) == 0) ?</div>
<div class="line">            next_hop : portid);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> l3fwd_simple_forward(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint8_t portid)</div>
<div class="line">        __attribute__((unused));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH) &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (ENABLE_MULTI_BUFFER_OPTIMIZE == 1))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MASK_ALL_PKTS   0xff</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_1ST_PKT 0xfe</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_2ND_PKT 0xfd</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_3RD_PKT 0xfb</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_4TH_PKT 0xf7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_5TH_PKT 0xef</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_6TH_PKT 0xdf</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_7TH_PKT 0xbf</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define EXCLUDE_8TH_PKT 0x7f</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">simple_ipv4_fwd_8pkts(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m[8], uint8_t portid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a35"></a><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr[8];</div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ipv4_hdr[8];</div>
<div class="line">    uint8_t dst_port[8];</div>
<div class="line">    int32_t ret[8];</div>
<div class="line">    <span class="keyword">union </span>ipv4_5tuple_host key[8];</div>
<div class="line">    __m128i data[8];</div>
<div class="line"></div>
<div class="line">    eth_hdr[0] = <a name="a36"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[0], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[1] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[1], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[2] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[2], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[3] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[3], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[4] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[4], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[5] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[5], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[6] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[6], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[7] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[7], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Handle IPv4 headers.*/</span></div>
<div class="line">    ipv4_hdr[0] = <a name="a37"></a><a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[0], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[1] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[1], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[2] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[2], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[3] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[3], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[4] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[4], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[5] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[5], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[6] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[6], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ipv4_hdr[7] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[7], <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* Check to make sure the packet is valid (RFC1812) */</span></div>
<div class="line">    uint8_t valid_mask = MASK_ALL_PKTS;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[0], m[0]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[0]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_1ST_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[1], m[1]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[1]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_2ND_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[2], m[2]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[2]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_3RD_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[3], m[3]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[3]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_4TH_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[4], m[4]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[4]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_5TH_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[5], m[5]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[5]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_6TH_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[6], m[6]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[6]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_7TH_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr[7], m[7]-&gt;pkt_len) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m[7]);</div>
<div class="line">        valid_mask &amp;= EXCLUDE_8TH_PKT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(valid_mask != MASK_ALL_PKTS)) {</div>
<div class="line">        <span class="keywordflow">if</span> (valid_mask == 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">        uint8_t i = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++)</div>
<div class="line">            <span class="keywordflow">if</span> ((0x1 &lt;&lt; i) &amp; valid_mask)</div>
<div class="line">                l3fwd_simple_forward(m[i], portid);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* End of #ifdef DO_RFC_1812_CHECKS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    data[0] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[0], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[1] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[1], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[2] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[2], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[3] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[3], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[4] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[4], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[5] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[5], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[6] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[6], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line">    data[7] = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[7], __m128i *,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv4_hdr, time_to_live)));</div>
<div class="line"></div>
<div class="line">    key[0].xmm = _mm_and_si128(data[0], mask0);</div>
<div class="line">    key[1].xmm = _mm_and_si128(data[1], mask0);</div>
<div class="line">    key[2].xmm = _mm_and_si128(data[2], mask0);</div>
<div class="line">    key[3].xmm = _mm_and_si128(data[3], mask0);</div>
<div class="line">    key[4].xmm = _mm_and_si128(data[4], mask0);</div>
<div class="line">    key[5].xmm = _mm_and_si128(data[5], mask0);</div>
<div class="line">    key[6].xmm = _mm_and_si128(data[6], mask0);</div>
<div class="line">    key[7].xmm = _mm_and_si128(data[7], mask0);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *key_array[8] = {&amp;key[0], &amp;key[1], &amp;key[2], &amp;key[3],</div>
<div class="line">            &amp;key[4], &amp;key[5], &amp;key[6], &amp;key[7]};</div>
<div class="line"></div>
<div class="line">    rte_hash_lookup_multi(<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv4_lookup_struct,</div>
<div class="line">            &amp;key_array[0], 8, ret);</div>
<div class="line">    dst_port[0] = (uint8_t) ((ret[0] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[0]]);</div>
<div class="line">    dst_port[1] = (uint8_t) ((ret[1] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[1]]);</div>
<div class="line">    dst_port[2] = (uint8_t) ((ret[2] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[2]]);</div>
<div class="line">    dst_port[3] = (uint8_t) ((ret[3] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[3]]);</div>
<div class="line">    dst_port[4] = (uint8_t) ((ret[4] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[4]]);</div>
<div class="line">    dst_port[5] = (uint8_t) ((ret[5] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[5]]);</div>
<div class="line">    dst_port[6] = (uint8_t) ((ret[6] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[6]]);</div>
<div class="line">    dst_port[7] = (uint8_t) ((ret[7] &lt; 0) ? portid : ipv4_l3fwd_out_if[ret[7]]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[0] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[0]) == 0)</div>
<div class="line">        dst_port[0] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[1] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[1]) == 0)</div>
<div class="line">        dst_port[1] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[2] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[2]) == 0)</div>
<div class="line">        dst_port[2] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[3] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[3]) == 0)</div>
<div class="line">        dst_port[3] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[4] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[4]) == 0)</div>
<div class="line">        dst_port[4] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[5] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[5]) == 0)</div>
<div class="line">        dst_port[5] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[6] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[6]) == 0)</div>
<div class="line">        dst_port[6] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[7] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[7]) == 0)</div>
<div class="line">        dst_port[7] = portid;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* Update time to live and header checksum */</span></div>
<div class="line">    --(ipv4_hdr[0]-&gt;<a name="a38"></a><a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[1]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[2]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[3]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    ++(ipv4_hdr[0]-&gt;<a name="a39"></a><a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[1]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[2]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[3]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    --(ipv4_hdr[4]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[5]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[6]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    --(ipv4_hdr[7]-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">    ++(ipv4_hdr[4]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[5]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[6]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line">    ++(ipv4_hdr[7]-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* dst addr */</span></div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[0]-&gt;d_addr = dest_eth_addr[dst_port[0]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[1]-&gt;d_addr = dest_eth_addr[dst_port[1]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[2]-&gt;d_addr = dest_eth_addr[dst_port[2]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[3]-&gt;d_addr = dest_eth_addr[dst_port[3]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[4]-&gt;d_addr = dest_eth_addr[dst_port[4]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[5]-&gt;d_addr = dest_eth_addr[dst_port[5]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[6]-&gt;d_addr = dest_eth_addr[dst_port[6]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[7]-&gt;d_addr = dest_eth_addr[dst_port[7]];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* src addr */</span></div>
<div class="line">    <a name="a40"></a><a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[0]], &amp;eth_hdr[0]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[1]], &amp;eth_hdr[1]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[2]], &amp;eth_hdr[2]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[3]], &amp;eth_hdr[3]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[4]], &amp;eth_hdr[4]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[5]], &amp;eth_hdr[5]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[6]], &amp;eth_hdr[6]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[7]], &amp;eth_hdr[7]-&gt;s_addr);</div>
<div class="line"></div>
<div class="line">    send_single_packet(m[0], (uint8_t)dst_port[0]);</div>
<div class="line">    send_single_packet(m[1], (uint8_t)dst_port[1]);</div>
<div class="line">    send_single_packet(m[2], (uint8_t)dst_port[2]);</div>
<div class="line">    send_single_packet(m[3], (uint8_t)dst_port[3]);</div>
<div class="line">    send_single_packet(m[4], (uint8_t)dst_port[4]);</div>
<div class="line">    send_single_packet(m[5], (uint8_t)dst_port[5]);</div>
<div class="line">    send_single_packet(m[6], (uint8_t)dst_port[6]);</div>
<div class="line">    send_single_packet(m[7], (uint8_t)dst_port[7]);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> get_ipv6_5tuple(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m0, __m128i mask0,</div>
<div class="line">        __m128i mask1, <span class="keyword">union</span> ipv6_5tuple_host *key)</div>
<div class="line">{</div>
<div class="line">    __m128i tmpdata0 = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m0,</div>
<div class="line">            __m128i *, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv6_hdr, payload_len)));</div>
<div class="line">    __m128i tmpdata1 = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m0,</div>
<div class="line">            __m128i *, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv6_hdr, payload_len) + <span class="keyword">sizeof</span>(__m128i)));</div>
<div class="line">    __m128i tmpdata2 = _mm_loadu_si128(<a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m0,</div>
<div class="line">            __m128i *, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a276e8a32e0bbf024aadd9420b8f2d3b3">offsetof</a>(<span class="keyword">struct</span> ipv6_hdr, payload_len) + <span class="keyword">sizeof</span>(__m128i) +</div>
<div class="line">            <span class="keyword">sizeof</span>(__m128i)));</div>
<div class="line">    key-&gt;xmm[0] = _mm_and_si128(tmpdata0, mask0);</div>
<div class="line">    key-&gt;xmm[1] = tmpdata1;</div>
<div class="line">    key-&gt;xmm[2] = _mm_and_si128(tmpdata2, mask1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">simple_ipv6_fwd_8pkts(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m[8], uint8_t portid)</div>
<div class="line">{</div>
<div class="line">    int32_t ret[8];</div>
<div class="line">    uint8_t dst_port[8];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr[8];</div>
<div class="line">    <span class="keyword">union </span>ipv6_5tuple_host key[8];</div>
<div class="line"></div>
<div class="line">    __attribute__((unused)) struct ipv6_hdr *ipv6_hdr[8];</div>
<div class="line"></div>
<div class="line">    eth_hdr[0] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[0], struct <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_hdr[1] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[1], struct ether_hdr *);</div>
<div class="line">    eth_hdr[2] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[2], struct ether_hdr *);</div>
<div class="line">    eth_hdr[3] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[3], struct ether_hdr *);</div>
<div class="line">    eth_hdr[4] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[4], struct ether_hdr *);</div>
<div class="line">    eth_hdr[5] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[5], struct ether_hdr *);</div>
<div class="line">    eth_hdr[6] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[6], struct ether_hdr *);</div>
<div class="line">    eth_hdr[7] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m[7], struct ether_hdr *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Handle IPv6 headers.*/</span></div>
<div class="line">    ipv6_hdr[0] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[0], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[1] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[1], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[2] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[2], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[3] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[3], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[4] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[4], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[5] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[5], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[6] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[6], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line">    ipv6_hdr[7] = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m[7], struct ipv6_hdr *,</div>
<div class="line">            sizeof(struct ether_hdr));</div>
<div class="line"></div>
<div class="line">    get_ipv6_5tuple(m[0], mask1, mask2, &amp;key[0]);</div>
<div class="line">    get_ipv6_5tuple(m[1], mask1, mask2, &amp;key[1]);</div>
<div class="line">    get_ipv6_5tuple(m[2], mask1, mask2, &amp;key[2]);</div>
<div class="line">    get_ipv6_5tuple(m[3], mask1, mask2, &amp;key[3]);</div>
<div class="line">    get_ipv6_5tuple(m[4], mask1, mask2, &amp;key[4]);</div>
<div class="line">    get_ipv6_5tuple(m[5], mask1, mask2, &amp;key[5]);</div>
<div class="line">    get_ipv6_5tuple(m[6], mask1, mask2, &amp;key[6]);</div>
<div class="line">    get_ipv6_5tuple(m[7], mask1, mask2, &amp;key[7]);</div>
<div class="line"></div>
<div class="line">    const <span class="keywordtype">void</span> *key_array[8] = {&amp;key[0], &amp;key[1], &amp;key[2], &amp;key[3],</div>
<div class="line">            &amp;key[4], &amp;key[5], &amp;key[6], &amp;key[7]};</div>
<div class="line"></div>
<div class="line">    rte_hash_lookup_multi(<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv6_lookup_struct,</div>
<div class="line">            &amp;key_array[0], 4, ret);</div>
<div class="line">    dst_port[0] = (uint8_t) ((ret[0] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[0]]);</div>
<div class="line">    dst_port[1] = (uint8_t) ((ret[1] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[1]]);</div>
<div class="line">    dst_port[2] = (uint8_t) ((ret[2] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[2]]);</div>
<div class="line">    dst_port[3] = (uint8_t) ((ret[3] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[3]]);</div>
<div class="line">    dst_port[4] = (uint8_t) ((ret[4] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[4]]);</div>
<div class="line">    dst_port[5] = (uint8_t) ((ret[5] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[5]]);</div>
<div class="line">    dst_port[6] = (uint8_t) ((ret[6] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[6]]);</div>
<div class="line">    dst_port[7] = (uint8_t) ((ret[7] &lt; 0) ? portid : ipv6_l3fwd_out_if[ret[7]]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[0] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[0]) == 0)</div>
<div class="line">        dst_port[0] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[1] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[1]) == 0)</div>
<div class="line">        dst_port[1] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[2] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[2]) == 0)</div>
<div class="line">        dst_port[2] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[3] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[3]) == 0)</div>
<div class="line">        dst_port[3] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[4] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[4]) == 0)</div>
<div class="line">        dst_port[4] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[5] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[5]) == 0)</div>
<div class="line">        dst_port[5] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[6] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[6]) == 0)</div>
<div class="line">        dst_port[6] = portid;</div>
<div class="line">    <span class="keywordflow">if</span> (dst_port[7] &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">            (enabled_port_mask &amp; 1 &lt;&lt; dst_port[7]) == 0)</div>
<div class="line">        dst_port[7] = portid;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* dst addr */</span></div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[0]-&gt;d_addr = dest_eth_addr[dst_port[0]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[1]-&gt;d_addr = dest_eth_addr[dst_port[1]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[2]-&gt;d_addr = dest_eth_addr[dst_port[2]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[3]-&gt;d_addr = dest_eth_addr[dst_port[3]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[4]-&gt;d_addr = dest_eth_addr[dst_port[4]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[5]-&gt;d_addr = dest_eth_addr[dst_port[5]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[6]-&gt;d_addr = dest_eth_addr[dst_port[6]];</div>
<div class="line">    *(uint64_t *)&amp;eth_hdr[7]-&gt;d_addr = dest_eth_addr[dst_port[7]];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* src addr */</span></div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[0]], &amp;eth_hdr[0]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[1]], &amp;eth_hdr[1]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[2]], &amp;eth_hdr[2]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[3]], &amp;eth_hdr[3]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[4]], &amp;eth_hdr[4]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[5]], &amp;eth_hdr[5]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[6]], &amp;eth_hdr[6]-&gt;s_addr);</div>
<div class="line">    <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port[7]], &amp;eth_hdr[7]-&gt;s_addr);</div>
<div class="line"></div>
<div class="line">    send_single_packet(m[0], (uint8_t)dst_port[0]);</div>
<div class="line">    send_single_packet(m[1], (uint8_t)dst_port[1]);</div>
<div class="line">    send_single_packet(m[2], (uint8_t)dst_port[2]);</div>
<div class="line">    send_single_packet(m[3], (uint8_t)dst_port[3]);</div>
<div class="line">    send_single_packet(m[4], (uint8_t)dst_port[4]);</div>
<div class="line">    send_single_packet(m[5], (uint8_t)dst_port[5]);</div>
<div class="line">    send_single_packet(m[6], (uint8_t)dst_port[6]);</div>
<div class="line">    send_single_packet(m[7], (uint8_t)dst_port[7]);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_LOOKUP_METHOD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((always_inline)) void</div>
<div class="line">l3fwd_simple_forward(struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint8_t portid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ipv4_hdr;</div>
<div class="line">    uint8_t dst_port;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a41"></a><a class="code" href="rte__mbuf_8h.html#aa9fef8bfc8393b3ece31b60835d46e56">RTE_ETH_IS_IPV4_HDR</a>(m-&gt;packet_type)) {</div>
<div class="line">        <span class="comment">/* Handle IPv4 headers.*/</span></div>
<div class="line">        ipv4_hdr = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m, <span class="keyword">struct</span> ipv4_hdr *,</div>
<div class="line">                <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">/* Check to make sure the packet is valid (RFC1812) */</span></div>
<div class="line">        <span class="keywordflow">if</span> (is_valid_ipv4_pkt(ipv4_hdr, m-&gt;pkt_len) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">         dst_port = get_ipv4_dst_port(ipv4_hdr, portid,</div>
<div class="line">            <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv4_lookup_struct);</div>
<div class="line">        <span class="keywordflow">if</span> (dst_port &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">                (enabled_port_mask &amp; 1 &lt;&lt; dst_port) == 0)</div>
<div class="line">            dst_port = portid;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">/* Update time to live and header checksum */</span></div>
<div class="line">        --(ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#a001bd5ec646244861baba152872aaf0e">time_to_live</a>);</div>
<div class="line">        ++(ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">/* dst addr */</span></div>
<div class="line">        *(uint64_t *)&amp;eth_hdr-&gt;<a name="a42"></a><a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a> = dest_eth_addr[dst_port];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* src addr */</span></div>
<div class="line">        <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port], &amp;eth_hdr-&gt;<a name="a43"></a><a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>);</div>
<div class="line"></div>
<div class="line">        send_single_packet(m, dst_port);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a name="a44"></a><a class="code" href="rte__mbuf_8h.html#a5fcf594e29330899e40b65755394ba90">RTE_ETH_IS_IPV6_HDR</a>(m-&gt;packet_type)) {</div>
<div class="line">        <span class="comment">/* Handle IPv6 headers.*/</span></div>
<div class="line">        <span class="keyword">struct </span>ipv6_hdr *ipv6_hdr;</div>
<div class="line"></div>
<div class="line">        ipv6_hdr = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(m, <span class="keyword">struct</span> ipv6_hdr *,</div>
<div class="line">                <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">        dst_port = get_ipv6_dst_port(ipv6_hdr, portid,</div>
<div class="line">                <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv6_lookup_struct);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (dst_port &gt;= RTE_MAX_ETHPORTS ||</div>
<div class="line">                (enabled_port_mask &amp; 1 &lt;&lt; dst_port) == 0)</div>
<div class="line">            dst_port = portid;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* dst addr */</span></div>
<div class="line">        *(uint64_t *)&amp;eth_hdr-&gt;<a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a> = dest_eth_addr[dst_port];</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* src addr */</span></div>
<div class="line">        <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[dst_port], &amp;eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>);</div>
<div class="line"></div>
<div class="line">        send_single_packet(m, dst_port);</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <span class="comment">/* Free the mbuf that contains non-IPV4/IPV6 packet */</span></div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_LPM) &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (ENABLE_MULTI_BUFFER_OPTIMIZE == 1))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef DO_RFC_1812_CHECKS</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IPV4_MIN_VER_IHL    0x45</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV4_MAX_VER_IHL    0x4f</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IPV4_MAX_VER_IHL_DIFF   (IPV4_MAX_VER_IHL - IPV4_MIN_VER_IHL)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Minimum value of IPV4 total length (20B) in network byte order. */</span></div>
<div class="line"><span class="preprocessor">#define IPV4_MIN_LEN_BE (sizeof(struct ipv4_hdr) &lt;&lt; 8)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * From http://www.rfc-editor.org/rfc/rfc1812.txt section 5.2.2:</span></div>
<div class="line"><span class="comment"> * - The IP version number must be 4.</span></div>
<div class="line"><span class="comment"> * - The IP header length field must be large enough to hold the</span></div>
<div class="line"><span class="comment"> *    minimum length legal IP datagram (20 bytes = 5 words).</span></div>
<div class="line"><span class="comment"> * - The IP total length field must be large enough to hold the IP</span></div>
<div class="line"><span class="comment"> *   datagram header, whose length is specified in the IP header length</span></div>
<div class="line"><span class="comment"> *   field.</span></div>
<div class="line"><span class="comment"> * If we encounter invalid IPV4 packet, then set destination port for it</span></div>
<div class="line"><span class="comment"> * to BAD_PORT value.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((always_inline)) void</div>
<div class="line">rfc1812_process(struct ipv4_hdr *ipv4_hdr, uint32_t *dp, uint32_t ptype)</div>
<div class="line">{</div>
<div class="line">    uint8_t ihl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__mbuf_8h.html#aa9fef8bfc8393b3ece31b60835d46e56">RTE_ETH_IS_IPV4_HDR</a>(ptype)) {</div>
<div class="line">        ihl = ipv4_hdr-&gt;version_ihl - IPV4_MIN_VER_IHL;</div>
<div class="line"></div>
<div class="line">        ipv4_hdr-&gt;time_to_live--;</div>
<div class="line">        ipv4_hdr-&gt;hdr_checksum++;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ihl &gt; IPV4_MAX_VER_IHL_DIFF ||</div>
<div class="line">                ((uint8_t)ipv4_hdr-&gt;total_length == 0 &amp;&amp;</div>
<div class="line">                ipv4_hdr-&gt;total_length &lt; IPV4_MIN_LEN_BE)) {</div>
<div class="line">            dp[0] = BAD_PORT;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define rfc1812_process(mb, dp) do { } while (0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* DO_RFC_1812_CHECKS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* APP_LOOKUP_LPM &amp;&amp; ENABLE_MULTI_BUFFER_OPTIMIZE */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_LPM) &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (ENABLE_MULTI_BUFFER_OPTIMIZE == 1))</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((always_inline)) uint16_t</div>
<div class="line">get_dst_port(struct <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt, uint32_t dst_ipv4, uint8_t portid)</div>
<div class="line">{</div>
<div class="line">    uint32_t next_hop_ipv4;</div>
<div class="line">    uint8_t next_hop_ipv6;</div>
<div class="line">    <span class="keyword">struct </span>ipv6_hdr *ipv6_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__mbuf_8h.html#aa9fef8bfc8393b3ece31b60835d46e56">RTE_ETH_IS_IPV4_HDR</a>(pkt-&gt;packet_type)) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__lpm_8h.html#a1bab3e9f44549b0490a5e2f1e7e21ede">rte_lpm_lookup</a>(<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv4_lookup_struct,</div>
<div class="line">                dst_ipv4, &amp;next_hop_ipv4) != 0) {</div>
<div class="line">            next_hop_ipv4 = portid;</div>
<div class="line">            <span class="keywordflow">return</span> next_hop_ipv4;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rte__mbuf_8h.html#a5fcf594e29330899e40b65755394ba90">RTE_ETH_IS_IPV6_HDR</a>(pkt-&gt;packet_type)) {</div>
<div class="line">        eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">        ipv6_hdr = (<span class="keyword">struct </span>ipv6_hdr *)(eth_hdr + 1);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__lpm6_8h.html#a08d20578eb3f70f25b4b1d6cf4013601">rte_lpm6_lookup</a>(<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv6_lookup_struct,</div>
<div class="line">                ipv6_hdr-&gt;<a name="a45"></a><a class="code" href="structipv6__hdr.html#a25c3a64d5cf7e63211898df5ed65cd22">dst_addr</a>, &amp;next_hop_ipv6) != 0) {</div>
<div class="line">            next_hop_ipv6 = portid;</div>
<div class="line">            <span class="keywordflow">return</span> next_hop_ipv6;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        next_hop_ipv4 = portid;</div>
<div class="line">        <span class="keywordflow">return</span> next_hop_ipv4;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">process_packet(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt, uint32_t *dst_port, uint8_t portid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ipv4_hdr;</div>
<div class="line">    uint32_t dst_ipv4;</div>
<div class="line">    uint16_t dp;</div>
<div class="line">    __m128i te, ve;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)(eth_hdr + 1);</div>
<div class="line"></div>
<div class="line">    dst_ipv4 = ipv4_hdr-&gt;<a name="a46"></a><a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>;</div>
<div class="line">    dst_ipv4 = <a class="code" href="rte__byteorder_8h.html#a980e02d221d693034bc63088d27888f7">rte_be_to_cpu_32</a>(dst_ipv4);</div>
<div class="line">    dp = get_dst_port(pkt, dst_ipv4, portid);</div>
<div class="line"></div>
<div class="line">    te = _mm_load_si128((__m128i *)eth_hdr);</div>
<div class="line">    ve = val_eth[dp];</div>
<div class="line"></div>
<div class="line">    dst_port[0] = dp;</div>
<div class="line">    rfc1812_process(ipv4_hdr, dst_port, pkt-&gt;<a name="a47"></a><a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a>);</div>
<div class="line"></div>
<div class="line">    te =  _mm_blend_epi16(te, ve, MASK_ETH);</div>
<div class="line">    _mm_store_si128((__m128i *)eth_hdr, te);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Read packet_type and destination IPV4 addresses from 4 mbufs.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">processx4_step1(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt[FWDSTEP],</div>
<div class="line">        __m128i *dip,</div>
<div class="line">        uint32_t *ipv4_flag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ipv4_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line">    uint32_t x0, x1, x2, x3;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[0], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)(eth_hdr + 1);</div>
<div class="line">    x0 = ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>;</div>
<div class="line">    ipv4_flag[0] = pkt[0]-&gt;<a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a> &amp; <a name="a48"></a><a class="code" href="rte__mbuf_8h.html#ae381ac5f3d455fe13de25aa809399a60">RTE_PTYPE_L3_IPV4</a>;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[1], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)(eth_hdr + 1);</div>
<div class="line">    x1 = ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>;</div>
<div class="line">    ipv4_flag[0] &amp;= pkt[1]-&gt;<a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a>;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[2], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)(eth_hdr + 1);</div>
<div class="line">    x2 = ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>;</div>
<div class="line">    ipv4_flag[0] &amp;= pkt[2]-&gt;<a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a>;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[3], <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)(eth_hdr + 1);</div>
<div class="line">    x3 = ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#ad3367f6b5057b9c73b012338e5a437ae">dst_addr</a>;</div>
<div class="line">    ipv4_flag[0] &amp;= pkt[3]-&gt;<a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a>;</div>
<div class="line"></div>
<div class="line">    dip[0] = _mm_set_epi32(x3, x2, x1, x0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Lookup into LPM for destination port.</span></div>
<div class="line"><span class="comment"> * If lookup fails, use incoming port (portid) as destination port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">processx4_step2(__m128i dip,</div>
<div class="line">        uint32_t ipv4_flag,</div>
<div class="line">        uint32_t portid,</div>
<div class="line">        <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt[FWDSTEP],</div>
<div class="line">        uint32_t dprt[FWDSTEP])</div>
<div class="line">{</div>
<div class="line">    rte_xmm_t dst;</div>
<div class="line">    <span class="keyword">const</span> __m128i bswap_mask = _mm_set_epi8(12, 13, 14, 15, 8, 9, 10, 11,</div>
<div class="line">            4, 5, 6, 7, 0, 1, 2, 3);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Byte swap 4 IPV4 addresses. */</span></div>
<div class="line">    dip = _mm_shuffle_epi8(dip, bswap_mask);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if all 4 packets are IPV4. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a49"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(ipv4_flag)) {</div>
<div class="line">        <a name="a50"></a><a class="code" href="rte__lpm_8h.html#a865f815f3d2cd706e0dbba3eb70aefcd">rte_lpm_lookupx4</a>(<a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;ipv4_lookup_struct, dip,</div>
<div class="line">                dprt, portid);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        dst.x = dip;</div>
<div class="line">        dprt[0] = get_dst_port(pkt[0], dst.u32[0], portid);</div>
<div class="line">        dprt[1] = get_dst_port(pkt[1], dst.u32[1], portid);</div>
<div class="line">        dprt[2] = get_dst_port(pkt[2], dst.u32[2], portid);</div>
<div class="line">        dprt[3] = get_dst_port(pkt[3], dst.u32[3], portid);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update source and destination MAC addresses in the ethernet header.</span></div>
<div class="line"><span class="comment"> * Perform RFC1812 checks and updates for IPV4 packets.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">processx4_step3(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt[FWDSTEP], uint32_t dst_port[FWDSTEP])</div>
<div class="line">{</div>
<div class="line">    __m128i te[FWDSTEP];</div>
<div class="line">    __m128i ve[FWDSTEP];</div>
<div class="line">    __m128i *p[FWDSTEP];</div>
<div class="line"></div>
<div class="line">    p[0] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[0], __m128i *);</div>
<div class="line">    p[1] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[1], __m128i *);</div>
<div class="line">    p[2] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[2], __m128i *);</div>
<div class="line">    p[3] = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt[3], __m128i *);</div>
<div class="line"></div>
<div class="line">    ve[0] = val_eth[dst_port[0]];</div>
<div class="line">    te[0] = _mm_load_si128(p[0]);</div>
<div class="line"></div>
<div class="line">    ve[1] = val_eth[dst_port[1]];</div>
<div class="line">    te[1] = _mm_load_si128(p[1]);</div>
<div class="line"></div>
<div class="line">    ve[2] = val_eth[dst_port[2]];</div>
<div class="line">    te[2] = _mm_load_si128(p[2]);</div>
<div class="line"></div>
<div class="line">    ve[3] = val_eth[dst_port[3]];</div>
<div class="line">    te[3] = _mm_load_si128(p[3]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Update first 12 bytes, keep rest bytes intact. */</span></div>
<div class="line">    te[0] =  _mm_blend_epi16(te[0], ve[0], MASK_ETH);</div>
<div class="line">    te[1] =  _mm_blend_epi16(te[1], ve[1], MASK_ETH);</div>
<div class="line">    te[2] =  _mm_blend_epi16(te[2], ve[2], MASK_ETH);</div>
<div class="line">    te[3] =  _mm_blend_epi16(te[3], ve[3], MASK_ETH);</div>
<div class="line"></div>
<div class="line">    _mm_store_si128(p[0], te[0]);</div>
<div class="line">    _mm_store_si128(p[1], te[1]);</div>
<div class="line">    _mm_store_si128(p[2], te[2]);</div>
<div class="line">    _mm_store_si128(p[3], te[3]);</div>
<div class="line"></div>
<div class="line">    rfc1812_process((<span class="keyword">struct</span> ipv4_hdr *)((<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *)p[0] + 1),</div>
<div class="line">            &amp;dst_port[0], pkt[0]-&gt;packet_type);</div>
<div class="line">    rfc1812_process((<span class="keyword">struct</span> ipv4_hdr *)((<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *)p[1] + 1),</div>
<div class="line">            &amp;dst_port[1], pkt[1]-&gt;packet_type);</div>
<div class="line">    rfc1812_process((<span class="keyword">struct</span> ipv4_hdr *)((<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *)p[2] + 1),</div>
<div class="line">            &amp;dst_port[2], pkt[2]-&gt;packet_type);</div>
<div class="line">    rfc1812_process((<span class="keyword">struct</span> ipv4_hdr *)((<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *)p[3] + 1),</div>
<div class="line">            &amp;dst_port[3], pkt[3]-&gt;packet_type);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * We group consecutive packets with the same destionation port into one burst.</span></div>
<div class="line"><span class="comment"> * To avoid extra latency this is done together with some other packet</span></div>
<div class="line"><span class="comment"> * processing, but after we made a final decision about packet&#39;s destination.</span></div>
<div class="line"><span class="comment"> * To do this we maintain:</span></div>
<div class="line"><span class="comment"> * pnum - array of number of consecutive packets with the same dest port for</span></div>
<div class="line"><span class="comment"> * each packet in the input burst.</span></div>
<div class="line"><span class="comment"> * lp - pointer to the last updated element in the pnum.</span></div>
<div class="line"><span class="comment"> * dlp - dest port value lp corresponds to.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define GRPSZ   (1 &lt;&lt; FWDSTEP)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define GRPMSK  (GRPSZ - 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define GROUP_PORT_STEP(dlp, dcp, lp, pn, idx)  do { \</span></div>
<div class="line"><span class="preprocessor">    if (likely((dlp) == (dcp)[(idx)])) {         \</span></div>
<div class="line"><span class="preprocessor">        (lp)[0]++;                           \</span></div>
<div class="line"><span class="preprocessor">    } else {                                     \</span></div>
<div class="line"><span class="preprocessor">        (dlp) = (dcp)[idx];                  \</span></div>
<div class="line"><span class="preprocessor">        (lp) = (pn) + (idx);                 \</span></div>
<div class="line"><span class="preprocessor">        (lp)[0] = 1;                         \</span></div>
<div class="line"><span class="preprocessor">    }                                            \</span></div>
<div class="line"><span class="preprocessor">} while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Group consecutive packets with the same destination port in bursts of 4.</span></div>
<div class="line"><span class="comment"> * Suppose we have array of destionation ports:</span></div>
<div class="line"><span class="comment"> * dst_port[] = {a, b, c, d,, e, ... }</span></div>
<div class="line"><span class="comment"> * dp1 should contain: &lt;a, b, c, d&gt;, dp2: &lt;b, c, d, e&gt;.</span></div>
<div class="line"><span class="comment"> * We doing 4 comparisions at once and the result is 4 bit mask.</span></div>
<div class="line"><span class="comment"> * This mask is used as an index into prebuild array of pnum values.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint16_t *</div>
<div class="line">port_groupx4(uint16_t pn[FWDSTEP + 1], uint16_t *lp, __m128i dp1, __m128i dp2)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>{</div>
<div class="line">        uint64_t pnum; <span class="comment">/* prebuild 4 values for pnum[]. */</span></div>
<div class="line">        int32_t  idx;  <span class="comment">/* index for new last updated elemnet. */</span></div>
<div class="line">        uint16_t lpv;  <span class="comment">/* add value to the last updated element. */</span></div>
<div class="line">    } gptbl[GRPSZ] = {</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0: a != b, b != c, c != d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000100010001),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 1: a == b, b != c, c != d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000100010002),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 1,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 2: a != b, b == c, c != d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000100020001),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 3: a == b, b == c, c != d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000100020003),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 2,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 4: a != b, b != c, c == d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000200010001),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 5: a == b, b != c, c == d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000200010002),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 1,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 6: a != b, b == c, c == d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000200030001),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 7: a == b, b == c, c == d, d != e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0001000200030004),</div>
<div class="line">        .idx = 4,</div>
<div class="line">        .lpv = 3,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 8: a != b, b != c, c != d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000100010001),</div>
<div class="line">        .idx = 3,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 9: a == b, b != c, c != d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000100010002),</div>
<div class="line">        .idx = 3,</div>
<div class="line">        .lpv = 1,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xa: a != b, b == c, c != d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000100020001),</div>
<div class="line">        .idx = 3,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xb: a == b, b == c, c != d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000100020003),</div>
<div class="line">        .idx = 3,</div>
<div class="line">        .lpv = 2,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xc: a != b, b != c, c == d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000300010001),</div>
<div class="line">        .idx = 2,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xd: a == b, b != c, c == d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000300010002),</div>
<div class="line">        .idx = 2,</div>
<div class="line">        .lpv = 1,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xe: a != b, b == c, c == d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000300040001),</div>
<div class="line">        .idx = 1,</div>
<div class="line">        .lpv = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* 0xf: a == b, b == c, c == d, d == e */</span></div>
<div class="line">        .pnum = UINT64_C(0x0002000300040005),</div>
<div class="line">        .idx = 0,</div>
<div class="line">        .lpv = 4,</div>
<div class="line">    },</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keyword">union </span>{</div>
<div class="line">        uint16_t u16[FWDSTEP + 1];</div>
<div class="line">        uint64_t u64;</div>
<div class="line">    } *pnum = (<span class="keywordtype">void</span> *)pn;</div>
<div class="line"></div>
<div class="line">    int32_t v;</div>
<div class="line"></div>
<div class="line">    dp1 = _mm_cmpeq_epi16(dp1, dp2);</div>
<div class="line">    dp1 = _mm_unpacklo_epi16(dp1, dp1);</div>
<div class="line">    v = _mm_movemask_ps((__m128)dp1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* update last port counter. */</span></div>
<div class="line">    lp[0] += gptbl[v].lpv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if dest port value has changed. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (v != GRPMSK) {</div>
<div class="line">        lp = pnum-&gt;u16 + gptbl[v].idx;</div>
<div class="line">        lp[0] = 1;</div>
<div class="line">        pnum-&gt;u64 = gptbl[v].pnum;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> lp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_LOOKUP_METHOD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">process_burst(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST], <span class="keywordtype">int</span> nb_rx,</div>
<div class="line">        uint8_t portid) {</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> j;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ((APP_LOOKUP_METHOD == APP_LOOKUP_LPM) &amp;&amp; \</span></div>
<div class="line"><span class="preprocessor">    (ENABLE_MULTI_BUFFER_OPTIMIZE == 1))</span></div>
<div class="line"><span class="preprocessor"></span>    int32_t k;</div>
<div class="line">    uint16_t dlp;</div>
<div class="line">    uint16_t *lp;</div>
<div class="line">    uint32_t dst_port[MAX_PKT_BURST];</div>
<div class="line">    __m128i dip[MAX_PKT_BURST / FWDSTEP];</div>
<div class="line">    uint32_t ipv4_flag[MAX_PKT_BURST / FWDSTEP];</div>
<div class="line">    uint16_t pnum[MAX_PKT_BURST + 1];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (ENABLE_MULTI_BUFFER_OPTIMIZE == 1)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span>    {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Send nb_rx - nb_rx%8 packets</span></div>
<div class="line"><span class="comment">         * in groups of 8.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        int32_t n = <a name="a51"></a><a class="code" href="rte__common_8h.html#a678a75ecaff653f4479cf2da04c843da">RTE_ALIGN_FLOOR</a>(nb_rx, 8);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; n; j += 8) {</div>
<div class="line">            uint32_t pkt_type =</div>
<div class="line">                pkts_burst[j]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+1]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+2]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+3]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+4]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+5]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+6]-&gt;packet_type &amp;</div>
<div class="line">                pkts_burst[j+7]-&gt;packet_type;</div>
<div class="line">            <span class="keywordflow">if</span> (pkt_type &amp; <a class="code" href="rte__mbuf_8h.html#ae381ac5f3d455fe13de25aa809399a60">RTE_PTYPE_L3_IPV4</a>) {</div>
<div class="line">                simple_ipv4_fwd_8pkts(&amp;pkts_burst[j], portid);</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkt_type &amp;</div>
<div class="line">                <a name="a52"></a><a class="code" href="rte__mbuf_8h.html#a44e077cfdb3846a3ca63c5039586b9e5">RTE_PTYPE_L3_IPV6</a>) {</div>
<div class="line">                simple_ipv6_fwd_8pkts(&amp;pkts_burst[j], portid);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+1], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+2], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+3], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+4], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+5], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+6], portid);</div>
<div class="line">                l3fwd_simple_forward(pkts_burst[j+7], portid);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (; j &lt; nb_rx ; j++)</div>
<div class="line">            l3fwd_simple_forward(pkts_burst[j], portid);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#elif (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    k = <a class="code" href="rte__common_8h.html#a678a75ecaff653f4479cf2da04c843da">RTE_ALIGN_FLOOR</a>(nb_rx, FWDSTEP);</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j != k; j += FWDSTEP)</div>
<div class="line">        processx4_step1(&amp;pkts_burst[j], &amp;dip[j / FWDSTEP],</div>
<div class="line">                &amp;ipv4_flag[j / FWDSTEP]);</div>
<div class="line"></div>
<div class="line">    k = <a class="code" href="rte__common_8h.html#a678a75ecaff653f4479cf2da04c843da">RTE_ALIGN_FLOOR</a>(nb_rx, FWDSTEP);</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j != k; j += FWDSTEP)</div>
<div class="line">        processx4_step2(dip[j / FWDSTEP], ipv4_flag[j / FWDSTEP],</div>
<div class="line">                portid, &amp;pkts_burst[j], &amp;dst_port[j]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Finish packet processing and group consecutive</span></div>
<div class="line"><span class="comment">     * packets with the same destination port.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    k = <a class="code" href="rte__common_8h.html#a678a75ecaff653f4479cf2da04c843da">RTE_ALIGN_FLOOR</a>(nb_rx, FWDSTEP);</div>
<div class="line">    <span class="keywordflow">if</span> (k != 0) {</div>
<div class="line">        __m128i dp1, dp2;</div>
<div class="line"></div>
<div class="line">        lp = pnum;</div>
<div class="line">        lp[0] = 1;</div>
<div class="line"></div>
<div class="line">        processx4_step3(pkts_burst, dst_port);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* dp1: &lt;d[0], d[1], d[2], d[3], ... &gt; */</span></div>
<div class="line">        dp1 = _mm_loadu_si128((__m128i *)dst_port);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (j = FWDSTEP; j != k; j += FWDSTEP) {</div>
<div class="line">            processx4_step3(&amp;pkts_burst[j], &amp;dst_port[j]);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * dp2:</span></div>
<div class="line"><span class="comment">             * &lt;d[j-3], d[j-2], d[j-1], d[j], ... &gt;</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            dp2 = _mm_loadu_si128(</div>
<div class="line">                    (__m128i *)&amp;dst_port[j - FWDSTEP + 1]);</div>
<div class="line">            lp  = port_groupx4(&amp;pnum[j - FWDSTEP], lp, dp1, dp2);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * dp1:</span></div>
<div class="line"><span class="comment">             * &lt;d[j], d[j+1], d[j+2], d[j+3], ... &gt;</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            dp1 = _mm_srli_si128(dp2, (FWDSTEP - 1) *</div>
<div class="line">                    <span class="keyword">sizeof</span>(dst_port[0]));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * dp2: &lt;d[j-3], d[j-2], d[j-1], d[j-1], ... &gt;</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        dp2 = _mm_shufflelo_epi16(dp1, 0xf9);</div>
<div class="line">        lp  = port_groupx4(&amp;pnum[j - FWDSTEP], lp, dp1, dp2);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * remove values added by the last repeated</span></div>
<div class="line"><span class="comment">         * dst port.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        lp[0]--;</div>
<div class="line">        dlp = dst_port[j - 1];</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">/* set dlp and lp to the never used values. */</span></div>
<div class="line">        dlp = BAD_PORT - 1;</div>
<div class="line">        lp = pnum + MAX_PKT_BURST;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Process up to last 3 packets one by one. */</span></div>
<div class="line">    <span class="keywordflow">switch</span> (nb_rx % FWDSTEP) {</div>
<div class="line">    <span class="keywordflow">case</span> 3:</div>
<div class="line">        process_packet(pkts_burst[j], dst_port + j, portid);</div>
<div class="line">        GROUP_PORT_STEP(dlp, dst_port, lp, pnum, j);</div>
<div class="line">        j++;</div>
<div class="line">    <span class="keywordflow">case</span> 2:</div>
<div class="line">        process_packet(pkts_burst[j], dst_port + j, portid);</div>
<div class="line">        GROUP_PORT_STEP(dlp, dst_port, lp, pnum, j);</div>
<div class="line">        j++;</div>
<div class="line">    <span class="keywordflow">case</span> 1:</div>
<div class="line">        process_packet(pkts_burst[j], dst_port + j, portid);</div>
<div class="line">        GROUP_PORT_STEP(dlp, dst_port, lp, pnum, j);</div>
<div class="line">        j++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Send packets out, through destination port.</span></div>
<div class="line"><span class="comment">     * Consecuteve pacekts with the same destination port</span></div>
<div class="line"><span class="comment">     * are already grouped together.</span></div>
<div class="line"><span class="comment">     * If destination port for the packet equals BAD_PORT,</span></div>
<div class="line"><span class="comment">     * then free the packet without sending it out.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; nb_rx; j += k) {</div>
<div class="line"></div>
<div class="line">        int32_t m;</div>
<div class="line">        uint16_t pn;</div>
<div class="line"></div>
<div class="line">        pn = dst_port[j];</div>
<div class="line">        k = pnum[j];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(pn != BAD_PORT))</div>
<div class="line">            send_packetsx4(pn, pkts_burst + j, k);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">for</span> (m = j; m != j + k; m++)</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[m]);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_LOOKUP_METHOD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* ENABLE_MULTI_BUFFER_OPTIMIZE == 0 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* Prefetch first packets */</span></div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; PREFETCH_OFFSET &amp;&amp; j &lt; nb_rx; j++)</div>
<div class="line">        <a name="a53"></a><a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkts_burst[j], <span class="keywordtype">void</span> *));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Prefetch and forward already prefetched packets */</span></div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; (nb_rx - PREFETCH_OFFSET); j++) {</div>
<div class="line">        <a class="code" href="rte__prefetch_8h.html#a7f89cf66766e6bfd63feb370a7280de9">rte_prefetch0</a>(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkts_burst[</div>
<div class="line">                j + PREFETCH_OFFSET], <span class="keywordtype">void</span> *));</div>
<div class="line">        l3fwd_simple_forward(pkts_burst[j], portid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Forward remaining prefetched packets */</span></div>
<div class="line">    <span class="keywordflow">for</span> (; j &lt; nb_rx; j++)</div>
<div class="line">        l3fwd_simple_forward(pkts_burst[j], portid);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* ENABLE_MULTI_BUFFER_OPTIMIZE */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * CPU-load stats collector</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_load_collector(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, j, k;</div>
<div class="line">    uint64_t hits;</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc;</div>
<div class="line">    uint64_t total[MAX_CPU] = { 0 };</div>
<div class="line">    <span class="keywordtype">unsigned</span> min_cpu = MAX_CPU;</div>
<div class="line">    <span class="keywordtype">unsigned</span> max_cpu = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> cpu_id;</div>
<div class="line">    <span class="keywordtype">int</span> busy_total = 0;</div>
<div class="line">    <span class="keywordtype">int</span> busy_flag = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_thread_per_cpu[MAX_CPU] = { 0 };</div>
<div class="line">    <span class="keyword">struct </span>thread_conf *thread_per_cpu[MAX_CPU][MAX_THREAD];</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>thread_conf *thread_conf;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> uint64_t interval_tsc = (<a name="a54"></a><a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1) /</div>
<div class="line">        US_PER_S * CPU_LOAD_TIMEOUT_US;</div>
<div class="line"></div>
<div class="line">    prev_tsc = 0;</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Wait for all threads</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Waiting for %d rx threads and %d tx threads\n&quot;</span>, n_rx_thread,</div>
<div class="line">            n_tx_thread);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a55"></a><a class="code" href="rte__atomic_8h.html#abf8058eb8021112818597b328c58abbc">rte_atomic16_read</a>(&amp;rx_counter) &lt; n_rx_thread)</div>
<div class="line">        rte_pause();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="rte__atomic_8h.html#abf8058eb8021112818597b328c58abbc">rte_atomic16_read</a>(&amp;tx_counter) &lt; n_tx_thread)</div>
<div class="line">        rte_pause();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_rx_thread; i++) {</div>
<div class="line"></div>
<div class="line">        thread_conf = &amp;rx_thread[i].conf;</div>
<div class="line">        cpu_id = thread_conf-&gt;cpu_id;</div>
<div class="line">        thread_per_cpu[cpu_id][n_thread_per_cpu[cpu_id]++] = thread_conf;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (cpu_id &gt; max_cpu)</div>
<div class="line">            max_cpu = cpu_id;</div>
<div class="line">        <span class="keywordflow">if</span> (cpu_id &lt; min_cpu)</div>
<div class="line">            min_cpu = cpu_id;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_tx_thread; i++) {</div>
<div class="line"></div>
<div class="line">        thread_conf = &amp;tx_thread[i].conf;</div>
<div class="line">        cpu_id = thread_conf-&gt;cpu_id;</div>
<div class="line">        thread_per_cpu[cpu_id][n_thread_per_cpu[cpu_id]++] = thread_conf;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (thread_conf-&gt;cpu_id &gt; max_cpu)</div>
<div class="line">            max_cpu = thread_conf-&gt;cpu_id;</div>
<div class="line">        <span class="keywordflow">if</span> (thread_conf-&gt;cpu_id &lt; min_cpu)</div>
<div class="line">            min_cpu = thread_conf-&gt;cpu_id;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        cpu_load.counter++;</div>
<div class="line">        <span class="keywordflow">for</span> (i = min_cpu; i &lt;= max_cpu; i++) {</div>
<div class="line">            <span class="keywordflow">for</span> (j = 0; j &lt; MAX_CPU_COUNTER; j++) {</div>
<div class="line">                <span class="keywordflow">for</span> (k = 0; k &lt; n_thread_per_cpu[i]; k++)</div>
<div class="line">                    <span class="keywordflow">if</span> (thread_per_cpu[i][k]-&gt;busy[j]) {</div>
<div class="line">                        busy_flag = 1;</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                <span class="keywordflow">if</span> (busy_flag) {</div>
<div class="line">                    cpu_load.hits[j][i]++;</div>
<div class="line">                    busy_total = 1;</div>
<div class="line">                    busy_flag = 0;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (busy_total) {</div>
<div class="line">                total[i]++;</div>
<div class="line">                busy_total = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line"></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; interval_tsc)) {</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;\033c&quot;</span>);</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;Cpu usage for %d rx threads and %d tx threads:\n\n&quot;</span>,</div>
<div class="line">                    n_rx_thread, n_tx_thread);</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;cpu#     proc%%  poll%%  overhead%%\n\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (i = min_cpu; i &lt;= max_cpu; i++) {</div>
<div class="line">                hits = 0;</div>
<div class="line">                printf(<span class="stringliteral">&quot;CPU %d:&quot;</span>, i);</div>
<div class="line">                <span class="keywordflow">for</span> (j = 0; j &lt; MAX_CPU_COUNTER; j++) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;%7&quot;</span> PRIu64 <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                            cpu_load.hits[j][i] * 100 / cpu_load.counter);</div>
<div class="line">                    hits += cpu_load.hits[j][i];</div>
<div class="line">                    cpu_load.hits[j][i] = 0;</div>
<div class="line">                }</div>
<div class="line">                printf(<span class="stringliteral">&quot;%7&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                        100 - total[i] * 100 / cpu_load.counter);</div>
<div class="line">                total[i] = 0;</div>
<div class="line">            }</div>
<div class="line">            cpu_load.counter = 0;</div>
<div class="line"></div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_CPU_LOAD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Null processing lthread loop</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This loop is used to start empty scheduler on lcore.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lthread_null(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore_id = <a name="a56"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    <a name="a57"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;Starting scheduler on lcore %d.\n&quot;</span>, lcore_id);</div>
<div class="line">    lthread_exit(NULL);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* main processing loop */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lthread_tx_per_ring(<span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> nb_rx;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ring.html">rte_ring</a> *ring;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *tx_conf;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>lthread_cond *ready;</div>
<div class="line"></div>
<div class="line">    tx_conf = (<span class="keyword">struct </span>thread_tx_conf *)dummy;</div>
<div class="line">    ring = tx_conf-&gt;ring;</div>
<div class="line">    ready = *tx_conf-&gt;ready;</div>
<div class="line"></div>
<div class="line">    lthread_set_data((<span class="keywordtype">void</span> *)tx_conf);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Move this lthread to lcore</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    lthread_set_affinity(tx_conf-&gt;conf.lcore_id);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;entering main tx loop on lcore %u\n&quot;</span>, <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"></div>
<div class="line">    nb_rx = 0;</div>
<div class="line">    <a name="a58"></a><a class="code" href="rte__atomic_8h.html#af291028467bd82dad7b9230d4c92d938">rte_atomic16_inc</a>(&amp;tx_counter);</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Read packet from ring</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        SET_CPU_BUSY(tx_conf, CPU_POLL);</div>
<div class="line">        nb_rx = <a name="a59"></a><a class="code" href="rte__ring_8h.html#a0bdbfc074c1af23cf7e117437ac7f5f5">rte_ring_sc_dequeue_burst</a>(ring, (<span class="keywordtype">void</span> **)pkts_burst,</div>
<div class="line">                MAX_PKT_BURST);</div>
<div class="line">        SET_CPU_IDLE(tx_conf, CPU_POLL);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (nb_rx &gt; 0) {</div>
<div class="line">            SET_CPU_BUSY(tx_conf, CPU_PROCESS);</div>
<div class="line">            portid = pkts_burst[0]-&gt;<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line">            process_burst(pkts_burst, nb_rx, portid);</div>
<div class="line">            SET_CPU_IDLE(tx_conf, CPU_PROCESS);</div>
<div class="line">            lthread_yield();</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            lthread_cond_wait(ready, 0);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main tx-lthreads spawner lthread.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This lthread is used to spawn one new lthread per ring from producers.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lthread_tx(<span class="keywordtype">void</span> *args)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>lthread *lt;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *tx_conf;</div>
<div class="line"></div>
<div class="line">    tx_conf = (<span class="keyword">struct </span>thread_tx_conf *)args;</div>
<div class="line">    lthread_set_data((<span class="keywordtype">void</span> *)tx_conf);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Move this lthread to the selected lcore</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    lthread_set_affinity(tx_conf-&gt;conf.lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Spawn tx readers (one per input ring)</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    lthread_create(&amp;lt, tx_conf-&gt;conf.lcore_id, lthread_tx_per_ring,</div>
<div class="line">            (<span class="keywordtype">void</span> *)tx_conf);</div>
<div class="line"></div>
<div class="line">    lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;Entering Tx main loop on lcore %u\n&quot;</span>, lcore_id);</div>
<div class="line"></div>
<div class="line">    tx_conf-&gt;conf.cpu_id = sched_getcpu();</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        lthread_sleep(BURST_TX_DRAIN_US * 1000);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * TX burst queue drain</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">for</span> (portid = 0; portid &lt; RTE_MAX_ETHPORTS; portid++) {</div>
<div class="line">            <span class="keywordflow">if</span> (tx_conf-&gt;tx_mbufs[portid].len == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            SET_CPU_BUSY(tx_conf, CPU_PROCESS);</div>
<div class="line">            send_burst(tx_conf, tx_conf-&gt;tx_mbufs[portid].len, portid);</div>
<div class="line">            SET_CPU_IDLE(tx_conf, CPU_PROCESS);</div>
<div class="line">            tx_conf-&gt;tx_mbufs[portid].len = 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lthread_rx(<span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint16_t nb_rx;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    uint8_t portid, queueid;</div>
<div class="line">    <span class="keywordtype">int</span> worker_id;</div>
<div class="line">    <span class="keywordtype">int</span> len[RTE_MAX_LCORE] = { 0 };</div>
<div class="line">    <span class="keywordtype">int</span> old_len, new_len;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    <span class="keyword">struct </span>thread_rx_conf *rx_conf;</div>
<div class="line"></div>
<div class="line">    rx_conf = (<span class="keyword">struct </span>thread_rx_conf *)dummy;</div>
<div class="line">    lthread_set_data((<span class="keywordtype">void</span> *)rx_conf);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Move this lthread to lcore</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    lthread_set_affinity(rx_conf-&gt;conf.lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rx_conf-&gt;n_rx_queue == 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;lcore %u has nothing to do\n&quot;</span>, <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;Entering main Rx loop on lcore %u\n&quot;</span>, <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_conf-&gt;n_rx_queue; i++) {</div>
<div class="line"></div>
<div class="line">        portid = rx_conf-&gt;rx_queue_list[i].port_id;</div>
<div class="line">        queueid = rx_conf-&gt;rx_queue_list[i].queue_id;</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot; -- lcoreid=%u portid=%hhu rxqueueid=%hhu\n&quot;</span>,</div>
<div class="line">                <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>(), portid, queueid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Init all condition variables (one per rx thread)</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_conf-&gt;n_rx_queue; i++)</div>
<div class="line">        lthread_cond_init(NULL, &amp;rx_conf-&gt;ready[i], NULL);</div>
<div class="line"></div>
<div class="line">    worker_id = 0;</div>
<div class="line"></div>
<div class="line">    rx_conf-&gt;conf.cpu_id = sched_getcpu();</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#af291028467bd82dad7b9230d4c92d938">rte_atomic16_inc</a>(&amp;rx_counter);</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Read packet from RX queues</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; rx_conf-&gt;n_rx_queue; ++i) {</div>
<div class="line">            portid = rx_conf-&gt;rx_queue_list[i].port_id;</div>
<div class="line">            queueid = rx_conf-&gt;rx_queue_list[i].queue_id;</div>
<div class="line"></div>
<div class="line">            SET_CPU_BUSY(rx_conf, CPU_POLL);</div>
<div class="line">            nb_rx = <a name="a60"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(portid, queueid, pkts_burst,</div>
<div class="line">                MAX_PKT_BURST);</div>
<div class="line">            SET_CPU_IDLE(rx_conf, CPU_POLL);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (nb_rx != 0) {</div>
<div class="line">                worker_id = (worker_id + 1) % rx_conf-&gt;n_ring;</div>
<div class="line">                old_len = len[worker_id];</div>
<div class="line"></div>
<div class="line">                SET_CPU_BUSY(rx_conf, CPU_PROCESS);</div>
<div class="line">                ret = <a name="a61"></a><a class="code" href="rte__ring_8h.html#ad8bf9c28ffd98485abed7445c4d6ab07">rte_ring_sp_enqueue_burst</a>(</div>
<div class="line">                        rx_conf-&gt;ring[worker_id],</div>
<div class="line">                        (<span class="keywordtype">void</span> **) pkts_burst,</div>
<div class="line">                        nb_rx);</div>
<div class="line"></div>
<div class="line">                new_len = old_len + ret;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (new_len &gt;= BURST_SIZE) {</div>
<div class="line">                    lthread_cond_signal(rx_conf-&gt;ready[worker_id]);</div>
<div class="line">                    new_len = 0;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                len[worker_id] = new_len;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; nb_rx)) {</div>
<div class="line">                    uint32_t k;</div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">for</span> (k = ret; k &lt; nb_rx; k++) {</div>
<div class="line">                        <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = pkts_burst[k];</div>
<div class="line"></div>
<div class="line">                        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                SET_CPU_IDLE(rx_conf, CPU_PROCESS);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            lthread_yield();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Start scheduler with initial lthread on lcore</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This lthread loop spawns all rx and tx lthreads on master lcore</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lthread_spawner(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keyword">struct </span>lthread *lt[MAX_THREAD];</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> n_thread = 0;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Entering lthread_spawner\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Create producers (rx threads) on default lcore</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_rx_thread; i++) {</div>
<div class="line">        rx_thread[i].conf.thread_id = i;</div>
<div class="line">        lthread_create(&amp;lt[n_thread], -1, lthread_rx,</div>
<div class="line">                (<span class="keywordtype">void</span> *)&amp;rx_thread[i]);</div>
<div class="line">        n_thread++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Wait for all producers. Until some producers can be started on the same</span></div>
<div class="line"><span class="comment">     * scheduler as this lthread, yielding is required to let them to run and</span></div>
<div class="line"><span class="comment">     * prevent deadlock here.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="rte__atomic_8h.html#abf8058eb8021112818597b328c58abbc">rte_atomic16_read</a>(&amp;rx_counter) &lt; n_rx_thread)</div>
<div class="line">        lthread_sleep(100000);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Create consumers (tx threads) on default lcore_id</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_tx_thread; i++) {</div>
<div class="line">        tx_thread[i].conf.thread_id = i;</div>
<div class="line">        lthread_create(&amp;lt[n_thread], -1, lthread_tx,</div>
<div class="line">                (<span class="keywordtype">void</span> *)&amp;tx_thread[i]);</div>
<div class="line">        n_thread++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Wait for all threads finished</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_thread; i++)</div>
<div class="line">        lthread_join(lt[i], NULL);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Start master scheduler with initial lthread spawning rx and tx lthreads</span></div>
<div class="line"><span class="comment"> * (main_lthread_master).</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">lthread_master_spawner(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keyword">struct </span>lthread *lt;</div>
<div class="line">    <span class="keywordtype">int</span> lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf) = &amp;lcore_conf[lcore_id];</div>
<div class="line">    lthread_create(&amp;lt, -1, lthread_spawner, NULL);</div>
<div class="line">    lthread_run();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Start scheduler on lcore.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">sched_spawner(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keyword">struct </span>lthread *lt;</div>
<div class="line">    <span class="keywordtype">int</span> lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (lcore_id == cpu_load_lcore_id) {</div>
<div class="line">        cpu_load_collector(arg);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_CPU_LOAD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf) = &amp;lcore_conf[lcore_id];</div>
<div class="line">    lthread_create(&amp;lt, -1, lthread_null, NULL);</div>
<div class="line">    lthread_run();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* main processing loop */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pthread_tx(<span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line">    uint64_t prev_tsc, diff_tsc, cur_tsc;</div>
<div class="line">    <span class="keywordtype">int</span> nb_rx;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *tx_conf;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> uint64_t drain_tsc = (<a class="code" href="rte__cycles_8h.html#ae016e608f344823e677819d8f04264c5">rte_get_tsc_hz</a>() + US_PER_S - 1) /</div>
<div class="line">        US_PER_S * BURST_TX_DRAIN_US;</div>
<div class="line"></div>
<div class="line">    prev_tsc = 0;</div>
<div class="line"></div>
<div class="line">    tx_conf = (<span class="keyword">struct </span>thread_tx_conf *)dummy;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;Entering main Tx loop on lcore %u\n&quot;</span>, <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"></div>
<div class="line">    tx_conf-&gt;conf.cpu_id = sched_getcpu();</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#af291028467bd82dad7b9230d4c92d938">rte_atomic16_inc</a>(&amp;tx_counter);</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        cur_tsc = rte_rdtsc();</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * TX burst queue drain</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        diff_tsc = cur_tsc - prev_tsc;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(diff_tsc &gt; drain_tsc)) {</div>
<div class="line"></div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * This could be optimized (use queueid instead of</span></div>
<div class="line"><span class="comment">             * portid), but it is not called so often</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            SET_CPU_BUSY(tx_conf, CPU_PROCESS);</div>
<div class="line">            <span class="keywordflow">for</span> (portid = 0; portid &lt; RTE_MAX_ETHPORTS; portid++) {</div>
<div class="line">                <span class="keywordflow">if</span> (tx_conf-&gt;tx_mbufs[portid].len == 0)</div>
<div class="line">                    <span class="keywordflow">continue</span>;</div>
<div class="line">                send_burst(tx_conf, tx_conf-&gt;tx_mbufs[portid].len, portid);</div>
<div class="line">                tx_conf-&gt;tx_mbufs[portid].len = 0;</div>
<div class="line">            }</div>
<div class="line">            SET_CPU_IDLE(tx_conf, CPU_PROCESS);</div>
<div class="line"></div>
<div class="line">            prev_tsc = cur_tsc;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Read packet from ring</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        SET_CPU_BUSY(tx_conf, CPU_POLL);</div>
<div class="line">        nb_rx = <a class="code" href="rte__ring_8h.html#a0bdbfc074c1af23cf7e117437ac7f5f5">rte_ring_sc_dequeue_burst</a>(tx_conf-&gt;ring,</div>
<div class="line">                (<span class="keywordtype">void</span> **)pkts_burst, MAX_PKT_BURST);</div>
<div class="line">        SET_CPU_IDLE(tx_conf, CPU_POLL);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(nb_rx == 0)) {</div>
<div class="line">            sched_yield();</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        SET_CPU_BUSY(tx_conf, CPU_PROCESS);</div>
<div class="line">        portid = pkts_burst[0]-&gt;<a class="code" href="structrte__mbuf.html#a2fa54f9024782843172506fadbee2ac8">port</a>;</div>
<div class="line">        process_burst(pkts_burst, nb_rx, portid);</div>
<div class="line">        SET_CPU_IDLE(tx_conf, CPU_PROCESS);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pthread_rx(<span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> worker_id;</div>
<div class="line">    uint32_t n;</div>
<div class="line">    uint32_t nb_rx;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line">    uint8_t portid, queueid;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>thread_rx_conf *rx_conf;</div>
<div class="line"></div>
<div class="line">    lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    rx_conf = (<span class="keyword">struct </span>thread_rx_conf *)dummy;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rx_conf-&gt;n_rx_queue == 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;lcore %u has nothing to do\n&quot;</span>, lcore_id);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot;entering main rx loop on lcore %u\n&quot;</span>, lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_conf-&gt;n_rx_queue; i++) {</div>
<div class="line"></div>
<div class="line">        portid = rx_conf-&gt;rx_queue_list[i].port_id;</div>
<div class="line">        queueid = rx_conf-&gt;rx_queue_list[i].queue_id;</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, L3FWD, <span class="stringliteral">&quot; -- lcoreid=%u portid=%hhu rxqueueid=%hhu\n&quot;</span>,</div>
<div class="line">                lcore_id, portid, queueid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    worker_id = 0;</div>
<div class="line">    rx_conf-&gt;conf.cpu_id = sched_getcpu();</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#af291028467bd82dad7b9230d4c92d938">rte_atomic16_inc</a>(&amp;rx_counter);</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Read packet from RX queues</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; rx_conf-&gt;n_rx_queue; ++i) {</div>
<div class="line">            portid = rx_conf-&gt;rx_queue_list[i].port_id;</div>
<div class="line">            queueid = rx_conf-&gt;rx_queue_list[i].queue_id;</div>
<div class="line"></div>
<div class="line">            SET_CPU_BUSY(rx_conf, CPU_POLL);</div>
<div class="line">            nb_rx = <a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(portid, queueid, pkts_burst,</div>
<div class="line">                MAX_PKT_BURST);</div>
<div class="line">            SET_CPU_IDLE(rx_conf, CPU_POLL);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (nb_rx == 0) {</div>
<div class="line">                sched_yield();</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            SET_CPU_BUSY(rx_conf, CPU_PROCESS);</div>
<div class="line">            worker_id = (worker_id + 1) % rx_conf-&gt;n_ring;</div>
<div class="line">            n = <a class="code" href="rte__ring_8h.html#ad8bf9c28ffd98485abed7445c4d6ab07">rte_ring_sp_enqueue_burst</a>(rx_conf-&gt;ring[worker_id],</div>
<div class="line">                    (<span class="keywordtype">void</span> **)pkts_burst, nb_rx);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(n != nb_rx)) {</div>
<div class="line">                uint32_t k;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">for</span> (k = n; k &lt; nb_rx; k++) {</div>
<div class="line">                    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = pkts_burst[k];</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            SET_CPU_IDLE(rx_conf, CPU_PROCESS);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * P-Thread spawner.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">pthread_run(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keywordtype">int</span> lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_rx_thread; i++)</div>
<div class="line">        <span class="keywordflow">if</span> (rx_thread[i].conf.lcore_id == lcore_id) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Start rx thread on %d...\n&quot;</span>, lcore_id);</div>
<div class="line">            <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf) = &amp;lcore_conf[lcore_id];</div>
<div class="line">            <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;data = (<span class="keywordtype">void</span> *)&amp;rx_thread[i];</div>
<div class="line">            pthread_rx((<span class="keywordtype">void</span> *)&amp;rx_thread[i]);</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_tx_thread; i++)</div>
<div class="line">        <span class="keywordflow">if</span> (tx_thread[i].conf.lcore_id == lcore_id) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Start tx thread on %d...\n&quot;</span>, lcore_id);</div>
<div class="line">            <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf) = &amp;lcore_conf[lcore_id];</div>
<div class="line">            <a class="code" href="rte__per__lcore_8h.html#a141e0f71c3187ebcc6cfdfdfeaa81842">RTE_PER_LCORE</a>(lcore_conf)-&gt;data = (<span class="keywordtype">void</span> *)&amp;tx_thread[i];</div>
<div class="line">            pthread_tx((<span class="keywordtype">void</span> *)&amp;tx_thread[i]);</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD)</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">if</span> (lcore_id == cpu_load_lcore_id)</div>
<div class="line">        cpu_load_collector(arg);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_CPU_LOAD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">check_lcore_params(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint8_t queue, lcore;</div>
<div class="line">    uint16_t i;</div>
<div class="line">    <span class="keywordtype">int</span> socketid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_rx_thread_params; ++i) {</div>
<div class="line">        queue = rx_thread_params[i].queue_id;</div>
<div class="line">        <span class="keywordflow">if</span> (queue &gt;= MAX_RX_QUEUE_PER_PORT) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;invalid queue number: %hhu\n&quot;</span>, queue);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        lcore = rx_thread_params[i].lcore_id;</div>
<div class="line">        <span class="keywordflow">if</span> (!<a name="a62"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore)) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;error: lcore %hhu is not enabled in lcore mask\n&quot;</span>, lcore);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        socketid = <a name="a63"></a><a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(lcore);</div>
<div class="line">        <span class="keywordflow">if</span> ((socketid != 0) &amp;&amp; (numa_on == 0))</div>
<div class="line">            printf(<span class="stringliteral">&quot;warning: lcore %hhu is on socket %d with numa off\n&quot;</span>,</div>
<div class="line">                lcore, socketid);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">check_port_config(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line">    uint16_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_rx_thread_params; ++i) {</div>
<div class="line">        portid = rx_thread_params[i].port_id;</div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;port %u is not enabled in port mask\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (portid &gt;= nb_ports) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;port %u is not present on the board\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint8_t</div>
<div class="line">get_port_n_rx_queues(<span class="keyword">const</span> uint8_t port)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> queue = -1;</div>
<div class="line">    uint16_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_rx_thread_params; ++i)</div>
<div class="line">        <span class="keywordflow">if</span> (rx_thread_params[i].port_id == port &amp;&amp;</div>
<div class="line">                rx_thread_params[i].queue_id &gt; queue)</div>
<div class="line">            queue = rx_thread_params[i].queue_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (uint8_t)(++queue);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_rx_rings(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> socket_io;</div>
<div class="line">    <span class="keyword">struct </span>thread_rx_conf *rx_conf;</div>
<div class="line">    <span class="keyword">struct </span>thread_tx_conf *tx_conf;</div>
<div class="line">    <span class="keywordtype">unsigned</span> rx_thread_id, tx_thread_id;</div>
<div class="line">    <span class="keywordtype">char</span> name[256];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ring.html">rte_ring</a> *ring = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (tx_thread_id = 0; tx_thread_id &lt; n_tx_thread; tx_thread_id++) {</div>
<div class="line"></div>
<div class="line">        tx_conf = &amp;tx_thread[tx_thread_id];</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;Connecting tx-thread %d with rx-thread %d\n&quot;</span>, tx_thread_id,</div>
<div class="line">                tx_conf-&gt;conf.thread_id);</div>
<div class="line"></div>
<div class="line">        rx_thread_id = tx_conf-&gt;conf.thread_id;</div>
<div class="line">        <span class="keywordflow">if</span> (rx_thread_id &gt; n_tx_thread) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;connection from tx-thread %u to rx-thread %u fails &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;(rx-thread not defined)\n&quot;</span>, tx_thread_id, rx_thread_id);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        rx_conf = &amp;rx_thread[rx_thread_id];</div>
<div class="line">        socket_io = <a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(rx_conf-&gt;conf.lcore_id);</div>
<div class="line"></div>
<div class="line">        snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;app_ring_s%u_rx%u_tx%u&quot;</span>,</div>
<div class="line">                socket_io, rx_thread_id, tx_thread_id);</div>
<div class="line"></div>
<div class="line">        ring = <a name="a64"></a><a class="code" href="rte__ring_8h.html#a5556487d8ec76cacfc059b66d8b77c98">rte_ring_create</a>(name, 1024 * 4, socket_io,</div>
<div class="line">                <a name="a65"></a><a class="code" href="rte__ring_8h.html#a127c66adbeab4653a47649993b94f35b">RING_F_SP_ENQ</a> | <a name="a66"></a><a class="code" href="rte__ring_8h.html#a421a61b2f94cdf65b3a6ac146c492fb9">RING_F_SC_DEQ</a>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ring == NULL) {</div>
<div class="line">            <a name="a67"></a><a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;Cannot create ring to connect rx-thread %u &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;with tx-thread %u\n&quot;</span>, rx_thread_id, tx_thread_id);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        rx_conf-&gt;ring[rx_conf-&gt;n_ring] = ring;</div>
<div class="line"></div>
<div class="line">        tx_conf-&gt;ring = ring;</div>
<div class="line">        tx_conf-&gt;ready = &amp;rx_conf-&gt;ready[rx_conf-&gt;n_ring];</div>
<div class="line"></div>
<div class="line">        rx_conf-&gt;n_ring++;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_rx_queues(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint16_t i, nb_rx_queue;</div>
<div class="line">    uint8_t thread;</div>
<div class="line"></div>
<div class="line">    n_rx_thread = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_rx_thread_params; ++i) {</div>
<div class="line">        thread = rx_thread_params[i].thread_id;</div>
<div class="line">        nb_rx_queue = rx_thread[thread].n_rx_queue;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (nb_rx_queue &gt;= MAX_RX_QUEUE_PER_LCORE) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;error: too many queues (%u) for thread: %u\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">unsigned</span>)nb_rx_queue + 1, (<span class="keywordtype">unsigned</span>)thread);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        rx_thread[thread].conf.thread_id = thread;</div>
<div class="line">        rx_thread[thread].conf.lcore_id = rx_thread_params[i].lcore_id;</div>
<div class="line">        rx_thread[thread].rx_queue_list[nb_rx_queue].port_id =</div>
<div class="line">            rx_thread_params[i].port_id;</div>
<div class="line">        rx_thread[thread].rx_queue_list[nb_rx_queue].queue_id =</div>
<div class="line">            rx_thread_params[i].queue_id;</div>
<div class="line">        rx_thread[thread].n_rx_queue++;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (thread &gt;= n_rx_thread)</div>
<div class="line">            n_rx_thread = thread + 1;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_tx_threads(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">    n_tx_thread = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_tx_thread_params; ++i) {</div>
<div class="line">        tx_thread[n_tx_thread].conf.thread_id = tx_thread_params[i].thread_id;</div>
<div class="line">        tx_thread[n_tx_thread].conf.lcore_id = tx_thread_params[i].lcore_id;</div>
<div class="line">        n_tx_thread++;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* display usage */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK -P&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  [--rx (port,queue,lcore,thread)[,(port,queue,lcore,thread]]&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  [--tx (lcore,thread)[,(lcore,thread]]&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  [--enable-jumbo [--max-pkt-len PKTLEN]]\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  -p PORTMASK: hexadecimal bitmask of ports to configure\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  -P : enable promiscuous mode\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --rx (port,queue,lcore,thread): rx queues configuration\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --tx (lcore,thread): tx threads configuration\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --stat-lcore LCORE: use lcore for stat collector\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --eth-dest=X,MM:MM:MM:MM:MM:MM: optional, ethernet destination for port X\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --no-numa: optional, disable numa awareness\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --ipv6: optional, specify it if running ipv6 packets\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --enable-jumbo: enable jumbo frame&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot; which max packet len is PKTLEN in decimal (64-9600)\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --hash-entry-num: specify the hash entry number in hexadecimal to be setup\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;  --no-lthreads: turn off lthread model\n&quot;</span>,</div>
<div class="line">        prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> parse_max_pkt_len(<span class="keyword">const</span> <span class="keywordtype">char</span> *pktlen)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse decimal string */</span></div>
<div class="line">    len = strtoul(pktlen, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((pktlen[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> len;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_hash_entry_number(<span class="keyword">const</span> <span class="keywordtype">char</span> *hash_entry_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> hash_en;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    hash_en = strtoul(hash_entry_num, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((hash_entry_num[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (hash_en == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> hash_en;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_rx_config(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> s[256];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *p0 = q_arg;</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    <span class="keyword">enum</span> fieldnames {</div>
<div class="line">        FLD_PORT = 0,</div>
<div class="line">        FLD_QUEUE,</div>
<div class="line">        FLD_LCORE,</div>
<div class="line">        FLD_THREAD,</div>
<div class="line">        _NUM_FLD</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> int_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">char</span> *str_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">unsigned</span> size;</div>
<div class="line"></div>
<div class="line">    nb_rx_thread_params = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((p = strchr(p0, <span class="charliteral">&#39;(&#39;</span>)) != NULL) {</div>
<div class="line">        ++p;</div>
<div class="line">        p0 = strchr(p, <span class="charliteral">&#39;)&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (p0 == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        size = p0 - p;</div>
<div class="line">        <span class="keywordflow">if</span> (size &gt;= <span class="keyword">sizeof</span>(s))</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;%.*s&quot;</span>, size, p);</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a68"></a><a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(s, <span class="keyword">sizeof</span>(s), str_fld, _NUM_FLD, <span class="charliteral">&#39;,&#39;</span>) != _NUM_FLD)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; _NUM_FLD; i++) {</div>
<div class="line">            errno = 0;</div>
<div class="line">            int_fld[i] = strtoul(str_fld[i], &amp;end, 0);</div>
<div class="line">            <span class="keywordflow">if</span> (errno != 0 || end == str_fld[i] || int_fld[i] &gt; 255)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (nb_rx_thread_params &gt;= MAX_LCORE_PARAMS) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;exceeded max number of rx params: %hu\n&quot;</span>,</div>
<div class="line">                    nb_rx_thread_params);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        rx_thread_params_array[nb_rx_thread_params].port_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_PORT];</div>
<div class="line">        rx_thread_params_array[nb_rx_thread_params].queue_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_QUEUE];</div>
<div class="line">        rx_thread_params_array[nb_rx_thread_params].lcore_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_LCORE];</div>
<div class="line">        rx_thread_params_array[nb_rx_thread_params].thread_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_THREAD];</div>
<div class="line">        ++nb_rx_thread_params;</div>
<div class="line">    }</div>
<div class="line">    rx_thread_params = rx_thread_params_array;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_tx_config(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> s[256];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *p0 = q_arg;</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    <span class="keyword">enum</span> fieldnames {</div>
<div class="line">        FLD_LCORE = 0,</div>
<div class="line">        FLD_THREAD,</div>
<div class="line">        _NUM_FLD</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> int_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">char</span> *str_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">unsigned</span> size;</div>
<div class="line"></div>
<div class="line">    nb_tx_thread_params = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((p = strchr(p0, <span class="charliteral">&#39;(&#39;</span>)) != NULL) {</div>
<div class="line">        ++p;</div>
<div class="line">        p0 = strchr(p, <span class="charliteral">&#39;)&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (p0 == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        size = p0 - p;</div>
<div class="line">        <span class="keywordflow">if</span> (size &gt;= <span class="keyword">sizeof</span>(s))</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;%.*s&quot;</span>, size, p);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(s, <span class="keyword">sizeof</span>(s), str_fld, _NUM_FLD, <span class="charliteral">&#39;,&#39;</span>) != _NUM_FLD)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; _NUM_FLD; i++) {</div>
<div class="line">            errno = 0;</div>
<div class="line">            int_fld[i] = strtoul(str_fld[i], &amp;end, 0);</div>
<div class="line">            <span class="keywordflow">if</span> (errno != 0 || end == str_fld[i] || int_fld[i] &gt; 255)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (nb_tx_thread_params &gt;= MAX_LCORE_PARAMS) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;exceeded max number of tx params: %hu\n&quot;</span>,</div>
<div class="line">                nb_tx_thread_params);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        tx_thread_params_array[nb_tx_thread_params].lcore_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_LCORE];</div>
<div class="line">        tx_thread_params_array[nb_tx_thread_params].thread_id =</div>
<div class="line">                (uint8_t)int_fld[FLD_THREAD];</div>
<div class="line">        ++nb_tx_thread_params;</div>
<div class="line">    }</div>
<div class="line">    tx_thread_params = tx_thread_params_array;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_stat_lcore(<span class="keyword">const</span> <span class="keywordtype">char</span> *stat_lcore)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lcore_id;</div>
<div class="line"></div>
<div class="line">    lcore_id = strtoul(stat_lcore, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((stat_lcore[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> lcore_id;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_eth_dest(<span class="keyword">const</span> <span class="keywordtype">char</span> *optarg)</div>
<div class="line">{</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keywordtype">char</span> *port_end;</div>
<div class="line">    uint8_t c, *dest, peer_addr[6];</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line">    portid = strtoul(optarg, &amp;port_end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> (errno != 0 || port_end == optarg || *port_end++ != <span class="charliteral">&#39;,&#39;</span>)</div>
<div class="line">        <a name="a69"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">        <span class="stringliteral">&quot;Invalid eth-dest: %s&quot;</span>, optarg);</div>
<div class="line">    <span class="keywordflow">if</span> (portid &gt;= RTE_MAX_ETHPORTS)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">        <span class="stringliteral">&quot;eth-dest: port %d &gt;= RTE_MAX_ETHPORTS(%d)\n&quot;</span>,</div>
<div class="line">        portid, RTE_MAX_ETHPORTS);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (cmdline_parse_etheraddr(NULL, port_end,</div>
<div class="line">        &amp;peer_addr, <span class="keyword">sizeof</span>(peer_addr)) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">        <span class="stringliteral">&quot;Invalid ethernet address: %s\n&quot;</span>,</div>
<div class="line">        port_end);</div>
<div class="line">    dest = (uint8_t *)&amp;dest_eth_addr[portid];</div>
<div class="line">    <span class="keywordflow">for</span> (c = 0; c &lt; 6; c++)</div>
<div class="line">        dest[c] = peer_addr[c];</div>
<div class="line">    *(uint64_t *)(val_eth + portid) = dest_eth_addr[portid];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CMD_LINE_OPT_RX_CONFIG &quot;rx&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_TX_CONFIG &quot;tx&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_STAT_LCORE &quot;stat-lcore&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_ETH_DEST &quot;eth-dest&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_NO_NUMA &quot;no-numa&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_IPV6 &quot;ipv6&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_ENABLE_JUMBO &quot;enable-jumbo&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_HASH_ENTRY_NUM &quot;hash-entry-num&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_LINE_OPT_NO_LTHREADS &quot;no-lthreads&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Parse the argument given in the command line of the application */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">char</span> **argvopt;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option lgopts[] = {</div>
<div class="line">        {CMD_LINE_OPT_RX_CONFIG, 1, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_TX_CONFIG, 1, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_STAT_LCORE, 1, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_ETH_DEST, 1, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_NO_NUMA, 0, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_IPV6, 0, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_ENABLE_JUMBO, 0, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_HASH_ENTRY_NUM, 1, 0, 0},</div>
<div class="line">        {CMD_LINE_OPT_NO_LTHREADS, 0, 0, 0},</div>
<div class="line">        {NULL, 0, 0, 0}</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    argvopt = argv;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argvopt, <span class="stringliteral">&quot;p:P&quot;</span>,</div>
<div class="line">                lgopts, &amp;option_index)) != EOF) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;invalid portmask\n&quot;</span>);</div>
<div class="line">                print_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:</div>
<div class="line">            printf(<span class="stringliteral">&quot;Promiscuous mode selected\n&quot;</span>);</div>
<div class="line">            promiscuous_on = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* long options */</span></div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_RX_CONFIG,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_RX_CONFIG))) {</div>
<div class="line">                ret = parse_rx_config(optarg);</div>
<div class="line">                <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;invalid rx-config\n&quot;</span>);</div>
<div class="line">                    print_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_TX_CONFIG,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_TX_CONFIG))) {</div>
<div class="line">                ret = parse_tx_config(optarg);</div>
<div class="line">                <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;invalid tx-config\n&quot;</span>);</div>
<div class="line">                    print_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_STAT_LCORE,</div>
<div class="line">                    <span class="keyword">sizeof</span>(CMD_LINE_OPT_STAT_LCORE))) {</div>
<div class="line">                cpu_load_lcore_id = parse_stat_lcore(optarg);</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_ETH_DEST,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_ETH_DEST)))</div>
<div class="line">                    parse_eth_dest(optarg);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_NO_NUMA,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_NO_NUMA))) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;numa is disabled\n&quot;</span>);</div>
<div class="line">                numa_on = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_IPV6,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_IPV6))) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;ipv6 is specified\n&quot;</span>);</div>
<div class="line">                ipv6 = 1;</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_NO_LTHREADS,</div>
<div class="line">                    <span class="keyword">sizeof</span>(CMD_LINE_OPT_NO_LTHREADS))) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;l-threads model is disabled\n&quot;</span>);</div>
<div class="line">                lthreads_on = 0;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_ENABLE_JUMBO,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_ENABLE_JUMBO))) {</div>
<div class="line">                <span class="keyword">struct </span>option lenopts = {<span class="stringliteral">&quot;max-pkt-len&quot;</span>, required_argument, 0,</div>
<div class="line">                        0};</div>
<div class="line"></div>
<div class="line">                printf(<span class="stringliteral">&quot;jumbo frame is enabled - disabling simple TX path\n&quot;</span>);</div>
<div class="line">                port_conf.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a70"></a><a class="code" href="structrte__eth__rxmode.html#a11f6e2aa5e36df74b8c2e4f9e870ce71">jumbo_frame</a> = 1;</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* if no max-pkt-len set, use the default value ETHER_MAX_LEN */</span></div>
<div class="line">                <span class="keywordflow">if</span> (0 == getopt_long(argc, argvopt, <span class="stringliteral">&quot;&quot;</span>, &amp;lenopts,</div>
<div class="line">                        &amp;option_index)) {</div>
<div class="line"></div>
<div class="line">                    ret = parse_max_pkt_len(optarg);</div>
<div class="line">                    <span class="keywordflow">if</span> ((ret &lt; 64) || (ret &gt; MAX_JUMBO_PKT_LEN)) {</div>
<div class="line">                        printf(<span class="stringliteral">&quot;invalid packet length\n&quot;</span>);</div>
<div class="line">                        print_usage(prgname);</div>
<div class="line">                        <span class="keywordflow">return</span> -1;</div>
<div class="line">                    }</div>
<div class="line">                    port_conf.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a71"></a><a class="code" href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">max_rx_pkt_len</a> = ret;</div>
<div class="line">                }</div>
<div class="line">                printf(<span class="stringliteral">&quot;set jumbo frame max packet length to %u\n&quot;</span>,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)port_conf.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a class="code" href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">max_rx_pkt_len</a>);</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (!strncmp(lgopts[option_index].name, CMD_LINE_OPT_HASH_ENTRY_NUM,</div>
<div class="line">                <span class="keyword">sizeof</span>(CMD_LINE_OPT_HASH_ENTRY_NUM))) {</div>
<div class="line">                ret = parse_hash_entry_number(optarg);</div>
<div class="line">                <span class="keywordflow">if</span> ((ret &gt; 0) &amp;&amp; (ret &lt;= L3FWD_HASH_ENTRIES)) {</div>
<div class="line">                    hash_entry_number = ret;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;invalid hash entry number\n&quot;</span>);</div>
<div class="line">                    print_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            print_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (optind &gt;= 0)</div>
<div class="line">        argv[optind-1] = prgname;</div>
<div class="line"></div>
<div class="line">    ret = optind-1;</div>
<div class="line">    optind = 0; <span class="comment">/* reset getopt lib */</span></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_ethaddr(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structether__addr.html">ether_addr</a> *eth_addr)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buf[ETHER_ADDR_FMT_SIZE];</div>
<div class="line"></div>
<div class="line">    <a name="a72"></a><a class="code" href="rte__ether_8h.html#abc6898349695b29d524d736d8ebce57d">ether_format_addr</a>(buf, ETHER_ADDR_FMT_SIZE, eth_addr);</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s%s&quot;</span>, name, buf);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_EXACT_MATCH)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> convert_ipv4_5tuple(<span class="keyword">struct</span> ipv4_5tuple *key1,</div>
<div class="line">        <span class="keyword">union</span> ipv4_5tuple_host *key2)</div>
<div class="line">{</div>
<div class="line">    key2-&gt;ip_dst = <a name="a73"></a><a class="code" href="rte__byteorder_8h.html#a7d62fcf485a335a6c1307763a150895c">rte_cpu_to_be_32</a>(key1-&gt;ip_dst);</div>
<div class="line">    key2-&gt;ip_src = <a class="code" href="rte__byteorder_8h.html#a7d62fcf485a335a6c1307763a150895c">rte_cpu_to_be_32</a>(key1-&gt;ip_src);</div>
<div class="line">    key2-&gt;port_dst = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(key1-&gt;port_dst);</div>
<div class="line">    key2-&gt;port_src = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(key1-&gt;port_src);</div>
<div class="line">    key2-&gt;proto = key1-&gt;proto;</div>
<div class="line">    key2-&gt;pad0 = 0;</div>
<div class="line">    key2-&gt;pad1 = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> convert_ipv6_5tuple(<span class="keyword">struct</span> ipv6_5tuple *key1,</div>
<div class="line">        <span class="keyword">union</span> ipv6_5tuple_host *key2)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++) {</div>
<div class="line">        key2-&gt;ip_dst[i] = key1-&gt;ip_dst[i];</div>
<div class="line">        key2-&gt;ip_src[i] = key1-&gt;ip_src[i];</div>
<div class="line">    }</div>
<div class="line">    key2-&gt;port_dst = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(key1-&gt;port_dst);</div>
<div class="line">    key2-&gt;port_src = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(key1-&gt;port_src);</div>
<div class="line">    key2-&gt;proto = key1-&gt;proto;</div>
<div class="line">    key2-&gt;pad0 = 0;</div>
<div class="line">    key2-&gt;pad1 = 0;</div>
<div class="line">    key2-&gt;reserve = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define BYTE_VALUE_MAX 256</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ALL_32_BITS 0xffffffff</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BIT_8_TO_15 0x0000ff00</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">populate_ipv4_few_flow_into_table(<span class="keyword">const</span> <span class="keyword">struct</span> rte_hash *h)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line">    int32_t ret;</div>
<div class="line">    uint32_t array_len = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ipv4_l3fwd_route_array);</div>
<div class="line"></div>
<div class="line">    mask0 = _mm_set_epi32(ALL_32_BITS, ALL_32_BITS, ALL_32_BITS, BIT_8_TO_15);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; array_len; i++) {</div>
<div class="line">        <span class="keyword">struct </span>ipv4_l3fwd_route  entry;</div>
<div class="line">        <span class="keyword">union </span>ipv4_5tuple_host newkey;</div>
<div class="line"></div>
<div class="line">        entry = ipv4_l3fwd_route_array[i];</div>
<div class="line">        convert_ipv4_5tuple(&amp;entry.key, &amp;newkey);</div>
<div class="line">        ret = <a name="a74"></a><a class="code" href="rte__hash_8h.html#a0247f58baa6cbf614e5b729ff0baf27e">rte_hash_add_key</a>(h, (<span class="keywordtype">void</span> *)&amp;newkey);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %&quot;</span> PRIu32</div>
<div class="line">                <span class="stringliteral">&quot; to the l3fwd hash.\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line">        ipv4_l3fwd_out_if[ret] = entry.if_out;</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Hash: Adding 0x%&quot;</span> PRIx32 <span class="stringliteral">&quot; keys\n&quot;</span>, array_len);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define BIT_16_TO_23 0x00ff0000</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">populate_ipv6_few_flow_into_table(<span class="keyword">const</span> <span class="keyword">struct</span> rte_hash *h)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line">    int32_t ret;</div>
<div class="line">    uint32_t array_len = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ipv6_l3fwd_route_array);</div>
<div class="line"></div>
<div class="line">    mask1 = _mm_set_epi32(ALL_32_BITS, ALL_32_BITS, ALL_32_BITS, BIT_16_TO_23);</div>
<div class="line">    mask2 = _mm_set_epi32(0, 0, ALL_32_BITS, ALL_32_BITS);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; array_len; i++) {</div>
<div class="line">        <span class="keyword">struct </span>ipv6_l3fwd_route entry;</div>
<div class="line">        <span class="keyword">union </span>ipv6_5tuple_host newkey;</div>
<div class="line"></div>
<div class="line">        entry = ipv6_l3fwd_route_array[i];</div>
<div class="line">        convert_ipv6_5tuple(&amp;entry.key, &amp;newkey);</div>
<div class="line">        ret = <a class="code" href="rte__hash_8h.html#a0247f58baa6cbf614e5b729ff0baf27e">rte_hash_add_key</a>(h, (<span class="keywordtype">void</span> *)&amp;newkey);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %&quot;</span> PRIu32</div>
<div class="line">                <span class="stringliteral">&quot; to the l3fwd hash.\n&quot;</span>, i);</div>
<div class="line">        }</div>
<div class="line">        ipv6_l3fwd_out_if[ret] = entry.if_out;</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Hash: Adding 0x%&quot;</span> PRIx32 <span class="stringliteral">&quot;keys\n&quot;</span>, array_len);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define NUMBER_PORT_USED 4</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">populate_ipv4_many_flow_into_table(<span class="keyword">const</span> <span class="keyword">struct</span> rte_hash *h,</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nr_flow)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    mask0 = _mm_set_epi32(ALL_32_BITS, ALL_32_BITS, ALL_32_BITS, BIT_8_TO_15);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nr_flow; i++) {</div>
<div class="line">        <span class="keyword">struct </span>ipv4_l3fwd_route entry;</div>
<div class="line">        <span class="keyword">union </span>ipv4_5tuple_host newkey;</div>
<div class="line">        uint8_t a = (uint8_t)((i / NUMBER_PORT_USED) % BYTE_VALUE_MAX);</div>
<div class="line">        uint8_t b = (uint8_t)(((i / NUMBER_PORT_USED) / BYTE_VALUE_MAX) %</div>
<div class="line">                BYTE_VALUE_MAX);</div>
<div class="line">        uint8_t c = (uint8_t)((i / NUMBER_PORT_USED) / (BYTE_VALUE_MAX *</div>
<div class="line">                BYTE_VALUE_MAX));</div>
<div class="line">        <span class="comment">/* Create the ipv4 exact match flow */</span></div>
<div class="line">        memset(&amp;entry, 0, <span class="keyword">sizeof</span>(entry));</div>
<div class="line">        <span class="keywordflow">switch</span> (i &amp; (NUMBER_PORT_USED - 1)) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            entry = ipv4_l3fwd_route_array[0];</div>
<div class="line">            entry.key.ip_dst = <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(101, c, b, a);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1:</div>
<div class="line">            entry = ipv4_l3fwd_route_array[1];</div>
<div class="line">            entry.key.ip_dst = <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(201, c, b, a);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">            entry = ipv4_l3fwd_route_array[2];</div>
<div class="line">            entry.key.ip_dst = <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(111, c, b, a);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 3:</div>
<div class="line">            entry = ipv4_l3fwd_route_array[3];</div>
<div class="line">            entry.key.ip_dst = <a class="code" href="rte__ip_8h.html#a052e2a96de0562a034776fa758255650">IPv4</a>(211, c, b, a);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        };</div>
<div class="line">        convert_ipv4_5tuple(&amp;entry.key, &amp;newkey);</div>
<div class="line">        int32_t ret = <a class="code" href="rte__hash_8h.html#a0247f58baa6cbf614e5b729ff0baf27e">rte_hash_add_key</a>(h, (<span class="keywordtype">void</span> *)&amp;newkey);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %u\n&quot;</span>, i);</div>
<div class="line"></div>
<div class="line">        ipv4_l3fwd_out_if[ret] = (uint8_t)entry.if_out;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Hash: Adding 0x%x keys\n&quot;</span>, nr_flow);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">populate_ipv6_many_flow_into_table(<span class="keyword">const</span> <span class="keyword">struct</span> rte_hash *h,</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nr_flow)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    mask1 = _mm_set_epi32(ALL_32_BITS, ALL_32_BITS, ALL_32_BITS, BIT_16_TO_23);</div>
<div class="line">    mask2 = _mm_set_epi32(0, 0, ALL_32_BITS, ALL_32_BITS);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nr_flow; i++) {</div>
<div class="line">        <span class="keyword">struct </span>ipv6_l3fwd_route entry;</div>
<div class="line">        <span class="keyword">union </span>ipv6_5tuple_host newkey;</div>
<div class="line"></div>
<div class="line">        uint8_t a = (uint8_t) ((i / NUMBER_PORT_USED) % BYTE_VALUE_MAX);</div>
<div class="line">        uint8_t b = (uint8_t) (((i / NUMBER_PORT_USED) / BYTE_VALUE_MAX) %</div>
<div class="line">                BYTE_VALUE_MAX);</div>
<div class="line">        uint8_t c = (uint8_t) ((i / NUMBER_PORT_USED) / (BYTE_VALUE_MAX *</div>
<div class="line">                BYTE_VALUE_MAX));</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Create the ipv6 exact match flow */</span></div>
<div class="line">        memset(&amp;entry, 0, <span class="keyword">sizeof</span>(entry));</div>
<div class="line">        <span class="keywordflow">switch</span> (i &amp; (NUMBER_PORT_USED - 1)) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            entry = ipv6_l3fwd_route_array[0];</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1:</div>
<div class="line">            entry = ipv6_l3fwd_route_array[1];</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">            entry = ipv6_l3fwd_route_array[2];</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 3:</div>
<div class="line">            entry = ipv6_l3fwd_route_array[3];</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        };</div>
<div class="line">        entry.key.ip_dst[13] = c;</div>
<div class="line">        entry.key.ip_dst[14] = b;</div>
<div class="line">        entry.key.ip_dst[15] = a;</div>
<div class="line">        convert_ipv6_5tuple(&amp;entry.key, &amp;newkey);</div>
<div class="line">        int32_t ret = <a class="code" href="rte__hash_8h.html#a0247f58baa6cbf614e5b729ff0baf27e">rte_hash_add_key</a>(h, (<span class="keywordtype">void</span> *)&amp;newkey);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %u\n&quot;</span>, i);</div>
<div class="line"></div>
<div class="line">        ipv6_l3fwd_out_if[ret] = (uint8_t) entry.if_out;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Hash: Adding 0x%x keys\n&quot;</span>, nr_flow);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">setup_hash(<span class="keywordtype">int</span> socketid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a75"></a><a class="code" href="structrte__hash__parameters.html">rte_hash_parameters</a> ipv4_l3fwd_hash_params = {</div>
<div class="line">        .<a name="a76"></a><a class="code" href="structrte__hash__parameters.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = NULL,</div>
<div class="line">        .entries = L3FWD_HASH_ENTRIES,</div>
<div class="line">        .key_len = <span class="keyword">sizeof</span>(<span class="keyword">union </span>ipv4_5tuple_host),</div>
<div class="line">        .hash_func = ipv4_hash_crc,</div>
<div class="line">        .hash_func_init_val = 0,</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__hash__parameters.html">rte_hash_parameters</a> ipv6_l3fwd_hash_params = {</div>
<div class="line">        .<a class="code" href="structrte__hash__parameters.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = NULL,</div>
<div class="line">        .entries = L3FWD_HASH_ENTRIES,</div>
<div class="line">        .key_len = <span class="keyword">sizeof</span>(<span class="keyword">union </span>ipv6_5tuple_host),</div>
<div class="line">        .hash_func = ipv6_hash_crc,</div>
<div class="line">        .hash_func_init_val = 0,</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">char</span> s[64];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* create ipv4 hash */</span></div>
<div class="line">    snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;ipv4_l3fwd_hash_%d&quot;</span>, socketid);</div>
<div class="line">    ipv4_l3fwd_hash_params.<a class="code" href="structrte__hash__parameters.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = s;</div>
<div class="line">    ipv4_l3fwd_hash_params.<a name="a77"></a><a class="code" href="structrte__hash__parameters.html#a229cb0bd24215f0cb940e0724dbd4d55">socket_id</a> = socketid;</div>
<div class="line">    ipv4_l3fwd_lookup_struct[socketid] =</div>
<div class="line">            <a name="a78"></a><a class="code" href="rte__hash_8h.html#a5afbd2564f738149a241bc22b2428612">rte_hash_create</a>(&amp;ipv4_l3fwd_hash_params);</div>
<div class="line">    <span class="keywordflow">if</span> (ipv4_l3fwd_lookup_struct[socketid] == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to create the l3fwd hash on &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;socket %d\n&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* create ipv6 hash */</span></div>
<div class="line">    snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;ipv6_l3fwd_hash_%d&quot;</span>, socketid);</div>
<div class="line">    ipv6_l3fwd_hash_params.<a class="code" href="structrte__hash__parameters.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = s;</div>
<div class="line">    ipv6_l3fwd_hash_params.<a class="code" href="structrte__hash__parameters.html#a229cb0bd24215f0cb940e0724dbd4d55">socket_id</a> = socketid;</div>
<div class="line">    ipv6_l3fwd_lookup_struct[socketid] =</div>
<div class="line">            <a class="code" href="rte__hash_8h.html#a5afbd2564f738149a241bc22b2428612">rte_hash_create</a>(&amp;ipv6_l3fwd_hash_params);</div>
<div class="line">    <span class="keywordflow">if</span> (ipv6_l3fwd_lookup_struct[socketid] == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to create the l3fwd hash on &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;socket %d\n&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (hash_entry_number != HASH_ENTRY_NUMBER_DEFAULT) {</div>
<div class="line">        <span class="comment">/* For testing hash matching with a large number of flows we</span></div>
<div class="line"><span class="comment">         * generate millions of IP 5-tuples with an incremented dst</span></div>
<div class="line"><span class="comment">         * address to initialize the hash table. */</span></div>
<div class="line">        <span class="keywordflow">if</span> (ipv6 == 0) {</div>
<div class="line">            <span class="comment">/* populate the ipv4 hash */</span></div>
<div class="line">            populate_ipv4_many_flow_into_table(</div>
<div class="line">                ipv4_l3fwd_lookup_struct[socketid], hash_entry_number);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* populate the ipv6 hash */</span></div>
<div class="line">            populate_ipv6_many_flow_into_table(</div>
<div class="line">                ipv6_l3fwd_lookup_struct[socketid], hash_entry_number);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">/* Use data in ipv4/ipv6 l3fwd lookup table directly to initialize</span></div>
<div class="line"><span class="comment">         * the hash table */</span></div>
<div class="line">        <span class="keywordflow">if</span> (ipv6 == 0) {</div>
<div class="line">            <span class="comment">/* populate the ipv4 hash */</span></div>
<div class="line">            populate_ipv4_few_flow_into_table(</div>
<div class="line">                    ipv4_l3fwd_lookup_struct[socketid]);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* populate the ipv6 hash */</span></div>
<div class="line">            populate_ipv6_few_flow_into_table(</div>
<div class="line">                    ipv6_l3fwd_lookup_struct[socketid]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">setup_lpm(<span class="keywordtype">int</span> socketid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a79"></a><a class="code" href="structrte__lpm6__config.html">rte_lpm6_config</a> config;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a80"></a><a class="code" href="structrte__lpm__config.html">rte_lpm_config</a> lpm_ipv4_config;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">char</span> s[64];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* create the LPM table */</span></div>
<div class="line">    snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;IPV4_L3FWD_LPM_%d&quot;</span>, socketid);</div>
<div class="line">    lpm_ipv4_config.max_rules = IPV4_L3FWD_LPM_MAX_RULES;</div>
<div class="line">    lpm_ipv4_config.number_tbl8s = 256;</div>
<div class="line">    lpm_ipv4_config.flags = 0;</div>
<div class="line">    ipv4_l3fwd_lookup_struct[socketid] =</div>
<div class="line">            <a name="a81"></a><a class="code" href="rte__lpm_8h.html#aec0add0a744e7b876e0ed74000dbb847">rte_lpm_create</a>(s, socketid, &amp;lpm_ipv4_config);</div>
<div class="line">    <span class="keywordflow">if</span> (ipv4_l3fwd_lookup_struct[socketid] == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to create the l3fwd LPM table&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; on socket %d\n&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* populate the LPM table */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; IPV4_L3FWD_NUM_ROUTES; i++) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* skip unused ports */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((1 &lt;&lt; ipv4_l3fwd_route_array[i].if_out &amp;</div>
<div class="line">                enabled_port_mask) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        ret = <a name="a82"></a><a class="code" href="rte__lpm_8h.html#a03aa0c18f8a7c1b0c194c9d99c7ba448">rte_lpm_add</a>(ipv4_l3fwd_lookup_struct[socketid],</div>
<div class="line">            ipv4_l3fwd_route_array[i].ip,</div>
<div class="line">            ipv4_l3fwd_route_array[i].depth,</div>
<div class="line">            ipv4_l3fwd_route_array[i].if_out);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %u to the &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;l3fwd LPM table on socket %d\n&quot;</span>,</div>
<div class="line">                i, socketid);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;LPM: Adding route 0x%08x / %d (%d)\n&quot;</span>,</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)ipv4_l3fwd_route_array[i].ip,</div>
<div class="line">            ipv4_l3fwd_route_array[i].depth,</div>
<div class="line">            ipv4_l3fwd_route_array[i].if_out);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* create the LPM6 table */</span></div>
<div class="line">    snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;IPV6_L3FWD_LPM_%d&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line">    config.max_rules = IPV6_L3FWD_LPM_MAX_RULES;</div>
<div class="line">    config.number_tbl8s = IPV6_L3FWD_LPM_NUMBER_TBL8S;</div>
<div class="line">    config.flags = 0;</div>
<div class="line">    ipv6_l3fwd_lookup_struct[socketid] = <a name="a83"></a><a class="code" href="rte__lpm6_8h.html#a2a61e4c93a53f4195212cae30aed1afc">rte_lpm6_create</a>(s, socketid,</div>
<div class="line">                &amp;config);</div>
<div class="line">    <span class="keywordflow">if</span> (ipv6_l3fwd_lookup_struct[socketid] == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to create the l3fwd LPM table&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; on socket %d\n&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* populate the LPM table */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; IPV6_L3FWD_NUM_ROUTES; i++) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* skip unused ports */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((1 &lt;&lt; ipv6_l3fwd_route_array[i].if_out &amp;</div>
<div class="line">                enabled_port_mask) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        ret = <a name="a84"></a><a class="code" href="rte__lpm6_8h.html#a8ad35ed5def78f4ff5245054e477b1b1">rte_lpm6_add</a>(ipv6_l3fwd_lookup_struct[socketid],</div>
<div class="line">            ipv6_l3fwd_route_array[i].ip,</div>
<div class="line">            ipv6_l3fwd_route_array[i].depth,</div>
<div class="line">            ipv6_l3fwd_route_array[i].if_out);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Unable to add entry %u to the &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;l3fwd LPM table on socket %d\n&quot;</span>,</div>
<div class="line">                i, socketid);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;LPM: Adding route %s / %d (%d)\n&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;IPV6&quot;</span>,</div>
<div class="line">            ipv6_l3fwd_route_array[i].depth,</div>
<div class="line">            ipv6_l3fwd_route_array[i].if_out);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">init_mem(<span class="keywordtype">unsigned</span> nb_mbuf)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>lcore_conf *qconf;</div>
<div class="line">    <span class="keywordtype">int</span> socketid;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line">    <span class="keywordtype">char</span> s[64];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (numa_on)</div>
<div class="line">            socketid = <a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(lcore_id);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            socketid = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (socketid &gt;= NB_SOCKETS) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Socket %d of lcore %u is out of range %d\n&quot;</span>,</div>
<div class="line">                socketid, lcore_id, NB_SOCKETS);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (pktmbuf_pool[socketid] == NULL) {</div>
<div class="line">            snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;mbuf_pool_%d&quot;</span>, socketid);</div>
<div class="line">            pktmbuf_pool[socketid] =</div>
<div class="line">                <a name="a85"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(s, nb_mbuf,</div>
<div class="line">                    MEMPOOL_CACHE_SIZE, 0,</div>
<div class="line">                    RTE_MBUF_DEFAULT_BUF_SIZE, socketid);</div>
<div class="line">            <span class="keywordflow">if</span> (pktmbuf_pool[socketid] == NULL)</div>
<div class="line">                <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                        <span class="stringliteral">&quot;Cannot init mbuf pool on socket %d\n&quot;</span>, socketid);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                printf(<span class="stringliteral">&quot;Allocated mbuf pool on socket %d\n&quot;</span>, socketid);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_LOOKUP_METHOD == APP_LOOKUP_LPM)</span></div>
<div class="line"><span class="preprocessor"></span>            setup_lpm(socketid);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>            setup_hash(socketid);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>        }</div>
<div class="line">        qconf = &amp;lcore_conf[lcore_id];</div>
<div class="line">        qconf-&gt;ipv4_lookup_struct = ipv4_l3fwd_lookup_struct[socketid];</div>
<div class="line">        qconf-&gt;ipv6_lookup_struct = ipv6_l3fwd_lookup_struct[socketid];</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check the link status of all ports in up to 9s, and print them finally */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">check_all_ports_link_status(uint8_t port_num, uint32_t port_mask)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#define CHECK_INTERVAL 100 </span><span class="comment">/* 100ms */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CHECK_TIME 90 </span><span class="comment">/* 9s (90 * 100ms) in total */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    uint8_t portid, count, all_ports_up, print_flag = 0;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a86"></a><a class="code" href="structrte__eth__link.html">rte_eth_link</a> link;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nChecking link status&quot;</span>);</div>
<div class="line">    fflush(stdout);</div>
<div class="line">    <span class="keywordflow">for</span> (count = 0; count &lt;= MAX_CHECK_TIME; count++) {</div>
<div class="line">        all_ports_up = 1;</div>
<div class="line">        <span class="keywordflow">for</span> (portid = 0; portid &lt; port_num; portid++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((port_mask &amp; (1 &lt;&lt; portid)) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            memset(&amp;link, 0, <span class="keyword">sizeof</span>(link));</div>
<div class="line">            <a name="a87"></a><a class="code" href="rte__ethdev_8h.html#a6908b1ef94c95ef85af851e6705a5f93">rte_eth_link_get_nowait</a>(portid, &amp;link);</div>
<div class="line">            <span class="comment">/* print link status if flag set */</span></div>
<div class="line">            <span class="keywordflow">if</span> (print_flag == 1) {</div>
<div class="line">                <span class="keywordflow">if</span> (link.link_status)</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Up - speed %u &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;Mbps - %s\n&quot;</span>, (uint8_t)portid,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span>)link.link_speed,</div>
<div class="line">                (link.link_duplex == <a name="a88"></a><a class="code" href="rte__ethdev_8h.html#a042c83951613bf2db5d3056b967041d6">ETH_LINK_FULL_DUPLEX</a>) ?</div>
<div class="line">                    (<span class="stringliteral">&quot;full-duplex&quot;</span>) : (<span class="stringliteral">&quot;half-duplex\n&quot;</span>));</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Down\n&quot;</span>,</div>
<div class="line">                        (uint8_t)portid);</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">/* clear all_ports_up flag if any link down */</span></div>
<div class="line">            <span class="keywordflow">if</span> (link.link_status == <a name="a89"></a><a class="code" href="rte__ethdev_8h.html#a08c012f37e07726170ff67daf667d850">ETH_LINK_DOWN</a>) {</div>
<div class="line">                all_ports_up = 0;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* after finally printing all link status, get out */</span></div>
<div class="line">        <span class="keywordflow">if</span> (print_flag == 1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            fflush(stdout);</div>
<div class="line">            <a name="a90"></a><a class="code" href="rte__cycles_8h.html#af73b844d50b98de74b1a0e1730262f85">rte_delay_ms</a>(CHECK_INTERVAL);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* set the print_flag if all ports up or timeout */</span></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 1 || count == (MAX_CHECK_TIME - 1)) {</div>
<div class="line">            print_flag = 1;</div>
<div class="line">            printf(<span class="stringliteral">&quot;done\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a91"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a92"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> *txconf;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports;</div>
<div class="line">    uint16_t queueid;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line">    uint32_t n_tx_queue, nb_lcores;</div>
<div class="line">    uint8_t portid, nb_rx_queue, queue, socketid;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a93"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid EAL parameters\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* pre-init dst MACs for all ports to 02:00:00:00:00:xx */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; RTE_MAX_ETHPORTS; portid++) {</div>
<div class="line">        dest_eth_addr[portid] = <a name="a94"></a><a class="code" href="rte__ether_8h.html#aa88ef1c2e21ad83afe35974c4cd2f4ff">ETHER_LOCAL_ADMIN_ADDR</a> +</div>
<div class="line">                ((uint64_t)portid &lt;&lt; 40);</div>
<div class="line">        *(uint64_t *)(val_eth + portid) = dest_eth_addr[portid];</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* parse application arguments (after the EAL ones) */</span></div>
<div class="line">    ret = parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid L3FWD parameters\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (check_lcore_params() &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;check_lcore_params failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Initializing rx-queues...\n&quot;</span>);</div>
<div class="line">    ret = init_rx_queues();</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;init_rx_queues failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Initializing tx-threads...\n&quot;</span>);</div>
<div class="line">    ret = init_tx_threads();</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;init_tx_threads failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Initializing rings...\n&quot;</span>);</div>
<div class="line">    ret = init_rx_rings();</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;init_rx_rings failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    nb_ports = <a name="a95"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_ports &gt; RTE_MAX_ETHPORTS)</div>
<div class="line">        nb_ports = RTE_MAX_ETHPORTS;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (check_port_config(nb_ports) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;check_port_config failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    nb_lcores = <a name="a96"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;\nSkipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* init port */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;Initializing port %d ... &quot;</span>, portid);</div>
<div class="line">        fflush(stdout);</div>
<div class="line"></div>
<div class="line">        nb_rx_queue = get_port_n_rx_queues(portid);</div>
<div class="line">        n_tx_queue = nb_lcores;</div>
<div class="line">        <span class="keywordflow">if</span> (n_tx_queue &gt; MAX_TX_QUEUE_PER_PORT)</div>
<div class="line">            n_tx_queue = MAX_TX_QUEUE_PER_PORT;</div>
<div class="line">        printf(<span class="stringliteral">&quot;Creating queues: nb_rxq=%d nb_txq=%u... &quot;</span>,</div>
<div class="line">            nb_rx_queue, (<span class="keywordtype">unsigned</span>)n_tx_queue);</div>
<div class="line">        ret = <a name="a97"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(portid, nb_rx_queue,</div>
<div class="line">                    (uint16_t)n_tx_queue, &amp;port_conf);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot configure device: err=%d, port=%d\n&quot;</span>,</div>
<div class="line">                ret, portid);</div>
<div class="line"></div>
<div class="line">        <a name="a98"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(portid, &amp;ports_eth_addr[portid]);</div>
<div class="line">        print_ethaddr(<span class="stringliteral">&quot; Address:&quot;</span>, &amp;ports_eth_addr[portid]);</div>
<div class="line">        printf(<span class="stringliteral">&quot;, &quot;</span>);</div>
<div class="line">        print_ethaddr(<span class="stringliteral">&quot;Destination:&quot;</span>,</div>
<div class="line">            (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structether__addr.html">ether_addr</a> *)&amp;dest_eth_addr[portid]);</div>
<div class="line">        printf(<span class="stringliteral">&quot;, &quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * prepare src MACs for each port.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;ports_eth_addr[portid],</div>
<div class="line">            (<span class="keyword">struct</span> <a class="code" href="structether__addr.html">ether_addr</a> *)(val_eth + portid) + 1);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* init memory */</span></div>
<div class="line">        ret = init_mem(NB_MBUF);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;init_mem failed\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* init one TX queue per couple (lcore,port) */</span></div>
<div class="line">        queueid = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (numa_on)</div>
<div class="line">                socketid = (uint8_t)<a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(lcore_id);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                socketid = 0;</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;txq=%u,%d,%d &quot;</span>, lcore_id, queueid, socketid);</div>
<div class="line">            fflush(stdout);</div>
<div class="line"></div>
<div class="line">            <a name="a99"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(portid, &amp;dev_info);</div>
<div class="line">            txconf = &amp;dev_info.default_txconf;</div>
<div class="line">            <span class="keywordflow">if</span> (port_conf.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a class="code" href="structrte__eth__rxmode.html#a11f6e2aa5e36df74b8c2e4f9e870ce71">jumbo_frame</a>)</div>
<div class="line">                txconf-&gt;<a name="a100"></a><a class="code" href="structrte__eth__txconf.html#a80d79f1953993347e9b0312a2096f86e">txq_flags</a> = 0;</div>
<div class="line">            ret = <a name="a101"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(portid, queueid, nb_txd,</div>
<div class="line">                             socketid, txconf);</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">                <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;rte_eth_tx_queue_setup: err=%d, &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;port=%d\n&quot;</span>, ret, portid);</div>
<div class="line"></div>
<div class="line">            tx_thread[lcore_id].tx_queue_id[portid] = queueid;</div>
<div class="line">            queueid++;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; n_rx_thread; i++) {</div>
<div class="line">        lcore_id = rx_thread[i].conf.lcore_id;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(lcore_id) == 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                    <span class="stringliteral">&quot;Cannot start Rx thread on lcore %u: lcore disabled\n&quot;</span>,</div>
<div class="line">                    lcore_id</div>
<div class="line">                );</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;\nInitializing rx queues for Rx thread %d on lcore %u ... &quot;</span>,</div>
<div class="line">                i, lcore_id);</div>
<div class="line">        fflush(stdout);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* init RX queues */</span></div>
<div class="line">        <span class="keywordflow">for</span> (queue = 0; queue &lt; rx_thread[i].n_rx_queue; ++queue) {</div>
<div class="line">            portid = rx_thread[i].rx_queue_list[queue].port_id;</div>
<div class="line">            queueid = rx_thread[i].rx_queue_list[queue].queue_id;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (numa_on)</div>
<div class="line">                socketid = (uint8_t)<a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(lcore_id);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                socketid = 0;</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;rxq=%d,%d,%d &quot;</span>, portid, queueid, socketid);</div>
<div class="line">            fflush(stdout);</div>
<div class="line"></div>
<div class="line">            ret = <a name="a102"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(portid, queueid, nb_rxd,</div>
<div class="line">                    socketid,</div>
<div class="line">                    NULL,</div>
<div class="line">                    pktmbuf_pool[socketid]);</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">                <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;rte_eth_rx_queue_setup: err=%d, &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;port=%d\n&quot;</span>, ret, portid);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* start ports */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Start device */</span></div>
<div class="line">        ret = <a name="a103"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(portid);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;rte_eth_dev_start: err=%d, port=%d\n&quot;</span>,</div>
<div class="line">                ret, portid);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * If enabled, put device in promiscuous mode.</span></div>
<div class="line"><span class="comment">         * This allows IO forwarding mode to forward packets</span></div>
<div class="line"><span class="comment">         * to itself through 2 cross-connected  ports of the</span></div>
<div class="line"><span class="comment">         * target machine.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (promiscuous_on)</div>
<div class="line">            <a name="a104"></a><a class="code" href="rte__ethdev_8h.html#aa8064b25aee324bdbbf779ea23d55f49">rte_eth_promiscuous_enable</a>(portid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    check_all_ports_link_status((uint8_t)nb_ports, enabled_port_mask);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (lthreads_on) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Starting L-Threading Model\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (APP_CPU_LOAD &gt; 0)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="keywordflow">if</span> (cpu_load_lcore_id &gt; 0)</div>
<div class="line">            <span class="comment">/* Use one lcore for cpu load collector */</span></div>
<div class="line">            nb_lcores--;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">        lthread_num_schedulers_set(nb_lcores);</div>
<div class="line">        <a name="a105"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(sched_spawner, NULL, <a name="a106"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2adace253c3a0d90f0e324943d18631a1ef4">SKIP_MASTER</a>);</div>
<div class="line">        lthread_master_spawner(NULL);</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Starting P-Threading Model\n&quot;</span>);</div>
<div class="line">        <span class="comment">/* launch per-lcore init on every lcore */</span></div>
<div class="line">        <a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(pthread_run, NULL, <a name="a107"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2ada39ec34f33f669f99bd28ab7c58a952ac">CALL_MASTER</a>);</div>
<div class="line">        <a name="a108"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(lcore_id) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a109"></a><a class="code" href="rte__launch_8h.html#a1282dc7cd7e6793afab3ef29239ddf54">rte_eal_wait_lcore</a>(lcore_id) &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
