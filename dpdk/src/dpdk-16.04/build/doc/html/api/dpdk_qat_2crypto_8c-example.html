<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: dpdk_qat/crypto.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">dpdk_qat/crypto.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;strings.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CPA_CY_SYM_DP_TMP_WORKAROUND 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;cpa.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cpa_types.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cpa_cy_sym_dp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cpa_cy_common.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cpa_cy_im.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;icp_sal_user.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;icp_sal_poll.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;crypto.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* CIPHER KEY LENGTHS */</span></div>
<div class="line"><span class="preprocessor">#define KEY_SIZE_64_IN_BYTES    (64 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KEY_SIZE_56_IN_BYTES    (56 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KEY_SIZE_128_IN_BYTES   (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KEY_SIZE_168_IN_BYTES   (168 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KEY_SIZE_192_IN_BYTES   (192 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KEY_SIZE_256_IN_BYTES   (256 / 8)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* HMAC AUTH KEY LENGTHS */</span></div>
<div class="line"><span class="preprocessor">#define AES_XCBC_AUTH_KEY_LENGTH_IN_BYTES   (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA1_AUTH_KEY_LENGTH_IN_BYTES       (160 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA224_AUTH_KEY_LENGTH_IN_BYTES     (224 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA256_AUTH_KEY_LENGTH_IN_BYTES     (256 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA384_AUTH_KEY_LENGTH_IN_BYTES     (384 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA512_AUTH_KEY_LENGTH_IN_BYTES     (512 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MD5_AUTH_KEY_LENGTH_IN_BYTES        (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KASUMI_AUTH_KEY_LENGTH_IN_BYTES     (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* HASH DIGEST LENGHTS */</span></div>
<div class="line"><span class="preprocessor">#define AES_XCBC_DIGEST_LENGTH_IN_BYTES     (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define AES_XCBC_96_DIGEST_LENGTH_IN_BYTES  (96 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MD5_DIGEST_LENGTH_IN_BYTES      (128 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA1_DIGEST_LENGTH_IN_BYTES     (160 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA1_96_DIGEST_LENGTH_IN_BYTES      (96 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA224_DIGEST_LENGTH_IN_BYTES       (224 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA256_DIGEST_LENGTH_IN_BYTES       (256 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA384_DIGEST_LENGTH_IN_BYTES       (384 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SHA512_DIGEST_LENGTH_IN_BYTES       (512 / 8)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KASUMI_DIGEST_LENGTH_IN_BYTES       (32 / 8)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IV_LENGTH_16_BYTES  (16)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IV_LENGTH_8_BYTES   (8)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * rte_memzone is used to allocate physically contiguous virtual memory.</span></div>
<div class="line"><span class="comment"> * In this application we allocate a single block and divide between variables</span></div>
<div class="line"><span class="comment"> * which require a virtual to physical mapping for use by the QAT driver.</span></div>
<div class="line"><span class="comment"> * Virt2phys is only performed during initialisation and not on the data-path.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define LCORE_MEMZONE_SIZE  (1 &lt;&lt; 22)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>lcore_memzone</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__memzone.html">rte_memzone</a> *memzone;</div>
<div class="line">    <span class="keywordtype">void</span> *next_free_address;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Size the qa software response queue.</span></div>
<div class="line"><span class="comment"> * Note: Head and Tail are 8 bit, therefore, the queue is</span></div>
<div class="line"><span class="comment"> * fixed to 256 entries.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define CRYPTO_SOFTWARE_QUEUE_SIZE 256</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>qa_callbackQueue {</div>
<div class="line">    uint8_t head;</div>
<div class="line">    uint8_t tail;</div>
<div class="line">    uint16_t numEntries;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *qaCallbackRing[CRYPTO_SOFTWARE_QUEUE_SIZE];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>qa_core_conf {</div>
<div class="line">    CpaCySymDpSessionCtx *encryptSessionHandleTbl[NUM_CRYPTO][NUM_HMAC];</div>
<div class="line">    CpaCySymDpSessionCtx *decryptSessionHandleTbl[NUM_CRYPTO][NUM_HMAC];</div>
<div class="line">    CpaInstanceHandle instanceHandle;</div>
<div class="line">    <span class="keyword">struct </span>qa_callbackQueue callbackQueue;</div>
<div class="line">    uint64_t qaOutstandingRequests;</div>
<div class="line">    uint64_t numResponseAttempts;</div>
<div class="line">    uint8_t kickFreq;</div>
<div class="line">    <span class="keywordtype">void</span> *pPacketIV;</div>
<div class="line">    CpaPhysicalAddr packetIVPhy;</div>
<div class="line">    <span class="keyword">struct </span>lcore_memzone lcoreMemzone;</div>
<div class="line">} <a name="a2"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_CORES   (RTE_MAX_LCORE)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>qa_core_conf qaCoreConf[MAX_CORES];</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *Create maximum possible key size,</span></div>
<div class="line"><span class="comment"> *One for cipher and one for hash</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>glob_keys {</div>
<div class="line">    uint8_t cipher_key[32];</div>
<div class="line">    uint8_t hash_key[64];</div>
<div class="line">    uint8_t iv[16];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>glob_keys g_crypto_hash_keys = {</div>
<div class="line">    .cipher_key = {0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,</div>
<div class="line">        0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,</div>
<div class="line">        0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,</div>
<div class="line">        0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20},</div>
<div class="line">    .hash_key = {0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,</div>
<div class="line">        0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,</div>
<div class="line">        0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,</div>
<div class="line">        0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20,</div>
<div class="line">        0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,</div>
<div class="line">        0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,</div>
<div class="line">        0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,</div>
<div class="line">        0x39,0x4a,0x4b,0x4c,0x4d,0x4e,0x4f,0x50},</div>
<div class="line">    .iv = {0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,</div>
<div class="line">        0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Offsets from the start of the packet.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define PACKET_DATA_START_PHYS(p) \</span></div>
<div class="line"><span class="preprocessor">        ((p)-&gt;buf_physaddr + (p)-&gt;data_off)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A fixed offset to where the crypto is to be performed, which is the first</span></div>
<div class="line"><span class="comment"> * byte after the Ethernet(14 bytes) and IPv4 headers(20 bytes)</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define CRYPTO_START_OFFSET     (14+20)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HASH_START_OFFSET       (14+20)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CIPHER_BLOCK_DEFAULT_SIZE   (16)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HASH_BLOCK_DEFAULT_SIZE     (16)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Offset to the opdata from the start of the data portion of packet.</span></div>
<div class="line"><span class="comment"> * Assumption: The buffer is physically contiguous.</span></div>
<div class="line"><span class="comment"> * +18 takes this to the next cache line.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CRYPTO_OFFSET_TO_OPDATA     (ETHER_MAX_LEN+18)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Default number of requests to place on the hardware ring before kicking the</span></div>
<div class="line"><span class="comment"> * ring pointers.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define CRYPTO_BURST_TX (16)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Only call the qa poll function when the number responses in the software</span></div>
<div class="line"><span class="comment"> * queue drops below this number.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define CRYPTO_QUEUED_RESP_POLL_THRESHOLD   (32)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Limit the number of polls per call to get_next_response.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define GET_NEXT_RESPONSE_FREQ  (32)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Max number of responses to pull from the qa in one poll.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define CRYPTO_MAX_RESPONSE_QUOTA \</span></div>
<div class="line"><span class="preprocessor">        (CRYPTO_SOFTWARE_QUEUE_SIZE-CRYPTO_QUEUED_RESP_POLL_THRESHOLD-1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CRYPTO_QUEUED_RESP_POLL_THRESHOLD + CRYPTO_MAX_RESPONSE_QUOTA &gt;= \</span></div>
<div class="line"><span class="preprocessor">        CRYPTO_SOFTWARE_QUEUE_SIZE)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#error Its possible to overflow the qa response Q with current poll and \</span></div>
<div class="line"><span class="preprocessor">        response quota.</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">crypto_callback(CpaCySymDpOpData *pOpData,</div>
<div class="line">        <a name="a3"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> CpaStatus status,</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> CpaBoolean verifyResult)</div>
<div class="line">{</div>
<div class="line">    uint32_t lcore_id;</div>
<div class="line">    lcore_id = <a name="a4"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>qa_callbackQueue *callbackQ = &amp;(qaCoreConf[lcore_id].callbackQueue);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Received a completion from the QA hardware.</span></div>
<div class="line"><span class="comment">     * Place the response on the return queue.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    callbackQ-&gt;qaCallbackRing[callbackQ-&gt;head] = pOpData-&gt;pCallbackTag;</div>
<div class="line">    callbackQ-&gt;head++;</div>
<div class="line">    callbackQ-&gt;numEntries++;</div>
<div class="line">    qaCoreConf[lcore_id].qaOutstandingRequests--;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">qa_crypto_callback(CpaCySymDpOpData *pOpData, CpaStatus status,</div>
<div class="line">        CpaBoolean verifyResult)</div>
<div class="line">{</div>
<div class="line">    crypto_callback(pOpData, status, verifyResult);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Each allocation from a particular memzone lasts for the life-time of</span></div>
<div class="line"><span class="comment"> * the application. No freeing of previous allocations will occur.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">alloc_memzone_region(uint32_t length, uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *current_free_addr_ptr = NULL;</div>
<div class="line">    <span class="keyword">struct </span>lcore_memzone *lcore_memzone = &amp;(qaCoreConf[lcore_id].lcoreMemzone);</div>
<div class="line"></div>
<div class="line">    current_free_addr_ptr  = lcore_memzone-&gt;next_free_address;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (current_free_addr_ptr + length &gt;=</div>
<div class="line">        (<span class="keywordtype">char</span> *)lcore_memzone-&gt;memzone-&gt;addr + lcore_memzone-&gt;memzone-&gt;len) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: No memory available in memzone\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    lcore_memzone-&gt;next_free_address = current_free_addr_ptr + length;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)current_free_addr_ptr;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Virtual to Physical Address translation is only executed during initialization</span></div>
<div class="line"><span class="comment"> * and not on the data-path.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> CpaPhysicalAddr</div>
<div class="line">qa_v2p(<span class="keywordtype">void</span> *ptr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structrte__memzone.html">rte_memzone</a> *memzone = NULL;</div>
<div class="line">    uint32_t lcore_id = 0;</div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__lcore_8h.html#a034c95b6412f09e8de11d430267dc1ba">RTE_LCORE_FOREACH</a>(lcore_id) {</div>
<div class="line">        memzone = qaCoreConf[lcore_id].lcoreMemzone.memzone;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ((<span class="keywordtype">char</span>*) ptr &gt;= (<span class="keywordtype">char</span> *) memzone-&gt;<a name="a6"></a><a class="code" href="structrte__memzone.html#ae5bd6c22dbf0f6b5b0ae0233f8eb3704">addr</a> &amp;&amp;</div>
<div class="line">                (<span class="keywordtype">char</span>*) ptr &lt; ((<span class="keywordtype">char</span>*) memzone-&gt;<a class="code" href="structrte__memzone.html#ae5bd6c22dbf0f6b5b0ae0233f8eb3704">addr</a> + memzone-&gt;<a name="a7"></a><a class="code" href="structrte__memzone.html#a7360b55975153b822efc5217b7734e6a">len</a>)) {</div>
<div class="line">            <span class="keywordflow">return</span> (CpaPhysicalAddr)</div>
<div class="line">                    (memzone-&gt;<a name="a8"></a><a class="code" href="structrte__memzone.html#a3901f538726d14b9ad14e0bd7578c959">phys_addr</a> + ((<span class="keywordtype">char</span> *) ptr - (<span class="keywordtype">char</span>*) memzone-&gt;<a class="code" href="structrte__memzone.html#ae5bd6c22dbf0f6b5b0ae0233f8eb3704">addr</a>));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Crypto: Corresponding physical address not found in memzone\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> (CpaPhysicalAddr) 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> CpaStatus</div>
<div class="line">getCoreAffinity(Cpa32U *coreAffinity, <span class="keyword">const</span> CpaInstanceHandle instanceHandle)</div>
<div class="line">{</div>
<div class="line">    CpaInstanceInfo2 info;</div>
<div class="line">    Cpa16U i = 0;</div>
<div class="line">    CpaStatus status = CPA_STATUS_SUCCESS;</div>
<div class="line"></div>
<div class="line">    memset(&amp;info, 0, <span class="keyword">sizeof</span>(CpaInstanceInfo2));</div>
<div class="line"></div>
<div class="line">    status = cpaCyInstanceGetInfo2(instanceHandle, &amp;info);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Error getting instance info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_CORES; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (CPA_BITMAP_BIT_TEST(info.coreAffinity, i)) {</div>
<div class="line">            *coreAffinity = i;</div>
<div class="line">            <span class="keywordflow">return</span> CPA_STATUS_SUCCESS;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> CpaStatus</div>
<div class="line">get_crypto_instance_on_core(CpaInstanceHandle *pInstanceHandle,</div>
<div class="line">        uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line">    Cpa16U numInstances = 0, i = 0;</div>
<div class="line">    CpaStatus status = CPA_STATUS_FAIL;</div>
<div class="line">    CpaInstanceHandle *pLocalInstanceHandles = NULL;</div>
<div class="line">    Cpa32U coreAffinity = 0;</div>
<div class="line"></div>
<div class="line">    status = cpaCyGetNumInstances(&amp;numInstances);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status || numInstances == 0) {</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    pLocalInstanceHandles = <a name="a9"></a><a class="code" href="rte__malloc_8h.html#afb7316a4ec228ed9b8ffc1864b03d85b">rte_malloc</a>(<span class="stringliteral">&quot;pLocalInstanceHandles&quot;</span>,</div>
<div class="line">            <span class="keyword">sizeof</span>(CpaInstanceHandle) * numInstances, RTE_CACHE_LINE_SIZE);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NULL == pLocalInstanceHandles) {</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line">    status = cpaCyGetInstances(numInstances, pLocalInstanceHandles);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: cpaCyGetInstances failed with status: %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>, status);</div>
<div class="line">        <a name="a10"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>((<span class="keywordtype">void</span> *) pLocalInstanceHandles);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; numInstances; i++) {</div>
<div class="line">        status = getCoreAffinity(&amp;coreAffinity, pLocalInstanceHandles[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>((<span class="keywordtype">void</span> *) pLocalInstanceHandles);</div>
<div class="line">            <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (coreAffinity == lcore_id) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Crypto: instance found on core %d\n&quot;</span>, i);</div>
<div class="line">            *pInstanceHandle = pLocalInstanceHandles[i];</div>
<div class="line">            <span class="keywordflow">return</span> CPA_STATUS_SUCCESS;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* core affinity not found */</span></div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>((<span class="keywordtype">void</span> *) pLocalInstanceHandles);</div>
<div class="line">    <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> CpaStatus</div>
<div class="line">initCySymSession(<span class="keyword">const</span> <span class="keywordtype">int</span> pkt_cipher_alg,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> pkt_hash_alg, <span class="keyword">const</span> CpaCySymHashMode hashMode,</div>
<div class="line">        <span class="keyword">const</span> CpaCySymCipherDirection crypto_direction,</div>
<div class="line">        CpaCySymSessionCtx **ppSessionCtx,</div>
<div class="line">        <span class="keyword">const</span> CpaInstanceHandle cyInstanceHandle,</div>
<div class="line">        <span class="keyword">const</span> uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line">    Cpa32U sessionCtxSizeInBytes = 0;</div>
<div class="line">    CpaStatus status = CPA_STATUS_FAIL;</div>
<div class="line">    CpaBoolean isCrypto = CPA_TRUE, isHmac = CPA_TRUE;</div>
<div class="line">    CpaCySymSessionSetupData sessionSetupData;</div>
<div class="line"></div>
<div class="line">    memset(&amp;sessionSetupData, 0, <span class="keyword">sizeof</span>(CpaCySymSessionSetupData));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Assumption: key length is set to each algorithm&#39;s max length */</span></div>
<div class="line">    <span class="keywordflow">switch</span> (pkt_cipher_alg) {</div>
<div class="line">    <span class="keywordflow">case</span> NO_CIPHER:</div>
<div class="line">        isCrypto = CPA_FALSE;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_DES:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_DES_ECB;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_64_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_DES_CBC:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_DES_CBC;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_64_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_DES3:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_3DES_ECB;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_192_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_DES3_CBC:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_3DES_CBC;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_192_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_AES:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_AES_ECB;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_128_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_AES_CBC_128:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_AES_CBC;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_128_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> CIPHER_KASUMI_F8:</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherAlgorithm =</div>
<div class="line">                CPA_CY_SYM_CIPHER_KASUMI_F8;</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherKeyLenInBytes =</div>
<div class="line">                KEY_SIZE_128_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Undefined Cipher specified\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Set the cipher direction */</span></div>
<div class="line">    <span class="keywordflow">if</span> (isCrypto) {</div>
<div class="line">        sessionSetupData.cipherSetupData.cipherDirection = crypto_direction;</div>
<div class="line">        sessionSetupData.cipherSetupData.pCipherKey =</div>
<div class="line">                g_crypto_hash_keys.cipher_key;</div>
<div class="line">        sessionSetupData.symOperation = CPA_CY_SYM_OP_CIPHER;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup Hash common fields */</span></div>
<div class="line">    <span class="keywordflow">switch</span> (pkt_hash_alg) {</div>
<div class="line">    <span class="keywordflow">case</span> NO_HASH:</div>
<div class="line">        isHmac = CPA_FALSE;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_AES_XCBC:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_AES_XCBC;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                AES_XCBC_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_AES_XCBC_96:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_AES_XCBC;</div>
<div class="line">                sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                AES_XCBC_96_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_MD5:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_MD5;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                MD5_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA1:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA1;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA1_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA1_96:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA1;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA1_96_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA224:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA224;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA224_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA256:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA256;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA256_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA384:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA384;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA384_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_SHA512:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_SHA512;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                SHA512_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> HASH_KASUMI_F9:</div>
<div class="line">        sessionSetupData.hashSetupData.hashAlgorithm = CPA_CY_SYM_HASH_KASUMI_F9;</div>
<div class="line">        sessionSetupData.hashSetupData.digestResultLenInBytes =</div>
<div class="line">                KASUMI_DIGEST_LENGTH_IN_BYTES;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Undefined Hash specified\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (isHmac) {</div>
<div class="line">        sessionSetupData.hashSetupData.hashMode = hashMode;</div>
<div class="line">        sessionSetupData.symOperation = CPA_CY_SYM_OP_HASH;</div>
<div class="line">        <span class="comment">/* If using authenticated hash setup key lengths */</span></div>
<div class="line">        <span class="keywordflow">if</span> (CPA_CY_SYM_HASH_MODE_AUTH == hashMode) {</div>
<div class="line">            <span class="comment">/* Use a common max length key */</span></div>
<div class="line">            sessionSetupData.hashSetupData.authModeSetupData.authKey =</div>
<div class="line">                    g_crypto_hash_keys.hash_key;</div>
<div class="line">            <span class="keywordflow">switch</span> (pkt_hash_alg) {</div>
<div class="line">            <span class="keywordflow">case</span> HASH_AES_XCBC:</div>
<div class="line">            <span class="keywordflow">case</span> HASH_AES_XCBC_96:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        AES_XCBC_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_MD5:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA1_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA1:</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA1_96:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA1_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA224:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA224_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA256:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA256_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA384:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA384_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_SHA512:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        SHA512_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> HASH_KASUMI_F9:</div>
<div class="line">                sessionSetupData.hashSetupData.authModeSetupData.authKeyLenInBytes =</div>
<div class="line">                        KASUMI_AUTH_KEY_LENGTH_IN_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                printf(<span class="stringliteral">&quot;Crypto: Undefined Hash specified\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Only high priority supported */</span></div>
<div class="line">    sessionSetupData.sessionPriority = CPA_CY_PRIORITY_HIGH;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If chaining algorithms */</span></div>
<div class="line">    <span class="keywordflow">if</span> (isCrypto &amp;&amp; isHmac) {</div>
<div class="line">        sessionSetupData.symOperation = CPA_CY_SYM_OP_ALGORITHM_CHAINING;</div>
<div class="line">        <span class="comment">/* @assumption Alg Chain order is cipher then hash for encrypt</span></div>
<div class="line"><span class="comment">         * and hash then cipher then has for decrypt*/</span></div>
<div class="line">        <span class="keywordflow">if</span> (CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT == crypto_direction) {</div>
<div class="line">            sessionSetupData.algChainOrder =</div>
<div class="line">                    CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            sessionSetupData.algChainOrder =</div>
<div class="line">                    CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!isCrypto &amp;&amp; !isHmac) {</div>
<div class="line">        *ppSessionCtx = NULL;</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_SUCCESS;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set flags for digest operations */</span></div>
<div class="line">    sessionSetupData.digestIsAppended = CPA_FALSE;</div>
<div class="line">    sessionSetupData.verifyDigest = CPA_TRUE;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the session context size based on the crypto and/or hash operations*/</span></div>
<div class="line">    status = cpaCySymDpSessionCtxGetSize(cyInstanceHandle, &amp;sessionSetupData,</div>
<div class="line">            &amp;sessionCtxSizeInBytes);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: cpaCySymDpSessionCtxGetSize error, status: %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                status);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    *ppSessionCtx = alloc_memzone_region(sessionCtxSizeInBytes, lcore_id);</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == *ppSessionCtx) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Failed to allocate memory for Session Context\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    status = cpaCySymDpInitSession(cyInstanceHandle, &amp;sessionSetupData,</div>
<div class="line">            *ppSessionCtx);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: cpaCySymDpInitSession failed with status %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>, status);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> CPA_STATUS_SUCCESS;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> CpaStatus</div>
<div class="line">initSessionDataTables(<span class="keyword">struct</span> qa_core_conf *qaCoreConf,uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line">    Cpa32U i = 0, j = 0;</div>
<div class="line">    CpaStatus status = CPA_STATUS_FAIL;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_CRYPTO; i++) {</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; NUM_HMAC; j++) {</div>
<div class="line">            <span class="keywordflow">if</span> (((i == CIPHER_KASUMI_F8) &amp;&amp; (j != NO_HASH) &amp;&amp; (j != HASH_KASUMI_F9)) ||</div>
<div class="line">                ((i != NO_CIPHER) &amp;&amp; (i != CIPHER_KASUMI_F8) &amp;&amp; (j == HASH_KASUMI_F9)))</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            status = initCySymSession(i, j, CPA_CY_SYM_HASH_MODE_AUTH,</div>
<div class="line">                    CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT,</div>
<div class="line">                    &amp;qaCoreConf-&gt;encryptSessionHandleTbl[i][j],</div>
<div class="line">                    qaCoreConf-&gt;instanceHandle,</div>
<div class="line">                    lcore_id);</div>
<div class="line">            <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Crypto: Failed to initialize Encrypt sessions\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">            }</div>
<div class="line">            status = initCySymSession(i, j, CPA_CY_SYM_HASH_MODE_AUTH,</div>
<div class="line">                    CPA_CY_SYM_CIPHER_DIRECTION_DECRYPT,</div>
<div class="line">                    &amp;qaCoreConf-&gt;decryptSessionHandleTbl[i][j],</div>
<div class="line">                    qaCoreConf-&gt;instanceHandle,</div>
<div class="line">                    lcore_id);</div>
<div class="line">            <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Crypto: Failed to initialize Decrypt sessions\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> CPA_STATUS_SUCCESS;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">crypto_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != icp_sal_userStartMultiProcess(<span class="stringliteral">&quot;SSL&quot;</span>,CPA_FALSE)) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Could not start sal for user space\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> CPA_STATUS_FAIL;</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;Crypto: icp_sal_userStartMultiProcess(\&quot;SSL\&quot;,CPA_FALSE)\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Per core initialisation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">per_core_crypto_init(uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line">    CpaStatus status = CPA_STATUS_FAIL;</div>
<div class="line">    <span class="keywordtype">char</span> memzone_name[<a name="a11"></a><a class="code" href="rte__memzone_8h.html#a5621a1253a3875b601cdc533b3180240">RTE_MEMZONE_NAMESIZE</a>];</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> socketID = <a name="a12"></a><a class="code" href="rte__lcore_8h.html#afef423c8171c6800dc6583979fe85856">rte_lcore_to_socket_id</a>(lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate software ring for response messages. */</span></div>
<div class="line"></div>
<div class="line">    qaCoreConf[lcore_id].callbackQueue.head = 0;</div>
<div class="line">    qaCoreConf[lcore_id].callbackQueue.tail = 0;</div>
<div class="line">    qaCoreConf[lcore_id].callbackQueue.numEntries = 0;</div>
<div class="line">    qaCoreConf[lcore_id].kickFreq = 0;</div>
<div class="line">    qaCoreConf[lcore_id].qaOutstandingRequests = 0;</div>
<div class="line">    qaCoreConf[lcore_id].numResponseAttempts = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise and reserve lcore memzone for virt2phys translation */</span></div>
<div class="line">    snprintf(memzone_name,</div>
<div class="line">            <a class="code" href="rte__memzone_8h.html#a5621a1253a3875b601cdc533b3180240">RTE_MEMZONE_NAMESIZE</a>,</div>
<div class="line">            <span class="stringliteral">&quot;lcore_%u&quot;</span>,</div>
<div class="line">            lcore_id);</div>
<div class="line"></div>
<div class="line">    qaCoreConf[lcore_id].lcoreMemzone.memzone = <a name="a13"></a><a class="code" href="rte__memzone_8h.html#a3ccbea77ccab608c6e683817a3eb170f">rte_memzone_reserve</a>(</div>
<div class="line">            memzone_name,</div>
<div class="line">            LCORE_MEMZONE_SIZE,</div>
<div class="line">            socketID,</div>
<div class="line">            0);</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == qaCoreConf[lcore_id].lcoreMemzone.memzone) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Error allocating memzone on lcore %u\n&quot;</span>,lcore_id);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    qaCoreConf[lcore_id].lcoreMemzone.next_free_address =</div>
<div class="line">                            qaCoreConf[lcore_id].lcoreMemzone.memzone-&gt;addr;</div>
<div class="line"></div>
<div class="line">    qaCoreConf[lcore_id].pPacketIV = alloc_memzone_region(IV_LENGTH_16_BYTES,</div>
<div class="line">                            lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NULL == qaCoreConf[lcore_id].pPacketIV ) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Failed to allocate memory for Initialization Vector\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    memcpy(qaCoreConf[lcore_id].pPacketIV, &amp;g_crypto_hash_keys.iv,</div>
<div class="line">            IV_LENGTH_16_BYTES);</div>
<div class="line"></div>
<div class="line">    qaCoreConf[lcore_id].packetIVPhy = qa_v2p(qaCoreConf[lcore_id].pPacketIV);</div>
<div class="line">    <span class="keywordflow">if</span> (0 == qaCoreConf[lcore_id].packetIVPhy) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Invalid physical address for Initialization Vector\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Obtain the instance handle that is mapped to the current lcore.</span></div>
<div class="line"><span class="comment">     * This can fail if an instance is not mapped to a bank which has been</span></div>
<div class="line"><span class="comment">     * affinitized to the current lcore.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    status = get_crypto_instance_on_core(&amp;(qaCoreConf[lcore_id].instanceHandle),</div>
<div class="line">            lcore_id);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: get_crypto_instance_on_core failed with status: %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                status);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    status = cpaCySymDpRegCbFunc(qaCoreConf[lcore_id].instanceHandle,</div>
<div class="line">            (CpaCySymDpCbFunc) qa_crypto_callback);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: cpaCySymDpRegCbFunc failed with status: %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>, status);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Set the address translation callback for virtual to physcial address</span></div>
<div class="line"><span class="comment">     * mapping. This will be called by the QAT driver during initialisation only.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    status = cpaCySetAddressTranslation(qaCoreConf[lcore_id].instanceHandle,</div>
<div class="line">            (CpaVirtualToPhysical) qa_v2p);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: cpaCySetAddressTranslation failed with status: %&quot;</span>PRId32<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                status);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    status = initSessionDataTables(&amp;qaCoreConf[lcore_id],lcore_id);</div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != status) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Crypto: Failed to allocate all session tables.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> CpaStatus</div>
<div class="line">enqueueOp(CpaCySymDpOpData *opData, uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    CpaStatus status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Assumption is there is no requirement to do load balancing between</span></div>
<div class="line"><span class="comment">     * acceleration units - that is one acceleration unit is tied to a core.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    opData-&gt;instanceHandle = qaCoreConf[lcore_id].instanceHandle;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((++qaCoreConf[lcore_id].kickFreq) % CRYPTO_BURST_TX == 0) {</div>
<div class="line">        status = cpaCySymDpEnqueueOp(opData, CPA_TRUE);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        status = cpaCySymDpEnqueueOp(opData, CPA_FALSE);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    qaCoreConf[lcore_id].qaOutstandingRequests++;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> status;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">crypto_flush_tx_queue(uint32_t lcore_id)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    cpaCySymDpPerformOpNow(qaCoreConf[lcore_id].instanceHandle);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> crypto_result</div>
<div class="line">crypto_encrypt(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *rte_buff, <span class="keyword">enum</span> cipher_alg c, <span class="keyword">enum</span> hash_alg h)</div>
<div class="line">{</div>
<div class="line">    CpaCySymDpOpData *opData =</div>
<div class="line">            <a name="a14"></a><a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(rte_buff, CpaCySymDpOpData *,</div>
<div class="line">                        CRYPTO_OFFSET_TO_OPDATA);</div>
<div class="line">    uint32_t lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(c &gt;= NUM_CRYPTO || h &gt;= NUM_HMAC))</div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line"></div>
<div class="line">    lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    memset(opData, 0, <span class="keyword">sizeof</span>(CpaCySymDpOpData));</div>
<div class="line"></div>
<div class="line">    opData-&gt;srcBuffer = opData-&gt;dstBuffer = PACKET_DATA_START_PHYS(rte_buff);</div>
<div class="line">    opData-&gt;srcBufferLen = opData-&gt;dstBufferLen = rte_buff-&gt;<a name="a16"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line">    opData-&gt;sessionCtx = qaCoreConf[lcore_id].encryptSessionHandleTbl[c][h];</div>
<div class="line">    opData-&gt;thisPhys = PACKET_DATA_START_PHYS(rte_buff)</div>
<div class="line">            + CRYPTO_OFFSET_TO_OPDATA;</div>
<div class="line">    opData-&gt;pCallbackTag = rte_buff;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if no crypto or hash operations are specified return fail */</span></div>
<div class="line">    <span class="keywordflow">if</span> (NO_CIPHER == c &amp;&amp; NO_HASH == h)</div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NO_CIPHER != c) {</div>
<div class="line">        opData-&gt;pIv = qaCoreConf[lcore_id].pPacketIV;</div>
<div class="line">        opData-&gt;iv = qaCoreConf[lcore_id].packetIVPhy;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (CIPHER_AES_CBC_128 == c)</div>
<div class="line">            opData-&gt;ivLenInBytes = IV_LENGTH_16_BYTES;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            opData-&gt;ivLenInBytes = IV_LENGTH_8_BYTES;</div>
<div class="line"></div>
<div class="line">        opData-&gt;cryptoStartSrcOffsetInBytes = CRYPTO_START_OFFSET;</div>
<div class="line">        opData-&gt;messageLenToCipherInBytes = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a></div>
<div class="line">                - CRYPTO_START_OFFSET;</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Work around for padding, message length has to be a multiple of</span></div>
<div class="line"><span class="comment">         * block size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        opData-&gt;messageLenToCipherInBytes -= opData-&gt;messageLenToCipherInBytes</div>
<div class="line">                % CIPHER_BLOCK_DEFAULT_SIZE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NO_HASH != h) {</div>
<div class="line"></div>
<div class="line">        opData-&gt;hashStartSrcOffsetInBytes = HASH_START_OFFSET;</div>
<div class="line">        opData-&gt;messageLenToHashInBytes = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a></div>
<div class="line">                - HASH_START_OFFSET;</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Work around for padding, message length has to be a multiple of block</span></div>
<div class="line"><span class="comment">         * size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        opData-&gt;messageLenToHashInBytes -= opData-&gt;messageLenToHashInBytes</div>
<div class="line">                % HASH_BLOCK_DEFAULT_SIZE;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Assumption: Ok ignore the passed digest pointer and place HMAC at end</span></div>
<div class="line"><span class="comment">         * of packet.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        opData-&gt;digestResult = rte_buff-&gt;<a name="a17"></a><a class="code" href="structrte__mbuf.html#a6f9e031fb601226363d0106789df32f7">buf_physaddr</a> + rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != enqueueOp(opData, lcore_id)) {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Failed to place a packet on the hardware queue.</span></div>
<div class="line"><span class="comment">         * Most likely because the QA hardware is busy.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> CRYPTO_RESULT_IN_PROGRESS;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> crypto_result</div>
<div class="line">crypto_decrypt(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *rte_buff, <span class="keyword">enum</span> cipher_alg c, <span class="keyword">enum</span> hash_alg h)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">    CpaCySymDpOpData *opData = <a class="code" href="rte__mbuf_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(rte_buff, <span class="keywordtype">void</span> *,</div>
<div class="line">                               CRYPTO_OFFSET_TO_OPDATA);</div>
<div class="line">    uint32_t lcore_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(c &gt;= NUM_CRYPTO || h &gt;= NUM_HMAC))</div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line"></div>
<div class="line">    lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line"></div>
<div class="line">    memset(opData, 0, <span class="keyword">sizeof</span>(CpaCySymDpOpData));</div>
<div class="line"></div>
<div class="line">    opData-&gt;dstBuffer = opData-&gt;srcBuffer = PACKET_DATA_START_PHYS(rte_buff);</div>
<div class="line">    opData-&gt;dstBufferLen = opData-&gt;srcBufferLen = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line">    opData-&gt;thisPhys = PACKET_DATA_START_PHYS(rte_buff)</div>
<div class="line">            + CRYPTO_OFFSET_TO_OPDATA;</div>
<div class="line">    opData-&gt;sessionCtx = qaCoreConf[lcore_id].decryptSessionHandleTbl[c][h];</div>
<div class="line">    opData-&gt;pCallbackTag = rte_buff;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if no crypto or hmac operations are specified return fail */</span></div>
<div class="line">    <span class="keywordflow">if</span> (NO_CIPHER == c &amp;&amp; NO_HASH == h)</div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NO_CIPHER != c) {</div>
<div class="line">        opData-&gt;pIv = qaCoreConf[lcore_id].pPacketIV;</div>
<div class="line">        opData-&gt;iv = qaCoreConf[lcore_id].packetIVPhy;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (CIPHER_AES_CBC_128 == c)</div>
<div class="line">            opData-&gt;ivLenInBytes = IV_LENGTH_16_BYTES;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            opData-&gt;ivLenInBytes = IV_LENGTH_8_BYTES;</div>
<div class="line"></div>
<div class="line">        opData-&gt;cryptoStartSrcOffsetInBytes = CRYPTO_START_OFFSET;</div>
<div class="line">        opData-&gt;messageLenToCipherInBytes = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a></div>
<div class="line">                - CRYPTO_START_OFFSET;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Work around for padding, message length has to be a multiple of block</span></div>
<div class="line"><span class="comment">         * size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        opData-&gt;messageLenToCipherInBytes -= opData-&gt;messageLenToCipherInBytes</div>
<div class="line">                % CIPHER_BLOCK_DEFAULT_SIZE;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (NO_HASH != h) {</div>
<div class="line">        opData-&gt;hashStartSrcOffsetInBytes = HASH_START_OFFSET;</div>
<div class="line">        opData-&gt;messageLenToHashInBytes = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a></div>
<div class="line">                - HASH_START_OFFSET;</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Work around for padding, message length has to be a multiple of block</span></div>
<div class="line"><span class="comment">         * size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        opData-&gt;messageLenToHashInBytes -= opData-&gt;messageLenToHashInBytes</div>
<div class="line">                % HASH_BLOCK_DEFAULT_SIZE;</div>
<div class="line">        opData-&gt;digestResult = rte_buff-&gt;<a class="code" href="structrte__mbuf.html#a6f9e031fb601226363d0106789df32f7">buf_physaddr</a> + rte_buff-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (CPA_STATUS_SUCCESS != enqueueOp(opData, lcore_id)) {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Failed to place a packet on the hardware queue.</span></div>
<div class="line"><span class="comment">         * Most likely because the QA hardware is busy.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">return</span> CRYPTO_RESULT_FAIL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> CRYPTO_RESULT_IN_PROGRESS;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> *</div>
<div class="line">crypto_get_next_response(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t lcore_id;</div>
<div class="line">    lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>qa_callbackQueue *callbackQ = &amp;(qaCoreConf[lcore_id].callbackQueue);</div>
<div class="line">    <span class="keywordtype">void</span> *entry = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (callbackQ-&gt;numEntries) {</div>
<div class="line">        entry = callbackQ-&gt;qaCallbackRing[callbackQ-&gt;tail];</div>
<div class="line">        callbackQ-&gt;tail++;</div>
<div class="line">        callbackQ-&gt;numEntries--;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* If there are no outstanding requests no need to poll, return entry */</span></div>
<div class="line">    <span class="keywordflow">if</span> (qaCoreConf[lcore_id].qaOutstandingRequests == 0)</div>
<div class="line">        <span class="keywordflow">return</span> entry;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (callbackQ-&gt;numEntries &lt; CRYPTO_QUEUED_RESP_POLL_THRESHOLD</div>
<div class="line">            &amp;&amp; qaCoreConf[lcore_id].numResponseAttempts++</div>
<div class="line">                    % GET_NEXT_RESPONSE_FREQ == 0) {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Only poll the hardware when there is less than</span></div>
<div class="line"><span class="comment">         * CRYPTO_QUEUED_RESP_POLL_THRESHOLD elements in the software queue</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        icp_sal_CyPollDpInstance(qaCoreConf[lcore_id].instanceHandle,</div>
<div class="line">                CRYPTO_MAX_RESPONSE_QUOTA);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> entry;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
