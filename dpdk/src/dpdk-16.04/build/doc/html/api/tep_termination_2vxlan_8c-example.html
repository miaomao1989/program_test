<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: tep_termination/vxlan.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">tep_termination/vxlan.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__hash__crc_8h.html">rte_hash_crc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__udp_8h.html">rte_udp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__sctp_8h.html">rte_sctp.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vxlan.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint16_t</div>
<div class="line">get_psd_sum(<span class="keywordtype">void</span> *l3_hdr, uint16_t ethertype, uint64_t ol_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ethertype == <a name="a0"></a><a class="code" href="rte__ether_8h.html#a08cc3337f1584270c6f9de9bffd14b2b">ETHER_TYPE_IPv4</a>)</div>
<div class="line">        <span class="keywordflow">return</span> <a name="a1"></a><a class="code" href="rte__ip_8h.html#a75f64f54d6cddb4fa42af12dd1554db4">rte_ipv4_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">/* assume ethertype == ETHER_TYPE_IPv6 */</span></div>
<div class="line">        <span class="keywordflow">return</span> <a name="a2"></a><a class="code" href="rte__ip_8h.html#ace337b73683fd373943d46cf79caceb5">rte_ipv6_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_ethernet(<span class="keyword">struct</span> <a name="_a3"></a><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr, <span class="keyword">union</span> tunnel_offload_info *info,</div>
<div class="line">        uint8_t *l4_proto)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structipv4__hdr.html">ipv4_hdr</a> *<a class="code" href="structipv4__hdr.html">ipv4_hdr</a>;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a5"></a><a class="code" href="structipv6__hdr.html">ipv6_hdr</a> *<a class="code" href="structipv6__hdr.html">ipv6_hdr</a>;</div>
<div class="line">    uint16_t ethertype;</div>
<div class="line"></div>
<div class="line">    info-&gt;outer_l2_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>);</div>
<div class="line">    ethertype = <a name="a6"></a><a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(eth_hdr-&gt;<a name="a7"></a><a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ethertype == <a name="a8"></a><a class="code" href="rte__ether_8h.html#aaaa516211cec2b61e3717c5fec36952f">ETHER_TYPE_VLAN</a>) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a9"></a><a class="code" href="structvlan__hdr.html">vlan_hdr</a> *<a class="code" href="structvlan__hdr.html">vlan_hdr</a> = (<span class="keyword">struct </span>vlan_hdr *)(eth_hdr + 1);</div>
<div class="line">        info-&gt;outer_l2_len  += <span class="keyword">sizeof</span>(<span class="keyword">struct </span>vlan_hdr);</div>
<div class="line">        ethertype = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(vlan_hdr-&gt;<a name="a10"></a><a class="code" href="structvlan__hdr.html#a5f6e76ca3fcc9927ee0ff351b452b89b">eth_proto</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (ethertype) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="rte__ether_8h.html#a08cc3337f1584270c6f9de9bffd14b2b">ETHER_TYPE_IPv4</a>:</div>
<div class="line">        ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)</div>
<div class="line">            ((<span class="keywordtype">char</span> *)eth_hdr + info-&gt;outer_l2_len);</div>
<div class="line">        info-&gt;outer_l3_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv4_hdr);</div>
<div class="line">        *l4_proto = ipv4_hdr-&gt;<a name="a11"></a><a class="code" href="structipv4__hdr.html#a513eb1be3a24fe8df91530edd4517ade">next_proto_id</a>;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a name="a12"></a><a class="code" href="rte__ether_8h.html#ac42bfbd5e6076e6aefffe141c22796a7">ETHER_TYPE_IPv6</a>:</div>
<div class="line">        ipv6_hdr = (<span class="keyword">struct </span>ipv6_hdr *)</div>
<div class="line">            ((<span class="keywordtype">char</span> *)eth_hdr + info-&gt;outer_l2_len);</div>
<div class="line">        info-&gt;outer_l3_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv6_hdr);</div>
<div class="line">        *l4_proto = ipv6_hdr-&gt;<a name="a13"></a><a class="code" href="structipv6__hdr.html#adaae928b69788f774db092e75f1c4fb7">proto</a>;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        info-&gt;outer_l3_len = 0;</div>
<div class="line">        *l4_proto = 0;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint64_t</div>
<div class="line">process_inner_cksums(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr, <span class="keyword">union</span> tunnel_offload_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *l3_hdr = NULL;</div>
<div class="line">    uint8_t l4_proto;</div>
<div class="line">    uint16_t ethertype;</div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ipv4_hdr;</div>
<div class="line">    <span class="keyword">struct </span>ipv6_hdr *ipv6_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a14"></a><a class="code" href="structudp__hdr.html">udp_hdr</a> *<a class="code" href="structudp__hdr.html">udp_hdr</a>;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a15"></a><a class="code" href="structtcp__hdr.html">tcp_hdr</a> *<a class="code" href="structtcp__hdr.html">tcp_hdr</a>;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a16"></a><a class="code" href="structsctp__hdr.html">sctp_hdr</a> *<a class="code" href="structsctp__hdr.html">sctp_hdr</a>;</div>
<div class="line">    uint64_t ol_flags = 0;</div>
<div class="line"></div>
<div class="line">    info-&gt;l2_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>);</div>
<div class="line">    ethertype = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(eth_hdr-&gt;<a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ethertype == <a class="code" href="rte__ether_8h.html#aaaa516211cec2b61e3717c5fec36952f">ETHER_TYPE_VLAN</a>) {</div>
<div class="line">        <span class="keyword">struct </span>vlan_hdr *vlan_hdr = (<span class="keyword">struct </span>vlan_hdr *)(eth_hdr + 1);</div>
<div class="line">        info-&gt;l2_len  += <span class="keyword">sizeof</span>(<span class="keyword">struct </span>vlan_hdr);</div>
<div class="line">        ethertype = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(vlan_hdr-&gt;<a class="code" href="structvlan__hdr.html#a5f6e76ca3fcc9927ee0ff351b452b89b">eth_proto</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    l3_hdr = (<span class="keywordtype">char</span> *)eth_hdr + info-&gt;l2_len;</div>
<div class="line"></div>
<div class="line">    if (ethertype == <a class="code" href="rte__ether_8h.html#a08cc3337f1584270c6f9de9bffd14b2b">ETHER_TYPE_IPv4</a>) {</div>
<div class="line">        ipv4_hdr = (<span class="keyword">struct </span>ipv4_hdr *)l3_hdr;</div>
<div class="line">        ipv4_hdr-&gt;<a name="a17"></a><a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a> = 0;</div>
<div class="line">        ol_flags |= <a name="a18"></a><a class="code" href="rte__mbuf_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a>;</div>
<div class="line">        ol_flags |= <a name="a19"></a><a class="code" href="rte__mbuf_8h.html#a51280725dafdf282a80b2d964418798c">PKT_TX_IP_CKSUM</a>;</div>
<div class="line">        info-&gt;l3_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv4_hdr);</div>
<div class="line">        l4_proto = ipv4_hdr-&gt;<a class="code" href="structipv4__hdr.html#a513eb1be3a24fe8df91530edd4517ade">next_proto_id</a>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ethertype == <a class="code" href="rte__ether_8h.html#ac42bfbd5e6076e6aefffe141c22796a7">ETHER_TYPE_IPv6</a>) {</div>
<div class="line">        ipv6_hdr = (<span class="keyword">struct </span>ipv6_hdr *)l3_hdr;</div>
<div class="line">        info-&gt;l3_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv6_hdr);</div>
<div class="line">        l4_proto = ipv6_hdr-&gt;<a class="code" href="structipv6__hdr.html#adaae928b69788f774db092e75f1c4fb7">proto</a>;</div>
<div class="line">        ol_flags |= <a name="a20"></a><a class="code" href="rte__mbuf_8h.html#a8478d650a7d2c49b1e1a173e52d52d35">PKT_TX_IPV6</a>;</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> 0; <span class="comment">/* packet type not supported, nothing to do */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (l4_proto == IPPROTO_UDP) {</div>
<div class="line">        udp_hdr = (<span class="keyword">struct </span>udp_hdr *)((<span class="keywordtype">char</span> *)l3_hdr + info-&gt;l3_len);</div>
<div class="line">        ol_flags |= <a name="a21"></a><a class="code" href="rte__mbuf_8h.html#a25b82ba8fa86ddfdbf9237f67a37c366">PKT_TX_UDP_CKSUM</a>;</div>
<div class="line">        udp_hdr-&gt;<a name="a22"></a><a class="code" href="structudp__hdr.html#ae0c0552d7f5d79ad5b0d77c892740c10">dgram_cksum</a> = get_psd_sum(l3_hdr,</div>
<div class="line">                ethertype, ol_flags);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l4_proto == IPPROTO_TCP) {</div>
<div class="line">        tcp_hdr = (<span class="keyword">struct </span>tcp_hdr *)((<span class="keywordtype">char</span> *)l3_hdr + info-&gt;l3_len);</div>
<div class="line">        ol_flags |= <a name="a23"></a><a class="code" href="rte__mbuf_8h.html#a1f4f9c739ef914bcd6c5fae63a4e2b9c">PKT_TX_TCP_CKSUM</a>;</div>
<div class="line">        tcp_hdr-&gt;<a name="a24"></a><a class="code" href="structtcp__hdr.html#a749687f86afcc33e9d390500910ef60d">cksum</a> = get_psd_sum(l3_hdr, ethertype,</div>
<div class="line">                ol_flags);</div>
<div class="line">        <span class="keywordflow">if</span> (tso_segsz != 0) {</div>
<div class="line">            ol_flags |= <a name="a25"></a><a class="code" href="rte__mbuf_8h.html#ad9d8db5f80d34e0a95c56df43d605c87">PKT_TX_TCP_SEG</a>;</div>
<div class="line">            info-&gt;tso_segsz = tso_segsz;</div>
<div class="line">            info-&gt;l4_len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>tcp_hdr);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l4_proto == IPPROTO_SCTP) {</div>
<div class="line">        sctp_hdr = (<span class="keyword">struct </span>sctp_hdr *)((<span class="keywordtype">char</span> *)l3_hdr + info-&gt;l3_len);</div>
<div class="line">        sctp_hdr-&gt;<a name="a26"></a><a class="code" href="structsctp__hdr.html#a0e993f40ec1686b78588605d4e0bde23">cksum</a> = 0;</div>
<div class="line">        ol_flags |= <a name="a27"></a><a class="code" href="rte__mbuf_8h.html#af3d1aa5cec10f00975ae4cd71c4c961e">PKT_TX_SCTP_CKSUM</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ol_flags;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">decapsulation(<span class="keyword">struct</span> <a name="_a28"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkt)</div>
<div class="line">{</div>
<div class="line">    uint8_t l4_proto = 0;</div>
<div class="line">    uint16_t outer_header_len;</div>
<div class="line">    <span class="keyword">struct </span>udp_hdr *udp_hdr;</div>
<div class="line">    <span class="keyword">union </span>tunnel_offload_info info = { .data = 0 };</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *phdr = <a name="a29"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(pkt, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    parse_ethernet(phdr, &amp;info, &amp;l4_proto);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (l4_proto != IPPROTO_UDP)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    udp_hdr = (<span class="keyword">struct </span>udp_hdr *)((<span class="keywordtype">char</span> *)phdr +</div>
<div class="line">        info.outer_l2_len + info.outer_l3_len);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (udp_hdr-&gt;<a name="a30"></a><a class="code" href="structudp__hdr.html#ae18defed4756b8c15e34718f51e86e55">dst_port</a> != <a name="a31"></a><a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(DEFAULT_VXLAN_PORT) &amp;&amp;</div>
<div class="line">        (pkt-&gt;<a name="a32"></a><a class="code" href="structrte__mbuf.html#a8d0990e39ae8f91a4937083eead6b65f">packet_type</a> &amp; <a name="a33"></a><a class="code" href="rte__mbuf_8h.html#a2dc271bd46d5a84dc8b2a3952b0cfec4">RTE_PTYPE_TUNNEL_MASK</a>) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    outer_header_len = info.outer_l2_len + info.outer_l3_len</div>
<div class="line">        + <span class="keyword">sizeof</span>(<span class="keyword">struct </span>udp_hdr) + sizeof(struct <a name="_a34"></a><a class="code" href="structvxlan__hdr.html">vxlan_hdr</a>);</div>
<div class="line"></div>
<div class="line">    <a name="a35"></a><a class="code" href="rte__mbuf_8h.html#a1bbd752194759ce7b419c4998f2e8651">rte_pktmbuf_adj</a>(pkt, outer_header_len);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">encapsulation(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint8_t queue_id)</div>
<div class="line">{</div>
<div class="line">    uint vport_id;</div>
<div class="line">    uint64_t ol_flags = 0;</div>
<div class="line">    uint32_t old_len = m-&gt;<a name="a36"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a>, hash;</div>
<div class="line">    <span class="keyword">union </span>tunnel_offload_info tx_offload = { .data = 0 };</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *phdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*Allocate space for new ethernet, IPv4, UDP and VXLAN headers*/</span></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *pneth = (<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *) <a name="a37"></a><a class="code" href="rte__mbuf_8h.html#aadf5bef4ceb0b76dfafff0895f285ab0">rte_pktmbuf_prepend</a>(m,</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv4_hdr)</div>
<div class="line">        + sizeof(struct udp_hdr) + sizeof(struct <a class="code" href="structvxlan__hdr.html">vxlan_hdr</a>));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>ipv4_hdr *ip = (<span class="keyword">struct </span>ipv4_hdr *) &amp;pneth[1];</div>
<div class="line">    <span class="keyword">struct </span>udp_hdr *udp = (<span class="keyword">struct </span>udp_hdr *) &amp;ip[1];</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structvxlan__hdr.html">vxlan_hdr</a> *vxlan = (<span class="keyword">struct </span><a class="code" href="structvxlan__hdr.html">vxlan_hdr</a> *) &amp;udp[1];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* convert TX queue ID to vport ID */</span></div>
<div class="line">    vport_id = queue_id - 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* replace original Ethernet header with ours */</span></div>
<div class="line">    pneth = <a name="a38"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(pneth, &amp;app_l2_hdr[vport_id],</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* copy in IP header */</span></div>
<div class="line">    ip = <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(ip, &amp;app_ip_hdr[vport_id],</div>
<div class="line">        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ipv4_hdr));</div>
<div class="line">    ip-&gt;<a name="a39"></a><a class="code" href="structipv4__hdr.html#aa487bb47bd88257a2fcd58d10c7836a2">total_length</a> = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(m-&gt;<a name="a40"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a></div>
<div class="line">                - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* outer IP checksum */</span></div>
<div class="line">    ol_flags |= <a name="a41"></a><a class="code" href="rte__mbuf_8h.html#aab3c837da93bf3cb1244786b768d20d0">PKT_TX_OUTER_IP_CKSUM</a>;</div>
<div class="line">    ip-&gt;<a class="code" href="structipv4__hdr.html#ab900fdcbfb9fd1da87d839741353acd0">hdr_checksum</a> = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* inner IP checksum offload */</span></div>
<div class="line">    <span class="keywordflow">if</span> (tx_checksum) {</div>
<div class="line">        ol_flags |= process_inner_cksums(phdr, &amp;tx_offload);</div>
<div class="line">        m-&gt;<a name="a42"></a><a class="code" href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">l2_len</a> = tx_offload.l2_len;</div>
<div class="line">        m-&gt;<a name="a43"></a><a class="code" href="structrte__mbuf.html#a82a34cb6d5935a8c0f043f2783d6b42d">l3_len</a> = tx_offload.l3_len;</div>
<div class="line">        m-&gt;<a name="a44"></a><a class="code" href="structrte__mbuf.html#a376ef42810847f01b34c83560ad78ea2">l4_len</a> = tx_offload.l4_len;</div>
<div class="line">        m-&gt;<a class="code" href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">l2_len</a> += <a name="a45"></a><a class="code" href="rte__ether_8h.html#aae49a5da37f9cf83cf2222f0c346d9f7">ETHER_VXLAN_HLEN</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    m-&gt;<a name="a46"></a><a class="code" href="structrte__mbuf.html#ae2867dcd6148e34a344ee638d0967d70">outer_l2_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>);</div>
<div class="line">    m-&gt;<a name="a47"></a><a class="code" href="structrte__mbuf.html#ab39a0751d4ed656e56e3d21d13901088">outer_l3_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ipv4_hdr);</div>
<div class="line"></div>
<div class="line">    m-&gt;<a name="a48"></a><a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= ol_flags;</div>
<div class="line">    m-&gt;<a name="a49"></a><a class="code" href="structrte__mbuf.html#ad3da3ccb45865ef8b5bd1f40668769e3">tso_segsz</a> = tx_offload.tso_segsz;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*VXLAN HEADER*/</span></div>
<div class="line">    vxlan-&gt;<a name="a50"></a><a class="code" href="structvxlan__hdr.html#af2216e6d5f3f2fa2b10fc8d8ae1ca24f">vx_flags</a> = <a name="a51"></a><a class="code" href="rte__byteorder_8h.html#a7d62fcf485a335a6c1307763a150895c">rte_cpu_to_be_32</a>(VXLAN_HF_VNI);</div>
<div class="line">    vxlan-&gt;<a name="a52"></a><a class="code" href="structvxlan__hdr.html#a32a9bedf3ba35da5b9534dba2746b025">vx_vni</a> = <a class="code" href="rte__byteorder_8h.html#a7d62fcf485a335a6c1307763a150895c">rte_cpu_to_be_32</a>(vxdev.out_key &lt;&lt; 8);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*UDP HEADER*/</span></div>
<div class="line">    udp-&gt;<a class="code" href="structudp__hdr.html#ae0c0552d7f5d79ad5b0d77c892740c10">dgram_cksum</a> = 0;</div>
<div class="line">    udp-&gt;<a name="a53"></a><a class="code" href="structudp__hdr.html#a747388563555906210041a6eb52a2705">dgram_len</a> = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(old_len</div>
<div class="line">                + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> udp_hdr)</div>
<div class="line">                + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structvxlan__hdr.html">vxlan_hdr</a>));</div>
<div class="line"></div>
<div class="line">    udp-&gt;<a class="code" href="structudp__hdr.html#ae18defed4756b8c15e34718f51e86e55">dst_port</a> = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>(vxdev.dst_port);</div>
<div class="line">    hash = <a name="a54"></a><a class="code" href="rte__hash__crc_8h.html#aaf1a10c0c1ee2b63d5a545ee6cb84740">rte_hash_crc</a>(phdr, 2 * <a name="a55"></a><a class="code" href="rte__ether_8h.html#abf4fcaacb1ad2010711b7c880ec2ed20">ETHER_ADDR_LEN</a>, phdr-&gt;<a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a>);</div>
<div class="line">    udp-&gt;<a name="a56"></a><a class="code" href="structudp__hdr.html#ab98974981cf4c143fcee028643f313e6">src_port</a> = <a class="code" href="rte__byteorder_8h.html#aaf31412a30c1d00c9e1cc9fa598b6484">rte_cpu_to_be_16</a>((((uint64_t) hash * PORT_RANGE) &gt;&gt; 32)</div>
<div class="line">                    + PORT_MIN);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
