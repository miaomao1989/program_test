<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: kni/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">kni/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_tun.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__kni_8h.html">rte_kni.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Macros for printing using RTE_LOG */</span></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_APP RTE_LOGTYPE_USER1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Max size of a single packet */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PACKET_SZ           2048</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Size of the data buffer in each mbuf */</span></div>
<div class="line"><span class="preprocessor">#define MBUF_DATA_SZ (MAX_PACKET_SZ + RTE_PKTMBUF_HEADROOM)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of mbufs in mempool that is created */</span></div>
<div class="line"><span class="preprocessor">#define NB_MBUF                 (8192 * 16)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* How many packets to attempt to read from NIC in one go */</span></div>
<div class="line"><span class="preprocessor">#define PKT_BURST_SZ            32</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* How many objects (mbufs) to keep in per-lcore mempool cache */</span></div>
<div class="line"><span class="preprocessor">#define MEMPOOL_CACHE_SZ        PKT_BURST_SZ</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of RX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define NB_RXD                  128</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define NB_TXD                  512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Total octets in ethernet header */</span></div>
<div class="line"><span class="preprocessor">#define KNI_ENET_HEADER_SIZE    14</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Total octets in the FCS */</span></div>
<div class="line"><span class="preprocessor">#define KNI_ENET_FCS_SIZE       4</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define KNI_US_PER_SECOND       1000000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KNI_SECOND_PER_DAY      86400</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define KNI_MAX_KTHREAD 32</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Structure of port parameters</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>kni_port_params {</div>
<div class="line">    uint8_t port_id;<span class="comment">/* Port ID */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_rx; <span class="comment">/* lcore ID for RX */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_tx; <span class="comment">/* lcore ID for TX */</span></div>
<div class="line">    uint32_t nb_lcore_k; <span class="comment">/* Number of lcores for KNI multi kernel threads */</span></div>
<div class="line">    uint32_t nb_kni; <span class="comment">/* Number of KNI devices to be created */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_k[KNI_MAX_KTHREAD]; <span class="comment">/* lcore ID list for kthreads */</span></div>
<div class="line">    <span class="keyword">struct </span>rte_kni *kni[KNI_MAX_KTHREAD]; <span class="comment">/* KNI context pointers */</span></div>
<div class="line">} <a name="a0"></a><a class="code" href="rte__memory_8h.html#a1a29b3bf8655b79e8dca721c5e815aa4">__rte_cache_aligned</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>kni_port_params *kni_port_params_array[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Options for configuring ethernet port */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf = {</div>
<div class="line">    .<a name="a2"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a3"></a><a class="code" href="structrte__eth__rxmode.html#afe394653330a4c4fff5bee718dfd5185">header_split</a> = 0,      <span class="comment">/* Header Split disabled */</span></div>
<div class="line">        .hw_ip_checksum = 0,    <span class="comment">/* IP checksum offload disabled */</span></div>
<div class="line">        .hw_vlan_filter = 0,    <span class="comment">/* VLAN filtering disabled */</span></div>
<div class="line">        .jumbo_frame = 0,       <span class="comment">/* Jumbo Frame Support disabled */</span></div>
<div class="line">        .hw_strip_crc = 0,      <span class="comment">/* CRC stripped by hardware */</span></div>
<div class="line">    },</div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mempool for mbufs */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a5"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> * pktmbuf_pool = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t ports_mask = 0;</div>
<div class="line"><span class="comment">/* Ports set in promiscuous mode off by default. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> promiscuous_on = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Structure type for recording kni interface specific stats */</span></div>
<div class="line"><span class="keyword">struct </span>kni_interface_stats {</div>
<div class="line">    <span class="comment">/* number of pkts received from NIC, and sent to KNI */</span></div>
<div class="line">    uint64_t rx_packets;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* number of pkts received from NIC, but failed to send to KNI */</span></div>
<div class="line">    uint64_t rx_dropped;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* number of pkts received from KNI, and sent to NIC */</span></div>
<div class="line">    uint64_t tx_packets;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* number of pkts received from KNI, but failed to send to NIC */</span></div>
<div class="line">    uint64_t tx_dropped;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* kni device statistics array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>kni_interface_stats kni_stats[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> kni_change_mtu(uint8_t port_id, <span class="keywordtype">unsigned</span> new_mtu);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> kni_config_network_interface(uint8_t port_id, uint8_t if_up);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a name="_a6"></a><a class="code" href="structrte__atomic32__t.html">rte_atomic32_t</a> kni_stop = <a name="a7"></a><a class="code" href="rte__atomic_8h.html#ad314fd28492e349e70ddf9b270234a63">RTE_ATOMIC32_INIT</a>(0);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Print out statistics on packets handled */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint8_t i;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\n**KNI example application statistics**\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;======  ==============  ============  ============  ============  ============\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot; Port    Lcore(RX/TX)    rx_packets    rx_dropped    tx_packets    tx_dropped\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;------  --------------  ------------  ------------  ------------  ------------\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!kni_port_params_array[i])</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">        printf(<span class="stringliteral">&quot;%7d %10u/%2u %13&quot;</span>PRIu64<span class="stringliteral">&quot; %13&quot;</span>PRIu64<span class="stringliteral">&quot; %13&quot;</span>PRIu64<span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;%13&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>, i,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_rx,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_tx,</div>
<div class="line">                        kni_stats[i].rx_packets,</div>
<div class="line">                        kni_stats[i].rx_dropped,</div>
<div class="line">                        kni_stats[i].tx_packets,</div>
<div class="line">                        kni_stats[i].tx_dropped);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;======  ==============  ============  ============  ============  ============\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Custom handling of signals to handle stats and kni processing */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">signal_handler(<span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* When we receive a USR1 signal, print stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGUSR1) {</div>
<div class="line">        print_stats();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* When we receive a USR2 signal, reset stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGUSR2) {</div>
<div class="line">        memset(&amp;kni_stats, 0, <span class="keyword">sizeof</span>(kni_stats));</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n**Statistics have been reset**\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* When we receive a RTMIN or SIGINT signal, stop kni processing */</span></div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGRTMIN || signum == SIGINT){</div>
<div class="line">        printf(<span class="stringliteral">&quot;SIGRTMIN is received, and the KNI processing is &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;going to stop\n&quot;</span>);</div>
<div class="line">        <a name="a8"></a><a class="code" href="rte__atomic_8h.html#a76fa947d23bc1aac76f70641cad255a7">rte_atomic32_inc</a>(&amp;kni_stop);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">kni_burst_free_mbufs(<span class="keyword">struct</span> <a name="_a9"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts, <span class="keywordtype">unsigned</span> num)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pkts == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num; i++) {</div>
<div class="line">        <a name="a10"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts[i]);</div>
<div class="line">        pkts[i] = NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">kni_ingress(<span class="keyword">struct</span> kni_port_params *p)</div>
<div class="line">{</div>
<div class="line">    uint8_t i, port_id;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_rx, num;</div>
<div class="line">    uint32_t nb_kni;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[PKT_BURST_SZ];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (p == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    nb_kni = p-&gt;nb_kni;</div>
<div class="line">    port_id = p-&gt;port_id;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_kni; i++) {</div>
<div class="line">        <span class="comment">/* Burst rx from eth */</span></div>
<div class="line">        nb_rx = <a name="a11"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(port_id, 0, pkts_burst, PKT_BURST_SZ);</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a12"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(nb_rx &gt; PKT_BURST_SZ)) {</div>
<div class="line">            <a name="a13"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Error receiving from eth\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Burst tx to kni */</span></div>
<div class="line">        num = <a name="a14"></a><a class="code" href="rte__kni_8h.html#ae470743959cbf73648b242d9f7270b02">rte_kni_tx_burst</a>(p-&gt;kni[i], pkts_burst, nb_rx);</div>
<div class="line">        kni_stats[port_id].rx_packets += num;</div>
<div class="line"></div>
<div class="line">        <a name="a15"></a><a class="code" href="rte__kni_8h.html#acd52d6e1e302e3bb87de6d786b3c5cc1">rte_kni_handle_request</a>(p-&gt;kni[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(num &lt; nb_rx)) {</div>
<div class="line">            <span class="comment">/* Free mbufs not tx to kni interface */</span></div>
<div class="line">            kni_burst_free_mbufs(&amp;pkts_burst[num], nb_rx - num);</div>
<div class="line">            kni_stats[port_id].rx_dropped += nb_rx - num;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">kni_egress(<span class="keyword">struct</span> kni_port_params *p)</div>
<div class="line">{</div>
<div class="line">    uint8_t i, port_id;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_tx, num;</div>
<div class="line">    uint32_t nb_kni;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[PKT_BURST_SZ];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (p == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    nb_kni = p-&gt;nb_kni;</div>
<div class="line">    port_id = p-&gt;port_id;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_kni; i++) {</div>
<div class="line">        <span class="comment">/* Burst rx from kni */</span></div>
<div class="line">        num = <a name="a16"></a><a class="code" href="rte__kni_8h.html#a0cdd727cdc227d005fef22c0189f3dfe">rte_kni_rx_burst</a>(p-&gt;kni[i], pkts_burst, PKT_BURST_SZ);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(num &gt; PKT_BURST_SZ)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Error receiving from KNI\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Burst tx to eth */</span></div>
<div class="line">        nb_tx = <a name="a17"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port_id, 0, pkts_burst, (uint16_t)num);</div>
<div class="line">        kni_stats[port_id].tx_packets += nb_tx;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(nb_tx &lt; num)) {</div>
<div class="line">            <span class="comment">/* Free mbufs not tx to NIC */</span></div>
<div class="line">            kni_burst_free_mbufs(&amp;pkts_burst[nb_tx], num - nb_tx);</div>
<div class="line">            kni_stats[port_id].tx_dropped += num - nb_tx;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">main_loop(<a name="a18"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    uint8_t i, nb_ports = <a name="a19"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    int32_t f_stop;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> lcore_id = <a name="a20"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">enum</span> lcore_rxtx {</div>
<div class="line">        LCORE_NONE,</div>
<div class="line">        LCORE_RX,</div>
<div class="line">        LCORE_TX,</div>
<div class="line">        LCORE_MAX</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">enum</span> lcore_rxtx flag = LCORE_NONE;</div>
<div class="line"></div>
<div class="line">    nb_ports = (uint8_t)(nb_ports &lt; RTE_MAX_ETHPORTS ?</div>
<div class="line">                nb_ports : RTE_MAX_ETHPORTS);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_ports; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!kni_port_params_array[i])</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i]-&gt;lcore_rx == (uint8_t)lcore_id) {</div>
<div class="line">            flag = LCORE_RX;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kni_port_params_array[i]-&gt;lcore_tx ==</div>
<div class="line">                        (uint8_t)lcore_id) {</div>
<div class="line">            flag = LCORE_TX;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (flag == LCORE_RX) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Lcore %u is reading from port %d\n&quot;</span>,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_rx,</div>
<div class="line">                    kni_port_params_array[i]-&gt;port_id);</div>
<div class="line">        <span class="keywordflow">while</span> (1) {</div>
<div class="line">            f_stop = <a name="a21"></a><a class="code" href="rte__atomic_8h.html#ab3041cc6a6a379e14e76dfcb61bec152">rte_atomic32_read</a>(&amp;kni_stop);</div>
<div class="line">            <span class="keywordflow">if</span> (f_stop)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            kni_ingress(kni_port_params_array[i]);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag == LCORE_TX) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Lcore %u is writing to port %d\n&quot;</span>,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_tx,</div>
<div class="line">                    kni_port_params_array[i]-&gt;port_id);</div>
<div class="line">        <span class="keywordflow">while</span> (1) {</div>
<div class="line">            f_stop = <a class="code" href="rte__atomic_8h.html#ab3041cc6a6a379e14e76dfcb61bec152">rte_atomic32_read</a>(&amp;kni_stop);</div>
<div class="line">            <span class="keywordflow">if</span> (f_stop)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            kni_egress(kni_port_params_array[i]);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Lcore %u has nothing to do\n&quot;</span>, lcore_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Display usage instructions */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;\nUsage: %s [EAL options] -- -p PORTMASK -P &quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;[--config (port,lcore_rx,lcore_tx,lcore_kthread...)&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;[,(port,lcore_rx,lcore_tx,lcore_kthread...)]]\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;    -p PORTMASK: hex bitmask of ports to use\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;    -P : enable promiscuous mode\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;    --config (port,lcore_rx,lcore_tx,lcore_kthread...): &quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;port and lcore configurations\n&quot;</span>,</div>
<div class="line">               prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Convert string to unsigned number. 0 is returned if error occurs */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t</div>
<div class="line">parse_unsigned(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;</div>
<div class="line"></div>
<div class="line">    num = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (uint32_t)num;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_config(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t i, j;</div>
<div class="line">    <span class="keyword">struct </span>kni_port_params **p = kni_port_params_array;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!p[i])</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(DEBUG, APP, <span class="stringliteral">&quot;Port ID: %d\n&quot;</span>, p[i]-&gt;port_id);</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(DEBUG, APP, <span class="stringliteral">&quot;Rx lcore ID: %u, Tx lcore ID: %u\n&quot;</span>,</div>
<div class="line">                    p[i]-&gt;lcore_rx, p[i]-&gt;lcore_tx);</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; p[i]-&gt;nb_lcore_k; j++)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(DEBUG, APP, <span class="stringliteral">&quot;Kernel thread lcore ID: %u\n&quot;</span>,</div>
<div class="line">                            p[i]-&gt;lcore_k[j]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_config(<span class="keyword">const</span> <span class="keywordtype">char</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *p0 = arg;</div>
<div class="line">    <span class="keywordtype">char</span> s[256], *end;</div>
<div class="line">    <span class="keywordtype">unsigned</span> size;</div>
<div class="line">    <span class="keyword">enum</span> fieldnames {</div>
<div class="line">        FLD_PORT = 0,</div>
<div class="line">        FLD_LCORE_RX,</div>
<div class="line">        FLD_LCORE_TX,</div>
<div class="line">        _NUM_FLD = KNI_MAX_KTHREAD + 3,</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">int</span> i, j, nb_token;</div>
<div class="line">    <span class="keywordtype">char</span> *str_fld[_NUM_FLD];</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> int_fld[_NUM_FLD];</div>
<div class="line">    uint8_t port_id, nb_kni_port_params = 0;</div>
<div class="line"></div>
<div class="line">    memset(&amp;kni_port_params_array, 0, <span class="keyword">sizeof</span>(kni_port_params_array));</div>
<div class="line">    <span class="keywordflow">while</span> (((p = strchr(p0, <span class="charliteral">&#39;(&#39;</span>)) != NULL) &amp;&amp;</div>
<div class="line">        nb_kni_port_params &lt; RTE_MAX_ETHPORTS) {</div>
<div class="line">        p++;</div>
<div class="line">        <span class="keywordflow">if</span> ((p0 = strchr(p, <span class="charliteral">&#39;)&#39;</span>)) == NULL)</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        size = p0 - p;</div>
<div class="line">        <span class="keywordflow">if</span> (size &gt;= <span class="keyword">sizeof</span>(s)) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Invalid config parameters\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        }</div>
<div class="line">        snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;%.*s&quot;</span>, size, p);</div>
<div class="line">        nb_token = <a name="a22"></a><a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(s, <span class="keyword">sizeof</span>(s), str_fld, _NUM_FLD, <span class="charliteral">&#39;,&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (nb_token &lt;= FLD_LCORE_TX) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Invalid config parameters\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; nb_token; i++) {</div>
<div class="line">            errno = 0;</div>
<div class="line">            int_fld[i] = strtoul(str_fld[i], &amp;end, 0);</div>
<div class="line">            <span class="keywordflow">if</span> (errno != 0 || end == str_fld[i]) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Invalid config parameters\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">goto</span> fail;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        i = 0;</div>
<div class="line">        port_id = (uint8_t)int_fld[i++];</div>
<div class="line">        <span class="keywordflow">if</span> (port_id &gt;= RTE_MAX_ETHPORTS) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Port ID %d could not exceed the maximum %d\n&quot;</span>,</div>
<div class="line">                        port_id, RTE_MAX_ETHPORTS);</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[port_id]) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Port %d has been configured\n&quot;</span>, port_id);</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        }</div>
<div class="line">        kni_port_params_array[port_id] =</div>
<div class="line">            <a name="a23"></a><a class="code" href="rte__malloc_8h.html#a58042061ad622f028aa2b97e8cb73a41">rte_zmalloc</a>(<span class="stringliteral">&quot;KNI_port_params&quot;</span>,</div>
<div class="line">                    <span class="keyword">sizeof</span>(<span class="keyword">struct</span> kni_port_params), RTE_CACHE_LINE_SIZE);</div>
<div class="line">        kni_port_params_array[port_id]-&gt;port_id = port_id;</div>
<div class="line">        kni_port_params_array[port_id]-&gt;lcore_rx =</div>
<div class="line">                    (uint8_t)int_fld[i++];</div>
<div class="line">        kni_port_params_array[port_id]-&gt;lcore_tx =</div>
<div class="line">                    (uint8_t)int_fld[i++];</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[port_id]-&gt;lcore_rx &gt;= RTE_MAX_LCORE ||</div>
<div class="line">        kni_port_params_array[port_id]-&gt;lcore_tx &gt;= RTE_MAX_LCORE) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;lcore_rx %u or lcore_tx %u ID could not &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;exceed the maximum %u\n&quot;</span>,</div>
<div class="line">                kni_port_params_array[port_id]-&gt;lcore_rx,</div>
<div class="line">                kni_port_params_array[port_id]-&gt;lcore_tx,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span>)RTE_MAX_LCORE);</div>
<div class="line">            <span class="keywordflow">goto</span> fail;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; i &lt; nb_token &amp;&amp; j &lt; KNI_MAX_KTHREAD; i++, j++)</div>
<div class="line">            kni_port_params_array[port_id]-&gt;lcore_k[j] =</div>
<div class="line">                        (uint8_t)int_fld[i];</div>
<div class="line">        kni_port_params_array[port_id]-&gt;nb_lcore_k = j;</div>
<div class="line">    }</div>
<div class="line">    print_config();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">fail:</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i]) {</div>
<div class="line">            <a name="a24"></a><a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(kni_port_params_array[i]);</div>
<div class="line">            kni_port_params_array[i] = NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">validate_parameters(uint32_t portmask)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!portmask) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;No port configured in port mask\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (((portmask &amp; (1 &lt;&lt; i)) &amp;&amp; !kni_port_params_array[i]) ||</div>
<div class="line">            (!(portmask &amp; (1 &lt;&lt; i)) &amp;&amp; kni_port_params_array[i]))</div>
<div class="line">            <a name="a25"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;portmask is not consistent &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;to port ids specified in --config\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i] &amp;&amp; !<a name="a26"></a><a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(\</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)(kni_port_params_array[i]-&gt;lcore_rx)))</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;lcore id %u for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;port %d receiving not enabled\n&quot;</span>,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_rx,</div>
<div class="line">                    kni_port_params_array[i]-&gt;port_id);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i] &amp;&amp; !<a class="code" href="rte__lcore_8h.html#a076d17802fafc1fb54e168cc37c94c60">rte_lcore_is_enabled</a>(\</div>
<div class="line">            (<span class="keywordtype">unsigned</span>)(kni_port_params_array[i]-&gt;lcore_tx)))</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;lcore id %u for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;port %d transmitting not enabled\n&quot;</span>,</div>
<div class="line">                    kni_port_params_array[i]-&gt;lcore_tx,</div>
<div class="line">                    kni_port_params_array[i]-&gt;port_id);</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CMDLINE_OPT_CONFIG  &quot;config&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Parse the arguments given in the command line of the application */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, longindex, ret = 0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option longopts[] = {</div>
<div class="line">        {CMDLINE_OPT_CONFIG, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, NULL, 0}</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Disable printing messages within getopt() */</span></div>
<div class="line">    opterr = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:P&quot;</span>, longopts,</div>
<div class="line">                        &amp;longindex)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            ports_mask = parse_unsigned(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:</div>
<div class="line">            promiscuous_on = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(longopts[longindex].name,</div>
<div class="line">                     CMDLINE_OPT_CONFIG,</div>
<div class="line">                     <span class="keyword">sizeof</span>(CMDLINE_OPT_CONFIG))) {</div>
<div class="line">                ret = parse_config(optarg);</div>
<div class="line">                <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Invalid config\n&quot;</span>);</div>
<div class="line">                    print_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            print_usage(prgname);</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid option specified\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check that options were parsed ok */</span></div>
<div class="line">    <span class="keywordflow">if</span> (validate_parameters(ports_mask) &lt; 0) {</div>
<div class="line">        print_usage(prgname);</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid parameters\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialize KNI subsystem */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">init_kni(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_of_kni_ports = 0, i;</div>
<div class="line">    <span class="keyword">struct </span>kni_port_params **params = kni_port_params_array;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Calculate the maximum number of KNI interfaces that will be used */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i]) {</div>
<div class="line">            num_of_kni_ports += (params[i]-&gt;nb_lcore_k ?</div>
<div class="line">                params[i]-&gt;nb_lcore_k : 1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Invoke rte KNI init to preallocate the ports */</span></div>
<div class="line">    <a name="a27"></a><a class="code" href="rte__kni_8h.html#add8d82dbb8f3fcec208274cccc6a10d6">rte_kni_init</a>(num_of_kni_ports);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialise a single port on an Ethernet device */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">init_port(uint8_t <a name="_a28"></a><a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise device and RX/TX queues */</span></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Initialising port %u ...\n&quot;</span>, (<span class="keywordtype">unsigned</span>)port);</div>
<div class="line">    fflush(stdout);</div>
<div class="line">    ret = <a name="a29"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, 1, 1, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not configure port%u (%d)\n&quot;</span>,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a30"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, 0, NB_RXD,</div>
<div class="line">        rte_eth_dev_socket_id(port), NULL, pktmbuf_pool);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not setup up RX queue for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port%u (%d)\n&quot;</span>, (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a31"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, 0, NB_TXD,</div>
<div class="line">        rte_eth_dev_socket_id(port), NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not setup up TX queue for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port%u (%d)\n&quot;</span>, (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a32"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not start port%u (%d)\n&quot;</span>,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (promiscuous_on)</div>
<div class="line">        <a name="a33"></a><a class="code" href="rte__ethdev_8h.html#aa8064b25aee324bdbbf779ea23d55f49">rte_eth_promiscuous_enable</a>(port);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check the link status of all ports in up to 9s, and print them finally */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">check_all_ports_link_status(uint8_t port_num, uint32_t port_mask)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#define CHECK_INTERVAL 100 </span><span class="comment">/* 100ms */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CHECK_TIME 90 </span><span class="comment">/* 9s (90 * 100ms) in total */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    uint8_t portid, count, all_ports_up, print_flag = 0;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a34"></a><a class="code" href="structrte__eth__link.html">rte_eth_link</a> link;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nChecking link status\n&quot;</span>);</div>
<div class="line">    fflush(stdout);</div>
<div class="line">    <span class="keywordflow">for</span> (count = 0; count &lt;= MAX_CHECK_TIME; count++) {</div>
<div class="line">        all_ports_up = 1;</div>
<div class="line">        <span class="keywordflow">for</span> (portid = 0; portid &lt; port_num; portid++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((port_mask &amp; (1 &lt;&lt; portid)) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            memset(&amp;link, 0, <span class="keyword">sizeof</span>(link));</div>
<div class="line">            <a name="a35"></a><a class="code" href="rte__ethdev_8h.html#a6908b1ef94c95ef85af851e6705a5f93">rte_eth_link_get_nowait</a>(portid, &amp;link);</div>
<div class="line">            <span class="comment">/* print link status if flag set */</span></div>
<div class="line">            <span class="keywordflow">if</span> (print_flag == 1) {</div>
<div class="line">                <span class="keywordflow">if</span> (link.link_status)</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Up - speed %u &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;Mbps - %s\n&quot;</span>, (uint8_t)portid,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span>)link.link_speed,</div>
<div class="line">                (link.link_duplex == <a name="a36"></a><a class="code" href="rte__ethdev_8h.html#a042c83951613bf2db5d3056b967041d6">ETH_LINK_FULL_DUPLEX</a>) ?</div>
<div class="line">                    (<span class="stringliteral">&quot;full-duplex&quot;</span>) : (<span class="stringliteral">&quot;half-duplex\n&quot;</span>));</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Down\n&quot;</span>,</div>
<div class="line">                        (uint8_t)portid);</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">/* clear all_ports_up flag if any link down */</span></div>
<div class="line">            <span class="keywordflow">if</span> (link.link_status == <a name="a37"></a><a class="code" href="rte__ethdev_8h.html#a08c012f37e07726170ff67daf667d850">ETH_LINK_DOWN</a>) {</div>
<div class="line">                all_ports_up = 0;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* after finally printing all link status, get out */</span></div>
<div class="line">        <span class="keywordflow">if</span> (print_flag == 1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            fflush(stdout);</div>
<div class="line">            <a name="a38"></a><a class="code" href="rte__cycles_8h.html#af73b844d50b98de74b1a0e1730262f85">rte_delay_ms</a>(CHECK_INTERVAL);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* set the print_flag if all ports up or timeout */</span></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 1 || count == (MAX_CHECK_TIME - 1)) {</div>
<div class="line">            print_flag = 1;</div>
<div class="line">            printf(<span class="stringliteral">&quot;done\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Callback for request of changing MTU */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">kni_change_mtu(uint8_t port_id, <span class="keywordtype">unsigned</span> new_mtu)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> conf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port_id &gt;= <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>()) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid port id %d\n&quot;</span>, port_id);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Change MTU of port %d to %u\n&quot;</span>, port_id, new_mtu);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Stop specific port */</span></div>
<div class="line">    <a name="a39"></a><a class="code" href="rte__ethdev_8h.html#a322fa275f154022db7bce02ee95e5612">rte_eth_dev_stop</a>(port_id);</div>
<div class="line"></div>
<div class="line">    memcpy(&amp;conf, &amp;port_conf, <span class="keyword">sizeof</span>(conf));</div>
<div class="line">    <span class="comment">/* Set new MTU */</span></div>
<div class="line">    <span class="keywordflow">if</span> (new_mtu &gt; <a name="a40"></a><a class="code" href="rte__ether_8h.html#aaebedff0cce73327398dd3139ba50e43">ETHER_MAX_LEN</a>)</div>
<div class="line">        conf.rxmode.jumbo_frame = 1;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        conf.rxmode.jumbo_frame = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* mtu + length of header + length of FCS = max pkt length */</span></div>
<div class="line">    conf.rxmode.max_rx_pkt_len = new_mtu + KNI_ENET_HEADER_SIZE +</div>
<div class="line">                            KNI_ENET_FCS_SIZE;</div>
<div class="line">    ret = <a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port_id, 1, 1, &amp;conf);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Fail to reconfigure port %d\n&quot;</span>, port_id);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Restart specific port */</span></div>
<div class="line">    ret = <a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port_id);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Fail to restart port %d\n&quot;</span>, port_id);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Callback for request of configuring network interface up/down */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">kni_config_network_interface(uint8_t port_id, uint8_t if_up)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port_id &gt;= <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>() || port_id &gt;= RTE_MAX_ETHPORTS) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Invalid port id %d\n&quot;</span>, port_id);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Configure network interface of %d %s\n&quot;</span>,</div>
<div class="line">                    port_id, if_up ? <span class="stringliteral">&quot;up&quot;</span> : <span class="stringliteral">&quot;down&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (if_up != 0) { <span class="comment">/* Configure network interface up */</span></div>
<div class="line">        <a class="code" href="rte__ethdev_8h.html#a322fa275f154022db7bce02ee95e5612">rte_eth_dev_stop</a>(port_id);</div>
<div class="line">        ret = <a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port_id);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="comment">/* Configure network interface down */</span></div>
<div class="line">        <a class="code" href="rte__ethdev_8h.html#a322fa275f154022db7bce02ee95e5612">rte_eth_dev_stop</a>(port_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, APP, <span class="stringliteral">&quot;Failed to start port %d\n&quot;</span>, port_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">kni_alloc(uint8_t port_id)</div>
<div class="line">{</div>
<div class="line">    uint8_t i;</div>
<div class="line">    <span class="keyword">struct </span>rte_kni *kni;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a41"></a><a class="code" href="structrte__kni__conf.html">rte_kni_conf</a> conf;</div>
<div class="line">    <span class="keyword">struct </span>kni_port_params **params = kni_port_params_array;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port_id &gt;= RTE_MAX_ETHPORTS || !params[port_id])</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    params[port_id]-&gt;nb_kni = params[port_id]-&gt;nb_lcore_k ?</div>
<div class="line">                params[port_id]-&gt;nb_lcore_k : 1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; params[port_id]-&gt;nb_kni; i++) {</div>
<div class="line">        <span class="comment">/* Clear conf at first */</span></div>
<div class="line">        memset(&amp;conf, 0, <span class="keyword">sizeof</span>(conf));</div>
<div class="line">        <span class="keywordflow">if</span> (params[port_id]-&gt;nb_lcore_k) {</div>
<div class="line">            snprintf(conf.name, RTE_KNI_NAMESIZE,</div>
<div class="line">                    <span class="stringliteral">&quot;vEth%u_%u&quot;</span>, port_id, i);</div>
<div class="line">            conf.core_id = params[port_id]-&gt;lcore_k[i];</div>
<div class="line">            conf.force_bind = 1;</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            snprintf(conf.name, RTE_KNI_NAMESIZE,</div>
<div class="line">                        <span class="stringliteral">&quot;vEth%u&quot;</span>, port_id);</div>
<div class="line">        conf.group_id = (uint16_t)port_id;</div>
<div class="line">        conf.mbuf_size = MAX_PACKET_SZ;</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * The first KNI device associated to a port</span></div>
<div class="line"><span class="comment">         * is the master, for multiple kernel thread</span></div>
<div class="line"><span class="comment">         * environment.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (i == 0) {</div>
<div class="line">            <span class="keyword">struct </span><a name="_a42"></a><a class="code" href="structrte__kni__ops.html">rte_kni_ops</a> ops;</div>
<div class="line">            <span class="keyword">struct </span><a name="_a43"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line"></div>
<div class="line">            memset(&amp;dev_info, 0, <span class="keyword">sizeof</span>(dev_info));</div>
<div class="line">            <a name="a44"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(port_id, &amp;dev_info);</div>
<div class="line">            conf.addr = dev_info.pci_dev-&gt;addr;</div>
<div class="line">            conf.id = dev_info.pci_dev-&gt;id;</div>
<div class="line"></div>
<div class="line">            memset(&amp;ops, 0, <span class="keyword">sizeof</span>(ops));</div>
<div class="line">            ops.port_id = port_id;</div>
<div class="line">            ops.change_mtu = kni_change_mtu;</div>
<div class="line">            ops.config_network_if = kni_config_network_interface;</div>
<div class="line"></div>
<div class="line">            kni = <a name="a45"></a><a class="code" href="rte__kni_8h.html#a6f0e3bfe35ac99edbf07dd709d294176">rte_kni_alloc</a>(pktmbuf_pool, &amp;conf, &amp;ops);</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            kni = <a class="code" href="rte__kni_8h.html#a6f0e3bfe35ac99edbf07dd709d294176">rte_kni_alloc</a>(pktmbuf_pool, &amp;conf, NULL);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!kni)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Fail to create kni for &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;port: %d\n&quot;</span>, port_id);</div>
<div class="line">        params[port_id]-&gt;kni[i] = kni;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">kni_free_kni(uint8_t port_id)</div>
<div class="line">{</div>
<div class="line">    uint8_t i;</div>
<div class="line">    <span class="keyword">struct </span>kni_port_params **p = kni_port_params_array;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port_id &gt;= RTE_MAX_ETHPORTS || !p[port_id])</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; p[port_id]-&gt;nb_kni; i++) {</div>
<div class="line">        <a name="a46"></a><a class="code" href="rte__kni_8h.html#abbfabc840e0630bf581eb5583a7d88fe">rte_kni_release</a>(p[port_id]-&gt;kni[i]);</div>
<div class="line">        p[port_id]-&gt;kni[i] = NULL;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__ethdev_8h.html#a322fa275f154022db7bce02ee95e5612">rte_eth_dev_stop</a>(port_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialise ports/queues etc. and start main loop on each core */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    uint8_t nb_sys_ports, port;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Associate signal_hanlder function with USR signals */</span></div>
<div class="line">    signal(SIGUSR1, signal_handler);</div>
<div class="line">    signal(SIGUSR2, signal_handler);</div>
<div class="line">    signal(SIGRTMIN, signal_handler);</div>
<div class="line">    signal(SIGINT, signal_handler);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise EAL */</span></div>
<div class="line">    ret = <a name="a47"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not initialise EAL (%d)\n&quot;</span>, ret);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse application arguments (after the EAL ones) */</span></div>
<div class="line">    ret = parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not parse input parameters\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create the mbuf pool */</span></div>
<div class="line">    pktmbuf_pool = <a name="a48"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;mbuf_pool&quot;</span>, NB_MBUF,</div>
<div class="line">        MEMPOOL_CACHE_SZ, 0, MBUF_DATA_SZ, <a name="a49"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (pktmbuf_pool == NULL) {</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Could not initialise mbuf pool\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get number of ports found in scan */</span></div>
<div class="line">    nb_sys_ports = <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_sys_ports == 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;No supported Ethernet device found\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check if the configured port ID is valid */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++)</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i] &amp;&amp; i &gt;= nb_sys_ports)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Configured invalid &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;port ID %u\n&quot;</span>, i);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize KNI subsystem */</span></div>
<div class="line">    init_kni();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise each port */</span></div>
<div class="line">    <span class="keywordflow">for</span> (port = 0; port &lt; nb_sys_ports; port++) {</div>
<div class="line">        <span class="comment">/* Skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> (!(ports_mask &amp; (1 &lt;&lt; port)))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        init_port(port);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (port &gt;= RTE_MAX_ETHPORTS)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Can not use more than &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;%d ports for kni\n&quot;</span>, RTE_MAX_ETHPORTS);</div>
<div class="line"></div>
<div class="line">        kni_alloc(port);</div>
<div class="line">    }</div>
<div class="line">    check_all_ports_link_status(nb_sys_ports, ports_mask);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Launch per-lcore function on every lcore */</span></div>
<div class="line">    <a name="a50"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(main_loop, NULL, <a name="a51"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2ada39ec34f33f669f99bd28ab7c58a952ac">CALL_MASTER</a>);</div>
<div class="line">    <a name="a52"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(i) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a53"></a><a class="code" href="rte__launch_8h.html#a1282dc7cd7e6793afab3ef29239ddf54">rte_eal_wait_lcore</a>(i) &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Release resources */</span></div>
<div class="line">    <span class="keywordflow">for</span> (port = 0; port &lt; nb_sys_ports; port++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!(ports_mask &amp; (1 &lt;&lt; port)))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        kni_free_kni(port);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef RTE_LIBRTE_XEN_DOM0</span></div>
<div class="line"><span class="preprocessor"></span>    <a name="a54"></a><a class="code" href="rte__kni_8h.html#a8edb3d07e6ae68b6631fe98e88fc27bc">rte_kni_close</a>();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++)</div>
<div class="line">        <span class="keywordflow">if</span> (kni_port_params_array[i]) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a0bc2d94a40f12074f57ecfd83e07bb7c">rte_free</a>(kni_port_params_array[i]);</div>
<div class="line">            kni_port_params_array[i] = NULL;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
