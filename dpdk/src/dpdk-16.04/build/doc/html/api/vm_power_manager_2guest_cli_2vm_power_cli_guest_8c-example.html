<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vm_power_manager/guest_cli/vm_power_cli_guest.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vm_power_manager/guest_cli/vm_power_cli_guest.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;termios.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_rdline.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_num.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmdline_8h.html">cmdline.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__power_8h.html">rte_power.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;vm_power_cli_guest.h&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CHANNEL_PATH &quot;/dev/virtio-ports/virtio.serial.port.poweragent&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_GUEST_CHANNEL RTE_LOGTYPE_USER1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span>cmd_quit_result {</div>
<div class="line">    cmdline_fixed_string_t quit;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_quit_parsed(__attribute__((unused)) <span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">                __attribute__((unused)) <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">                __attribute__((unused)) <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id;</div>
<div class="line"></div>
<div class="line">    <a name="a0"></a><a class="code" href="rte__lcore_8h.html#a034c95b6412f09e8de11d430267dc1ba">RTE_LCORE_FOREACH</a>(lcore_id) {</div>
<div class="line">        <a name="a1"></a><a class="code" href="rte__power_8h.html#a490d4829c85c7fa3a401901c093a758b">rte_power_exit</a>(lcore_id);</div>
<div class="line">    }</div>
<div class="line">    cmdline_quit(cl);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cmdline_parse_token_string_t cmd_quit_quit =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_quit_result, quit, <span class="stringliteral">&quot;quit&quot;</span>);</div>
<div class="line"></div>
<div class="line">cmdline_parse_inst_t cmd_quit = {</div>
<div class="line">    .f = cmd_quit_parsed,  <span class="comment">/* function to call */</span></div>
<div class="line">    .data = NULL,      <span class="comment">/* 2nd arg of func */</span></div>
<div class="line">    .help_str = <span class="stringliteral">&quot;close the application&quot;</span>,</div>
<div class="line">    .tokens = {        <span class="comment">/* token list, NULL terminated */</span></div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_quit_quit,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* *** VM operations *** */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>cmd_set_cpu_freq_result {</div>
<div class="line">    cmdline_fixed_string_t set_cpu_freq;</div>
<div class="line">    uint8_t lcore_id;</div>
<div class="line">    cmdline_fixed_string_t cmd;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cmd_set_cpu_freq_parsed(<span class="keywordtype">void</span> *parsed_result, <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">               __attribute__((unused)) <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = -1;</div>
<div class="line">    <span class="keyword">struct </span>cmd_set_cpu_freq_result *res = parsed_result;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!strcmp(res-&gt;cmd , <span class="stringliteral">&quot;up&quot;</span>))</div>
<div class="line">        ret = <a name="a2"></a><a class="code" href="rte__power_8h.html#a54247c4b378e6f2febfec5e4b1d830bf">rte_power_freq_up</a>(res-&gt;lcore_id);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(res-&gt;cmd , <span class="stringliteral">&quot;down&quot;</span>))</div>
<div class="line">        ret = <a name="a3"></a><a class="code" href="rte__power_8h.html#a44abd639c8e661d45689b117ab299cb7">rte_power_freq_down</a>(res-&gt;lcore_id);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(res-&gt;cmd , <span class="stringliteral">&quot;min&quot;</span>))</div>
<div class="line">        ret = <a name="a4"></a><a class="code" href="rte__power_8h.html#a7a41f3f643e0206afc7103877660ccd0">rte_power_freq_min</a>(res-&gt;lcore_id);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(res-&gt;cmd , <span class="stringliteral">&quot;max&quot;</span>))</div>
<div class="line">        ret = <a name="a5"></a><a class="code" href="rte__power_8h.html#a310dcbbc427faef63830ea635f5df627">rte_power_freq_max</a>(res-&gt;lcore_id);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 1)</div>
<div class="line">        cmdline_printf(cl, <span class="stringliteral">&quot;Error sending message: %s\n&quot;</span>, strerror(ret));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">cmdline_parse_token_string_t cmd_set_cpu_freq =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_set_cpu_freq_result,</div>
<div class="line">            set_cpu_freq, <span class="stringliteral">&quot;set_cpu_freq&quot;</span>);</div>
<div class="line">cmdline_parse_token_string_t cmd_set_cpu_freq_core_num =</div>
<div class="line">    TOKEN_NUM_INITIALIZER(<span class="keyword">struct</span> cmd_set_cpu_freq_result,</div>
<div class="line">            lcore_id, UINT8);</div>
<div class="line">cmdline_parse_token_string_t cmd_set_cpu_freq_cmd_cmd =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_set_cpu_freq_result,</div>
<div class="line">            cmd, <span class="stringliteral">&quot;up#down#min#max&quot;</span>);</div>
<div class="line"></div>
<div class="line">cmdline_parse_inst_t cmd_set_cpu_freq_set = {</div>
<div class="line">    .f = cmd_set_cpu_freq_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;set_cpu_freq &lt;core_num&gt; &lt;up|down|min|max&gt;, Set the current &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;frequency for the specified core by scaling up/down/min/max&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_set_cpu_freq,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_set_cpu_freq_core_num,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_set_cpu_freq_cmd_cmd,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">cmdline_parse_ctx_t main_ctx[] = {</div>
<div class="line">        (cmdline_parse_inst_t *)&amp;cmd_quit,</div>
<div class="line">        (cmdline_parse_inst_t *)&amp;cmd_set_cpu_freq_set,</div>
<div class="line">        NULL,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">run_cli(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cmdline *cl;</div>
<div class="line"></div>
<div class="line">    cl = cmdline_stdin_new(main_ctx, <span class="stringliteral">&quot;vmpower(guest)&gt; &quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (cl == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    cmdline_interact(cl);</div>
<div class="line">    cmdline_stdin_exit(cl);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
