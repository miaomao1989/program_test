<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: ip_pipeline/cpu_core_map.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ip_pipeline/cpu_core_map.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;cpu_core_map.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>cpu_core_map {</div>
<div class="line">    uint32_t n_max_sockets;</div>
<div class="line">    uint32_t n_max_cores_per_socket;</div>
<div class="line">    uint32_t n_max_ht_per_core;</div>
<div class="line">    uint32_t n_sockets;</div>
<div class="line">    uint32_t n_cores_per_socket;</div>
<div class="line">    uint32_t n_ht_per_core;</div>
<div class="line">    <span class="keywordtype">int</span> map[0];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint32_t</div>
<div class="line">cpu_core_map_pos(<span class="keyword">struct</span> cpu_core_map *map,</div>
<div class="line">    uint32_t socket_id,</div>
<div class="line">    uint32_t core_id,</div>
<div class="line">    uint32_t ht_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> (socket_id * map-&gt;n_max_cores_per_socket + core_id) *</div>
<div class="line">        map-&gt;n_max_ht_per_core + ht_id;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_eal(<span class="keyword">struct</span> cpu_core_map *map);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_linux(<span class="keyword">struct</span> cpu_core_map *map);</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_and_check(<span class="keyword">struct</span> cpu_core_map *map);</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>cpu_core_map *</div>
<div class="line">cpu_core_map_init(uint32_t n_max_sockets,</div>
<div class="line">    uint32_t n_max_cores_per_socket,</div>
<div class="line">    uint32_t n_max_ht_per_core,</div>
<div class="line">    uint32_t eal_initialized)</div>
<div class="line">{</div>
<div class="line">    uint32_t map_size, map_mem_size, i;</div>
<div class="line">    <span class="keyword">struct </span>cpu_core_map *map;</div>
<div class="line">    <span class="keywordtype">int</span> status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check input arguments */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((n_max_sockets == 0) ||</div>
<div class="line">        (n_max_cores_per_socket == 0) ||</div>
<div class="line">        (n_max_ht_per_core == 0))</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Memory allocation */</span></div>
<div class="line">    map_size = n_max_sockets * n_max_cores_per_socket * n_max_ht_per_core;</div>
<div class="line">    map_mem_size = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>cpu_core_map) + map_size * <span class="keyword">sizeof</span>(int);</div>
<div class="line">    map = (<span class="keyword">struct </span>cpu_core_map *) malloc(map_mem_size);</div>
<div class="line">    <span class="keywordflow">if</span> (map == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialization */</span></div>
<div class="line">    map-&gt;n_max_sockets = n_max_sockets;</div>
<div class="line">    map-&gt;n_max_cores_per_socket = n_max_cores_per_socket;</div>
<div class="line">    map-&gt;n_max_ht_per_core = n_max_ht_per_core;</div>
<div class="line">    map-&gt;n_sockets = 0;</div>
<div class="line">    map-&gt;n_cores_per_socket = 0;</div>
<div class="line">    map-&gt;n_ht_per_core = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; map_size; i++)</div>
<div class="line">        map-&gt;map[i] = -1;</div>
<div class="line"></div>
<div class="line">    status = (eal_initialized) ?</div>
<div class="line">        cpu_core_map_compute_eal(map) :</div>
<div class="line">        cpu_core_map_compute_linux(map);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (status) {</div>
<div class="line">        free(map);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    status = cpu_core_map_compute_and_check(map);</div>
<div class="line">    <span class="keywordflow">if</span> (status) {</div>
<div class="line">        free(map);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> map;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_eal(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    uint32_t socket_id, core_id, ht_id;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Compute map */</span></div>
<div class="line">    <span class="keywordflow">for</span> (socket_id = 0; socket_id &lt; map-&gt;n_max_sockets; socket_id++) {</div>
<div class="line">        uint32_t n_detected, core_id_contig;</div>
<div class="line">        <span class="keywordtype">int</span> lcore_id;</div>
<div class="line"></div>
<div class="line">        n_detected = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) {</div>
<div class="line">            <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structlcore__config.html">lcore_config</a> *p = &amp;<a class="code" href="structlcore__config.html">lcore_config</a>[lcore_id];</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> ((p-&gt;<a name="a1"></a><a class="code" href="structlcore__config.html#a6a90eb3ed619c50e79ec9fa6dcc186cd">detected</a>) &amp;&amp; (p-&gt;<a name="a2"></a><a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a> == socket_id))</div>
<div class="line">                n_detected++;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        core_id_contig = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (core_id = 0; n_detected ; core_id++) {</div>
<div class="line">            ht_id = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (lcore_id = 0;</div>
<div class="line">                lcore_id &lt; RTE_MAX_LCORE;</div>
<div class="line">                lcore_id++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structlcore__config.html">lcore_config</a> *p =</div>
<div class="line">                    &amp;<a class="code" href="structlcore__config.html">lcore_config</a>[lcore_id];</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structlcore__config.html#a6a90eb3ed619c50e79ec9fa6dcc186cd">detected</a>) &amp;&amp;</div>
<div class="line">                    (p-&gt;<a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a> == socket_id) &amp;&amp;</div>
<div class="line">                    (p-&gt;<a name="a3"></a><a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a> == core_id)) {</div>
<div class="line">                    uint32_t pos = cpu_core_map_pos(map,</div>
<div class="line">                        socket_id,</div>
<div class="line">                        core_id_contig,</div>
<div class="line">                        ht_id);</div>
<div class="line"></div>
<div class="line">                    map-&gt;map[pos] = lcore_id;</div>
<div class="line">                    ht_id++;</div>
<div class="line">                    n_detected--;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (ht_id) {</div>
<div class="line">                core_id_contig++;</div>
<div class="line">                <span class="keywordflow">if</span> (core_id_contig ==</div>
<div class="line">                    map-&gt;n_max_cores_per_socket)</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_and_check(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    uint32_t <a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a>, <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>, ht_id;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Compute n_ht_per_core, n_cores_per_socket, n_sockets */</span></div>
<div class="line">    <span class="keywordflow">for</span> (ht_id = 0; ht_id &lt; map-&gt;n_max_ht_per_core; ht_id++) {</div>
<div class="line">        <span class="keywordflow">if</span> (map-&gt;map[ht_id] == -1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        map-&gt;n_ht_per_core++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (map-&gt;n_ht_per_core == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (core_id = 0; core_id &lt; map-&gt;n_max_cores_per_socket; core_id++) {</div>
<div class="line">        uint32_t pos = core_id * map-&gt;n_max_ht_per_core;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (map-&gt;map[pos] == -1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        map-&gt;n_cores_per_socket++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (map-&gt;n_cores_per_socket == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (socket_id = 0; socket_id &lt; map-&gt;n_max_sockets; socket_id++) {</div>
<div class="line">        uint32_t pos = socket_id * map-&gt;n_max_cores_per_socket *</div>
<div class="line">            map-&gt;n_max_ht_per_core;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (map-&gt;map[pos] == -1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        map-&gt;n_sockets++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (map-&gt;n_sockets == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check that each socket has exactly the same number of cores</span></div>
<div class="line"><span class="comment">    and that each core has exactly the same number of hyper-threads */</span></div>
<div class="line">    <span class="keywordflow">for</span> (socket_id = 0; socket_id &lt; map-&gt;n_sockets; socket_id++) {</div>
<div class="line">        <span class="keywordflow">for</span> (core_id = 0; core_id &lt; map-&gt;n_cores_per_socket; core_id++)</div>
<div class="line">            <span class="keywordflow">for</span> (ht_id = 0;</div>
<div class="line">                ht_id &lt; map-&gt;n_max_ht_per_core;</div>
<div class="line">                ht_id++) {</div>
<div class="line">                uint32_t pos = (socket_id *</div>
<div class="line">                    map-&gt;n_max_cores_per_socket + <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>) *</div>
<div class="line">                    map-&gt;n_max_ht_per_core + ht_id;</div>
<div class="line"></div>
<div class="line">                if (((ht_id &lt; map-&gt;n_ht_per_core) &amp;&amp;</div>
<div class="line">                    (map-&gt;map[pos] == -1)) ||</div>
<div class="line">                    ((ht_id &gt;= map-&gt;n_ht_per_core) &amp;&amp;</div>
<div class="line">                    (map-&gt;map[pos] != -1)))</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> ( ; core_id &lt; map-&gt;n_max_cores_per_socket; core_id++)</div>
<div class="line">            <span class="keywordflow">for</span> (ht_id = 0;</div>
<div class="line">                ht_id &lt; map-&gt;n_max_ht_per_core;</div>
<div class="line">                ht_id++) {</div>
<div class="line">                uint32_t pos = cpu_core_map_pos(map,</div>
<div class="line">                    socket_id,</div>
<div class="line">                    core_id,</div>
<div class="line">                    ht_id);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (map-&gt;map[pos] != -1)</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define FILE_LINUX_CPU_N_LCORES \</span></div>
<div class="line"><span class="preprocessor">    &quot;/sys/devices/system/cpu/present&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_get_n_lcores_linux(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buffer[64], *string;</div>
<div class="line">    FILE *fd;</div>
<div class="line"></div>
<div class="line">    fd = fopen(FILE_LINUX_CPU_N_LCORES, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (fd == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), fd) == NULL) {</div>
<div class="line">        fclose(fd);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fclose(fd);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">string</span> = index(buffer, <span class="charliteral">&#39;-&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keywordtype">string</span> == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> atoi(++<span class="keywordtype">string</span>) + 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define FILE_LINUX_CPU_CORE_ID \</span></div>
<div class="line"><span class="preprocessor">    &quot;/sys/devices/system/cpu/cpu%&quot; PRIu32 &quot;/topology/core_id&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_get_core_id_linux(<span class="keywordtype">int</span> lcore_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buffer[64];</div>
<div class="line">    FILE *fd;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>;</div>
<div class="line"></div>
<div class="line">    snprintf(buffer, <span class="keyword">sizeof</span>(buffer), FILE_LINUX_CPU_CORE_ID, lcore_id);</div>
<div class="line">    fd = fopen(buffer, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (fd == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), fd) == NULL) {</div>
<div class="line">        fclose(fd);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fclose(fd);</div>
<div class="line"></div>
<div class="line">    core_id = atoi(buffer);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define FILE_LINUX_CPU_SOCKET_ID \</span></div>
<div class="line"><span class="preprocessor">    &quot;/sys/devices/system/cpu/cpu%&quot; PRIu32 &quot;/topology/physical_package_id&quot;</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_get_socket_id_linux(<span class="keywordtype">int</span> lcore_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buffer[64];</div>
<div class="line">    FILE *fd;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a>;</div>
<div class="line"></div>
<div class="line">    snprintf(buffer, <span class="keyword">sizeof</span>(buffer), FILE_LINUX_CPU_SOCKET_ID, lcore_id);</div>
<div class="line">    fd = fopen(buffer, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (fd == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), fd) == NULL) {</div>
<div class="line">        fclose(fd);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fclose(fd);</div>
<div class="line"></div>
<div class="line">    socket_id = atoi(buffer);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_compute_linux(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    uint32_t <a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a>, <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>, ht_id;</div>
<div class="line">    <span class="keywordtype">int</span> n_lcores;</div>
<div class="line"></div>
<div class="line">    n_lcores = cpu_core_map_get_n_lcores_linux();</div>
<div class="line">    <span class="keywordflow">if</span> (n_lcores &lt;= 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Compute map */</span></div>
<div class="line">    <span class="keywordflow">for</span> (socket_id = 0; socket_id &lt; map-&gt;n_max_sockets; socket_id++) {</div>
<div class="line">        uint32_t n_detected, core_id_contig;</div>
<div class="line">        <span class="keywordtype">int</span> lcore_id;</div>
<div class="line"></div>
<div class="line">        n_detected = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; n_lcores; lcore_id++) {</div>
<div class="line">            <span class="keywordtype">int</span> lcore_socket_id =</div>
<div class="line">                cpu_core_map_get_socket_id_linux(lcore_id);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (lcore_socket_id &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (((uint32_t) lcore_socket_id) == socket_id)</div>
<div class="line">                n_detected++;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        core_id_contig = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (core_id = 0; n_detected ; core_id++) {</div>
<div class="line">            ht_id = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; n_lcores; lcore_id++) {</div>
<div class="line">                <span class="keywordtype">int</span> lcore_socket_id =</div>
<div class="line">                    cpu_core_map_get_socket_id_linux(</div>
<div class="line">                    lcore_id);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (lcore_socket_id &lt; 0)</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">                <span class="keywordtype">int</span> lcore_core_id =</div>
<div class="line">                    cpu_core_map_get_core_id_linux(</div>
<div class="line">                        lcore_id);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (lcore_core_id &lt; 0)</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (((uint32_t) lcore_socket_id == socket_id) &amp;&amp;</div>
<div class="line">                    ((uint32_t) lcore_core_id == core_id)) {</div>
<div class="line">                    uint32_t pos = cpu_core_map_pos(map,</div>
<div class="line">                        socket_id,</div>
<div class="line">                        core_id_contig,</div>
<div class="line">                        ht_id);</div>
<div class="line"></div>
<div class="line">                    map-&gt;map[pos] = lcore_id;</div>
<div class="line">                    ht_id++;</div>
<div class="line">                    n_detected--;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (ht_id) {</div>
<div class="line">                core_id_contig++;</div>
<div class="line">                <span class="keywordflow">if</span> (core_id_contig ==</div>
<div class="line">                    map-&gt;n_max_cores_per_socket)</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">cpu_core_map_print(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    uint32_t <a class="code" href="structlcore__config.html#a30eb8f175881194b94d9ba753c7a0a03">socket_id</a>, <a class="code" href="structlcore__config.html#af46d0cc773f9a1796623ba48f75baeec">core_id</a>, ht_id;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (map == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (socket_id = 0; socket_id &lt; map-&gt;n_sockets; socket_id++) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Socket %&quot;</span> PRIu32 <span class="stringliteral">&quot;:\n&quot;</span>, socket_id);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (core_id = 0;</div>
<div class="line">            core_id &lt; map-&gt;n_cores_per_socket;</div>
<div class="line">            core_id++) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;[%&quot;</span> PRIu32 <span class="stringliteral">&quot;] = [&quot;</span>, core_id);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">for</span> (ht_id = 0; ht_id &lt; map-&gt;n_ht_per_core; ht_id++) {</div>
<div class="line">                <span class="keywordtype">int</span> lcore_id = cpu_core_map_get_lcore_id(map,</div>
<div class="line">                    socket_id,</div>
<div class="line">                    core_id,</div>
<div class="line">                    ht_id);</div>
<div class="line"></div>
<div class="line">                uint32_t core_id_noncontig =</div>
<div class="line">                    cpu_core_map_get_core_id_linux(</div>
<div class="line">                        lcore_id);</div>
<div class="line"></div>
<div class="line">                printf(<span class="stringliteral">&quot; %&quot;</span> PRId32 <span class="stringliteral">&quot; (%&quot;</span> PRIu32 <span class="stringliteral">&quot;) &quot;</span>,</div>
<div class="line">                    lcore_id,</div>
<div class="line">                    core_id_noncontig);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            printf(<span class="stringliteral">&quot;]\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint32_t</div>
<div class="line">cpu_core_map_get_n_sockets(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (map == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> map-&gt;n_sockets;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint32_t</div>
<div class="line">cpu_core_map_get_n_cores_per_socket(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (map == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> map-&gt;n_cores_per_socket;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">uint32_t</div>
<div class="line">cpu_core_map_get_n_ht_per_core(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (map == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> map-&gt;n_ht_per_core;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">cpu_core_map_get_lcore_id(<span class="keyword">struct</span> cpu_core_map *map,</div>
<div class="line">    uint32_t socket_id,</div>
<div class="line">    uint32_t core_id,</div>
<div class="line">    uint32_t ht_id)</div>
<div class="line">{</div>
<div class="line">    uint32_t pos;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((map == NULL) ||</div>
<div class="line">        (socket_id &gt;= map-&gt;n_sockets) ||</div>
<div class="line">        (core_id &gt;= map-&gt;n_cores_per_socket) ||</div>
<div class="line">        (ht_id &gt;= map-&gt;n_ht_per_core))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    pos = cpu_core_map_pos(map, socket_id, core_id, ht_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> map-&gt;map[pos];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">cpu_core_map_free(<span class="keyword">struct</span> cpu_core_map *map)</div>
<div class="line">{</div>
<div class="line">    free(map);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
