<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: exception_path/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">exception_path/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_tun.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Macros for printing using RTE_LOG */</span></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_APP RTE_LOGTYPE_USER1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FATAL_ERROR(fmt, args...)       rte_exit(EXIT_FAILURE, fmt &quot;\n&quot;, ##args)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PRINT_INFO(fmt, args...)        RTE_LOG(INFO, APP, fmt &quot;\n&quot;, ##args)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Max ports than can be used (each port is associated with two lcores) */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PORTS               (RTE_MAX_LCORE / 2)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Max size of a single packet */</span></div>
<div class="line"><span class="preprocessor">#define MAX_PACKET_SZ (2048)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Size of the data buffer in each mbuf */</span></div>
<div class="line"><span class="preprocessor">#define MBUF_DATA_SZ (MAX_PACKET_SZ + RTE_PKTMBUF_HEADROOM)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of mbufs in mempool that is created */</span></div>
<div class="line"><span class="preprocessor">#define NB_MBUF                 8192</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* How many packets to attempt to read from NIC in one go */</span></div>
<div class="line"><span class="preprocessor">#define PKT_BURST_SZ            32</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* How many objects (mbufs) to keep in per-lcore mempool cache */</span></div>
<div class="line"><span class="preprocessor">#define MEMPOOL_CACHE_SZ        PKT_BURST_SZ</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of RX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define NB_RXD                  128</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Number of TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define NB_TXD                  512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * RX and TX Prefetch, Host, and Write-back threshold values should be</span></div>
<div class="line"><span class="comment"> * carefully set for optimal performance. Consult the network</span></div>
<div class="line"><span class="comment"> * controller&#39;s datasheet and supporting DPDK documentation for guidance</span></div>
<div class="line"><span class="comment"> * on how these parameters should be set.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Options for configuring ethernet port */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf = {</div>
<div class="line">    .<a name="a1"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a2"></a><a class="code" href="structrte__eth__rxmode.html#afe394653330a4c4fff5bee718dfd5185">header_split</a> = 0,      <span class="comment">/* Header Split disabled */</span></div>
<div class="line">        .hw_ip_checksum = 0,    <span class="comment">/* IP checksum offload disabled */</span></div>
<div class="line">        .hw_vlan_filter = 0,    <span class="comment">/* VLAN filtering disabled */</span></div>
<div class="line">        .jumbo_frame = 0,       <span class="comment">/* Jumbo Frame Support disabled */</span></div>
<div class="line">        .hw_strip_crc = 0,      <span class="comment">/* CRC stripped by hardware */</span></div>
<div class="line">    },</div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a3"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mempool for mbufs */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> * pktmbuf_pool = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t ports_mask = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mask of cores that read from NIC and write to tap */</span></div>
<div class="line"><span class="keyword">static</span> uint64_t input_cores_mask = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Mask of cores that read from tap and write to NIC */</span></div>
<div class="line"><span class="keyword">static</span> uint64_t output_cores_mask = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Array storing port_id that is associated with each lcore */</span></div>
<div class="line"><span class="keyword">static</span> uint8_t port_ids[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Structure type for recording lcore-specific stats */</span></div>
<div class="line"><span class="keyword">struct </span>stats {</div>
<div class="line">    uint64_t rx;</div>
<div class="line">    uint64_t tx;</div>
<div class="line">    uint64_t dropped;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Array of lcore-specific stats */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>stats lcore_stats[RTE_MAX_LCORE];</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Print out statistics on packets handled */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\n**Exception-Path example application statistics**\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;=======  ======  ============  ============  ===============\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot; Lcore    Port            RX            TX    Dropped on TX\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;-------  ------  ------------  ------------  ---------------\n&quot;</span>);</div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__lcore_8h.html#a034c95b6412f09e8de11d430267dc1ba">RTE_LCORE_FOREACH</a>(i) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%6u %7u %13&quot;</span>PRIu64<span class="stringliteral">&quot; %13&quot;</span>PRIu64<span class="stringliteral">&quot; %16&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">               i, (<span class="keywordtype">unsigned</span>)port_ids[i],</div>
<div class="line">               lcore_stats[i].rx, lcore_stats[i].tx,</div>
<div class="line">               lcore_stats[i].dropped);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;=======  ======  ============  ============  ===============\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Custom handling of signals to handle stats */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">signal_handler(<span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* When we receive a USR1 signal, print stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGUSR1) {</div>
<div class="line">        print_stats();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* When we receive a USR2 signal, reset stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGUSR2) {</div>
<div class="line">        memset(&amp;lcore_stats, 0, <span class="keyword">sizeof</span>(lcore_stats));</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n**Statistics have been reset**\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Create a tap network interface, or use existing one with same name.</span></div>
<div class="line"><span class="comment"> * If name[0]=&#39;\0&#39; then a name is automatically assigned and returned in name.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> tap_create(<span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>ifreq ifr;</div>
<div class="line">    <span class="keywordtype">int</span> fd, ret;</div>
<div class="line"></div>
<div class="line">    fd = open(<span class="stringliteral">&quot;/dev/net/tun&quot;</span>, O_RDWR);</div>
<div class="line">    <span class="keywordflow">if</span> (fd &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> fd;</div>
<div class="line"></div>
<div class="line">    memset(&amp;ifr, 0, <span class="keyword">sizeof</span>(ifr));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* TAP device without packet information */</span></div>
<div class="line">    ifr.ifr_flags = IFF_TAP | IFF_NO_PI;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (name &amp;&amp; *name)</div>
<div class="line">        snprintf(ifr.ifr_name, IFNAMSIZ, <span class="stringliteral">&quot;%s&quot;</span>, name);</div>
<div class="line"></div>
<div class="line">    ret = ioctl(fd, TUNSETIFF, (<span class="keywordtype">void</span> *) &amp;ifr);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        close(fd);</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (name)</div>
<div class="line">        snprintf(name, IFNAMSIZ, <span class="stringliteral">&quot;%s&quot;</span>, ifr.ifr_name);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> fd;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Main processing loop */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">main_loop(__attribute__((unused)) <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> lcore_id = <a name="a6"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keywordtype">char</span> tap_name[IFNAMSIZ];</div>
<div class="line">    <span class="keywordtype">int</span> tap_fd;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((1ULL &lt;&lt; lcore_id) &amp; input_cores_mask) {</div>
<div class="line">        <span class="comment">/* Create new tap interface */</span></div>
<div class="line">        snprintf(tap_name, IFNAMSIZ, <span class="stringliteral">&quot;tap_dpdk_%.2u&quot;</span>, lcore_id);</div>
<div class="line">        tap_fd = tap_create(tap_name);</div>
<div class="line">        <span class="keywordflow">if</span> (tap_fd &lt; 0)</div>
<div class="line">            FATAL_ERROR(<span class="stringliteral">&quot;Could not create tap interface \&quot;%s\&quot; (%d)&quot;</span>,</div>
<div class="line">                    tap_name, tap_fd);</div>
<div class="line"></div>
<div class="line">        PRINT_INFO(<span class="stringliteral">&quot;Lcore %u is reading from port %u and writing to %s&quot;</span>,</div>
<div class="line">                   lcore_id, (<span class="keywordtype">unsigned</span>)port_ids[lcore_id], tap_name);</div>
<div class="line">        fflush(stdout);</div>
<div class="line">        <span class="comment">/* Loop forever reading from NIC and writing to tap */</span></div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[PKT_BURST_SZ];</div>
<div class="line">            <span class="keywordtype">unsigned</span> i;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nb_rx =</div>
<div class="line">                    <a name="a8"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(port_ids[lcore_id], 0,</div>
<div class="line">                        pkts_burst, PKT_BURST_SZ);</div>
<div class="line">            lcore_stats[lcore_id].rx += nb_rx;</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; <a name="a9"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(i &lt; nb_rx); i++) {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = pkts_burst[i];</div>
<div class="line">                <span class="comment">/* Ignore return val from write() */</span></div>
<div class="line">                <span class="keywordtype">int</span> ret = write(tap_fd,</div>
<div class="line">                                <a name="a10"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">void</span>*),</div>
<div class="line">                                <a name="a11"></a><a class="code" href="rte__mbuf_8h.html#a2a1e1b30162161ed11d3ba2faf7bbf13">rte_pktmbuf_data_len</a>(m));</div>
<div class="line">                <a name="a12"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">                <span class="keywordflow">if</span> (<a name="a13"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 0))</div>
<div class="line">                    lcore_stats[lcore_id].dropped++;</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    lcore_stats[lcore_id].tx++;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((1ULL &lt;&lt; lcore_id) &amp; output_cores_mask) {</div>
<div class="line">        <span class="comment">/* Create new tap interface */</span></div>
<div class="line">        snprintf(tap_name, IFNAMSIZ, <span class="stringliteral">&quot;tap_dpdk_%.2u&quot;</span>, lcore_id);</div>
<div class="line">        tap_fd = tap_create(tap_name);</div>
<div class="line">        <span class="keywordflow">if</span> (tap_fd &lt; 0)</div>
<div class="line">            FATAL_ERROR(<span class="stringliteral">&quot;Could not create tap interface \&quot;%s\&quot; (%d)&quot;</span>,</div>
<div class="line">                    tap_name, tap_fd);</div>
<div class="line"></div>
<div class="line">        PRINT_INFO(<span class="stringliteral">&quot;Lcore %u is reading from %s and writing to port %u&quot;</span>,</div>
<div class="line">                   lcore_id, tap_name, (<span class="keywordtype">unsigned</span>)port_ids[lcore_id]);</div>
<div class="line">        fflush(stdout);</div>
<div class="line">        <span class="comment">/* Loop forever reading from tap and writing to NIC */</span></div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="keywordtype">int</span> ret;</div>
<div class="line">            <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = <a name="a14"></a><a class="code" href="rte__mbuf_8h.html#ad4d1c289d8cffc831dfb77c64f52447b">rte_pktmbuf_alloc</a>(pktmbuf_pool);</div>
<div class="line">            <span class="keywordflow">if</span> (m == NULL)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            ret = read(tap_fd, <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">void</span> *),</div>
<div class="line">                MAX_PACKET_SZ);</div>
<div class="line">            lcore_stats[lcore_id].rx++;</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 0)) {</div>
<div class="line">                FATAL_ERROR(<span class="stringliteral">&quot;Reading from %s interface failed&quot;</span>,</div>
<div class="line">                            tap_name);</div>
<div class="line">            }</div>
<div class="line">            m-&gt;<a name="a15"></a><a class="code" href="structrte__mbuf.html#a54163d61074a843b5a9560b74f7d3581">nb_segs</a> = 1;</div>
<div class="line">            m-&gt;<a name="a16"></a><a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a> = NULL;</div>
<div class="line">            m-&gt;<a name="a17"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a> = (uint16_t)ret;</div>
<div class="line">            m-&gt;<a name="a18"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = (uint16_t)ret;</div>
<div class="line">            ret = <a name="a19"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(port_ids[lcore_id], 0, &amp;m, 1);</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(ret &lt; 1)) {</div>
<div class="line">                <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">                lcore_stats[lcore_id].dropped++;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                lcore_stats[lcore_id].tx++;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        PRINT_INFO(<span class="stringliteral">&quot;Lcore %u has nothing to do&quot;</span>, lcore_id);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Tap file is closed automatically when program exits. Putting close()</span></div>
<div class="line"><span class="comment">     * here will cause the compiler to give an error about unreachable code.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Display usage instructions */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    PRINT_INFO(<span class="stringliteral">&quot;\nUsage: %s [EAL options] -- -p PORTMASK -i IN_CORES -o OUT_CORES\n&quot;</span></div>
<div class="line">               <span class="stringliteral">&quot;    -p PORTMASK: hex bitmask of ports to use\n&quot;</span></div>
<div class="line">               <span class="stringliteral">&quot;    -i IN_CORES: hex bitmask of cores which read from NIC\n&quot;</span></div>
<div class="line">               <span class="stringliteral">&quot;    -o OUT_CORES: hex bitmask of cores which write to NIC&quot;</span>,</div>
<div class="line">               prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Convert string to unsigned number. 0 is returned if error occurs */</span></div>
<div class="line"><span class="keyword">static</span> uint64_t</div>
<div class="line">parse_unsigned(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    uint64_t num;</div>
<div class="line"></div>
<div class="line">    num = strtoull(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> (uint64_t)num;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Record affinities between ports and lcores in global port_ids[] array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">setup_port_lcore_affinities(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i;</div>
<div class="line">    uint8_t tx_port = 0;</div>
<div class="line">    uint8_t rx_port = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup port_ids[] array, and check masks were ok */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#a034c95b6412f09e8de11d430267dc1ba">RTE_LCORE_FOREACH</a>(i) {</div>
<div class="line">        <span class="keywordflow">if</span> (input_cores_mask &amp; (1ULL &lt;&lt; i)) {</div>
<div class="line">            <span class="comment">/* Skip ports that are not enabled */</span></div>
<div class="line">            <span class="keywordflow">while</span> ((ports_mask &amp; (1 &lt;&lt; rx_port)) == 0) {</div>
<div class="line">                rx_port++;</div>
<div class="line">                <span class="keywordflow">if</span> (rx_port &gt; (<span class="keyword">sizeof</span>(ports_mask) * 8))</div>
<div class="line">                    <span class="keywordflow">goto</span> fail; <span class="comment">/* not enough ports */</span></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            port_ids[i] = rx_port++;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (output_cores_mask &amp; (1ULL &lt;&lt; i)) {</div>
<div class="line">            <span class="comment">/* Skip ports that are not enabled */</span></div>
<div class="line">            <span class="keywordflow">while</span> ((ports_mask &amp; (1 &lt;&lt; tx_port)) == 0) {</div>
<div class="line">                tx_port++;</div>
<div class="line">                <span class="keywordflow">if</span> (tx_port &gt; (<span class="keyword">sizeof</span>(ports_mask) * 8))</div>
<div class="line">                    <span class="keywordflow">goto</span> fail; <span class="comment">/* not enough ports */</span></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            port_ids[i] = tx_port++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rx_port != tx_port)</div>
<div class="line">        <span class="keywordflow">goto</span> fail; <span class="comment">/* uneven number of cores in masks */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ports_mask &amp; (~((1 &lt;&lt; rx_port) - 1)))</div>
<div class="line">        <span class="keywordflow">goto</span> fail; <span class="comment">/* unused ports */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">fail:</div>
<div class="line">    FATAL_ERROR(<span class="stringliteral">&quot;Invalid core/port masks specified on command line&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Parse the arguments given in the command line of the application */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Disable printing messages within getopt() */</span></div>
<div class="line">    opterr = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt(argc, argv, <span class="stringliteral">&quot;i:o:p:&quot;</span>)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">            input_cores_mask = parse_unsigned(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:</div>
<div class="line">            output_cores_mask = parse_unsigned(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            ports_mask = parse_unsigned(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            print_usage(prgname);</div>
<div class="line">            FATAL_ERROR(<span class="stringliteral">&quot;Invalid option specified&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check that options were parsed ok */</span></div>
<div class="line">    <span class="keywordflow">if</span> (input_cores_mask == 0) {</div>
<div class="line">        print_usage(prgname);</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;IN_CORES not specified correctly&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (output_cores_mask == 0) {</div>
<div class="line">        print_usage(prgname);</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;OUT_CORES not specified correctly&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ports_mask == 0) {</div>
<div class="line">        print_usage(prgname);</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;PORTMASK not specified correctly&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    setup_port_lcore_affinities();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialise a single port on an Ethernet device */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">init_port(uint8_t <a name="_a20"></a><a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise device and RX/TX queues */</span></div>
<div class="line">    PRINT_INFO(<span class="stringliteral">&quot;Initialising port %u ...&quot;</span>, (<span class="keywordtype">unsigned</span>)port);</div>
<div class="line">    fflush(stdout);</div>
<div class="line">    ret = <a name="a21"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, 1, 1, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not configure port%u (%d)&quot;</span>,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a22"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, 0, NB_RXD, rte_eth_dev_socket_id(port),</div>
<div class="line">                NULL,</div>
<div class="line">                pktmbuf_pool);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not setup up RX queue for port%u (%d)&quot;</span>,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a23"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, 0, NB_TXD, rte_eth_dev_socket_id(port),</div>
<div class="line">                NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not setup up TX queue for port%u (%d)&quot;</span>,</div>
<div class="line">                    (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    ret = <a name="a24"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not start port%u (%d)&quot;</span>, (<span class="keywordtype">unsigned</span>)port, ret);</div>
<div class="line"></div>
<div class="line">    <a name="a25"></a><a class="code" href="rte__ethdev_8h.html#aa8064b25aee324bdbbf779ea23d55f49">rte_eth_promiscuous_enable</a>(port);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check the link status of all ports in up to 9s, and print them finally */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">check_all_ports_link_status(uint8_t port_num, uint32_t port_mask)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#define CHECK_INTERVAL 100 </span><span class="comment">/* 100ms */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_CHECK_TIME 90 </span><span class="comment">/* 9s (90 * 100ms) in total */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>    uint8_t portid, count, all_ports_up, print_flag = 0;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a26"></a><a class="code" href="structrte__eth__link.html">rte_eth_link</a> link;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nChecking link status&quot;</span>);</div>
<div class="line">    fflush(stdout);</div>
<div class="line">    <span class="keywordflow">for</span> (count = 0; count &lt;= MAX_CHECK_TIME; count++) {</div>
<div class="line">        all_ports_up = 1;</div>
<div class="line">        <span class="keywordflow">for</span> (portid = 0; portid &lt; port_num; portid++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((port_mask &amp; (1 &lt;&lt; portid)) == 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            memset(&amp;link, 0, <span class="keyword">sizeof</span>(link));</div>
<div class="line">            <a name="a27"></a><a class="code" href="rte__ethdev_8h.html#a6908b1ef94c95ef85af851e6705a5f93">rte_eth_link_get_nowait</a>(portid, &amp;link);</div>
<div class="line">            <span class="comment">/* print link status if flag set */</span></div>
<div class="line">            <span class="keywordflow">if</span> (print_flag == 1) {</div>
<div class="line">                <span class="keywordflow">if</span> (link.link_status)</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Up - speed %u &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;Mbps - %s\n&quot;</span>, (uint8_t)portid,</div>
<div class="line">                        (<span class="keywordtype">unsigned</span>)link.link_speed,</div>
<div class="line">                (link.link_duplex == <a name="a28"></a><a class="code" href="rte__ethdev_8h.html#a042c83951613bf2db5d3056b967041d6">ETH_LINK_FULL_DUPLEX</a>) ?</div>
<div class="line">                    (<span class="stringliteral">&quot;full-duplex&quot;</span>) : (<span class="stringliteral">&quot;half-duplex\n&quot;</span>));</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    printf(<span class="stringliteral">&quot;Port %d Link Down\n&quot;</span>,</div>
<div class="line">                        (uint8_t)portid);</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">/* clear all_ports_up flag if any link down */</span></div>
<div class="line">            <span class="keywordflow">if</span> (link.link_status == <a name="a29"></a><a class="code" href="rte__ethdev_8h.html#a08c012f37e07726170ff67daf667d850">ETH_LINK_DOWN</a>) {</div>
<div class="line">                all_ports_up = 0;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* after finally printing all link status, get out */</span></div>
<div class="line">        <span class="keywordflow">if</span> (print_flag == 1)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">            fflush(stdout);</div>
<div class="line">            <a name="a30"></a><a class="code" href="rte__cycles_8h.html#af73b844d50b98de74b1a0e1730262f85">rte_delay_ms</a>(CHECK_INTERVAL);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* set the print_flag if all ports up or timeout */</span></div>
<div class="line">        <span class="keywordflow">if</span> (all_ports_up == 1 || count == (MAX_CHECK_TIME - 1)) {</div>
<div class="line">            print_flag = 1;</div>
<div class="line">            printf(<span class="stringliteral">&quot;done\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialise ports/queues etc. and start main loop on each core */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i,high_port;</div>
<div class="line">    uint8_t nb_sys_ports, port;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Associate signal_hanlder function with USR signals */</span></div>
<div class="line">    signal(SIGUSR1, signal_handler);</div>
<div class="line">    signal(SIGUSR2, signal_handler);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise EAL */</span></div>
<div class="line">    ret = <a name="a31"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not initialise EAL (%d)&quot;</span>, ret);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse application arguments (after the EAL ones) */</span></div>
<div class="line">    parse_args(argc, argv);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create the mbuf pool */</span></div>
<div class="line">    pktmbuf_pool = <a name="a32"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;mbuf_pool&quot;</span>, NB_MBUF,</div>
<div class="line">            MEMPOOL_CACHE_SZ, 0, MBUF_DATA_SZ, <a name="a33"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (pktmbuf_pool == NULL) {</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Could not initialise mbuf pool&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get number of ports found in scan */</span></div>
<div class="line">    nb_sys_ports = <a name="a34"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (nb_sys_ports == 0)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;No supported Ethernet device found&quot;</span>);</div>
<div class="line">    <span class="comment">/* Find highest port set in portmask */</span></div>
<div class="line">    <span class="keywordflow">for</span> (high_port = (<span class="keyword">sizeof</span>(ports_mask) * 8) - 1;</div>
<div class="line">            (high_port != 0) &amp;&amp; !(ports_mask &amp; (1 &lt;&lt; high_port));</div>
<div class="line">            high_port--)</div>
<div class="line">        ; <span class="comment">/* empty body */</span></div>
<div class="line">    <span class="keywordflow">if</span> (high_port &gt; nb_sys_ports)</div>
<div class="line">        FATAL_ERROR(<span class="stringliteral">&quot;Port mask requires more ports than available&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialise each port */</span></div>
<div class="line">    <span class="keywordflow">for</span> (port = 0; port &lt; nb_sys_ports; port++) {</div>
<div class="line">        <span class="comment">/* Skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((ports_mask &amp; (1 &lt;&lt; port)) == 0) {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        init_port(port);</div>
<div class="line">    }</div>
<div class="line">    check_all_ports_link_status(nb_sys_ports, ports_mask);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Launch per-lcore function on every lcore */</span></div>
<div class="line">    <a name="a35"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(main_loop, NULL, <a name="a36"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2ada39ec34f33f669f99bd28ab7c58a952ac">CALL_MASTER</a>);</div>
<div class="line">    <a name="a37"></a><a class="code" href="rte__lcore_8h.html#a7c9e9927c695ee953c15d64026511919">RTE_LCORE_FOREACH_SLAVE</a>(i) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a38"></a><a class="code" href="rte__launch_8h.html#a1282dc7cd7e6793afab3ef29239ddf54">rte_eal_wait_lcore</a>(i) &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
