<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: ptpclient/ptpclient.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ptpclient/ptpclient.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2015 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This application is a simple Layer 2 PTP v2 client. It shows delta values</span></div>
<div class="line"><span class="comment"> * which are used to synchronize the PHC clock. if the &quot;-T 1&quot; parameter is</span></div>
<div class="line"><span class="comment"> * passed to the application the Linux kernel clock is also synchronized.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RX_RING_SIZE 128</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TX_RING_SIZE 512</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define NUM_MBUFS            8191</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBUF_CACHE_SIZE       250</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Values for the PTP messageType field. */</span></div>
<div class="line"><span class="preprocessor">#define SYNC                  0x0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_REQ             0x1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PDELAY_REQ            0x2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PDELAY_RESP           0x3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FOLLOW_UP             0x8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DELAY_RESP            0x9</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PDELAY_RESP_FOLLOW_UP 0xA</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ANNOUNCE              0xB</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SIGNALING             0xC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MANAGEMENT            0xD</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define NSEC_PER_SEC        1000000000L</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define KERNEL_TIME_ADJUST_LIMIT  20000</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define PTP_PROTOCOL             0x88F7</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool;</div>
<div class="line">uint32_t ptp_enabled_port_mask;</div>
<div class="line">uint8_t ptp_enabled_port_nb;</div>
<div class="line"><span class="keyword">static</span> uint8_t ptp_enabled_ports[RTE_MAX_ETHPORTS];</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf_default = {</div>
<div class="line">    .<a name="a2"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = { .<a name="a3"></a><a class="code" href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">max_rx_pkt_len</a> = <a name="a4"></a><a class="code" href="rte__ether_8h.html#aaebedff0cce73327398dd3139ba50e43">ETHER_MAX_LEN</a> }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a5"></a><a class="code" href="structether__addr.html">ether_addr</a> ether_multicast = {</div>
<div class="line">    .<a name="a6"></a><a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a> = {0x01, 0x1b, 0x19, 0x0, 0x0, 0x0}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Structs used for PTP handling. */</span></div>
<div class="line"><span class="keyword">struct </span>tstamp {</div>
<div class="line">    uint16_t   sec_msb;</div>
<div class="line">    uint32_t   sec_lsb;</div>
<div class="line">    uint32_t   ns;</div>
<div class="line">}  __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>clock_id {</div>
<div class="line">    uint8_t <span class="keywordtype">id</span>[8];</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>port_id {</div>
<div class="line">    <span class="keyword">struct </span>clock_id        clock_id;</div>
<div class="line">    uint16_t               port_number;</div>
<div class="line">}  __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ptp_header {</div>
<div class="line">    uint8_t              msg_type;</div>
<div class="line">    uint8_t              ver;</div>
<div class="line">    uint16_t             message_length;</div>
<div class="line">    uint8_t              domain_number;</div>
<div class="line">    uint8_t              reserved1;</div>
<div class="line">    uint8_t              flag_field[2];</div>
<div class="line">    int64_t              correction;</div>
<div class="line">    uint32_t             reserved2;</div>
<div class="line">    <span class="keyword">struct </span>port_id       source_port_id;</div>
<div class="line">    uint16_t             seq_id;</div>
<div class="line">    uint8_t              control;</div>
<div class="line">    int8_t               log_message_interval;</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>sync_msg {</div>
<div class="line">    <span class="keyword">struct </span>ptp_header   hdr;</div>
<div class="line">    <span class="keyword">struct </span>tstamp       origin_tstamp;</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>follow_up_msg {</div>
<div class="line">    <span class="keyword">struct </span>ptp_header   hdr;</div>
<div class="line">    <span class="keyword">struct </span>tstamp       precise_origin_tstamp;</div>
<div class="line">    uint8_t             suffix[0];</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>delay_req_msg {</div>
<div class="line">    <span class="keyword">struct </span>ptp_header   hdr;</div>
<div class="line">    <span class="keyword">struct </span>tstamp       origin_tstamp;</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>delay_resp_msg {</div>
<div class="line">    <span class="keyword">struct </span>ptp_header    hdr;</div>
<div class="line">    <span class="keyword">struct </span>tstamp        rx_tstamp;</div>
<div class="line">    <span class="keyword">struct </span>port_id       req_port_id;</div>
<div class="line">    uint8_t              suffix[0];</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ptp_message {</div>
<div class="line">    <span class="keyword">union </span>{</div>
<div class="line">        <span class="keyword">struct </span>ptp_header          header;</div>
<div class="line">        <span class="keyword">struct </span>sync_msg            sync;</div>
<div class="line">        <span class="keyword">struct </span>delay_req_msg       delay_req;</div>
<div class="line">        <span class="keyword">struct </span>follow_up_msg       follow_up;</div>
<div class="line">        <span class="keyword">struct </span>delay_resp_msg      delay_resp;</div>
<div class="line">    } __attribute__((packed));</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>ptpv2_data_slave_ordinary {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m;</div>
<div class="line">    <span class="keyword">struct </span>timespec tstamp1;</div>
<div class="line">    <span class="keyword">struct </span>timespec tstamp2;</div>
<div class="line">    <span class="keyword">struct </span>timespec tstamp3;</div>
<div class="line">    <span class="keyword">struct </span>timespec tstamp4;</div>
<div class="line">    <span class="keyword">struct </span>clock_id client_clock_id;</div>
<div class="line">    <span class="keyword">struct </span>clock_id master_clock_id;</div>
<div class="line">    <span class="keyword">struct </span>timeval new_adj;</div>
<div class="line">    int64_t delta;</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    uint16_t seqID_SYNC;</div>
<div class="line">    uint16_t seqID_FOLLOWUP;</div>
<div class="line">    uint8_t ptpset;</div>
<div class="line">    uint8_t kernel_time_set;</div>
<div class="line">    uint8_t current_ptp_port;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>ptpv2_data_slave_ordinary ptp_data;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> uint64_t timespec64_to_ns(<span class="keyword">const</span> <span class="keyword">struct</span> timespec *ts)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> ((uint64_t) ts-&gt;tv_sec * NSEC_PER_SEC) + ts-&gt;tv_nsec;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>timeval</div>
<div class="line">ns_to_timeval(int64_t nsec)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>timespec t_spec = {0, 0};</div>
<div class="line">    <span class="keyword">struct </span>timeval t_eval = {0, 0};</div>
<div class="line">    int32_t rem;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (nsec == 0)</div>
<div class="line">        <span class="keywordflow">return</span> t_eval;</div>
<div class="line">    rem = nsec % NSEC_PER_SEC;</div>
<div class="line">    t_spec.tv_sec = nsec / NSEC_PER_SEC;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (rem &lt; 0) {</div>
<div class="line">        t_spec.tv_sec--;</div>
<div class="line">        rem += NSEC_PER_SEC;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    t_spec.tv_nsec = rem;</div>
<div class="line">    t_eval.tv_sec = t_spec.tv_sec;</div>
<div class="line">    t_eval.tv_usec = t_spec.tv_nsec / 1000;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> t_eval;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initializes a given port using global settings and with the RX buffers</span></div>
<div class="line"><span class="comment"> * coming from the mbuf_pool passed as a parameter.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">port_init(uint8_t <a name="_a8"></a><a class="code" href="structport.html">port</a>, <span class="keyword">struct</span> <a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a9"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf = port_conf_default;</div>
<div class="line">    <span class="keyword">const</span> uint16_t rx_rings = 1;</div>
<div class="line">    <span class="keyword">const</span> uint16_t tx_rings = 1;</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (port &gt;= <a name="a10"></a><a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>())</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Configure the Ethernet device. */</span></div>
<div class="line">    retval = <a name="a11"></a><a class="code" href="rte__ethdev_8h.html#ac30d075b4b206c7122e200164ce69893">rte_eth_dev_configure</a>(port, rx_rings, tx_rings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate and set up 1 RX queue per Ethernet port. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rx_rings; q++) {</div>
<div class="line">        retval = <a name="a12"></a><a class="code" href="rte__ethdev_8h.html#a8db38c1bb895250a99b217bb24126d8e">rte_eth_rx_queue_setup</a>(port, q, RX_RING_SIZE,</div>
<div class="line">                rte_eth_dev_socket_id(port), NULL, mbuf_pool);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Allocate and set up 1 TX queue per Ethernet port. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; tx_rings; q++) {</div>
<div class="line">        <span class="comment">/* Setup txq_flags */</span></div>
<div class="line">        <span class="keyword">struct </span><a name="_a13"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> *txconf;</div>
<div class="line"></div>
<div class="line">        <a name="a14"></a><a class="code" href="rte__ethdev_8h.html#a469a98f6245c85d14f58af8f73168d8b">rte_eth_dev_info_get</a>(q, &amp;dev_info);</div>
<div class="line">        txconf = &amp;dev_info.default_txconf;</div>
<div class="line">        txconf-&gt;<a name="a15"></a><a class="code" href="structrte__eth__txconf.html#a80d79f1953993347e9b0312a2096f86e">txq_flags</a> = 0;</div>
<div class="line"></div>
<div class="line">        retval = <a name="a16"></a><a class="code" href="rte__ethdev_8h.html#af4b9fe682d4487fb3efecc40d08d04a7">rte_eth_tx_queue_setup</a>(port, q, TX_RING_SIZE,</div>
<div class="line">                rte_eth_dev_socket_id(port), txconf);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the Ethernet port. */</span></div>
<div class="line">    retval = <a name="a17"></a><a class="code" href="rte__ethdev_8h.html#ab6cdec593efa6b9809e711ade3a2fe24">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable timesync timestamping for the Ethernet device */</span></div>
<div class="line">    <a name="a18"></a><a class="code" href="rte__ethdev_8h.html#a31a74c7ea4360731faff68623c4016ac">rte_eth_timesync_enable</a>(port);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Enable RX in promiscuous mode for the Ethernet device. */</span></div>
<div class="line">    <a name="a19"></a><a class="code" href="rte__ethdev_8h.html#aa8064b25aee324bdbbf779ea23d55f49">rte_eth_promiscuous_enable</a>(port);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_clock_info(<span class="keyword">struct</span> ptpv2_data_slave_ordinary *ptp_data)</div>
<div class="line">{</div>
<div class="line">    int64_t nsec;</div>
<div class="line">    <span class="keyword">struct </span>timespec net_time, sys_time;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Master Clock id: %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x&quot;</span>,</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[0],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[1],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[2],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[3],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[4],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[5],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[6],</div>
<div class="line">        ptp_data-&gt;master_clock_id.id[7]);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nT2 - Slave  Clock.  %lds %ldns&quot;</span>,</div>
<div class="line">            (ptp_data-&gt;tstamp2.tv_sec),</div>
<div class="line">            (ptp_data-&gt;tstamp2.tv_nsec));</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nT1 - Master Clock.  %lds %ldns &quot;</span>,</div>
<div class="line">            ptp_data-&gt;tstamp1.tv_sec,</div>
<div class="line">            (ptp_data-&gt;tstamp1.tv_nsec));</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nT3 - Slave  Clock.  %lds %ldns&quot;</span>,</div>
<div class="line">            ptp_data-&gt;tstamp3.tv_sec,</div>
<div class="line">            (ptp_data-&gt;tstamp3.tv_nsec));</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nT4 - Master Clock.  %lds %ldns &quot;</span>,</div>
<div class="line">            ptp_data-&gt;tstamp4.tv_sec,</div>
<div class="line">            (ptp_data-&gt;tstamp4.tv_nsec));</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nDelta between master and slave clocks:%&quot;</span>PRId64<span class="stringliteral">&quot;ns\n&quot;</span>,</div>
<div class="line">            ptp_data-&gt;delta);</div>
<div class="line"></div>
<div class="line">    clock_gettime(CLOCK_REALTIME, &amp;sys_time);</div>
<div class="line">    <a name="a20"></a><a class="code" href="rte__ethdev_8h.html#aa659027c1751e81800aa7b61e77936c3">rte_eth_timesync_read_time</a>(ptp_data-&gt;current_ptp_port, &amp;net_time);</div>
<div class="line"></div>
<div class="line">    time_t ts = net_time.tv_sec;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\n\nComparison between Linux kernel Time and PTP:&quot;</span>);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nCurrent PTP Time: %.24s %.9ld ns&quot;</span>,</div>
<div class="line">            ctime(&amp;ts), net_time.tv_nsec);</div>
<div class="line"></div>
<div class="line">    nsec = (int64_t)timespec64_to_ns(&amp;net_time) -</div>
<div class="line">            (int64_t)timespec64_to_ns(&amp;sys_time);</div>
<div class="line">    ptp_data-&gt;new_adj = ns_to_timeval(nsec);</div>
<div class="line"></div>
<div class="line">    gettimeofday(&amp;ptp_data-&gt;new_adj, NULL);</div>
<div class="line"></div>
<div class="line">    time_t tp = ptp_data-&gt;new_adj.tv_sec;</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nCurrent SYS Time: %.24s %.6ld ns&quot;</span>,</div>
<div class="line">                ctime(&amp;tp), ptp_data-&gt;new_adj.tv_usec);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nDelta between PTP and Linux Kernel time:%&quot;</span>PRId64<span class="stringliteral">&quot;ns\n&quot;</span>,</div>
<div class="line">                nsec);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;[Ctrl+C to quit]\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clear screen and put cursor in column 1, row 1 */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\033[2J\033[1;1H&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int64_t</div>
<div class="line">delta_eval(<span class="keyword">struct</span> ptpv2_data_slave_ordinary *ptp_data)</div>
<div class="line">{</div>
<div class="line">    int64_t delta;</div>
<div class="line">    uint64_t t1 = 0;</div>
<div class="line">    uint64_t t2 = 0;</div>
<div class="line">    uint64_t t3 = 0;</div>
<div class="line">    uint64_t t4 = 0;</div>
<div class="line"></div>
<div class="line">    t1 = timespec64_to_ns(&amp;ptp_data-&gt;tstamp1);</div>
<div class="line">    t2 = timespec64_to_ns(&amp;ptp_data-&gt;tstamp2);</div>
<div class="line">    t3 = timespec64_to_ns(&amp;ptp_data-&gt;tstamp3);</div>
<div class="line">    t4 = timespec64_to_ns(&amp;ptp_data-&gt;tstamp4);</div>
<div class="line"></div>
<div class="line">    delta = -((int64_t)((t2 - t1) - (t4 - t3))) / 2;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> delta;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the PTP SYNC message.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_sync(<span class="keyword">struct</span> ptpv2_data_slave_ordinary *ptp_data, uint16_t rx_tstamp_idx)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>ptp_header *ptp_hdr;</div>
<div class="line"></div>
<div class="line">    ptp_hdr = (<span class="keyword">struct </span>ptp_header *)(<a name="a21"></a><a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(ptp_data-&gt;m, <span class="keywordtype">char</span> *)</div>
<div class="line">            + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a name="_a22"></a><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    ptp_data-&gt;seqID_SYNC = <a name="a23"></a><a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(ptp_hdr-&gt;seq_id);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ptp_data-&gt;ptpset == 0) {</div>
<div class="line">        <a name="a24"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;ptp_data-&gt;master_clock_id,</div>
<div class="line">                &amp;ptp_hdr-&gt;source_port_id.clock_id,</div>
<div class="line">                <span class="keyword">sizeof</span>(<span class="keyword">struct</span> clock_id));</div>
<div class="line">        ptp_data-&gt;ptpset = 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (memcmp(&amp;ptp_hdr-&gt;source_port_id.clock_id,</div>
<div class="line">            &amp;ptp_hdr-&gt;source_port_id.clock_id,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> clock_id)) == 0) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ptp_data-&gt;ptpset == 1)</div>
<div class="line">            <a name="a25"></a><a class="code" href="rte__ethdev_8h.html#a7dccf3e814e5a1de9a57d9f9323f6651">rte_eth_timesync_read_rx_timestamp</a>(ptp_data-&gt;portid,</div>
<div class="line">                    &amp;ptp_data-&gt;tstamp2, rx_tstamp_idx);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the PTP FOLLOWUP message and send DELAY_REQ to the master clock.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_fup(<span class="keyword">struct</span> ptpv2_data_slave_ordinary *ptp_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line">    <span class="keyword">struct </span>ptp_header *ptp_hdr;</div>
<div class="line">    <span class="keyword">struct </span>clock_id *client_clkid;</div>
<div class="line">    <span class="keyword">struct </span>ptp_message *ptp_msg;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *created_pkt;</div>
<div class="line">    <span class="keyword">struct </span>tstamp *origin_tstamp;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__addr.html">ether_addr</a> eth_multicast = ether_multicast;</div>
<div class="line">    <span class="keywordtype">size_t</span> pkt_size;</div>
<div class="line">    <span class="keywordtype">int</span> wait_us;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = ptp_data-&gt;m;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    ptp_hdr = (<span class="keyword">struct </span>ptp_header *)(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">char</span> *)</div>
<div class="line">            + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    <span class="keywordflow">if</span> (memcmp(&amp;ptp_data-&gt;master_clock_id,</div>
<div class="line">            &amp;ptp_hdr-&gt;source_port_id.clock_id,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> clock_id)) != 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    ptp_data-&gt;seqID_FOLLOWUP = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(ptp_hdr-&gt;seq_id);</div>
<div class="line">    ptp_msg = (<span class="keyword">struct </span>ptp_message *) (<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">char</span> *) +</div>
<div class="line">                      <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">    origin_tstamp = &amp;ptp_msg-&gt;follow_up.precise_origin_tstamp;</div>
<div class="line">    ptp_data-&gt;tstamp1.tv_nsec = ntohl(origin_tstamp-&gt;ns);</div>
<div class="line">    ptp_data-&gt;tstamp1.tv_sec =</div>
<div class="line">        ((uint64_t)ntohl(origin_tstamp-&gt;sec_lsb)) |</div>
<div class="line">        (((uint64_t)ntohs(origin_tstamp-&gt;sec_msb)) &lt;&lt; 32);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ptp_data-&gt;seqID_FOLLOWUP == ptp_data-&gt;seqID_SYNC) {</div>
<div class="line"></div>
<div class="line">        created_pkt = <a name="a26"></a><a class="code" href="rte__mbuf_8h.html#ad4d1c289d8cffc831dfb77c64f52447b">rte_pktmbuf_alloc</a>(mbuf_pool);</div>
<div class="line">        pkt_size = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>) +</div>
<div class="line">            sizeof(struct ptp_message);</div>
<div class="line">        created_pkt-&gt;<a name="a27"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> = pkt_size;</div>
<div class="line">        created_pkt-&gt;<a name="a28"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a> = pkt_size;</div>
<div class="line">        eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(created_pkt, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">        <a name="a29"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(ptp_data-&gt;portid, &amp;eth_hdr-&gt;<a name="a30"></a><a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Set multicast address 01-1B-19-00-00-00. */</span></div>
<div class="line">        <a name="a31"></a><a class="code" href="rte__ether_8h.html#a38a0c494f25e8d352ba382a9e3e806b7">ether_addr_copy</a>(&amp;eth_multicast, &amp;eth_hdr-&gt;<a name="a32"></a><a class="code" href="structether__hdr.html#a48d4fb059dd0fcb99a47a890dc1c10f0">d_addr</a>);</div>
<div class="line"></div>
<div class="line">        eth_hdr-&gt;<a name="a33"></a><a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a> = htons(PTP_PROTOCOL);</div>
<div class="line">        ptp_msg = (<span class="keyword">struct </span>ptp_message *)</div>
<div class="line">            (<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(created_pkt, <span class="keywordtype">char</span> *) +</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">        ptp_msg-&gt;delay_req.hdr.seq_id = htons(ptp_data-&gt;seqID_SYNC);</div>
<div class="line">        ptp_msg-&gt;delay_req.hdr.msg_type = DELAY_REQ;</div>
<div class="line">        ptp_msg-&gt;delay_req.hdr.ver = 2;</div>
<div class="line">        ptp_msg-&gt;delay_req.hdr.control = 1;</div>
<div class="line">        ptp_msg-&gt;delay_req.hdr.log_message_interval = 127;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Set up clock id. */</span></div>
<div class="line">        client_clkid =</div>
<div class="line">            &amp;ptp_msg-&gt;delay_req.hdr.source_port_id.clock_id;</div>
<div class="line"></div>
<div class="line">        client_clkid-&gt;id[0] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[0];</div>
<div class="line">        client_clkid-&gt;id[1] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[1];</div>
<div class="line">        client_clkid-&gt;id[2] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[2];</div>
<div class="line">        client_clkid-&gt;id[3] = 0xFF;</div>
<div class="line">        client_clkid-&gt;id[4] = 0xFE;</div>
<div class="line">        client_clkid-&gt;id[5] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[3];</div>
<div class="line">        client_clkid-&gt;id[6] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[4];</div>
<div class="line">        client_clkid-&gt;id[7] = eth_hdr-&gt;<a class="code" href="structether__hdr.html#a10047aa0ea4caae2a392e4d5850deb6f">s_addr</a>.<a class="code" href="structether__addr.html#a17e6cc2bacfdff827dfbe413871ee2bc">addr_bytes</a>[5];</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;ptp_data-&gt;client_clock_id,</div>
<div class="line">               client_clkid,</div>
<div class="line">               <span class="keyword">sizeof</span>(<span class="keyword">struct</span> clock_id));</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Enable flag for hardware timestamping. */</span></div>
<div class="line">        created_pkt-&gt;<a name="a34"></a><a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= <a name="a35"></a><a class="code" href="rte__mbuf_8h.html#abc825dad2d8379b581b597e8ea6c42bc">PKT_TX_IEEE1588_TMST</a>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*Read value from NIC to prevent latching with old value. */</span></div>
<div class="line">        <a name="a36"></a><a class="code" href="rte__ethdev_8h.html#a7c3423257cee4bb471265b5981f9a5df">rte_eth_timesync_read_tx_timestamp</a>(ptp_data-&gt;portid,</div>
<div class="line">                &amp;ptp_data-&gt;tstamp3);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Transmit the packet. */</span></div>
<div class="line">        <a name="a37"></a><a class="code" href="rte__ethdev_8h.html#a8053f1efd106a1d939e77f97566846b0">rte_eth_tx_burst</a>(ptp_data-&gt;portid, 0, &amp;created_pkt, 1);</div>
<div class="line"></div>
<div class="line">        wait_us = 0;</div>
<div class="line">        ptp_data-&gt;tstamp3.tv_nsec = 0;</div>
<div class="line">        ptp_data-&gt;tstamp3.tv_sec = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Wait at least 1 us to read TX timestamp. */</span></div>
<div class="line">        <span class="keywordflow">while</span> ((<a class="code" href="rte__ethdev_8h.html#a7c3423257cee4bb471265b5981f9a5df">rte_eth_timesync_read_tx_timestamp</a>(ptp_data-&gt;portid,</div>
<div class="line">                &amp;ptp_data-&gt;tstamp3) &lt; 0) &amp;&amp; (wait_us &lt; 1000)) {</div>
<div class="line">            <a name="a38"></a><a class="code" href="rte__cycles_8h.html#a62a6204f524c4781cae7e9e4a0b01b7f">rte_delay_us</a>(1);</div>
<div class="line">            wait_us++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update the kernel time with the difference between it and the current NIC</span></div>
<div class="line"><span class="comment"> * time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">update_kernel_time(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    int64_t nsec;</div>
<div class="line">    <span class="keyword">struct </span>timespec net_time, sys_time;</div>
<div class="line"></div>
<div class="line">    clock_gettime(CLOCK_REALTIME, &amp;sys_time);</div>
<div class="line">    <a class="code" href="rte__ethdev_8h.html#aa659027c1751e81800aa7b61e77936c3">rte_eth_timesync_read_time</a>(ptp_data.current_ptp_port, &amp;net_time);</div>
<div class="line"></div>
<div class="line">    nsec = (int64_t)timespec64_to_ns(&amp;net_time) -</div>
<div class="line">           (int64_t)timespec64_to_ns(&amp;sys_time);</div>
<div class="line"></div>
<div class="line">    ptp_data.new_adj = ns_to_timeval(nsec);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * If difference between kernel time and system time in NIC is too big</span></div>
<div class="line"><span class="comment">     * (more than +/- 20 microseconds), use clock_settime to set directly</span></div>
<div class="line"><span class="comment">     * the kernel time, as adjtime is better for small adjustments (takes</span></div>
<div class="line"><span class="comment">     * longer to adjust the time).</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (nsec &gt; KERNEL_TIME_ADJUST_LIMIT || nsec &lt; -KERNEL_TIME_ADJUST_LIMIT)</div>
<div class="line">        clock_settime(CLOCK_REALTIME, &amp;net_time);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        adjtime(&amp;ptp_data.new_adj, 0);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the DELAY_RESP message.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_drsp(<span class="keyword">struct</span> ptpv2_data_slave_ordinary *ptp_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m = ptp_data-&gt;m;</div>
<div class="line">    <span class="keyword">struct </span>ptp_message *ptp_msg;</div>
<div class="line">    <span class="keyword">struct </span>tstamp *rx_tstamp;</div>
<div class="line">    uint16_t seq_id;</div>
<div class="line"></div>
<div class="line">    ptp_msg = (<span class="keyword">struct </span>ptp_message *) (<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">char</span> *) +</div>
<div class="line">                    <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line">    seq_id = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(ptp_msg-&gt;delay_resp.hdr.seq_id);</div>
<div class="line">    <span class="keywordflow">if</span> (memcmp(&amp;ptp_data-&gt;client_clock_id,</div>
<div class="line">           &amp;ptp_msg-&gt;delay_resp.req_port_id.clock_id,</div>
<div class="line">           <span class="keyword">sizeof</span>(<span class="keyword">struct</span> clock_id)) == 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (seq_id == ptp_data-&gt;seqID_FOLLOWUP) {</div>
<div class="line">            rx_tstamp = &amp;ptp_msg-&gt;delay_resp.rx_tstamp;</div>
<div class="line">            ptp_data-&gt;tstamp4.tv_nsec = ntohl(rx_tstamp-&gt;ns);</div>
<div class="line">            ptp_data-&gt;tstamp4.tv_sec =</div>
<div class="line">                ((uint64_t)ntohl(rx_tstamp-&gt;sec_lsb)) |</div>
<div class="line">                (((uint64_t)ntohs(rx_tstamp-&gt;sec_msb)) &lt;&lt; 32);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Evaluate the delta for adjustment. */</span></div>
<div class="line">            ptp_data-&gt;delta = delta_eval(ptp_data);</div>
<div class="line"></div>
<div class="line">            <a name="a39"></a><a class="code" href="rte__ethdev_8h.html#a6c3885b48cf4a21036add9c6c190ec6d">rte_eth_timesync_adjust_time</a>(ptp_data-&gt;portid,</div>
<div class="line">                             ptp_data-&gt;delta);</div>
<div class="line"></div>
<div class="line">            ptp_data-&gt;current_ptp_port = ptp_data-&gt;portid;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Update kernel time if enabled in app parameters. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (ptp_data-&gt;kernel_time_set == 1)</div>
<div class="line">                update_kernel_time();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* This function processes PTP packets, implementing slave PTP IEEE1588 L2</span></div>
<div class="line"><span class="comment"> * functionality.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">parse_ptp_frames(uint8_t portid, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m) {</div>
<div class="line">    <span class="keyword">struct </span>ptp_header *ptp_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a> *eth_hdr;</div>
<div class="line">    uint16_t eth_type;</div>
<div class="line"></div>
<div class="line">    eth_hdr = <a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structether__hdr.html">ether_hdr</a> *);</div>
<div class="line">    eth_type = <a class="code" href="rte__byteorder_8h.html#a8af3e7299c03a0d3a7dea4c1f543b210">rte_be_to_cpu_16</a>(eth_hdr-&gt;<a class="code" href="structether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (eth_type == PTP_PROTOCOL) {</div>
<div class="line">        ptp_data.m = m;</div>
<div class="line">        ptp_data.portid = portid;</div>
<div class="line">        ptp_hdr = (<span class="keyword">struct </span>ptp_header *)(<a class="code" href="rte__mbuf_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keywordtype">char</span> *)</div>
<div class="line">                    + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structether__hdr.html">ether_hdr</a>));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (ptp_hdr-&gt;msg_type) {</div>
<div class="line">        <span class="keywordflow">case</span> SYNC:</div>
<div class="line">            parse_sync(&amp;ptp_data, m-&gt;<a name="a40"></a><a class="code" href="structrte__mbuf.html#a71d997b3a6531130e5fe90db7e71189d">timesync</a>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> FOLLOW_UP:</div>
<div class="line">            parse_fup(&amp;ptp_data);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> DELAY_RESP:</div>
<div class="line">            parse_drsp(&amp;ptp_data);</div>
<div class="line">            print_clock_info(&amp;ptp_data);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The lcore main. This is the main thread that does the work, reading from an</span></div>
<div class="line"><span class="comment"> * input port and writing to an output port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> __attribute__((noreturn)) void</div>
<div class="line">lcore_main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint8_t portid;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_rx;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Check that the port is on the same NUMA node as the polling thread</span></div>
<div class="line"><span class="comment">     * for best performance.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nCore %u Waiting for SYNC packets. [Ctrl+C to quit]\n&quot;</span>,</div>
<div class="line">            <a name="a41"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Run until the application is quit or killed. */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="comment">/* Read packet from RX queues. */</span></div>
<div class="line">        <span class="keywordflow">for</span> (portid = 0; portid &lt; ptp_enabled_port_nb; portid++) {</div>
<div class="line"></div>
<div class="line">            portid = ptp_enabled_ports[portid];</div>
<div class="line">            nb_rx = <a name="a42"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(portid, 0, &amp;m, 1);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (<a name="a43"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(nb_rx == 0))</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a name="a44"></a><a class="code" href="rte__mbuf_8h.html#a4c7ca1953f60e88311695f3036b46dc1">PKT_RX_IEEE1588_PTP</a>)</div>
<div class="line">                parse_ptp_frames(portid, m);</div>
<div class="line"></div>
<div class="line">            <a name="a45"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">print_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK -T VALUE\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot; -T VALUE: 0 - Disable, 1 - Enable Linux Clock&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot; Synchronization (0 default)\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot; -p PORTMASK: hexadecimal bitmask of ports to configure\n&quot;</span>,</div>
<div class="line">        prgname);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ptp_parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse the hexadecimal string. */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_ptp_kernel(<span class="keyword">const</span> <span class="keywordtype">char</span> *param)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Parse the hexadecimal string. */</span></div>
<div class="line">    pm = strtoul(param, &amp;end, 16);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((param[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <span class="keywordflow">if</span> (pm == 0)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Parse the commandline arguments. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">ptp_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">char</span> **argvopt;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option lgopts[] = { {NULL, 0, 0, 0} };</div>
<div class="line"></div>
<div class="line">    argvopt = argv;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argvopt, <span class="stringliteral">&quot;p:T:&quot;</span>,</div>
<div class="line">                  lgopts, &amp;option_index)) != EOF) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Portmask. */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            ptp_enabled_port_mask = ptp_parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (ptp_enabled_port_mask == 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;invalid portmask\n&quot;</span>);</div>
<div class="line">                print_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="comment">/* Time synchronization. */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;T&#39;</span>:</div>
<div class="line">            ret = parse_ptp_kernel(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">                print_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ptp_data.kernel_time_set = ret;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            print_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    argv[optind-1] = prgname;</div>
<div class="line"></div>
<div class="line">    optind = 0; <span class="comment">/* Reset getopt lib. */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The main function, which does initialization and calls the per-lcore</span></div>
<div class="line"><span class="comment"> * functions.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports;</div>
<div class="line"></div>
<div class="line">    uint8_t portid;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize the Environment Abstraction Layer (EAL). */</span></div>
<div class="line">    <span class="keywordtype">int</span> ret = <a name="a46"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a47"></a><a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    memset(&amp;ptp_data, <span class="charliteral">&#39;\0&#39;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ptpv2_data_slave_ordinary));</div>
<div class="line"></div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"></div>
<div class="line">    ret = ptp_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with PTP initialization\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check that there is an even number of ports to send/receive on. */</span></div>
<div class="line">    nb_ports = <a class="code" href="rte__ethdev_8h.html#ac228551f31e57645c7bb5efd1db2e63d">rte_eth_dev_count</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Creates a new mempool in memory to hold the mbufs. */</span></div>
<div class="line">    mbuf_pool = <a name="a48"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;MBUF_POOL&quot;</span>, NUM_MBUFS * nb_ports,</div>
<div class="line">        MBUF_CACHE_SIZE, 0, RTE_MBUF_DEFAULT_BUF_SIZE, <a name="a49"></a><a class="code" href="rte__lcore_8h.html#a2319a4f10ebccbea11e4c2f88e0da54c">rte_socket_id</a>());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize all ports. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; nb_ports; portid++) {</div>
<div class="line">        <span class="keywordflow">if</span> ((ptp_enabled_port_mask &amp; (1 &lt;&lt; portid)) != 0) {</div>
<div class="line">            <span class="keywordflow">if</span> (port_init(portid, mbuf_pool) == 0) {</div>
<div class="line">                ptp_enabled_ports[ptp_enabled_port_nb] = portid;</div>
<div class="line">                ptp_enabled_port_nb++;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                     <span class="stringliteral">&quot;Cannot init port %&quot;</span>PRIu8 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                     portid);</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            printf(<span class="stringliteral">&quot;Skipping disabled port %u\n&quot;</span>, portid);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ptp_enabled_port_nb == 0) {</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae2e5522e2b4921a751675e4a4d167fb4">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;All available ports are disabled.&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; Please set portmask.\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a50"></a><a class="code" href="rte__lcore_8h.html#af19d0d832c209c0c1962ea3e3f714861">rte_lcore_count</a>() &gt; 1)</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nWARNING: Too many lcores enabled. Only 1 used.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Call lcore_main on the master core only. */</span></div>
<div class="line">    lcore_main();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
