<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: multi_process/client_server_mp/mp_server/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">multi_process/client_server_mp/mp_server/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/ip.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memzone_8h.html">rte_memzone.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__fbk__hash_8h.html">rte_fbk_hash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;common.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;args.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;init.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * When doing reads from the NIC or the client queues,</span></div>
<div class="line"><span class="comment"> * use this batch size</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define PACKET_READ_SIZE 32</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Local buffers to put packets in, used to send packets in bursts to the</span></div>
<div class="line"><span class="comment"> * clients</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>client_rx_buf {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buffer[PACKET_READ_SIZE];</div>
<div class="line">    uint16_t count;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">/* One buffer per client rx queue - dynamically allocate array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>client_rx_buf *cl_rx_buf;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">get_printable_mac_addr(uint8_t <a name="_a1"></a><a class="code" href="structport.html">port</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> err_address[] = <span class="stringliteral">&quot;00:00:00:00:00:00&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> addresses[RTE_MAX_ETHPORTS][<span class="keyword">sizeof</span>(err_address)];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a2"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(port &gt;= RTE_MAX_ETHPORTS))</div>
<div class="line">        <span class="keywordflow">return</span> err_address;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addresses[port][0]==<span class="charliteral">&#39;\0&#39;</span>)){</div>
<div class="line">        <span class="keyword">struct </span><a name="_a3"></a><a class="code" href="structether__addr.html">ether_addr</a> mac;</div>
<div class="line">        <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#a5686df2817980236f2c4f1cc72dd2c30">rte_eth_macaddr_get</a>(port, &amp;mac);</div>
<div class="line">        snprintf(addresses[port], <span class="keyword">sizeof</span>(addresses[port]),</div>
<div class="line">                <span class="stringliteral">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</div>
<div class="line">                mac.addr_bytes[0], mac.addr_bytes[1], mac.addr_bytes[2],</div>
<div class="line">                mac.addr_bytes[3], mac.addr_bytes[4], mac.addr_bytes[5]);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> addresses[port];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function displays the recorded statistics for each port</span></div>
<div class="line"><span class="comment"> * and for each client. It uses ANSI terminal codes to clear</span></div>
<div class="line"><span class="comment"> * screen when called. It is called from a single non-master</span></div>
<div class="line"><span class="comment"> * thread in the server process, when the process is run with more</span></div>
<div class="line"><span class="comment"> * than one lcore enabled.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_stats_display(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, j;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> topLeft[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>,<span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    uint64_t port_tx[RTE_MAX_ETHPORTS], port_tx_drop[RTE_MAX_ETHPORTS];</div>
<div class="line">    uint64_t client_tx[MAX_CLIENTS], client_tx_drop[MAX_CLIENTS];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* to get TX stats, we need to do some summing calculations */</span></div>
<div class="line">    memset(port_tx, 0, <span class="keyword">sizeof</span>(port_tx));</div>
<div class="line">    memset(port_tx_drop, 0, <span class="keyword">sizeof</span>(port_tx_drop));</div>
<div class="line">    memset(client_tx, 0, <span class="keyword">sizeof</span>(client_tx));</div>
<div class="line">    memset(client_tx_drop, 0, <span class="keyword">sizeof</span>(client_tx_drop));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_clients; i++){</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">volatile</span> <span class="keyword">struct </span>tx_stats *tx = &amp;ports-&gt;tx_stats[i];</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; ports-&gt;num_ports; j++){</div>
<div class="line">            <span class="comment">/* assign to local variables here, save re-reading volatile vars */</span></div>
<div class="line">            <span class="keyword">const</span> uint64_t tx_val = tx-&gt;tx[ports-&gt;id[j]];</div>
<div class="line">            <span class="keyword">const</span> uint64_t drop_val = tx-&gt;tx_drop[ports-&gt;id[j]];</div>
<div class="line">            port_tx[j] += tx_val;</div>
<div class="line">            port_tx_drop[j] += drop_val;</div>
<div class="line">            client_tx[i] += tx_val;</div>
<div class="line">            client_tx_drop[i] += drop_val;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%s%s&quot;</span>, clr, topLeft);</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;PORTS\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;-----\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; ports-&gt;num_ports; i++)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Port %u: &#39;%s&#39;\t&quot;</span>, (<span class="keywordtype">unsigned</span>)ports-&gt;id[i],</div>
<div class="line">                get_printable_mac_addr(ports-&gt;id[i]));</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; ports-&gt;num_ports; i++){</div>
<div class="line">        printf(<span class="stringliteral">&quot;Port %u - rx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\t&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;tx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">unsigned</span>)ports-&gt;id[i], ports-&gt;rx_stats.rx[i],</div>
<div class="line">                port_tx[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\nCLIENTS\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;-------\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_clients; i++){</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rx = clients[i].stats.rx;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rx_drop = clients[i].stats.rx_drop;</div>
<div class="line">        printf(<span class="stringliteral">&quot;Client %2u - rx: %9llu, rx_drop: %9llu\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;            tx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;, tx_drop: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                i, rx, rx_drop, client_tx[i], client_tx_drop[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The function called from each non-master lcore used by the process.</span></div>
<div class="line"><span class="comment"> * The test_and_set function is used to randomly pick a single lcore on which</span></div>
<div class="line"><span class="comment"> * the code to display the statistics will run. Otherwise, the code just</span></div>
<div class="line"><span class="comment"> * repeatedly sleeps.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">sleep_lcore(__attribute__((unused)) <span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Used to pick a display thread - static, so zero-initialised */</span></div>
<div class="line">    <span class="keyword">static</span> <a name="_a5"></a><a class="code" href="structrte__atomic32__t.html">rte_atomic32_t</a> display_stats;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Only one core should display stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="rte__atomic_8h.html#a82ef4eba412a27299860ac88d273a60b">rte_atomic32_test_and_set</a>(&amp;display_stats)) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> sleeptime = 1;</div>
<div class="line">        printf(<span class="stringliteral">&quot;Core %u displaying statistics\n&quot;</span>, <a name="a7"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Longer initial pause so above printf is seen */</span></div>
<div class="line">        sleep(sleeptime * 3);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Loop forever: sleep always returns 0 or &lt;= param */</span></div>
<div class="line">        <span class="keywordflow">while</span> (sleep(sleeptime) &lt;= sleeptime)</div>
<div class="line">            do_stats_display();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function to set all the client statistic values to zero.</span></div>
<div class="line"><span class="comment"> * Called at program startup.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">clear_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_clients; i++)</div>
<div class="line">        clients[i].stats.rx = clients[i].stats.rx_drop = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * send a burst of traffic to a client, assuming there are packets</span></div>
<div class="line"><span class="comment"> * available to be sent to this client</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">flush_rx_queue(uint16_t client)</div>
<div class="line">{</div>
<div class="line">    uint16_t j;</div>
<div class="line">    <span class="keyword">struct </span>client *cl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (cl_rx_buf[client].count == 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    cl = &amp;clients[client];</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a8"></a><a class="code" href="rte__ring_8h.html#a9c5b9e5f047ff9f55c7b7b12203f3dd7">rte_ring_enqueue_bulk</a>(cl-&gt;rx_q, (<span class="keywordtype">void</span> **)cl_rx_buf[client].buffer,</div>
<div class="line">            cl_rx_buf[client].count) != 0){</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; cl_rx_buf[client].count; j++)</div>
<div class="line">            <a name="a9"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(cl_rx_buf[client].buffer[j]);</div>
<div class="line">        cl-&gt;stats.rx_drop += cl_rx_buf[client].count;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        cl-&gt;stats.rx += cl_rx_buf[client].count;</div>
<div class="line"></div>
<div class="line">    cl_rx_buf[client].count = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * marks a packet down to be sent to a particular client process</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">enqueue_rx_packet(uint8_t client, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf)</div>
<div class="line">{</div>
<div class="line">    cl_rx_buf[client].buffer[cl_rx_buf[client].count++] = buf;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function takes a group of packets and routes them</span></div>
<div class="line"><span class="comment"> * individually to the client process. Very simply round-robins the packets</span></div>
<div class="line"><span class="comment"> * without checking any of the packet contents.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">process_packets(uint32_t port_num <a name="a10"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a>,</div>
<div class="line">        <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts[], uint16_t rx_count)</div>
<div class="line">{</div>
<div class="line">    uint16_t i;</div>
<div class="line">    uint8_t client = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++) {</div>
<div class="line">        enqueue_rx_packet(client, pkts[i]);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (++client == num_clients)</div>
<div class="line">            client = 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_clients; i++)</div>
<div class="line">        flush_rx_queue(i);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function called by the master lcore of the DPDK process.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_packet_forwarding(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> port_num = 0; <span class="comment">/* indexes the port[] array */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf[PACKET_READ_SIZE];</div>
<div class="line">        uint16_t rx_count;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* read a port */</span></div>
<div class="line">        rx_count = <a name="a11"></a><a class="code" href="rte__ethdev_8h.html#aee7daffe261e67355a78b106627c4c45">rte_eth_rx_burst</a>(ports-&gt;id[port_num], 0, \</div>
<div class="line">                buf, PACKET_READ_SIZE);</div>
<div class="line">        ports-&gt;rx_stats.rx[port_num] += rx_count;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Now process the NIC packets read */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a12"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count &gt; 0))</div>
<div class="line">            process_packets(port_num, buf, rx_count);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* move to next port */</span></div>
<div class="line">        <span class="keywordflow">if</span> (++port_num == ports-&gt;num_ports)</div>
<div class="line">            port_num = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* initialise the system */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init(argc, argv) &lt; 0 )</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <a name="a13"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Finished Process Init.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    cl_rx_buf = calloc(num_clients, <span class="keyword">sizeof</span>(cl_rx_buf[0]));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* clear statistics */</span></div>
<div class="line">    clear_stats();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* put all other cores to sleep bar master */</span></div>
<div class="line">    <a name="a14"></a><a class="code" href="rte__launch_8h.html#a2f78fc845135fe22c1ba1c870954b60a">rte_eal_mp_remote_launch</a>(sleep_lcore, NULL, <a name="a15"></a><a class="code" href="rte__launch_8h.html#a83b0efa9e30a74217e7a95956845e2adace253c3a0d90f0e324943d18631a1ef4">SKIP_MASTER</a>);</div>
<div class="line"></div>
<div class="line">    do_packet_forwarding();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
