<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>DPDK: vhost_xen/xenstore_parse.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">16.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">vhost_xen/xenstore_parse.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*-</span></div>
<div class="line"><span class="comment"> *   BSD LICENSE</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Copyright(c) 2010-2014 Intel Corporation. All rights reserved.</span></div>
<div class="line"><span class="comment"> *   All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div>
<div class="line"><span class="comment"> *   are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in</span></div>
<div class="line"><span class="comment"> *       the documentation and/or other materials provided with the</span></div>
<div class="line"><span class="comment"> *       distribution.</span></div>
<div class="line"><span class="comment"> *     * Neither the name of Intel Corporation nor the names of its</span></div>
<div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div>
<div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div>
<div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div>
<div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div>
<div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div>
<div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div>
<div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div>
<div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div>
<div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div>
<div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;xen/sys/gntalloc.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;xen/sys/gntdev.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;xen/xen-compat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#if __XEN_LATEST_INTERFACE_VERSION__ &lt; 0x00040200</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;xs.h&gt;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &lt;xenstore.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;xen_vhost.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* xenstore handle */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>xs_handle *xs = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* gntdev file descriptor to map grant pages */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> d_fd = -1;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  The grant node format in xenstore for vring/mpool is like:</span></div>
<div class="line"><span class="comment"> *  idx#_rx_vring_gref = &quot;gref1#, gref2#, gref3#&quot;</span></div>
<div class="line"><span class="comment"> *  idx#_mempool_gref  = &quot;gref1#, gref2#, gref3#&quot;</span></div>
<div class="line"><span class="comment"> *  each gref# is the grant reference for a shared page.</span></div>
<div class="line"><span class="comment"> *  In each shared page, we store the grant_node_item items.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>grant_node_item {</div>
<div class="line">    uint32_t gref;</div>
<div class="line">    uint32_t pfn;</div>
<div class="line">} __attribute__((packed));</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> cmdline_parse_etheraddr(<span class="keywordtype">void</span> *tk, <span class="keyword">const</span> <span class="keywordtype">char</span> *srcbuf,</div>
<div class="line">    <span class="keywordtype">void</span> *res, <span class="keywordtype">unsigned</span> ressize);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Map grant ref refid at addr_ori*/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">xen_grant_mmap(<span class="keywordtype">void</span> *addr_ori, <span class="keywordtype">int</span> domid, <span class="keywordtype">int</span> refid, uint64_t *pindex)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>ioctl_gntdev_map_grant_ref arg;</div>
<div class="line">    <span class="keywordtype">void</span> *addr = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz = getpagesize();</div>
<div class="line"></div>
<div class="line">    arg.count = 1;</div>
<div class="line">    arg.refs[0].domid = domid;</div>
<div class="line">    arg.refs[0].ref = refid;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> rv = ioctl(d_fd, IOCTL_GNTDEV_MAP_GRANT_REF, &amp;arg);</div>
<div class="line">    <span class="keywordflow">if</span> (rv) {</div>
<div class="line">        <a name="a0"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: (%d,%d) %s (ioctl failed)\n&quot;</span>, __func__,</div>
<div class="line">                domid, refid, strerror(errno));</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (addr_ori == NULL)</div>
<div class="line">        addr = mmap(addr_ori, pg_sz, PROT_READ|PROT_WRITE, MAP_SHARED,</div>
<div class="line">                d_fd, arg.index);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        addr = mmap(addr_ori, pg_sz, PROT_READ|PROT_WRITE, MAP_SHARED | MAP_FIXED,</div>
<div class="line">                d_fd, arg.index);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (addr == MAP_FAILED) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: (%d, %d) %s (map failed)\n&quot;</span>, __func__,</div>
<div class="line">                domid, refid, strerror(errno));</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pindex)</div>
<div class="line">        *pindex = arg.index;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> addr;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Unmap one grant ref, and munmap must be called before this */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_unmap_grant_ref(uint64_t index)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>ioctl_gntdev_unmap_grant_ref arg;</div>
<div class="line">    <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">    arg.count = 1;</div>
<div class="line">    arg.index = index;</div>
<div class="line">    rv = ioctl(d_fd, IOCTL_GNTDEV_UNMAP_GRANT_REF, &amp;arg);</div>
<div class="line">    <span class="keywordflow">if</span> (rv) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: index 0x%&quot;</span> PRIx64 <span class="stringliteral">&quot;unmap failed\n&quot;</span>, __func__, index);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Reserve a virtual address space.</span></div>
<div class="line"><span class="comment"> * On success, returns the pointer. On failure, returns NULL.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">get_xen_virtual(<span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> page_sz)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *addr;</div>
<div class="line">    uintptr_t aligned_addr;</div>
<div class="line"></div>
<div class="line">    addr = mmap(NULL, size + page_sz, PROT_READ, MAP_SHARED | MAP_ANONYMOUS, -1, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (addr == MAP_FAILED) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;failed get a virtual area\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    aligned_addr = <a name="a1"></a><a class="code" href="rte__common_8h.html#a856650153655096752b4c2a29690a15d">RTE_ALIGN_CEIL</a>((uintptr_t)addr, page_sz);</div>
<div class="line">    munmap(addr, aligned_addr - (uintptr_t)addr);</div>
<div class="line">    munmap((<span class="keywordtype">void</span> *)(aligned_addr + size), page_sz + (uintptr_t)addr - aligned_addr);</div>
<div class="line">    addr = (<span class="keywordtype">void</span> *)(aligned_addr);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> addr;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">free_xen_virtual(<span class="keywordtype">void</span> *addr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> page_sz <a name="a2"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (addr)</div>
<div class="line">        munmap(addr, size);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Returns val str in xenstore.</span></div>
<div class="line"><span class="comment"> * @param path</span></div>
<div class="line"><span class="comment"> *  Full path string for key</span></div>
<div class="line"><span class="comment"> * @return</span></div>
<div class="line"><span class="comment"> *  Pointer to Val str, NULL on failure</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *</div>
<div class="line">xen_read_node(<span class="keywordtype">char</span> *path, uint32_t *len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line"></div>
<div class="line">    buf = xs_read(xs, XBT_NULL, path, len);</div>
<div class="line">    <span class="keywordflow">return</span> buf;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cal_pagenum(<span class="keyword">struct</span> xen_gnt *gnt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * the items in the page are in the format of</span></div>
<div class="line"><span class="comment">     * gref#,pfn#,...,gref#,pfn#</span></div>
<div class="line"><span class="comment">     * FIXME, 0 is reserved by system, use it as terminator.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; (PAGE_PFNNUM) / 2; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (gnt-&gt;gref_pfn[i * 2].gref &lt;= 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> i;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Frees memory allocated to a grant node */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">xen_free_gntnode(<span class="keyword">struct</span> xen_gntnode *gntnode)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (gntnode == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    free(gntnode-&gt;gnt_info);</div>
<div class="line">    free(gntnode);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse a grant node.</span></div>
<div class="line"><span class="comment"> * @param domid</span></div>
<div class="line"><span class="comment"> *  Guest domain id.</span></div>
<div class="line"><span class="comment"> * @param path</span></div>
<div class="line"><span class="comment"> *  Full path string for a grant node, like for the following (key, val) pair</span></div>
<div class="line"><span class="comment"> *  idx#_mempool_gref = &quot;gref#, gref#, gref#&quot;</span></div>
<div class="line"><span class="comment"> *  path = &#39;local/domain/domid/control/dpdk/idx#_mempool_gref&#39;</span></div>
<div class="line"><span class="comment"> *  gref# is a shared page contain packed (gref,pfn) entries</span></div>
<div class="line"><span class="comment"> * @return</span></div>
<div class="line"><span class="comment"> *  Returns the pointer to xen_gntnode</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>xen_gntnode *</div>
<div class="line">parse_gntnode(<span class="keywordtype">int</span> dom_id, <span class="keywordtype">char</span> *path)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> **gref_list = NULL;</div>
<div class="line">    uint32_t i, len, gref_num;</div>
<div class="line">    <span class="keywordtype">void</span> *addr = NULL;</div>
<div class="line">    <span class="keywordtype">char</span> *buf = NULL;</div>
<div class="line">    <span class="keyword">struct </span>xen_gntnode *gntnode = NULL;</div>
<div class="line">    <span class="keyword">struct </span>xen_gnt *gnt = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz = getpagesize();</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    uint64_t index;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((buf = xen_read_node(path, &amp;len)) == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    gref_list = malloc(MAX_GREF_PER_NODE * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));</div>
<div class="line">    <span class="keywordflow">if</span> (gref_list == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    gref_num = <a name="a3"></a><a class="code" href="rte__string__fns_8h.html#af3ffc4e2ca821bc44f7fd08afbfe3638">rte_strsplit</a>(buf, len, gref_list, MAX_GREF_PER_NODE,</div>
<div class="line">            XEN_GREF_SPLITTOKEN);</div>
<div class="line">    <span class="keywordflow">if</span> (gref_num == 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: invalid grant node format\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    gntnode = calloc(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> xen_gntnode));</div>
<div class="line">    gnt = calloc(gref_num, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> xen_gnt));</div>
<div class="line">    <span class="keywordflow">if</span> (gnt == NULL || gntnode == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; gref_num; i++) {</div>
<div class="line">        errno = 0;</div>
<div class="line">        gnt[i].gref = strtol(gref_list[i], &amp;end, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (errno != 0 || end == NULL || end == gref_list[i] ||</div>
<div class="line">            (*end != <span class="charliteral">&#39;\0&#39;</span> &amp;&amp;  *end != XEN_GREF_SPLITTOKEN)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: parse grant node item failed\n&quot;</span>, __func__);</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line">        addr = xen_grant_mmap(NULL, dom_id, gnt[i].gref, &amp;index);</div>
<div class="line">        <span class="keywordflow">if</span> (addr == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: map gref %u failed\n&quot;</span>, __func__, gnt[i].gref);</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;      %s: map gref %u to %p\n&quot;</span>, __func__, gnt[i].gref, addr);</div>
<div class="line">        memcpy(gnt[i].gref_pfn, addr, pg_sz);</div>
<div class="line">        <span class="keywordflow">if</span> (munmap(addr, pg_sz)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap gref %u failed\n&quot;</span>, __func__, gnt[i].gref);</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (xen_unmap_grant_ref(index)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: release gref %u failed\n&quot;</span>, __func__, gnt[i].gref);</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    gntnode-&gt;gnt_num  = gref_num;</div>
<div class="line">    gntnode-&gt;gnt_info = gnt;</div>
<div class="line"></div>
<div class="line">    free(buf);</div>
<div class="line">    free(gref_list);</div>
<div class="line">    <span class="keywordflow">return</span> gntnode;</div>
<div class="line"></div>
<div class="line">err:</div>
<div class="line">    free(gnt);</div>
<div class="line">    free(gntnode);</div>
<div class="line">    free(gref_list);</div>
<div class="line">    free(buf);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function maps grant node of vring or mbuf pool to a continous virtual address space,</span></div>
<div class="line"><span class="comment"> * and returns mapped address, pfn array, index array</span></div>
<div class="line"><span class="comment"> * @param gntnode</span></div>
<div class="line"><span class="comment"> *  Pointer to grant node</span></div>
<div class="line"><span class="comment"> * @param domid</span></div>
<div class="line"><span class="comment"> *  Guest domain id</span></div>
<div class="line"><span class="comment"> * @param ppfn</span></div>
<div class="line"><span class="comment"> *  Pointer to pfn array, caller should free this array</span></div>
<div class="line"><span class="comment"> * @param pgs</span></div>
<div class="line"><span class="comment"> *  Pointer to number of pages</span></div>
<div class="line"><span class="comment"> * @param ppindex</span></div>
<div class="line"><span class="comment"> *  Pointer to index array, used to release grefs when to free this node</span></div>
<div class="line"><span class="comment"> * @return</span></div>
<div class="line"><span class="comment"> *  Pointer to mapped virtual address, NULL on failure</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">map_gntnode(<span class="keyword">struct</span> xen_gntnode *gntnode, <span class="keywordtype">int</span> domid, uint32_t **ppfn, uint32_t *pgs, uint64_t **ppindex)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>xen_gnt *gnt;</div>
<div class="line">    uint32_t i, j;</div>
<div class="line">    <span class="keywordtype">size_t</span> total_pages = 0;</div>
<div class="line">    <span class="keywordtype">void</span> *addr;</div>
<div class="line">    uint32_t *pfn;</div>
<div class="line">    uint64_t *pindex;</div>
<div class="line">    uint32_t pfn_num = 0;</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (gntnode == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    pg_sz = getpagesize();</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; gntnode-&gt;gnt_num; i++) {</div>
<div class="line">        gnt = gntnode-&gt;gnt_info + i;</div>
<div class="line">        total_pages += cal_pagenum(gnt);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((addr = get_xen_virtual(total_pages * pg_sz, pg_sz)) == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, XENHOST, <span class="stringliteral">&quot;  %s: failed get_xen_virtual\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    pfn = calloc(total_pages, (<span class="keywordtype">size_t</span>)<span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line">    pindex = calloc(total_pages, (<span class="keywordtype">size_t</span>)<span class="keyword">sizeof</span>(uint64_t));</div>
<div class="line">    <span class="keywordflow">if</span> (pfn == NULL || pindex == NULL) {</div>
<div class="line">        free_xen_virtual(addr, total_pages * pg_sz, pg_sz);</div>
<div class="line">        free(pfn);</div>
<div class="line">        free(pindex);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;    %s: total pages:%zu, map to [%p, %p]\n&quot;</span>, __func__, total_pages, addr, <a name="a4"></a><a class="code" href="rte__common_8h.html#a96c6294ef6a307980f78899fe8a5813e">RTE_PTR_ADD</a>(addr, total_pages * pg_sz - 1));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; gntnode-&gt;gnt_num; i++) {</div>
<div class="line">        gnt = gntnode-&gt;gnt_info + i;</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; (PAGE_PFNNUM) / 2; j++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((gnt-&gt;gref_pfn[j * 2].gref) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">goto</span> _end;</div>
<div class="line">            <span class="comment">/*alternative: batch map, or through libxc*/</span></div>
<div class="line">            <span class="keywordflow">if</span> (xen_grant_mmap(<a class="code" href="rte__common_8h.html#a96c6294ef6a307980f78899fe8a5813e">RTE_PTR_ADD</a>(addr, pfn_num * pg_sz),</div>
<div class="line">                    domid,</div>
<div class="line">                    gnt-&gt;gref_pfn[j * 2].gref,</div>
<div class="line">                    &amp;pindex[pfn_num]) == NULL) {</div>
<div class="line">                <span class="keywordflow">goto</span> mmap_failed;</div>
<div class="line">            }</div>
<div class="line">            pfn[pfn_num] = gnt-&gt;gref_pfn[j * 2 + 1].pfn_num;</div>
<div class="line">            pfn_num++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">mmap_failed:</div>
<div class="line">    <span class="keywordflow">if</span> (pfn_num)</div>
<div class="line">        munmap(addr, pfn_num * pg_sz);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; pfn_num; i++) {</div>
<div class="line">        xen_unmap_grant_ref(pindex[i]);</div>
<div class="line">    }</div>
<div class="line">    free(pindex);</div>
<div class="line">    free(pfn);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">_end:</div>
<div class="line">    <span class="keywordflow">if</span> (ppindex)</div>
<div class="line">        *ppindex = pindex;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        free(pindex);</div>
<div class="line">    <span class="keywordflow">if</span> (ppfn)</div>
<div class="line">        *ppfn = pfn;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        free(pfn);</div>
<div class="line">    <span class="keywordflow">if</span> (pgs)</div>
<div class="line">        *pgs = total_pages;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> addr;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_mpool_va(<span class="keyword">struct</span> xen_mempool *mempool)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX] = {0};</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line">    uint32_t len;</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    <span class="keywordtype">int</span> ret = -1;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line">    snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">        XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_GVA_SUFFIX,</div>
<div class="line">        mempool-&gt;dom_id, mempool-&gt;pool_idx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>((buf = xen_read_node(path, &amp;len)) == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> out;</div>
<div class="line">    mempool-&gt;gva = (<span class="keywordtype">void</span> *)strtoul(buf, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> (errno != 0 || end == NULL || end == buf || *end != <span class="charliteral">&#39;\0&#39;</span>) {</div>
<div class="line">        mempool-&gt;gva = NULL;</div>
<div class="line">        <span class="keywordflow">goto</span> out;</div>
<div class="line">    }</div>
<div class="line">    ret = 0;</div>
<div class="line">out:</div>
<div class="line">    free(buf);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * map mbuf pool</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">map_mempoolnode(<span class="keyword">struct</span> xen_gntnode *gntnode,</div>
<div class="line">            <span class="keyword">struct</span> xen_mempool *mempool)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (gntnode == NULL || mempool == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    mempool-&gt;hva =</div>
<div class="line">        map_gntnode(gntnode, mempool-&gt;dom_id, &amp;mempool-&gt;mempfn_tbl, &amp;mempool-&gt;mempfn_num, &amp;mempool-&gt;pindex);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: map mempool at %p\n&quot;</span>, __func__, (<span class="keywordtype">void</span> *)mempool-&gt;hva);</div>
<div class="line">    <span class="keywordflow">if</span> (mempool-&gt;hva)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">cleanup_mempool(<span class="keyword">struct</span> xen_mempool *mempool)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz = getpagesize();</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (mempool-&gt;hva)</div>
<div class="line">        munmap(mempool-&gt;hva, mempool-&gt;mempfn_num * pg_sz);</div>
<div class="line">    mempool-&gt;hva = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (mempool-&gt;pindex) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap dom %02u mempool%02u %u grefs\n&quot;</span>,</div>
<div class="line">            __func__,</div>
<div class="line">            mempool-&gt;dom_id,</div>
<div class="line">            mempool-&gt;pool_idx,</div>
<div class="line">            mempool-&gt;mempfn_num);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; mempool-&gt;mempfn_num; i ++) {</div>
<div class="line">            xen_unmap_grant_ref(mempool-&gt;pindex[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    mempool-&gt;pindex = NULL;</div>
<div class="line"></div>
<div class="line">    free(mempool-&gt;mempfn_tbl);</div>
<div class="line">    mempool-&gt;mempfn_tbl = NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * process mempool node idx#_mempool_gref, idx = 0, 1, 2...</span></div>
<div class="line"><span class="comment"> * untill we encounter a node that doesn&#39;t exist.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_mempoolnode(<span class="keyword">struct</span> xen_guest *guest)</div>
<div class="line">{</div>
<div class="line">    uint32_t i, len;</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX] = {0};</div>
<div class="line">    <span class="keyword">struct </span>xen_gntnode *gntnode = NULL;</div>
<div class="line">    <span class="keyword">struct </span>xen_mempool *mempool = NULL;</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line"></div>
<div class="line">    bzero(&amp;guest-&gt;mempool, MAX_XENVIRT_MEMPOOL * <span class="keyword">sizeof</span>(guest-&gt;mempool[0]));</div>
<div class="line">    guest-&gt;pool_num = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="comment">/* check if null terminated */</span></div>
<div class="line">        snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">            XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_MEMPOOL_SUFFIX,</div>
<div class="line">            guest-&gt;dom_id,</div>
<div class="line">            guest-&gt;pool_num);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ((buf = xen_read_node(path, &amp;len)) != NULL) {</div>
<div class="line">            <span class="comment">/* this node exists */</span></div>
<div class="line">            free(buf);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (guest-&gt;pool_num == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, PMD, <span class="stringliteral">&quot;no mempool found\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        mempool = &amp;guest-&gt;mempool[guest-&gt;pool_num];</div>
<div class="line">        mempool-&gt;dom_id = guest-&gt;dom_id;</div>
<div class="line">        mempool-&gt;pool_idx = guest-&gt;pool_num;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: mempool %u parse gntnode %s\n&quot;</span>, __func__, guest-&gt;pool_num, path);</div>
<div class="line">        gntnode = parse_gntnode(guest-&gt;dom_id, path);</div>
<div class="line">        <span class="keywordflow">if</span> (gntnode == NULL)</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (parse_mpool_va(mempool))</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: mempool %u map gntnode %s\n&quot;</span>, __func__, guest-&gt;pool_num, path);</div>
<div class="line">        <span class="keywordflow">if</span> (map_mempoolnode(gntnode, mempool))</div>
<div class="line">            <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">        xen_free_gntnode(gntnode);</div>
<div class="line">        guest-&gt;pool_num++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">err:</div>
<div class="line">    <span class="keywordflow">if</span> (gntnode)</div>
<div class="line">        xen_free_gntnode(gntnode);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt;  MAX_XENVIRT_MEMPOOL ; i++) {</div>
<div class="line">        cleanup_mempool(&amp;guest-&gt;mempool[i]);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* reinitialise mempool */</span></div>
<div class="line">    bzero(&amp;guest-&gt;mempool, MAX_XENVIRT_MEMPOOL * <span class="keyword">sizeof</span>(guest-&gt;mempool[0]));</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_map_vringflag(<span class="keyword">struct</span> xen_vring *vring)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX] = {0};</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line">    uint32_t len,gref;</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz = getpagesize();</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line"></div>
<div class="line">    snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">        XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_VRINGFLAG_SUFFIX,</div>
<div class="line">        vring-&gt;dom_id, vring-&gt;virtio_idx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>((buf = xen_read_node(path, &amp;len)) == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    errno = 0;</div>
<div class="line">    gref = strtol(buf, &amp;end, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (errno != 0 || end == NULL || end == buf) {</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;flag = xen_grant_mmap(0, vring-&gt;dom_id, gref, &amp;vring-&gt;flag_index);</div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;flag == NULL || *vring-&gt;flag == 0)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    free(buf);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">err:</div>
<div class="line">    free(buf);</div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;flag) {</div>
<div class="line">        munmap(vring-&gt;flag, pg_sz);</div>
<div class="line">        vring-&gt;flag = NULL;</div>
<div class="line">        xen_unmap_grant_ref(vring-&gt;flag_index);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_map_rxvringnode(<span class="keyword">struct</span> xen_gntnode *gntnode,</div>
<div class="line">                <span class="keyword">struct</span> xen_vring *vring)</div>
<div class="line">{</div>
<div class="line">    vring-&gt;rxvring_addr =</div>
<div class="line">        map_gntnode(gntnode, vring-&gt;dom_id, &amp;vring-&gt;rxpfn_tbl, &amp;vring-&gt;rxpfn_num, &amp;vring-&gt;rx_pindex);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: map rx vring at %p\n&quot;</span>, __func__, (<span class="keywordtype">void</span> *)vring-&gt;rxvring_addr);</div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;rxvring_addr)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_map_txvringnode(<span class="keyword">struct</span> xen_gntnode *gntnode,</div>
<div class="line">                <span class="keyword">struct</span> xen_vring *vring)</div>
<div class="line">{</div>
<div class="line">    vring-&gt;txvring_addr =</div>
<div class="line">        map_gntnode(gntnode, vring-&gt;dom_id, &amp;vring-&gt;txpfn_tbl, &amp;vring-&gt;txpfn_num, &amp;vring-&gt;tx_pindex);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: map tx vring at %p\n&quot;</span>, __func__, (<span class="keywordtype">void</span> *)vring-&gt;txvring_addr);</div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;txvring_addr)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">cleanup_vring(<span class="keyword">struct</span> xen_vring *vring)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> pg_sz = getpagesize();</div>
<div class="line">    uint32_t i;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: cleanup dom %u vring %u\n&quot;</span>, __func__, vring-&gt;dom_id, vring-&gt;virtio_idx);</div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;rxvring_addr) {</div>
<div class="line">        munmap(vring-&gt;rxvring_addr, vring-&gt;rxpfn_num * pg_sz);</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap rx vring [%p, %p]\n&quot;</span>,</div>
<div class="line">            __func__,</div>
<div class="line">            vring-&gt;rxvring_addr,</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a96c6294ef6a307980f78899fe8a5813e">RTE_PTR_ADD</a>(vring-&gt;rxvring_addr,</div>
<div class="line">            vring-&gt;rxpfn_num * pg_sz - 1));</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;rxvring_addr = NULL;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;rx_pindex) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap rx vring %u grefs\n&quot;</span>, __func__, vring-&gt;rxpfn_num);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; vring-&gt;rxpfn_num; i++) {</div>
<div class="line">            xen_unmap_grant_ref(vring-&gt;rx_pindex[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;rx_pindex = NULL;</div>
<div class="line"></div>
<div class="line">    free(vring-&gt;rxpfn_tbl);</div>
<div class="line">    vring-&gt;rxpfn_tbl = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;txvring_addr) {</div>
<div class="line">        munmap(vring-&gt;txvring_addr, vring-&gt;txpfn_num * pg_sz);</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap tx vring [%p, %p]\n&quot;</span>,</div>
<div class="line">            __func__,</div>
<div class="line">            vring-&gt;txvring_addr,</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a96c6294ef6a307980f78899fe8a5813e">RTE_PTR_ADD</a>(vring-&gt;txvring_addr,</div>
<div class="line">            vring-&gt;txpfn_num * pg_sz - 1));</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;txvring_addr = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;tx_pindex) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap tx vring %u grefs\n&quot;</span>, __func__, vring-&gt;txpfn_num);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; vring-&gt;txpfn_num; i++) {</div>
<div class="line">            xen_unmap_grant_ref(vring-&gt;tx_pindex[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;tx_pindex = NULL;</div>
<div class="line"></div>
<div class="line">    free(vring-&gt;txpfn_tbl);</div>
<div class="line">    vring-&gt;txpfn_tbl = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (vring-&gt;flag) {</div>
<div class="line">        <span class="keywordflow">if</span> (!munmap((<span class="keywordtype">void</span> *)vring-&gt;flag, pg_sz))</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: unmap flag page at %p\n&quot;</span>, __func__, vring-&gt;flag);</div>
<div class="line">        <span class="keywordflow">if</span> (!xen_unmap_grant_ref(vring-&gt;flag_index))</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: release flag ref index 0x%&quot;</span> PRIx64 <span class="stringliteral">&quot;\n&quot;</span>, __func__, vring-&gt;flag_index);</div>
<div class="line">    }</div>
<div class="line">    vring-&gt;flag = NULL;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_parse_etheraddr(<span class="keyword">struct</span> xen_vring *vring)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX] = {0};</div>
<div class="line">    <span class="keywordtype">char</span> *buf;</div>
<div class="line">    uint32_t len;</div>
<div class="line">    <span class="keywordtype">int</span> ret = -1;</div>
<div class="line"></div>
<div class="line">    snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">        XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_ADDR_SUFFIX,</div>
<div class="line">        vring-&gt;dom_id, vring-&gt;virtio_idx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((buf = xen_read_node(path, &amp;len)) == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> out;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (cmdline_parse_etheraddr(NULL, buf, &amp;vring-&gt;addr,</div>
<div class="line">            <span class="keyword">sizeof</span>(vring-&gt;addr)) &lt; 0)</div>
<div class="line">        <span class="keywordflow">goto</span> out;</div>
<div class="line">    ret = 0;</div>
<div class="line">out:</div>
<div class="line">    free(buf);</div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_vringnode(<span class="keyword">struct</span> xen_guest *guest, uint32_t virtio_idx)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX] = {0};</div>
<div class="line">    <span class="keyword">struct </span>xen_gntnode *rx_gntnode = NULL;</div>
<div class="line">    <span class="keyword">struct </span>xen_gntnode *tx_gntnode = NULL;</div>
<div class="line">    <span class="keyword">struct </span>xen_vring *vring = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*check if null terminated */</span></div>
<div class="line">    snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">        XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_RXVRING_SUFFIX,</div>
<div class="line">        guest-&gt;dom_id,</div>
<div class="line">        virtio_idx);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: virtio %u parse rx gntnode %s\n&quot;</span>, __func__, virtio_idx, path);</div>
<div class="line">    rx_gntnode = parse_gntnode(guest-&gt;dom_id, path);</div>
<div class="line">    <span class="keywordflow">if</span> (rx_gntnode == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*check if null terminated */</span></div>
<div class="line">    snprintf(path, <span class="keyword">sizeof</span>(path),</div>
<div class="line">        XEN_VM_ROOTNODE_FMT<span class="stringliteral">&quot;/%d_&quot;</span>XEN_TXVRING_SUFFIX,</div>
<div class="line">        guest-&gt;dom_id,</div>
<div class="line">        virtio_idx);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: virtio %u parse tx gntnode %s\n&quot;</span>, __func__, virtio_idx, path);</div>
<div class="line">    tx_gntnode = parse_gntnode(guest-&gt;dom_id, path);</div>
<div class="line">    <span class="keywordflow">if</span> (tx_gntnode == NULL)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    vring = &amp;guest-&gt;vring[virtio_idx];</div>
<div class="line">    bzero(vring, <span class="keyword">sizeof</span>(*vring));</div>
<div class="line">    vring-&gt;dom_id = guest-&gt;dom_id;</div>
<div class="line">    vring-&gt;virtio_idx = virtio_idx;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (xen_parse_etheraddr(vring) != 0)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: virtio %u map rx gntnode %s\n&quot;</span>, __func__, virtio_idx, path);</div>
<div class="line">    <span class="keywordflow">if</span> (xen_map_rxvringnode(rx_gntnode, vring) != 0)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, XENHOST, <span class="stringliteral">&quot;  %s: virtio %u map tx gntnode %s\n&quot;</span>, __func__, virtio_idx, path);</div>
<div class="line">    <span class="keywordflow">if</span> (xen_map_txvringnode(tx_gntnode, vring) != 0)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (xen_map_vringflag(vring) != 0)</div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"></div>
<div class="line">    guest-&gt;vring_num++;</div>
<div class="line"></div>
<div class="line">    xen_free_gntnode(rx_gntnode);</div>
<div class="line">    xen_free_gntnode(tx_gntnode);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">err:</div>
<div class="line">    <span class="keywordflow">if</span> (rx_gntnode)</div>
<div class="line">        xen_free_gntnode(rx_gntnode);</div>
<div class="line">    <span class="keywordflow">if</span> (tx_gntnode)</div>
<div class="line">        xen_free_gntnode(tx_gntnode);</div>
<div class="line">    <span class="keywordflow">if</span> (vring) {</div>
<div class="line">        cleanup_vring(vring);</div>
<div class="line">        bzero(vring, <span class="keyword">sizeof</span>(*vring));</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Open xen grant dev driver</span></div>
<div class="line"><span class="comment"> * @return</span></div>
<div class="line"><span class="comment"> *  0 on success, -1 on failure.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">xen_grant_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    d_fd = open(XEN_GNTDEV_FNAME, O_RDWR);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> d_fd == -1? (-1): (0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialise xenstore handle and open grant dev driver.</span></div>
<div class="line"><span class="comment"> * @return</span></div>
<div class="line"><span class="comment"> *  0 on success, -1 on failure.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">xenhost_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    xs = xs_daemon_open();</div>
<div class="line">    <span class="keywordflow">if</span> (xs == NULL) {</div>
<div class="line">        <a name="a5"></a><a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;failed initialize xen daemon handler&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (xen_grant_init())</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
