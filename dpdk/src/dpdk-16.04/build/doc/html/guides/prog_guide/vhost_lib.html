

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>25. Vhost Library &mdash; Data Plane Development Kit 16.04.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Data Plane Development Kit 16.04.0 documentation" href="../index.html"/>
        <link rel="up" title="Programmerâ€™s Guide" href="index.html"/>
        <link rel="next" title="26. Port Hotplug Framework" href="port_hotplug_framework.html"/>
        <link rel="prev" title="24. Packet Framework" href="packet_framework.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Data Plane Development Kit
          

          
            
            <img src="../_static/DPDK_logo_vertical_rev_small.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                16.04.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux_gsg/index.html">Getting Started Guide for Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../freebsd_gsg/index.html">Getting Started Guide for FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xen/index.html">Xen Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Programmer&#8217;s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html">2. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_abstraction_layer.html">3. Environment Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="ring_lib.html">4. Ring Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="mempool_lib.html">5. Mempool Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="mbuf_lib.html">6. Mbuf Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="poll_mode_drv.html">7. Poll Mode Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="cryptodev_lib.html">8. Cryptography Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="ivshmem_lib.html">9. IVSHMEM Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_bonding_poll_mode_drv_lib.html">10. Link Bonding Poll Mode Driver Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="timer_lib.html">11. Timer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="hash_lib.html">12. Hash Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpm_lib.html">13. LPM Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpm6_lib.html">14. LPM6 Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_distrib_lib.html">15. Packet Distributor Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="reorder_lib.html">16. Reorder Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_fragment_reassembly_lib.html">17. IP Fragmentation and Reassembly Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_proc_support.html">18. Multi-process Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel_nic_interface.html">19. Kernel NIC Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread_safety_dpdk_functions.html">20. Thread Safety of DPDK Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_framework.html">21. Quality of Service (QoS) Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="power_man.html">22. Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_classif_access_ctrl.html">23. Packet Classification and Access Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_framework.html">24. Packet Framework</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">25. Vhost Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vhost-api-overview">25.1. Vhost API Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vhost-implementation">25.2. Vhost Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vhost-cuse-implementation">25.2.1. Vhost cuse implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vhost-user-implementation">25.2.2. Vhost user implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vhost-supported-vswitch-reference">25.3. Vhost supported vSwitch reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="port_hotplug_framework.html">26. Port Hotplug Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="source_org.html">27. Source Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_kit_build_system.html">28. Development Kit Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_kit_root_make_help.html">29. Development Kit Root Makefile Help</a></li>
<li class="toctree-l2"><a class="reference internal" href="extend_dpdk.html">30. Extending the DPDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="build_app.html">31. Building Your Own Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ext_app_lib_make_help.html">32. External Application/Library Makefile help</a></li>
<li class="toctree-l2"><a class="reference internal" href="perf_opt_guidelines.html">33. Performance Optimization Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_efficient_code.html">34. Writing Efficient Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="profile_app.html">35. Profile Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="glossary.html">36. Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../nics/index.html">Network Interface Controller Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cryptodevs/index.html">Crypto Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_app_ug/index.html">Sample Applications User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testpmd_app_ug/index.html">Testpmd Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rel_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributor&#8217;s Guidelines</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Data Plane Development Kit</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Programmer&#8217;s Guide</a> &raquo;</li>
      
    <li>25. Vhost Library</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/prog_guide/vhost_lib.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="vhost-library">
<h1>25. Vhost Library</h1>
<p>The vhost library implements a user space vhost driver. It supports both vhost-cuse
(cuse: user space character device) and vhost-user(user space socket server).
It also creates, manages and destroys vhost devices for corresponding virtio
devices in the guest. Vhost supported vSwitch could register callbacks to this
library, which will be called when a vhost device is activated or deactivated
by guest virtual machine.</p>
<div class="section" id="vhost-api-overview">
<h2>25.1. Vhost API Overview</h2>
<ul>
<li><p class="first">Vhost driver registration</p>
<blockquote>
<div><p>rte_vhost_driver_register registers the vhost driver into the system.
For vhost-cuse, character device file will be created under the /dev directory.
Character device name is specified as the parameter.
For vhost-user, a Unix domain socket server will be created with the parameter as
the local socket path.</p>
</div></blockquote>
</li>
<li><p class="first">Vhost session start</p>
<blockquote>
<div><p>rte_vhost_driver_session_start starts the vhost session loop.
Vhost session is an infinite blocking loop.
Put the session in a dedicate DPDK thread.</p>
</div></blockquote>
</li>
<li><p class="first">Callback register</p>
<blockquote>
<div><p>Vhost supported vSwitch could call rte_vhost_driver_callback_register to
register two callbacks, new_destory and destroy_device.
When virtio device is activated or deactivated by guest virtual machine,
the callback will be called, then vSwitch could put the device onto data
core or remove the device from data core by setting or unsetting
VIRTIO_DEV_RUNNING on the device flags.</p>
</div></blockquote>
</li>
<li><p class="first">Read/write packets from/to guest virtual machine</p>
<blockquote>
<div><p>rte_vhost_enqueue_burst transmit host packets to guest.
rte_vhost_dequeue_burst receives packets from guest.</p>
</div></blockquote>
</li>
<li><p class="first">Feature enable/disable</p>
<blockquote>
<div><p>Now one negotiate-able feature in vhost is merge-able.
vSwitch could enable/disable this feature for performance consideration.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="vhost-implementation">
<h2>25.2. Vhost Implementation</h2>
<div class="section" id="vhost-cuse-implementation">
<h3>25.2.1. Vhost cuse implementation</h3>
<p>When vSwitch registers the vhost driver, it will register a cuse device driver
into the system and creates a character device file. This cuse driver will
receive vhost open/release/IOCTL message from QEMU simulator.</p>
<p>When the open call is received, vhost driver will create a vhost device for the
virtio device in the guest.</p>
<p>When VHOST_SET_MEM_TABLE IOCTL is received, vhost searches the memory region
to find the starting user space virtual address that maps the memory of guest
virtual machine. Through this virtual address and the QEMU pid, vhost could
find the file QEMU uses to map the guest memory. Vhost maps this file into its
address space, in this way vhost could fully access the guest physical memory,
which means vhost could access the shared virtio ring and the guest physical
address specified in the entry of the ring.</p>
<p>The guest virtual machine tells the vhost whether the virtio device is ready
for processing or is de-activated through VHOST_NET_SET_BACKEND message.
The registered callback from vSwitch will be called.</p>
<p>When the release call is released, vhost will destroy the device.</p>
</div>
<div class="section" id="vhost-user-implementation">
<h3>25.2.2. Vhost user implementation</h3>
<p>When vSwitch registers a vhost driver, it will create a Unix domain socket server
into the system. This server will listen for a connection and process the vhost message from
QEMU simulator.</p>
<p>When there is a new socket connection, it means a new virtio device has been created in
the guest virtual machine, and the vhost driver will create a vhost device for this virtio device.</p>
<p>For messages with a file descriptor, the file descriptor could be directly used in the vhost
process as it is already installed by Unix domain socket.</p>
<blockquote>
<div><ul class="simple">
<li>VHOST_SET_MEM_TABLE</li>
<li>VHOST_SET_VRING_KICK</li>
<li>VHOST_SET_VRING_CALL</li>
<li>VHOST_SET_LOG_FD</li>
<li>VHOST_SET_VRING_ERR</li>
</ul>
</div></blockquote>
<p>For VHOST_SET_MEM_TABLE message, QEMU will send us information for each memory region and its
file descriptor in the ancillary data of the message. The fd is used to map that region.</p>
<p>There is no VHOST_NET_SET_BACKEND message as in vhost cuse to signal us whether virtio device
is ready or should be stopped.
VHOST_SET_VRING_KICK is used as the signal to put the vhost device onto data plane.
VHOST_GET_VRING_BASE is used as the signal to remove vhost device from data plane.</p>
<p>When the socket connection is closed, vhost will destroy the device.</p>
</div>
</div>
<div class="section" id="vhost-supported-vswitch-reference">
<h2>25.3. Vhost supported vSwitch reference</h2>
<p>For more vhost details and how to support vhost in vSwitch, please refer to vhost example in the
DPDK Sample Applications Guide.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="port_hotplug_framework.html" class="btn btn-neutral float-right" title="26. Port Hotplug Framework" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="packet_framework.html" class="btn btn-neutral" title="24. Packet Framework" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'16.04.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>