# 内存子系统

电子业在内存子系统上付出了艰辛的努力，只为紧跟现代处理器需要的低访问时间和满足当今应用程序要求的高容量需求。

解释当前内存子系统之前，我们先了解一下与内存有关的一些常用术语。

1. RAM(随机访问存储器)
2. SRAM(静态RAM)
3. DRAM(动态RAM)
4. SDRAM(同步DRAM)
5. SIMM(单列直插式内存模块)
6. DIMM(双列直插内存模块)
7. UDIMM(无缓冲DIMM)
8. RDIMM(带寄存器的DIMM)
9. DDR(双数据速率SDRAM)
10. DDR2(第二代DDR)
11. DDR3(第三代DDR)

电子器件工程联合委员会(`Joint Electron Device Engineering Council`，`JEDEC`)是半导体工程标准化机构，`JEDEC 21`，`22`定义了从256位`SRAM`到最新的`DDR3`模组的半导体存储器标准。

现代服务器的内存子系统是由`RAM`组成的，允许数据在一个固定的时间按任意顺序访问，不用考虑它所在的物理位置，`RAM`可以是静态的或动态的。

## `SRAM`

`SRAM`(静态`RAM`)通常非常快，但比`DRAM`的容量要小，它们有一块芯片结构维持信息，但它们不够大，因此不能作为服务器的主要内存。

## `DRAM`

`DRAM`(动态`RAM`)是服务器的唯一选择，术语“动态”表示信息是存储在集成电路的电容器内的，由于电容器会自动放电，为避免数据丢失，需要定期充电，内存控制器通常负责充电操作。

## `SDRAM`

`SDRAM`(同步`DRAM`)是最常用的`DRAM`，`SDRAM`具有同步接口，它们的操作与时钟信号保持同步，时钟用于驱动流水线内存访问的内部有限状态机，流水线意味着上一个访问未结束前，芯片可以接收一个新的内存访问，与传统`DRAM`相比，这种方法大大提高了`SDRAM`的性能。

`DDR2`和`DDR3`是两个最常用的`SDRAM`，下图显示了一块`DRAM`芯片的内部结构。

![DRAM芯片的内部结构](http://image20.it168.com/201008_0x0/157/c657c2ae4bf2b659.jpg)

为了提高性能，降低功耗，内存阵列被分割成多个“内存库(bank)”，下图显示了一个4-bank和一个8-bank的内存阵列组织方式。

![内存bank](http://image20.it168.com/201008_0x0/157/b928ba7d578d231.jpg)

DDR2芯片有四个内部内存bank，DDR3芯片有八个内部内存bank。

## DIMM

需要将多个内存芯片组装到一起才能构成一个内存子系统，它们就是按著名的DIMM(双列直插内存模块)组织的。

下图显示了内存子系统的传统组织方式，例如，内存控制器连接四个DIMM，每一个由多块DRAM芯片组成，内存控制器有一个地址总线，一个数据总线和一个命令(也叫做控制)总线，它负责读，写和刷新存储在DIMM中的信息。

![传统内存子系统示例](http://image20.it168.com/201008_0x0/157/b047651724323090.jpg)

下图展示了一个内存控制器与一个DDR3 DIMM连接的示例，该DIMM由八块DRAM芯片组成，每一块有8位数据存储能力，每存储字(内存数据总线的宽度)则共有64位数据存储能力。地址总线有15位，它可在不同时间运送“行地址”或“列地址”，总共有30个地址位。此外，在DDR3芯片中，3位的bank地址允许访问8个bank，可被视作提高了控制器的地址空间总容量，但即使内存控制器有这样的地址容量，市面上DDR3芯片容量还是很小。最后，RAS(Row Address Selection，行地址选择)，CAS(Column Address Selection，列地址选择)，WE(Write Enabled，写启用)等都是命令总线上的。

![DDR3内存控制器示例](http://image20.it168.com/201008_0x0/157/d6b571e7cf7ea1b7.jpg)

下面是一个DIMM的示意图。

![ DIMM示意图](http://image20.it168.com/201008_0x0/157/7b3e07eeb7eed615.jpg)

上图显示了8个DDR3芯片，每个提供了8位信息(通常表示为x8)


## ECC和Chipkill

数据完整性是服务器架构最关注的一个点，很多时候需要安装额外的DIMM检测和恢复内存错误，最常见的办法是增加8位ECC(纠错码)，将存储字从64位扩大到72位，就象海明码一样，允许纠正一位错误，检测两位错误，它们也被称作SEC(Single Error Correction，单纠错)/DED(Double Error Detection，双检错)。

先组织存储字再写入到内存芯片中，EEC可以用于保护任一内存芯片的失效，以及单内存芯片的任意多位错误，这些功能有几个不同的名字。

1. Chipkill是IBM的商标
2. Oracle称之为扩展EEC
3. 惠普称之为Chipspare
4. 英特尔有一个类似的功能叫做x4单设备数据校正(Intel x4 SDDC)

Chipkill通过跨多个内存芯片位散射EEC字的位实现这个功能，任一内存芯片失效只会影响到一个ECC位，它允许重建内存中的内容。

下图了显示了一个读和写128位数据的内存控制器，增加EEC后就变成144位了，144位分成4个36位的存储字，每个存储字将是SEC/DED。如果使用两个DIMM，每个包含18个4位芯片，可以按照下图所示的方法重组位，如果芯片失效，每4个字中只会有一个错误，但因为字是SEC/DED的，每4个字可以纠正一个错误，因此所有错误都可以被纠正过来。

[Chipkill示例](http://image20.it168.com/201008_0x0/157/d8be95eec4164d7e.jpg)

## 内存Rank

我们重新回到DIMM是如何组织的，一组产生64位有用数据(不计ECC)的芯片叫做一个Rank，为了在DIMM上存储更多的数据，可以安装多个Rank，目前有单，双和四个Rank的 DIMM，下图显示了这三种组织方法。

[DIMM和内存排](http://image20.it168.com/201008_0x0/157/af9278273fc8212a.jpg)

上图最前面显示的是一个单Rank的RAM，由9个8位芯片组成，一般表示为1Rx8，中间显示的是一个1Rx4，由18个4位芯片组成，最后显示的是一个2Rx8，由18个8位芯片组成。

内存Rank不能使用地址位选择，只能使用芯片选择，现代内存控制器最多可达8个独立的芯片选择，因此最大可支持8个Rank。

## UDIMM和RDIMM

SDRAM DIMM进一步细分为UDIMM(无缓冲DIMM)和RDIMM(带寄存器的DIMM)，在UDIMM中，内存芯片直接连接到地址总线和控制总线，无任何中间部分。

RDIMM在传入地址和控制总线，以及SDRAM之间有额外的组件(寄存器)，这些寄存器增加了一个延迟时钟周期，但它们减少了内存控制器上的电负荷，允许内存控制器安装更多的DIMM。

RDIMM通常更贵，因为它需要附加组件，但它们在服务器中得到了普遍使用，因为对于服务器来说，扩展能力和稳定性比价格更重要。

虽然理论上带寄存器/无缓冲的和ECC/非ECC DIMM是可以任何组合的，但大多数服务器级内存模块都同时具有ECC和带寄存器功能。

下图显示了一个ECC RDIMM，寄存器是箭头指向的芯片，这个ECC DIMM由9个内存芯片组成。

![ ECC RDIMM](http://image20.it168.com/201008_0x0/157/2a0176a0ac1eae7d.jpg)

## DDR2和DDR3

第一代SDRAM技术叫做SDR(Single Data Rate)，表示每个时钟周期传输一个数据单元，之后又出现了DDR(Double Data Rate)标准，其带宽几乎是SDR的两倍，无需提高时钟频率，可在时钟上升沿和下降沿信号上同时传输数据，DDR技术发展到今天形成了两套标准：DDR2和DDR3。

DDR 2 SDRAM的工作电压是1.8V，采用240针DIMM模块封装，通过改善总线信号，它们可以以两倍于DDR的速度工作在外部数据总线上，规则是：
1. 每DRAM时钟数据传输两次
2. 每次数据传输8个字节(64位)


下表显示了DDR2标准。

DDR 3 SDRAM在DDR2的基础上对以下这些方面做了改进：
1. 将工作电压降低到1.5v，减少功耗;
2. 通过引入0.5-8Gb的芯片增加了内存密度，单Rank的容量最大可达16GB;
3. 增加了内存带宽，内存突发长度从4字增加到8字，增加突发长度是为了更好地满足不断增长的外部数据传输速率，随着传输速率的增长，突发长度(传输的大小)必须增长，但不能超出DRAM核心的访问速度。

DDR3 DIMM有240针，数量和尺寸都和DDR2一样，但它们在电气特性上是不兼容的，缺口位置不一样，未来，DDR3将工作在更快的时钟频率，目前，市面上存在DDR3-800，1066和1333三种类型。

下表对不同的DDR3 DIMM模块进行了总结。

表3. DDR3 DIMM
